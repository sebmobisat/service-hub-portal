<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="meta.vehicle.title">Vehicle Details - Service Hub Portal</title>
    
    <!-- Global protection against Node.js exports errors - MUST BE FIRST -->
    <script>
        // Global protection against Node.js exports errors
        if (typeof module === 'undefined') {
            var module = {};
        }
        if (typeof exports === 'undefined') {
            var exports = {};
        }
        if (typeof require === 'undefined') {
            var require = function() { return {}; };
        }
    </script>
    
    <!-- Authentication Configuration -->
    <script src="/js/auth-config.js"></script>
    <!-- Custom Dialog -->
    <script src="/js/custom-dialog.js"></script>
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    
    <!-- Tailwind CSS -->
    <script>
        // Suppress Tailwind CDN warning in development
        const originalWarn = console.warn;
        console.warn = function(...args) {
            if (args[0] && typeof args[0] === 'string' && args[0].includes('cdn.tailwindcss.com should not be used in production')) {
                return; // Suppress this specific warning
            }
            originalWarn.apply(console, args);
        };
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/css/styles.css">
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    
    <style>
        /* Certificate Cards Theme Support - Same as certificates.html */
        .certificate-card {
            /* Default Light Theme */
            background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
            border-color: #e5e7eb;
            color: #111827;
        }
        
        /* Dark Theme Overrides */
        html.dark .certificate-card {
            background: linear-gradient(135deg, #374151 0%, #4b5563 100%);
            border-color: #6b7280;
            color: #f9fafb;
        }
        
        .ai-report-content strong:first-child {
            margin-top: 0 !important;
        }
        
        .ai-report-content strong::before {
            content: '' !important;
            position: absolute !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            height: 2px !important;
            background: linear-gradient(90deg, #8b5cf6, #a855f7, #c084fc) !important;
        }
        
        .dark .ai-report-content strong::before {
            background: linear-gradient(90deg, #a78bfa, #c084fc, #ddd6fe) !important;
        }
        
        .ai-report-content p {
            margin-bottom: 1rem !important;
            padding: 0.5rem 0 !important;
            position: relative !important;
        }
        
        .ai-report-content p:not(:last-child)::after {
            content: '' !important;
            position: absolute !important;
            bottom: 0 !important;
            left: 0 !important;
            right: 0 !important;
            height: 1px !important;
            background: linear-gradient(90deg, transparent, rgba(139, 92, 246, 0.1), transparent) !important;
        }
        
        .dark .ai-report-content p:not(:last-child)::after {
            background: linear-gradient(90deg, transparent, rgba(167, 139, 250, 0.1), transparent) !important;
        }
        
        .ai-report-content ul {
            margin: 1rem 0 1.5rem 0 !important;
            padding-left: 2rem !important;
            position: relative !important;
        }
        
        .ai-report-content ul::before {
            content: '' !important;
            position: absolute !important;
            left: 0.5rem !important;
            top: 0.5rem !important;
            bottom: 0.5rem !important;
            width: 2px !important;
            background: linear-gradient(180deg, #8b5cf6, #a855f7) !important;
            border-radius: 1px !important;
        }
        
        .dark .ai-report-content ul::before {
            background: linear-gradient(180deg, #a78bfa, #c084fc) !important;
        }
        
        .ai-report-content li {
            margin-bottom: 0.75rem !important;
            padding: 0.5rem 1rem !important;
            background: rgba(139, 92, 246, 0.05) !important;
            border-radius: 8px !important;
            border-left: 3px solid #8b5cf6 !important;
            position: relative !important;
            transition: all 0.2s ease !important;
        }
        
        .dark .ai-report-content li {
            background: rgba(167, 139, 250, 0.1) !important;
            border-left-color: #a78bfa !important;
        }
        
        .ai-report-content li:hover {
            background: rgba(139, 92, 246, 0.1) !important;
            transform: translateX(4px) !important;
        }
        
        .dark .ai-report-content li:hover {
            background: rgba(167, 139, 250, 0.15) !important;
        }
        
        .ai-report-content li::before {
            content: '•' !important;
            color: #8b5cf6 !important;
            font-weight: bold !important;
            position: absolute !important;
            left: -0.5rem !important;
            top: 0.5rem !important;
        }
        
        .dark .ai-report-content li::before {
            color: #a78bfa !important;
        }
        
        /* Highlight important numbers */
        .ai-report-content strong + p {
            font-weight: 500 !important;
            color: #1f2937 !important;
            background: rgba(34, 197, 94, 0.1) !important;
            padding: 0.75rem 1rem !important;
            border-radius: 8px !important;
            border-left: 3px solid #22c55e !important;
            margin: 1rem 0 !important;
        }
        
        .dark .ai-report-content strong + p {
            color: #f9fafb !important;
            background: rgba(34, 197, 94, 0.15) !important;
            border-left-color: #4ade80 !important;
        }
        
        /* Warning/alert styling */
        .ai-report-content p:contains('warning'), .ai-report-content p:contains('Warning') {
            background: rgba(245, 158, 11, 0.1) !important;
            border-left: 3px solid #f59e0b !important;
            padding: 0.75rem 1rem !important;
            border-radius: 8px !important;
            margin: 1rem 0 !important;
        }
        
        .dark .ai-report-content p:contains('warning'), .dark .ai-report-content p:contains('Warning') {
            background: rgba(245, 158, 11, 0.15) !important;
            border-left-color: #fbbf24 !important;
        }
    </style>
</head>

<body class="min-h-screen theme-transition">
    <!-- Sidebar -->
    <div class="sidebar fixed left-0 top-0 h-full w-16 flex flex-col py-4 z-50">
        <!-- Logo -->
        <div class="flex items-center justify-center mb-8">
            <img src="/images/greenbox-logo.png" alt="Service Hub" class="w-10 h-10 object-contain" onerror="handleLogoError()" id="sidebarLogo">
            <!-- Fallback logo if image fails -->
            <div class="w-10 h-10 bg-green-600 rounded-lg flex items-center justify-center text-white font-bold text-xs" style="display: none;" id="logoFallback">
                SH
            </div>
        </div>
        
        <!-- Menu Items (only icons) -->
        <nav class="flex-1 py-4">
            <!-- Dashboard Page -->
            <div class="relative group">
                <button onclick="window.location.href='/'" class="w-full p-3 flex justify-center rounded-lg text-gray-300 hover:bg-gray-700 hover:text-white transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                    </svg>
                </button>
                <!-- Tooltip -->
                <div class="absolute left-full ml-2 px-2 py-1 bg-gray-900 text-white text-sm rounded opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none whitespace-nowrap z-60" data-i18n="nav.dashboard"></div>
            </div>
            
            <!-- Certificates Page -->
            <div class="relative group mt-2">
                <button onclick="window.location.href='/certificates.html'" class="w-full p-3 flex justify-center rounded-lg text-gray-300 hover:bg-gray-700 hover:text-white transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                </button>
                <!-- Tooltip -->
                <div class="absolute left-full ml-2 px-2 py-1 bg-gray-900 text-white text-sm rounded opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none whitespace-nowrap z-60" data-i18n="nav.certificates"></div>
            </div>
            
            <!-- Settings -->
            <div class="relative group mt-2">
                <button onclick="window.location.href='/settings.html'" class="w-full p-3 flex justify-center rounded-lg text-gray-300 hover:bg-gray-700 hover:text-white transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                </button>
                <!-- Tooltip -->
                <div class="absolute left-full ml-2 px-2 py-1 bg-gray-900 text-white text-sm rounded opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none whitespace-nowrap z-60" data-i18n="nav.settings"></div>
            </div>
        </nav>
        
        <!-- Logout -->
        <div class="relative group mt-auto">
            <button onclick="logout()" class="w-full p-3 flex justify-center rounded-lg text-gray-300 hover:bg-red-600 hover:text-white transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                </svg>
            </button>
            <!-- Tooltip -->
            <div class="absolute left-full ml-2 px-2 py-1 bg-gray-900 text-white text-sm rounded opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none whitespace-nowrap z-60" data-i18n="nav.logout"></div>
        </div>
    </div>

    <!-- Main content with left margin for sidebar -->
    <div style="margin-left: 64px;">
        <!-- Header -->
        <header class="bg-gray-800 border-b border-gray-700 px-4 py-3">
            <div class="flex items-center justify-between">
                    <div>
                    <h1 class="text-xl font-semibold text-white" data-i18n="vehicle.page_title">Dettagli Veicolo</h1>
                    <p class="text-gray-400 text-sm" data-i18n="vehicle.page_subtitle">Informazioni complete del veicolo e storico</p>
                    </div>
                <div class="flex items-center space-x-4">
                    <img id="headerLogo" src="/images/header_logo_dark_theme.png?v10" alt="Mobisat" class="h-8 w-auto object-contain">
                </div>
            </div>
        </header>

        <!-- Page Content -->
        <div class="w-[95%] mx-auto px-4 py-8">
            <!-- Vehicle Information Card -->
        <div class="certificate-card rounded-lg shadow-lg border overflow-hidden">
                <!-- Vehicle Header -->
                <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-4">
                            <!-- Vehicle Image Placeholder -->
                            <div id="vehicleImageContainer" class="w-24 h-16 bg-gray-200 dark:bg-gray-700 rounded-lg flex items-center justify-center">
                                <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 9l4-4 4 4m0 6l-4 4-4-4"/>
                                </svg>
                            </div>
                            
                            <div>
                                <h2 id="vehicleTitle" class="text-2xl font-bold text-gray-900 dark:text-white">
                                    Loading...
                                </h2>
                                <p id="vehicleSubtitle" class="text-gray-500 dark:text-gray-400">
                                    Vehicle information
                                </p>
                            </div>
                        </div>
                        
                        <div class="text-right">
                            <div class="text-sm text-gray-500 dark:text-gray-400" data-i18n="vehicle.certificate_number">Certificate #</div>
                            <div id="certificateNumber" class="text-lg font-semibold text-gray-900 dark:text-white">-</div>
                        </div>
                    </div>
                </div>
                
                <!-- Navigation -->
                <div class="px-6 py-3 border-b border-gray-200 dark:border-gray-700">
                    <a href="/certificates.html" class="inline-flex items-center gap-2 text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 text-sm font-medium transition-colors">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                        </svg>
                        <span>Torna ai Certificati</span>
                    </a>
                </div>
                
                <!-- Tabs Navigation -->
                <div class="border-b border-gray-200 dark:border-gray-700">
                    <nav class="flex space-x-2 px-6" aria-label="Tabs">
                        <button id="tab-overview" class="tab-button py-4 px-6 rounded-t-lg font-medium text-sm whitespace-nowrap bg-gray-800 text-white shadow-lg border-b-4 border-gray-900 focus:outline-none" data-tab="overview">
                            <div class="flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                <span data-it="Veicolo" data-en="Vehicle">Veicolo</span>
                            </div>
                        </button>
                        <button id="tab-client" class="tab-button py-4 px-6 rounded-t-lg font-medium text-sm whitespace-nowrap bg-gray-100 text-gray-700 hover:bg-gray-200 hover:text-gray-900 dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600 transition-all duration-200 focus:outline-none" data-tab="client">
                            <div class="flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                                </svg>
                                <span data-it="Cliente" data-en="Client">Cliente</span>
                            </div>
                        </button>
                        <button id="tab-analytics" class="tab-button py-4 px-6 rounded-t-lg font-medium text-sm whitespace-nowrap bg-gray-100 text-gray-700 hover:bg-gray-200 hover:text-gray-900 dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600 transition-all duration-200 focus:outline-none" data-tab="analytics">
                            <div class="flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                                </svg>
                                <span data-it="Analytics" data-en="Analytics">Analytics</span>
                            </div>
                        </button>
                        <button id="tab-obd-data" class="tab-button py-4 px-6 rounded-t-lg font-medium text-sm whitespace-nowrap bg-gray-100 text-gray-700 hover:bg-gray-200 hover:text-gray-900 dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600 transition-all duration-200 focus:outline-none" data-tab="obd-data">
                            <div class="flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                                </svg>
                                <span data-it="Dati OBD" data-en="OBD Data">Dati OBD</span>
                            </div>
                        </button>
                        <button id="tab-obd-errors" class="tab-button py-4 px-6 rounded-t-lg font-medium text-sm whitespace-nowrap bg-gray-100 text-gray-700 hover:bg-gray-200 hover:text-gray-900 dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600 transition-all duration-200 focus:outline-none" data-tab="obd-errors">
                            <div class="flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.464 0L4.36 16.5c-.77.833.192 2.5 1.732 2.5z"/>
                                </svg>
                                <span data-it="Errori OBD" data-en="OBD Errors">Errori OBD</span>
                            </div>
                        </button>
                        <button id="tab-ai-report" class="tab-button py-4 px-6 rounded-t-lg font-medium text-sm whitespace-nowrap bg-gray-100 text-gray-700 hover:bg-gray-200 hover:text-gray-900 dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600 transition-all duration-200 focus:outline-none" data-tab="ai-report">
                            <div class="flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                                </svg>
                                <span data-it="Report AI" data-en="AI Report">AI Report</span>
                            </div>
                        </button>

                    </nav>
                </div>

                <!-- Tab Contents -->
                <div class="tab-content">
                    <!-- Overview Tab -->
                    <div id="content-overview" class="tab-panel p-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- Basic Information -->
                        <div class="space-y-4">
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center gap-2">
                                <svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                <span data-i18n="vehicle.basic_info">Basic Information</span>
                            </h3>
                            
                            <div class="space-y-3">
                                <div>
                                    <span class="font-bold text-gray-900 dark:text-white" data-i18n="vehicle.brand">Brand</span><span class="font-bold text-gray-900 dark:text-white">: </span><span id="vehicleBrand" class="text-gray-600 dark:text-gray-300">-</span>
                                </div>
                                <div>
                                    <span class="font-bold text-gray-900 dark:text-white" data-i18n="vehicle.model">Model</span><span class="font-bold text-gray-900 dark:text-white">: </span><span id="vehicleModel" class="text-gray-600 dark:text-gray-300">-</span>
                                </div>
                                <div>
                                    <span class="font-bold text-gray-900 dark:text-white" data-i18n="vehicle.year">Year</span><span class="font-bold text-gray-900 dark:text-white">: </span><span id="vehicleYear" class="text-gray-600 dark:text-gray-300">-</span>
                                </div>
                                <div>
                                    <span class="font-bold text-gray-900 dark:text-white" data-i18n="vehicle.plate">License Plate</span><span class="font-bold text-gray-900 dark:text-white">: </span><span id="vehiclePlate" class="text-gray-600 dark:text-gray-300">-</span>
                                </div>
                                <div>
                                    <span class="font-bold text-gray-900 dark:text-white" data-it="VIN" data-en="VIN">VIN</span><span class="font-bold text-gray-900 dark:text-white">: </span><span id="vehicleVin" class="text-gray-600 dark:text-gray-300">-</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Technical Details -->
                        <div class="space-y-4">
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center gap-2">
                                <svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 7.172V5L8 4z"/>
                                </svg>
                                <span data-i18n="vehicle.technical_details">Technical Details</span>
                            </h3>
                            
                            <div class="space-y-3">
                                <div>
                                    <span class="font-bold text-gray-900 dark:text-white" data-i18n="vehicle.fuel_type">Fuel Type</span><span class="font-bold text-gray-900 dark:text-white">: </span><span id="vehicleFuelType" class="text-gray-600 dark:text-gray-300">-</span>
                                </div>
                                <div>
                                    <span class="font-bold text-gray-900 dark:text-white" data-i18n="vehicle.odometer">Odometer</span><span class="font-bold text-gray-900 dark:text-white">: </span><span id="vehicleOdometer" class="text-gray-600 dark:text-gray-300">- km</span>
                                </div>
                                <div>
                                    <span class="font-bold text-gray-900 dark:text-white" data-i18n="vehicle.color">Color</span><span class="font-bold text-gray-900 dark:text-white">: </span><span id="vehicleColor" class="text-gray-600 dark:text-gray-300">-</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Device Information -->
                        <div class="space-y-4">
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center gap-2">
                                <svg class="w-5 h-5 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"/>
                                </svg>
                                <span data-i18n="vehicle.device_info">Device Information</span>
                            </h3>
                            
                            <div class="space-y-3">
                                <div>
                                    <span class="font-bold text-gray-900 dark:text-white" data-i18n="vehicle.device_id">Device ID</span><span class="font-bold text-gray-900 dark:text-white">: </span><span id="deviceId" class="text-gray-600 dark:text-gray-300">-</span>
                                </div>
                                <div>
                                    <span class="font-bold text-gray-900 dark:text-white" data-i18n="vehicle.imei">IMEI</span><span class="font-bold text-gray-900 dark:text-white">: </span><span id="deviceImei" class="text-gray-600 dark:text-gray-300">-</span>
                                </div>
                                <div>
                                    <span class="font-bold text-gray-900 dark:text-white" data-i18n="vehicle.serial">Serial</span><span class="font-bold text-gray-900 dark:text-white">: </span><span id="deviceSerial" class="text-gray-600 dark:text-gray-300">-</span>
                                </div>
                                <div>
                                    <span class="font-bold text-gray-900 dark:text-white" data-i18n="vehicle.installation_date">Installation Date</span><span class="font-bold text-gray-900 dark:text-white">: </span><span id="installationDate" class="text-gray-600 dark:text-gray-300">-</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

                    <!-- Analytics Tab -->
                    <div id="content-analytics" class="tab-panel hidden p-6">
                        <!-- Header -->
                        <div class="flex items-center justify-between mb-6">
                            <div class="flex items-center gap-4">
                                <div class="p-3 bg-indigo-600/20 rounded-xl">
                                    <svg class="w-6 h-6 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                                    </svg>
                                </div>
                                <div>
                                                                    <h2 class="text-2xl font-bold text-gray-900 dark:text-white" data-it="Analisi Veicolo" data-en="Vehicle Analytics">Vehicle Analytics</h2>
                                <p class="text-gray-600 dark:text-gray-400" data-it="Report completi di performance e utilizzo" data-en="Comprehensive performance and usage reports">Comprehensive performance and usage reports</p>
                                </div>
                            </div>
                            
                            <!-- Date Range Selector -->
                            <div class="flex items-center gap-3">
                                <div class="flex items-center gap-2">
                                    <label class="text-sm font-medium text-gray-600 dark:text-gray-300" data-it="Periodo:" data-en="Period:">Period:</label>
                                    <select id="dateRangeSelector" class="bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-gray-100 text-sm rounded-lg px-3 py-2 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all">
                                        <option value="today" data-it="Oggi" data-en="Today">Today</option>
                                        <option value="yesterday" data-it="Ieri" data-en="Yesterday">Yesterday</option>
                                        <option value="thisWeek" data-it="Questa Settimana" data-en="This Week">This Week</option>
                                        <option value="lastWeek" data-it="Scorsa Settimana" data-en="Last Week">Last Week</option>
                                        <option value="thisMonth" data-it="Questo Mese" data-en="This Month">This Month</option>
                                        <option value="lastMonth" data-it="Scorso Mese" data-en="Last Month">Last Month</option>
                                        <option value="last7days" selected data-it="Ultimi 7 Giorni" data-en="Last 7 Days">Last 7 Days</option>
                                        <option value="last30days" data-it="Ultimi 30 Giorni" data-en="Last 30 Days">Last 30 Days</option>
                                        <option value="last90days" data-it="Ultimi 90 Giorni" data-en="Last 90 Days">Last 90 Days</option>
                                        <option value="thisYear" data-it="Quest'Anno" data-en="This Year">This Year</option>
                                        <option value="custom" data-it="Intervallo Personalizzato" data-en="Custom Range">Custom Range</option>
                                    </select>
                                </div>
                                

                                
                                <!-- Custom Date Inputs -->
                                <div id="customDateInputs" class="flex items-center gap-2" style="display: none;">
                                    <input type="date" id="startDateInput" class="bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-gray-100 text-sm rounded-lg px-3 py-2 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all">
                                    <span class="text-gray-600 dark:text-gray-400" data-it="a" data-en="to">to</span>
                                    <input type="date" id="endDateInput" class="bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-gray-100 text-sm rounded-lg px-3 py-2 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all">
                                </div>
                                
                                                                    <button id="refreshAnalytics" class="px-4 py-2 bg-gradient-to-r from-indigo-600 to-indigo-700 text-white rounded-lg text-sm font-medium hover:from-indigo-700 hover:to-indigo-800 transition-all duration-200 flex items-center gap-2 shadow-lg" data-it="Aggiorna" data-en="Refresh">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                                        </svg>
                                        Refresh
                                    </button>
                        </div>
                    </div>
                    
                    <!-- Summary Statistics -->
                        <div class="mb-6">
                        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4" id="summaryStats">
                            <!-- Summary cards will be populated here -->
                        </div>
                    </div>
                    
                    <!-- Charts Grid -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            
                            <!-- Battery Chart -->
                            <div class="relative group">
                                <!-- Modern chart container for both modes -->
                                <div class="relative bg-white dark:bg-gradient-to-br dark:from-gray-800 dark:via-gray-700 dark:to-gray-900 rounded-2xl p-8 border border-gray-200 dark:border-gray-600/40 shadow-lg hover:border-yellow-400/50 hover:shadow-xl transition-all duration-300">
                                    <!-- Background glow effect -->
                                    <div class="absolute inset-0 bg-gradient-to-r from-yellow-50/40 to-yellow-100/30 dark:from-yellow-500/10 dark:via-yellow-400/5 dark:to-yellow-600/10 rounded-2xl opacity-40 group-hover:opacity-60 transition-opacity duration-300"></div>
                                    
                                    <!-- Header -->
                                    <div class="relative flex items-center gap-4 mb-6">
                                        <div class="p-4 bg-gradient-to-br from-yellow-500 to-yellow-600 rounded-xl shadow-lg">
                                            <svg class="w-12 h-12 text-white drop-shadow-sm" fill="currentColor" viewBox="0 0 24 24">
                                                <path d="M4 6h16v2h2v8h-2v2H4v-2H2V8h2V6zm2 2v8h12V8H6zm1 2h2v4H7v-4zm8 0h2v4h-2v-4zm-4-1h2v6h-2V9z"/>
                                                <rect x="3" y="9" width="1" height="6" fill="currentColor"/>
                                                <rect x="20" y="9" width="1" height="6" fill="currentColor"/>
                                            </svg>
                                    </div>
                                    <div>
                                                                                <h3 class="text-xl font-bold text-gray-900 dark:text-white" data-it="Tensione Batteria" data-en="Battery Voltage">Tensione Batteria</h3>
                                    <p class="text-sm text-gray-600 dark:text-gray-300" data-it="Tensione media giornaliera (V)" data-en="Daily average voltage (V)">Tensione media giornaliera (V)</p>
                                    </div>
                                </div>
                                    
                                    <!-- Chart area -->
                                    <div class="relative h-72 bg-gray-50 dark:bg-gray-900/80 rounded-xl p-4 border border-gray-200 dark:border-gray-700/50">
                                    <canvas id="batteryChart"></canvas>
                                    </div>
                                    
                                    <!-- Top highlight -->
                                    <div class="absolute top-0 left-1/4 right-1/4 h-px bg-gradient-to-r from-transparent via-yellow-400/50 to-transparent"></div>
                                </div>
                            </div>
                            
                            <!-- Distance & Time Chart -->
                            <div class="relative group">
                                <!-- Modern chart container for both modes -->
                                <div class="relative bg-white dark:bg-gradient-to-br dark:from-gray-800 dark:via-gray-700 dark:to-gray-900 rounded-2xl p-8 border border-gray-200 dark:border-gray-600/40 shadow-lg hover:border-blue-400/50 hover:shadow-xl transition-all duration-300">
                                    <!-- Background glow effect -->
                                    <div class="absolute inset-0 bg-gradient-to-r from-blue-50/40 to-blue-100/30 dark:from-blue-500/10 dark:via-blue-400/5 dark:to-blue-600/10 rounded-2xl opacity-40 group-hover:opacity-60 transition-opacity duration-300"></div>
                                    
                                    <!-- Header -->
                                    <div class="relative flex items-center gap-4 mb-6">
                                        <div class="p-4 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl shadow-lg">
                                            <svg class="w-12 h-12 text-white drop-shadow-sm" fill="currentColor" viewBox="0 0 24 24">
                                                <path d="M2 12h2l1-3h2l1 3h2l1-3h2l1 3h2l1-3h2l1 3h2l1-3h2v2h-2l-1 3h-2l-1-3h-2l-1 3h-2l-1-3h-2l-1 3h-2l-1-3h-2l-1 3H2v-2z"/>
                                                <path d="M1 10h22v4H1z" opacity="0.3"/>
                                                <path d="M3 11h2v2H3zm4 0h2v2H7zm4 0h2v2h-2zm4 0h2v2h-2zm4 0h2v2h-2z"/>
                                                <circle cx="5" cy="8" r="1"/>
                                                <circle cx="12" cy="8" r="1"/>
                                                <circle cx="19" cy="8" r="1"/>
                                            </svg>
                                    </div>
                                    <div>
                                                                                <h3 class="text-xl font-bold text-gray-900 dark:text-white" data-it="Distanza e Tempo" data-en="Distance and Time">Distanza e Tempo</h3>
                                    <p class="text-sm text-gray-600 dark:text-gray-300" data-it="Distanza giornaliera (km) e tempo (ore)" data-en="Daily distance (km) and time (hours)">Distanza giornaliera (km) e tempo (ore)</p>
                                    </div>
                                </div>
                                    
                                    <!-- Chart area -->
                                    <div class="relative h-72 bg-gray-50 dark:bg-gray-900/80 rounded-xl p-4 border border-gray-200 dark:border-gray-700/50">
                                    <canvas id="distanceTimeChart"></canvas>
                                    </div>
                                    
                                    <!-- Top highlight -->
                                    <div class="absolute top-0 left-1/4 right-1/4 h-px bg-gradient-to-r from-transparent via-blue-400/50 to-transparent"></div>
                                </div>
                            </div>
                            
                            <!-- Speed Chart -->
                            <div class="relative group">
                                <!-- Modern chart container for both modes -->
                                <div class="relative bg-white dark:bg-gradient-to-br dark:from-gray-800 dark:via-gray-700 dark:to-gray-900 rounded-2xl p-8 border border-gray-200 dark:border-gray-600/40 shadow-lg hover:border-green-400/50 hover:shadow-xl transition-all duration-300">
                                    <!-- Background glow effect -->
                                    <div class="absolute inset-0 bg-gradient-to-r from-green-50/40 to-green-100/30 dark:from-green-500/10 dark:via-green-400/5 dark:to-green-600/10 rounded-2xl opacity-40 group-hover:opacity-60 transition-opacity duration-300"></div>
                                    
                                    <!-- Header -->
                                    <div class="relative flex items-center gap-4 mb-6">
                                        <div class="p-4 bg-gradient-to-br from-green-500 to-green-600 rounded-xl shadow-lg">
                                            <svg class="w-12 h-12 text-white drop-shadow-sm" fill="currentColor" viewBox="0 0 24 24">
                                                <!-- Speedometer Outer Ring -->
                                                <circle cx="12" cy="14" r="9" fill="none" stroke="currentColor" stroke-width="2"/>
                                                <circle cx="12" cy="14" r="7" fill="none" stroke="currentColor" stroke-width="1" opacity="0.5"/>
                                                
                                                <!-- Speed Marks -->
                                                <line x1="12" y1="6" x2="12" y2="8" stroke="currentColor" stroke-width="2"/>
                                                <line x1="5.5" y1="8.5" x2="6.5" y2="9.5" stroke="currentColor" stroke-width="1.5"/>
                                                <line x1="3" y1="14" x2="5" y2="14" stroke="currentColor" stroke-width="2"/>
                                                <line x1="5.5" y1="19.5" x2="6.5" y2="18.5" stroke="currentColor" stroke-width="1.5"/>
                                                <line x1="18.5" y1="8.5" x2="17.5" y2="9.5" stroke="currentColor" stroke-width="1.5"/>
                                                <line x1="21" y1="14" x2="19" y2="14" stroke="currentColor" stroke-width="2"/>
                                                <line x1="18.5" y1="19.5" x2="17.5" y2="18.5" stroke="currentColor" stroke-width="1.5"/>
                                                
                                                <!-- Speed Numbers -->
                                                <text x="12" y="9" text-anchor="middle" font-size="3" font-weight="bold">120</text>
                                                <text x="6" y="16" text-anchor="middle" font-size="2.5">0</text>
                                                <text x="18" y="16" text-anchor="middle" font-size="2.5">240</text>
                                                
                                                <!-- Needle -->
                                                <line x1="12" y1="14" x2="16" y2="10" stroke="red" stroke-width="3" stroke-linecap="round"/>
                                                
                                                <!-- Center Hub -->
                                                <circle cx="12" cy="14" r="1.5" fill="currentColor"/>
                                                
                                                <!-- KM/H Label -->
                                                <text x="12" y="20" text-anchor="middle" font-size="2" font-weight="bold">KM/H</text>
                                            </svg>
                                    </div>
                                    <div>
                                                                                <h3 class="text-xl font-bold text-gray-900 dark:text-white" data-it="Analisi Velocità" data-en="Speed Analysis">Analisi Velocità</h3>
                                    <p class="text-sm text-gray-600 dark:text-gray-300" data-it="Velocità massima giornaliera (km/h)" data-en="Daily maximum speed (km/h)">Velocità massima giornaliera (km/h)</p>
                                    </div>
                                </div>
                                    
                                    <!-- Chart area -->
                                    <div class="relative h-72 bg-gray-50 dark:bg-gray-900/80 rounded-xl p-4 border border-gray-200 dark:border-gray-700/50">
                                    <canvas id="speedChart"></canvas>
                                    </div>
                                    
                                    <!-- Top highlight -->
                                    <div class="absolute top-0 left-1/4 right-1/4 h-px bg-gradient-to-r from-transparent via-green-400/50 to-transparent"></div>
                                </div>
                            </div>
                            
                            <!-- Activity Overview Chart -->
                            <div class="relative group">
                                <!-- Modern chart container for both modes -->
                                <div class="relative bg-white dark:bg-gradient-to-br dark:from-gray-800 dark:via-gray-700 dark:to-gray-900 rounded-2xl p-8 border border-gray-200 dark:border-gray-600/40 shadow-lg hover:border-purple-400/50 hover:shadow-xl transition-all duration-300">
                                    <!-- Background glow effect -->
                                    <div class="absolute inset-0 bg-gradient-to-r from-purple-50/40 to-purple-100/30 dark:from-purple-500/10 dark:via-purple-400/5 dark:to-purple-600/10 rounded-2xl opacity-40 group-hover:opacity-60 transition-opacity duration-300"></div>
                                    
                                    <!-- Header -->
                                    <div class="relative flex items-center gap-4 mb-6">
                                        <div class="p-4 bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl shadow-lg">
                                            <svg class="w-12 h-12 text-white drop-shadow-sm" fill="currentColor" viewBox="0 0 24 24">
                                                <!-- Map Background -->
                                                <rect x="2" y="3" width="20" height="18" rx="2" fill="currentColor" opacity="0.2"/>
                                                <rect x="2" y="3" width="20" height="18" rx="2" fill="none" stroke="currentColor" stroke-width="2"/>
                                                
                                                <!-- Route Path -->
                                                <path d="M6 8 Q10 6 14 10 Q18 14 18 16" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
                                                
                                                <!-- Starting Point A -->
                                                <circle cx="6" cy="8" r="2.5" fill="green"/>
                                                <text x="6" y="9" text-anchor="middle" font-size="3" font-weight="bold" fill="white">A</text>
                                                
                                                <!-- Ending Point B -->
                                                <circle cx="18" cy="16" r="2.5" fill="red"/>
                                                <text x="18" y="17" text-anchor="middle" font-size="3" font-weight="bold" fill="white">B</text>
                                                
                                                <!-- Waypoints -->
                                                <circle cx="10" cy="7" r="1" fill="currentColor"/>
                                                <circle cx="14" cy="12" r="1" fill="currentColor"/>
                                                
                                                <!-- Distance Indicator -->
                                                <text x="12" y="19" text-anchor="middle" font-size="2" font-weight="bold">245 KM</text>
                                                
                                                <!-- Grid Lines -->
                                                <line x1="8" y1="3" x2="8" y2="21" stroke="currentColor" stroke-width="0.5" opacity="0.3"/>
                                                <line x1="12" y1="3" x2="12" y2="21" stroke="currentColor" stroke-width="0.5" opacity="0.3"/>
                                                <line x1="16" y1="3" x2="16" y2="21" stroke="currentColor" stroke-width="0.5" opacity="0.3"/>
                                                <line x1="2" y1="7" x2="22" y2="7" stroke="currentColor" stroke-width="0.5" opacity="0.3"/>
                                                <line x1="2" y1="12" x2="22" y2="12" stroke="currentColor" stroke-width="0.5" opacity="0.3"/>
                                                <line x1="2" y1="17" x2="22" y2="17" stroke="currentColor" stroke-width="0.5" opacity="0.3"/>
                                            </svg>
                                    </div>
                                    <div>
                                                                                <h3 class="text-xl font-bold text-gray-900 dark:text-white" data-it="Panoramica Attività" data-en="Activity Overview">Panoramica Attività</h3>
                                    <p class="text-sm text-gray-600 dark:text-gray-300" data-it="Viaggi ed eventi giornalieri" data-en="Daily trips and events">Viaggi ed eventi giornalieri</p>
                                    </div>
                                </div>
                                    
                                    <!-- Chart area -->
                                    <div class="relative h-72 bg-gray-50 dark:bg-gray-900/80 rounded-xl p-4 border border-gray-200 dark:border-gray-700/50">
                                    <canvas id="tripsEventsChart"></canvas>
                                    </div>
                                    
                                    <!-- Top highlight -->
                                    <div class="absolute top-0 left-1/4 right-1/4 h-px bg-gradient-to-r from-transparent via-purple-400/50 to-transparent"></div>
                                </div>
                            </div>
                            
                        </div>
                        
                        <!-- Full Width Charts -->
                        <div class="grid grid-cols-1 xl:grid-cols-2 gap-6 mt-6">
                            
                            <!-- System Health Chart -->
                            <div class="relative group">
                                <!-- Modern chart container for both modes -->
                                <div class="relative bg-white dark:bg-gradient-to-br dark:from-gray-800 dark:via-gray-700 dark:to-gray-900 rounded-2xl p-8 border border-gray-200 dark:border-gray-600/40 shadow-lg hover:border-red-400/50 hover:shadow-xl transition-all duration-300">
                                    <!-- Background glow effect -->
                                    <div class="absolute inset-0 bg-gradient-to-r from-red-50/40 to-red-100/30 dark:from-red-500/10 dark:via-red-400/5 dark:to-red-600/10 rounded-2xl opacity-40 group-hover:opacity-60 transition-opacity duration-300"></div>
                                    
                                    <!-- Header -->
                                    <div class="relative flex items-center gap-4 mb-6">
                                        <div class="p-4 bg-gradient-to-br from-red-500 to-red-600 rounded-xl shadow-lg">
                                            <svg class="w-12 h-12 text-white drop-shadow-sm" fill="currentColor" viewBox="0 0 24 24">
                                                <!-- Scanner Device Body -->
                                                <rect x="6" y="4" width="12" height="16" rx="2" fill="currentColor"/>
                                                <rect x="7" y="5" width="10" height="14" rx="1" fill="none" stroke="white" stroke-width="1"/>
                                                
                                                <!-- LCD Screen -->
                                                <rect x="8" y="7" width="8" height="5" rx="0.5" fill="black"/>
                                                <text x="12" y="10" text-anchor="middle" font-size="2" fill="lime">OBD-II</text>
                                                <text x="12" y="11.5" text-anchor="middle" font-size="1.5" fill="lime">READY</text>
                                                
                                                <!-- Control Buttons -->
                                                <circle cx="9" cy="14" r="1" fill="white"/>
                                                <circle cx="12" cy="14" r="1" fill="white"/>
                                                <circle cx="15" cy="14" r="1" fill="white"/>
                                                
                                                <!-- LED Indicators -->
                                                <circle cx="9" cy="16.5" r="0.5" fill="green"/>
                                                <circle cx="12" cy="16.5" r="0.5" fill="yellow"/>
                                                <circle cx="15" cy="16.5" r="0.5" fill="red"/>
                                                
                                                <!-- Cable -->
                                                <path d="M12 20 Q12 22 10 22 Q8 22 8 20 Q8 18 10 18" fill="none" stroke="currentColor" stroke-width="2"/>
                                                
                                                <!-- OBD Port Connector -->
                                                <rect x="9" y="18" width="2" height="1.5" rx="0.2" fill="currentColor"/>
                                                
                                                <!-- Brand/Model -->
                                                <text x="12" y="6" text-anchor="middle" font-size="1.5" font-weight="bold" fill="white">AUTO-SCAN</text>
                                                
                                                <!-- Data Lines on Screen -->
                                                <line x1="8.5" y1="8" x2="15.5" y2="8" stroke="lime" stroke-width="0.3"/>
                                                <line x1="8.5" y1="8.5" x2="13" y2="8.5" stroke="lime" stroke-width="0.3"/>
                                                <line x1="8.5" y1="9" x2="14" y2="9" stroke="lime" stroke-width="0.3"/>
                                            </svg>
                                    </div>
                                    <div>
                                                                                <h3 class="text-xl font-bold text-gray-900 dark:text-white" data-it="Stato Sistema e Diagnostica" data-en="System Health and Diagnostics">Stato Sistema e Diagnostica</h3>
                                    <p class="text-sm text-gray-600 dark:text-gray-300" data-it="Errori OBD, incidenti, violazioni e posizioni" data-en="OBD errors, incidents, violations and positions">Errori OBD, incidenti, violazioni e posizioni</p>
                                    </div>
                                </div>
                                    
                                    <!-- Chart area -->
                                    <div class="relative h-72 bg-gray-50 dark:bg-gray-900/80 rounded-xl p-4 border border-gray-200 dark:border-gray-700/50">
                                    <canvas id="systemHealthChart"></canvas>
                                    </div>
                                    
                                    <!-- Top highlight -->
                                    <div class="absolute top-0 left-1/4 right-1/4 h-px bg-gradient-to-r from-transparent via-red-400/50 to-transparent"></div>
                                </div>
                            </div>
                            
                        </div>
                    </div>

                    <!-- OBD Data Tab -->
                    <div id="content-obd-data" class="tab-panel hidden p-6">
                        <!-- Header -->
                        <div class="flex items-center justify-between mb-6">
                            <div class="flex items-center gap-4">
                                <div class="p-3 bg-orange-600/20 rounded-xl">
                                    <svg class="w-6 h-6 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                                    </svg>
                                </div>
                                <div>
                                    <h2 class="text-2xl font-bold text-gray-900 dark:text-white" data-it="Dati OBD" data-en="OBD Data">Dati OBD</h2>
                                    <p class="text-sm text-gray-600 dark:text-gray-400" data-it="Dati OBD relativi agli ultimi 7 giorni" data-en="OBD data for the last 7 days">Dati OBD relativi agli ultimi 7 giorni</p>
                                </div>
                            </div>
                        </div>

                        <!-- OBD Data Summary -->
                        <div class="mb-6 p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-200 dark:border-blue-700/50">
                            <div class="flex items-center gap-3 mb-3">
                                <svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                <span class="font-semibold text-blue-900 dark:text-blue-100" data-it="Informazioni Dati" data-en="Data Information">Informazioni Dati</span>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                                <div>
                                    <span class="font-medium text-gray-700 dark:text-gray-300" data-it="Periodo:" data-en="Period:">Periodo:</span>
                                    <span id="obdDateRange" class="text-gray-900 dark:text-gray-100 ml-2">-</span>
                                </div>
                                <div>
                                    <span class="font-medium text-gray-700 dark:text-gray-300" data-it="Posizioni Analizzate:" data-en="Positions Analyzed:">Posizioni Analizzate:</span>
                                    <span id="obdPositionsCount" class="text-gray-900 dark:text-gray-100 ml-2">-</span>
                                </div>
                                <div>
                                    <span class="font-medium text-gray-700 dark:text-gray-300" data-it="Dispositivo:" data-en="Device:">Dispositivo:</span>
                                    <span id="obdDeviceInfo" class="text-gray-900 dark:text-gray-100 ml-2">-</span>
                                </div>
                            </div>
                        </div>

                        <!-- OBD Data Loading -->
                        <div id="obdDataLoading" class="text-center py-12">
                            <div class="inline-flex items-center justify-center w-12 h-12 bg-orange-600/20 rounded-full mb-4">
                                <svg class="w-6 h-6 text-orange-400 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                                </svg>
                            </div>
                            <p class="text-gray-600 dark:text-gray-300" data-it="Caricamento dati OBD..." data-en="Loading OBD data...">Caricamento dati OBD...</p>
                        </div>

                        <!-- OBD Data Content -->
                        <div id="obdDataContent" class="space-y-8" style="display: none;">
                            <!-- Engine Performance & Load Section -->
                            <div class="obd-section">
                                <div class="flex items-center gap-3 mb-6">
                                    <div class="p-3 bg-red-600/20 rounded-xl">
                                        <svg class="w-6 h-6 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 7.172V5L8 4z"/>
                                        </svg>
                                    </div>
                                    <h3 class="text-xl font-bold text-gray-900 dark:text-white" data-it="Performance e Carico Motore" data-en="Engine Performance & Load">Performance e Carico Motore</h3>
                                </div>
                                <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6" id="enginePerformanceCharts">
                                    <!-- Charts will be populated here -->
                                </div>
                            </div>

                            <!-- Separator -->
                            <div class="border-t border-gray-200 dark:border-gray-700 my-8"></div>

                            <!-- Fuel System & Efficiency Section -->
                            <div class="obd-section">
                                <div class="flex items-center gap-3 mb-6">
                                    <div class="p-3 bg-yellow-600/20 rounded-xl">
                                        <svg class="w-6 h-6 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16v2h2v8h-2v2H4v-2H2V8h2V6zm2 2v8h12V8H6zm1 2h2v4H7v-4zm8 0h2v4h-2v-4zm-4-1h2v6h-2V9z"/>
                                        </svg>
                                    </div>
                                    <h3 class="text-xl font-bold text-gray-900 dark:text-white" data-it="Sistema Carburante ed Efficienza" data-en="Fuel System & Efficiency">Sistema Carburante ed Efficienza</h3>
                                </div>
                                <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6" id="fuelSystemCharts">
                                    <!-- Charts will be populated here -->
                                </div>
                            </div>

                            <!-- Separator -->
                            <div class="border-t border-gray-200 dark:border-gray-700 my-8"></div>

                            <!-- Air & Intake System Section -->
                            <div class="obd-section">
                                <div class="flex items-center gap-3 mb-6">
                                    <div class="p-3 bg-blue-600/20 rounded-xl">
                                        <svg class="w-6 h-6 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z"/>
                                        </svg>
                                    </div>
                                    <h3 class="text-xl font-bold text-gray-900 dark:text-white" data-it="Sistema Aria e Aspirazione" data-en="Air & Intake System">Sistema Aria e Aspirazione</h3>
                                </div>
                                <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6" id="airIntakeCharts">
                                    <!-- Charts will be populated here -->
                                </div>
                            </div>

                            <!-- Separator -->
                            <div class="border-t border-gray-200 dark:border-gray-700 my-8"></div>

                            <!-- Operational Metrics & Diagnostics Section -->
                            <div class="obd-section">
                                <div class="flex items-center gap-3 mb-6">
                                    <div class="p-3 bg-green-600/20 rounded-xl">
                                        <svg class="w-6 h-6 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                        </svg>
                                    </div>
                                    <h3 class="text-xl font-bold text-gray-900 dark:text-white" data-it="Metriche Operative e Diagnostica" data-en="Operational Metrics & Diagnostics">Metriche Operative e Diagnostica</h3>
                                </div>
                                <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6" id="operationalMetricsCharts">
                                    <!-- Charts will be populated here -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- OBD Errors Tab -->
                    <div id="content-obd-errors" class="tab-panel hidden p-6">
                        <div class="max-w-4xl mx-auto">
                            <div class="text-center py-16">
                                <div class="mb-8">
                                    <svg class="w-24 h-24 mx-auto text-orange-500 mb-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.78 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"/>
                                    </svg>
                                    <h2 class="text-3xl font-bold text-gray-900 dark:text-white mb-4" data-it="Errori OBD" data-en="OBD Errors">Errori OBD</h2>
                                    <p class="text-lg text-gray-600 dark:text-gray-300 mb-6" data-it="Analisi degli errori e dei codici di guasto OBD-II" data-en="Analysis of OBD-II error codes and fault diagnostics">Analisi degli errori e dei codici di guasto OBD-II</p>
                                </div>
                                
                                <!-- Under Construction Message -->
                                <div class="bg-gradient-to-r from-yellow-50 to-orange-50 dark:from-yellow-900/20 dark:to-orange-900/20 border border-yellow-200 dark:border-yellow-700 rounded-2xl p-8 mb-8">
                                    <div class="flex items-center justify-center mb-6">
                                        <svg class="w-16 h-16 text-yellow-600 dark:text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C20.168 18.477 18.582 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
                                        </svg>
                                    </div>
                                    <h3 class="text-2xl font-semibold text-yellow-800 dark:text-yellow-300 mb-4" data-it="🚧 Sezione in Costruzione 🚧" data-en="🚧 Under Construction 🚧">🚧 Sezione in Costruzione 🚧</h3>
                                    <p class="text-yellow-700 dark:text-yellow-200 text-lg leading-relaxed" data-it="Questa funzionalità è attualmente in fase di sviluppo. Presto potrai visualizzare e analizzare i codici di errore OBD-II del tuo veicolo, inclusi DTCs (Diagnostic Trouble Codes), stati dei sensori e raccomandazioni per la risoluzione dei problemi." data-en="This feature is currently under development. Soon you'll be able to view and analyze your vehicle's OBD-II error codes, including DTCs (Diagnostic Trouble Codes), sensor statuses, and troubleshooting recommendations.">
                                        Questa funzionalità è attualmente in fase di sviluppo. Presto potrai visualizzare e analizzare i codici di errore OBD-II del tuo veicolo, inclusi DTCs (Diagnostic Trouble Codes), stati dei sensori e raccomandazioni per la risoluzione dei problemi.
                                    </p>
                                </div>
                                
                                <!-- Features Coming Soon -->
                                <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6 text-left">
                                    <div class="bg-white dark:bg-gray-800 rounded-xl p-6 border border-gray-200 dark:border-gray-700 shadow-sm">
                                        <div class="w-12 h-12 bg-red-100 dark:bg-red-900/20 rounded-lg flex items-center justify-center mb-4">
                                            <svg class="w-6 h-6 text-red-600 dark:text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.464 0L4.36 16.5c-.77.833.192 2.5 1.732 2.5z"/>
                                            </svg>
                                        </div>
                                        <h4 class="font-semibold text-gray-900 dark:text-white mb-2" data-it="Codici DTC" data-en="DTC Codes">Codici DTC</h4>
                                        <p class="text-sm text-gray-600 dark:text-gray-300" data-it="Visualizzazione e decodifica dei Diagnostic Trouble Codes" data-en="Display and decode Diagnostic Trouble Codes">Visualizzazione e decodifica dei Diagnostic Trouble Codes</p>
                                    </div>
                                    
                                    <div class="bg-white dark:bg-gray-800 rounded-xl p-6 border border-gray-200 dark:border-gray-700 shadow-sm">
                                        <div class="w-12 h-12 bg-blue-100 dark:bg-blue-900/20 rounded-lg flex items-center justify-center mb-4">
                                            <svg class="w-6 h-6 text-blue-600 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                                            </svg>
                                        </div>
                                        <h4 class="font-semibold text-gray-900 dark:text-white mb-2" data-it="Stati Sensori" data-en="Sensor Status">Stati Sensori</h4>
                                        <p class="text-sm text-gray-600 dark:text-gray-300" data-it="Monitoraggio dello stato di tutti i sensori OBD-II" data-en="Monitor the status of all OBD-II sensors">Monitoraggio dello stato di tutti i sensori OBD-II</p>
                                    </div>
                                    
                                    <div class="bg-white dark:bg-gray-800 rounded-xl p-6 border border-gray-200 dark:border-gray-700 shadow-sm">
                                        <div class="w-12 h-12 bg-green-100 dark:bg-green-900/20 rounded-lg flex items-center justify-center mb-4">
                                            <svg class="w-6 h-6 text-green-600 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                                            </svg>
                                        </div>
                                        <h4 class="font-semibold text-gray-900 dark:text-white mb-2" data-it="Raccomandazioni" data-en="Recommendations">Raccomandazioni</h4>
                                        <p class="text-sm text-gray-600 dark:text-gray-300" data-it="Suggerimenti per la risoluzione dei problemi" data-en="Troubleshooting suggestions and recommendations">Suggerimenti per la risoluzione dei problemi</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- AI Report Tab -->
                    <div id="content-ai-report" class="tab-panel hidden p-6">
                        <div id="aiReportContent">
                            <div class="text-center py-16">
                                <!-- AI Brain Icon -->
                                <div class="flex justify-center mb-8">
                                    <div class="relative">
                                        <div class="w-24 h-24 bg-gradient-to-br from-purple-600 via-blue-600 to-indigo-600 rounded-full flex items-center justify-center shadow-2xl">
                                            <svg class="w-12 h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                                            </svg>
                                        </div>
                                        <!-- Animated pulse effect -->
                                        <div class="absolute inset-0 w-24 h-24 bg-gradient-to-br from-purple-400 via-blue-400 to-indigo-400 rounded-full opacity-20 animate-ping"></div>
                                    </div>
                                </div>
                                
                                <!-- Title with Brain Icon -->
                                <div class="flex items-center justify-center gap-3 mb-4">
                                    <svg class="w-8 h-8 text-purple-600 dark:text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                                    </svg>
                                    <h2 class="text-4xl font-bold bg-gradient-to-r from-purple-600 via-blue-600 to-indigo-600 bg-clip-text text-transparent" data-it="Advanced Automotive AI Report" data-en="Advanced Automotive AI Report">Advanced Automotive AI Report</h2>
                                </div>
                                
                                <!-- Subtitle -->
                                <p class="text-xl text-gray-600 dark:text-gray-300 mb-12 max-w-3xl mx-auto leading-relaxed" data-it="Key Metrics and AI-Driven Insights for Automotive Innovation" data-en="Key Metrics and AI-Driven Insights for Automotive Innovation">
                                    Key Metrics and AI-Driven Insights for Automotive Innovation
                                </p>
                                
                                <!-- Action Button -->
                                <div class="flex justify-center">
                                    <button id="generateAIReportTab" class="group relative px-8 py-4 bg-gradient-to-r from-purple-600 via-blue-600 to-indigo-600 text-white rounded-xl font-semibold text-lg hover:from-purple-700 hover:via-blue-700 hover:to-indigo-700 transition-all duration-300 transform hover:scale-105 shadow-lg hover:shadow-xl" data-it="Create AI Report" data-en="Create AI Report">
                                        <span class="flex items-center gap-3">
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                                            </svg>
                                            <span data-it="Create AI Report" data-en="Create AI Report">Create AI Report</span>
                                        </span>
                                        <!-- Loading state (hidden by default) -->
                                        <span id="aiReportLoading" class="hidden flex items-center gap-3">
                                            <svg class="w-5 h-5 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                                            </svg>
                                            <span data-it="AI Report Generation in Progress" data-en="AI Report Generation in Progress">AI Report Generation in Progress</span>
                                        </span>
                                    </button>
                                </div>
                                
                                <!-- Description -->
                                <p class="text-gray-500 dark:text-gray-400 mt-8 max-w-2xl mx-auto mb-12" data-it="L'AI analizzerà i dati del veicolo per fornire insights avanzati su performance, efficienza e raccomandazioni di manutenzione." data-en="AI will analyze vehicle data to provide advanced insights on performance, efficiency, and maintenance recommendations.">
                                    AI will analyze vehicle data to provide advanced insights on performance, efficiency, and maintenance recommendations.
                                </p>
                                
                                <!-- Vehicle Metrics Cards -->
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 mb-12">
                                    <!-- Total Odometer -->
                                    <div class="bg-white dark:bg-gray-800 rounded-xl p-6 border border-gray-200 dark:border-gray-700 shadow-lg hover:shadow-xl transition-all duration-300">
                                        <div class="flex items-center justify-between mb-4">
                                            <div class="w-12 h-12 bg-blue-100 dark:bg-blue-900/20 rounded-lg flex items-center justify-center">
                                                <svg class="w-6 h-6 text-blue-600 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
                                                </svg>
                                            </div>
                                            <span class="text-xs text-gray-500 dark:text-gray-400" data-it="Totale" data-en="Total">Total</span>
                                        </div>
                                        <h3 class="text-2xl font-bold text-gray-900 dark:text-white mb-1" id="aiTotalOdometer">-</h3>
                                        <p class="text-sm text-gray-600 dark:text-gray-300" data-it="Odometro Totale" data-en="Total Odometer">Total Odometer</p>
                                    </div>
                                    
                                    <!-- Distance Last 90 Days -->
                                    <div class="bg-white dark:bg-gray-800 rounded-xl p-6 border border-gray-200 dark:border-gray-700 shadow-lg hover:shadow-xl transition-all duration-300">
                                        <div class="flex items-center justify-between mb-4">
                                            <div class="w-12 h-12 bg-green-100 dark:bg-green-900/20 rounded-lg flex items-center justify-center">
                                                <svg class="w-6 h-6 text-green-600 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-1.447-.894L15 4m0 13V4m-6 3l6-3"/>
                                                </svg>
                                            </div>
                                            <span class="text-xs text-gray-500 dark:text-gray-400" data-it="90 giorni" data-en="90 days">90 days</span>
                                        </div>
                                        <h3 class="text-2xl font-bold text-gray-900 dark:text-white mb-1" id="aiDistance90Days">-</h3>
                                        <p class="text-sm text-gray-600 dark:text-gray-300" data-it="Distanza Percorsa" data-en="Distance Traveled">Distance Traveled</p>
                                    </div>
                                    
                                    <!-- Number of Trips -->
                                    <div class="bg-white dark:bg-gray-800 rounded-xl p-6 border border-gray-200 dark:border-gray-700 shadow-lg hover:shadow-xl transition-all duration-300">
                                        <div class="flex items-center justify-between mb-4">
                                            <div class="w-12 h-12 bg-purple-100 dark:bg-purple-900/20 rounded-lg flex items-center justify-center">
                                                <svg class="w-6 h-6 text-purple-600 dark:text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                                </svg>
                                            </div>
                                            <span class="text-xs text-gray-500 dark:text-gray-400" data-it="90 giorni" data-en="90 days">90 days</span>
                                        </div>
                                        <h3 class="text-2xl font-bold text-gray-900 dark:text-white mb-1" id="aiTrips90Days">-</h3>
                                        <p class="text-sm text-gray-600 dark:text-gray-300" data-it="Numero Viaggi" data-en="Number of Trips">Number of Trips</p>
                                    </div>
                                    
                                    <!-- Driving Time -->
                                    <div class="bg-white dark:bg-gray-800 rounded-xl p-6 border border-gray-200 dark:border-gray-700 shadow-lg hover:shadow-xl transition-all duration-300">
                                        <div class="flex items-center justify-between mb-4">
                                            <div class="w-12 h-12 bg-orange-100 dark:bg-orange-900/20 rounded-lg flex items-center justify-center">
                                                <svg class="w-6 h-6 text-orange-600 dark:text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                                </svg>
                                            </div>
                                            <span class="text-xs text-gray-500 dark:text-gray-400" data-it="90 giorni" data-en="90 days">90 days</span>
                                        </div>
                                        <h3 class="text-2xl font-bold text-gray-900 dark:text-white mb-1" id="aiDrivingTime90Days">-</h3>
                                        <p class="text-sm text-gray-600 dark:text-gray-300" data-it="Tempo di Guida" data-en="Driving Time">Driving Time</p>
                                    </div>
                                    
                                    <!-- Average Battery -->
                                    <div class="bg-white dark:bg-gray-800 rounded-xl p-6 border border-gray-200 dark:border-gray-700 shadow-lg hover:shadow-xl transition-all duration-300">
                                        <div class="flex items-center justify-between mb-4">
                                            <div class="w-12 h-12 bg-yellow-100 dark:bg-yellow-900/20 rounded-lg flex items-center justify-center">
                                                <svg class="w-6 h-6 text-yellow-600 dark:text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                                </svg>
                                            </div>
                                            <span class="text-xs text-gray-500 dark:text-gray-400" data-it="90 giorni" data-en="90 days">90 days</span>
                                        </div>
                                        <h3 class="text-2xl font-bold text-gray-900 dark:text-white mb-1" id="aiAvgBattery90Days">-</h3>
                                        <p class="text-sm text-gray-600 dark:text-gray-300" data-it="Batteria Media" data-en="Average Battery">Average Battery</p>
                                    </div>
                                    
                                    <!-- Average Speed -->
                                    <div class="bg-white dark:bg-gray-800 rounded-xl p-6 border border-gray-200 dark:border-gray-700 shadow-lg hover:shadow-xl transition-all duration-300">
                                        <div class="flex items-center justify-between mb-4">
                                            <div class="w-12 h-12 bg-red-100 dark:bg-red-900/20 rounded-lg flex items-center justify-center">
                                                <svg class="w-6 h-6 text-red-600 dark:text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                                                </svg>
                                            </div>
                                            <span class="text-xs text-gray-500 dark:text-gray-400" data-it="90 giorni" data-en="90 days">90 days</span>
                                        </div>
                                        <h3 class="text-2xl font-bold text-gray-900 dark:text-white mb-1" id="aiAvgSpeed90Days">-</h3>
                                        <p class="text-sm text-gray-600 dark:text-gray-300" data-it="Velocità Media" data-en="Average Speed">Average Speed</p>
                                    </div>
                                    
                                    <!-- OBD Errors -->
                                    <div class="bg-white dark:bg-gray-800 rounded-xl p-6 border border-gray-200 dark:border-gray-700 shadow-lg hover:shadow-xl transition-all duration-300">
                                        <div class="flex items-center justify-between mb-4">
                                            <div class="w-12 h-12 bg-red-100 dark:bg-red-900/20 rounded-lg flex items-center justify-center">
                                                <svg class="w-6 h-6 text-red-600 dark:text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.464 0L4.36 16.5c-.77.833.192 2.5 1.732 2.5z"/>
                                                </svg>
                                            </div>
                                            <span class="text-xs text-gray-500 dark:text-gray-400" data-it="90 giorni" data-en="90 days">90 days</span>
                                        </div>
                                        <h3 class="text-2xl font-bold text-gray-900 dark:text-white mb-1" id="aiOBDErrors90Days">-</h3>
                                        <p class="text-sm text-gray-600 dark:text-gray-300" data-it="Errori OBD" data-en="OBD Errors">OBD Errors</p>
                                    </div>
                                </div>
                                
                                <!-- AI Report Results Section (Hidden by default) -->
                                <div id="aiReportResults" class="hidden">
                                    <div class="bg-gradient-to-r from-purple-50 to-blue-50 dark:from-purple-900/20 dark:to-blue-900/20 border border-purple-200 dark:border-purple-700 rounded-2xl p-8 mb-8">
                                        <div class="flex items-center gap-3 mb-6">
                                            <svg class="w-8 h-8 text-purple-600 dark:text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                                            </svg>
                                            <h3 class="text-2xl font-bold text-gray-900 dark:text-white" data-it="Analisi AI Completata" data-en="AI Analysis Complete">AI Analysis Complete</h3>
                                        </div>
                                        <div id="aiReportContent" class="prose prose-gray dark:prose-invert max-w-none">
                                            <!-- AI Report content will be inserted here -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Client Tab -->
                    <div id="content-client" class="tab-panel hidden p-6">
                        
                        <div id="clientInfoSection">
                            <div class="text-center py-8">
                                <div class="inline-flex items-center justify-center w-12 h-12 bg-indigo-600/20 rounded-full mb-4">
                                    <svg class="w-6 h-6 text-indigo-400 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                                    </svg>
                                </div>
                                <p class="text-gray-600 dark:text-gray-300" data-it="Caricamento informazioni cliente..." data-en="Loading client information...">Caricamento informazioni cliente...</p>
                            </div>
                </div>
            </div>
                </div>
            </div>


        </div>
    </div>

    <!-- Chart.js Library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js" onerror="console.warn('⚠️ Chart.js failed to load')"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/index.min.js" onerror="console.warn('⚠️ date-fns failed to load')"></script>
    
    <!-- Clean AI Report - No Wrappers, No Icons -->
    <style>
        #aiReportText {
            font-family: Arial, sans-serif;
            font-size: 14px;
            line-height: 1.2;
            color: #e5e7eb;
            background: transparent;
            padding: 0;
            border: none;
            margin: 0;
            white-space: pre-line;
        }
    </style>
    
    <style>
        /* Modern 3D Cards and Charts Styling */
        .shadow-3xl {
            box-shadow: 0 35px 60px -12px rgba(0, 0, 0, 0.25), 
                        0 0 0 1px rgba(255, 255, 255, 0.02);
        }
        
        .hover\\:shadow-3xl:hover {
            box-shadow: 0 45px 80px -12px rgba(0, 0, 0, 0.35), 
                        0 0 0 1px rgba(255, 255, 255, 0.05);
        }
        
        /* Glass morphism effect for chart areas */
        .chart-glass {
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        
        /* Subtle hover effects similar to certificates page */
        .stats-card:hover {
            transform: translateY(-2px);
        }
        
        /* Improved gradients for modern look */
        .modern-gradient {
            background: linear-gradient(135deg, #1f2937 0%, #111827 50%, #0f172a 100%);
        }

        /* Tab System Styles - REMOVE BLUE BORDER */
        .tab-button {
            outline: none !important;
            box-shadow: none !important;
        }
        
        .tab-button:focus,
        .tab-button:active,
        .tab-button:focus-visible {
            outline: none !important;
            box-shadow: none !important;
        }
        
        /* Ensure selected tabs have gray-dark styling */
        .tab-button.bg-gray-800 {
            background-color: #1f2937 !important;
            color: white !important;
            border-bottom: 4px solid #111827 !important;
        }
        
        /* NUCLEAR OPTION - Remove ALL blue borders forever */
        .tab-button,
        .tab-button *,
        button.tab-button,
        .tab-button:hover,
        .tab-button:focus,
        .tab-button:active,
        .tab-button:focus-visible,
        .tab-button:focus-within {
            outline: none !important;
            box-shadow: none !important;
        }
        
        /* Remove blue border but keep other borders */
        .tab-button:focus,
        .tab-button:active {
            border-color: transparent !important;
        }
        
        /* Force gray-dark styling on selected tabs - HIGHEST PRIORITY */
        .tab-button.bg-gray-800,
        .tab-button[class*="bg-gray-800"] {
            background-color: #1f2937 !important;
            color: white !important;
            border-bottom: 4px solid #111827 !important;
            border-top: none !important;
            border-left: none !important;
            border-right: none !important;
        }
        
        .tab-panel {
            min-height: 500px;
        }
        
        .tab-panel.hidden {
            display: none;
        }
        
        .tab-content {
            background: inherit;
        }
    </style>
    </style>
    
    <!-- Authentication Guard -->
    <script src="/js/auth-guard.js" onerror="console.warn('⚠️ auth-guard.js failed to load')"></script>
    
    <!-- Theme System -->
    <script src="/js/theme.js" onerror="console.warn('⚠️ theme.js failed to load')"></script>
    <script src="/js/i18n.js" onerror="console.warn('⚠️ i18n.js failed to load')"></script>
    <script src="/js/vehicleImageService.js" onerror="console.warn('⚠️ vehicleImageService.js failed to load')"></script>
    
    <script>
        // Global protection against Node.js exports errors
        if (typeof module === 'undefined') {
            var module = {};
        }
        if (typeof exports === 'undefined') {
            var exports = {};
        }
        
        let vehicleData = null;
        let certificateData = null;

        // FIRST TAB SYSTEM REMOVED - USING COMPLETE IMPLEMENTATION BELOW

        // Logo switcher function
        function updateHeaderLogo() {
            const logo = document.getElementById('headerLogo');
            if (!logo) return;
            
            const isDark = document.documentElement.classList.contains('dark');
            
            if (isDark) {
                // Dark mode -> use header_logo_dark_theme.png
                logo.src = '/images/header_logo_dark_theme.png?v10';
            } else {
                // Light mode -> use header_logo_light_theme.png
                logo.src = '/images/header_logo_light_theme.png?v10';
            }
        }
        
        // Logo will be updated in main DOMContentLoaded
        
        // Watch for theme changes
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                    updateHeaderLogo();
                }
            });
        });
        
        // Start observing
        observer.observe(document.documentElement, {
            attributes: true,
            attributeFilter: ['class']
        });

        // Handle logo error
        function handleLogoError() {
            const sidebarLogo = document.getElementById('sidebarLogo');
            if (sidebarLogo) {
                sidebarLogo.style.display = 'none';
            }
        }

        // 🛡️ SECURITY FUNCTIONS - Added for authentication
        function checkAuthenticationStatus() {
            if (window.authManager) {
                return window.authManager.requireAuth();
            }
            
            // Fallback for older browsers
            const token = localStorage.getItem('servicehub-auth-token') || sessionStorage.getItem('servicehub-auth-token');
            const user = localStorage.getItem('servicehub-user') || sessionStorage.getItem('servicehub-user');
            
            if (!token || !user) {
                // Redirect to login immediately if not authenticated
                console.warn('🚫 Access denied: User not authenticated');
                window.location.href = '/pages/login.html';
                return false;
            }
            
            return true;
        }
        
        // 🔐 Secure API call with fallback for backward compatibility
        async function secureApiCall(url, options = {}) {
            if (window.authManager) {
                return window.authManager.secureApiCall(url, options);
            }
            
            // Fallback for older browsers
            const token = localStorage.getItem('servicehub-auth-token') || sessionStorage.getItem('servicehub-auth-token');
            
            // Default headers
            const defaultHeaders = {
                'Content-Type': 'application/json'
            };
            
            // Add Authorization header if token is available
            if (token) {
                defaultHeaders['Authorization'] = `Bearer ${token}`;
            } else {
                // Only show security warnings in production
                if (window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1') {
                    console.warn('⚠️ SECURITY: API call without auth token:', url);
                }
            }
            
            const config = {
                method: 'GET',
                headers: defaultHeaders,
                ...options
            };
            
            try {
                const response = await fetch(url, config);
                
                if (response.status === 401) {
                    console.error('🚫 Authentication failed - token expired or invalid');
                    // Don't redirect yet - just log the error for now
                    return null;
                }
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                return response;
            } catch (error) {
                console.error('❌ Secure API call failed:', error);
                throw error;
            }
        }

        // Get URL parameters and auto-clean URL
        function getUrlParams() {
            const params = new URLSearchParams(window.location.search);
            
            // Check if we have complex URL with vehicleData
            const vehicleDataParam = params.get('vehicleData');
            const certificateIdParam = params.get('certificateId');
            
            if (vehicleDataParam) {
                try {
                    // Parse the complex data
                    const vehicleData = JSON.parse(decodeURIComponent(vehicleDataParam));
                    const certificateId = vehicleData.id;
                    
                    if (certificateId) {
                        // 🧹 AUTO-CLEAN URL: Replace complex URL with simple one
                        // Store vehicleData in sessionStorage before cleaning URL
                        sessionStorage.setItem('vehiclePageData', JSON.stringify(vehicleData));
                        const cleanUrl = `${window.location.pathname}?certificateId=${certificateId}`;
                        window.history.replaceState({}, document.title, cleanUrl);
                        
                        return {
                            certificateId: certificateId.toString(),
                            vehicleData: vehicleData
                        };
                    }
                } catch (error) {
                    console.error('Error parsing vehicleData parameter:', error);
                }
            }
            
            // Check if we have vehicleData in sessionStorage (from previous URL cleaning)
            const storedVehicleData = sessionStorage.getItem('vehiclePageData');
            if (storedVehicleData && certificateIdParam) {
                try {
                    const vehicleData = JSON.parse(storedVehicleData);
                    console.log('📦 Found stored vehicle data in sessionStorage');
    
                    return {
                        certificateId: certificateIdParam,
                        vehicleData: vehicleData
                    };
                } catch (error) {
                    console.error('❌ Error parsing stored vehicleData:', error);
                    sessionStorage.removeItem('vehiclePageData');
                }
            }
            
            // Standard case: simple URL with certificateId only
            return {
                certificateId: certificateIdParam,
                vehicleData: null
            };
        }



        // Load vehicle data
        async function loadVehicleData() {
            try {
                const params = getUrlParams();
                console.log('🔍 Loading vehicle data with params:', params);
                
                if (params.vehicleData) {
                    // Case 1: We have vehicle data from URL or sessionStorage
                    vehicleData = params.vehicleData.vehicle;
                    certificateData = params.vehicleData;
                    // Make certificateData globally accessible for tabs
                    window.certificateData = certificateData;
                    displayVehicleData();
                    console.log('✅ Vehicle data loaded from stored data');
                } else if (params.certificateId) {
                    // Case 2: We have certificateId, load from API
                    console.log('🔄 Loading certificate data from API for ID:', params.certificateId);
                    await loadCertificateData(params.certificateId);
                } else {
                    // Case 3: No data available
                    console.error('❌ No vehicle data or certificate ID provided');
                    showError('Nessun dato veicolo disponibile. Torna alla pagina dei certificati.');
                }
            } catch (error) {
                console.error('❌ Error loading vehicle data:', error);
                showError('Errore nel caricamento dei dati. Riprova più tardi.');
            }
        }

        // Display vehicle data
        function displayVehicleData() {
            if (!vehicleData || !certificateData) return;

            // Update page title
            document.getElementById('vehicleTitle').textContent = 
                `${vehicleData.brand || 'Unknown'} ${vehicleData.model || 'Vehicle'}`;
            
            document.getElementById('vehicleSubtitle').textContent = 
                `${vehicleData.year || 'Unknown Year'} • ${vehicleData.plate || 'No Plate'}`;

            // Certificate information
            document.getElementById('certificateNumber').textContent = certificateData.id || '-';

            // Basic information
            document.getElementById('vehicleBrand').textContent = vehicleData.brand || '-';
            document.getElementById('vehicleModel').textContent = vehicleData.model || '-';
            document.getElementById('vehicleYear').textContent = vehicleData.year || '-';
            document.getElementById('vehiclePlate').textContent = vehicleData.plate || '-';
            document.getElementById('vehicleVin').textContent = vehicleData.vin || '-';

            // Technical details
            document.getElementById('vehicleFuelType').textContent = vehicleData.fuelType || '-';
            document.getElementById('vehicleOdometer').textContent = 
                certificateData.odometer ? `${certificateData.odometer} km` : '- km';
            document.getElementById('vehicleColor').textContent = vehicleData.color || '-';

            // Device information
            document.getElementById('deviceId').textContent = certificateData.deviceId || '-';
            document.getElementById('deviceImei').textContent = certificateData.imei || '-';
            document.getElementById('deviceSerial').textContent = certificateData.serial || '-';
            
            // Format installation date
            if (certificateData.createdAt) {
                const date = new Date(certificateData.createdAt);
                document.getElementById('installationDate').textContent = date.toLocaleDateString();
            }

            // Load vehicle image if available
            loadVehicleImage();
            
            // Note: Analytics, Client and Throttle data will be loaded when user clicks on their respective tabs
        }

        // Load certificate data from API
        async function loadCertificateData(certificateId) {
            try {
                console.log('🔄 Making API call to load certificate:', certificateId);
                const response = await secureApiCall(`/api/certificates/${certificateId}`);
                
                if (response && response.ok) {
                    const data = await response.json();
                    console.log('📊 API response received:', data);
                    
                    if (data.success && data.certificate) {
                        certificateData = data.certificate;
                        vehicleData = data.certificate.vehicle;
                        // Make certificateData globally accessible for tabs
                        window.certificateData = certificateData;
                        displayVehicleData();
                        console.log('✅ Certificate data loaded successfully');
                    } else {
                        console.error('❌ Certificate not found in API response');
                        showError('Certificato non trovato. Verifica che l\'ID sia corretto.');
                    }
                } else {
                    console.error('❌ API call failed with status:', response?.status);
                    if (response?.status === 401) {
                        showError('Sessione scaduta. Effettua nuovamente il login.');
                    } else if (response?.status === 404) {
                        showError('Certificato non trovato. Verifica che l\'ID sia corretto.');
                    } else {
                        showError('Errore nel caricamento del certificato. Riprova più tardi.');
                    }
                }
            } catch (error) {
                console.error('❌ Error loading certificate data:', error);
                if (error.message.includes('authentication')) {
                    showError('Sessione scaduta. Effettua nuovamente il login.');
                } else {
                    showError('Errore di connessione. Verifica la tua connessione internet.');
                }
            }
        }

        // Load vehicle image
        async function loadVehicleImage() {
            if (!vehicleData || typeof window.vehicleImageService === 'undefined') return;

            try {
                const imageUrl = await window.vehicleImageService.getVehicleImage(vehicleData);
                if (imageUrl) {
                    const container = document.getElementById('vehicleImageContainer');
                    container.innerHTML = `<img src="${imageUrl}" alt="${vehicleData.brand} ${vehicleData.model}" class="w-full h-full object-cover rounded-lg">`;
                }
            } catch (error) {
                console.warn('Failed to load vehicle image:', error);
            }
        }

        // Show error message
        function showError(message) {
            console.error('Error:', message);
            
            // Create error display
            const errorDiv = document.createElement('div');
            errorDiv.className = 'bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4';
            errorDiv.innerHTML = `
                <div class="flex items-center">
                    <i class="fas fa-exclamation-triangle mr-2"></i>
                    <strong>Errore:</strong> ${message}
                </div>
            `;
            
            // Insert at the top of the container
            const container = document.querySelector('.container');
            if (container) {
                container.insertBefore(errorDiv, container.firstChild);
            }
            
            // Also update title and subtitle
            const titleElement = document.getElementById('vehicleTitle');
            const subtitleElement = document.getElementById('vehicleSubtitle');
            if (titleElement) titleElement.textContent = 'Errore';
            if (subtitleElement) subtitleElement.textContent = message;
        }

        // Logout function
        async function logout() {
            const confirmed = await window.customDialog.confirm(
                'Conferma Logout',
                window.i18n.t('message.logout_confirm'),
                'Esci',
                'Annulla'
            );
            
            if (confirmed) {
                localStorage.removeItem('authData');
                window.location.href = '/login.html';
            }
        }

        // Analytics Dashboard Variables
        let analyticsCharts = {};
        let analyticsData = [];
        let summaryData = {};
        let aiReportData = null;

        // Generate AI Report
        async function generateAIReport() {
            
            if (!certificateData || !certificateData.deviceId) {
                console.error('❌ No certificateData or deviceId available for AI report');
                return;
            }

            const generateBtn = document.getElementById('generateAIReportTab');
            const contentDiv = document.getElementById('aiReportContent');
            
            // Check if elements exist before proceeding
            if (!generateBtn) {
                console.error('❌ generateAIReportTab button not found in DOM');
                return;
            }
            
            if (!contentDiv) {
                console.error('❌ aiReportContent div not found in DOM');
                return;
            }
            
            try {
                // Show loading state
                generateBtn.disabled = true;
                generateBtn.innerHTML = `
                    <svg class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Generating...
                `;
                
                contentDiv.innerHTML = `
                    <div class="text-center py-12">
                        <div class="inline-flex items-center justify-center w-16 h-16 bg-purple-600/20 rounded-full mb-4">
                            <svg class="w-8 h-8 text-purple-400 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                            </svg>
                        </div>
                                                        <h3 class="text-xl font-semibold text-white mb-2" data-it="Analizzando i Dati del Veicolo..." data-en="Analyzing Vehicle Data...">Analyzing Vehicle Data...</h3>
                                <p class="text-purple-200" data-it="La nostra AI sta elaborando i dati di performance del veicolo e la diagnostica OBD per generare insights personalizzati." data-en="Our AI is processing your vehicle's performance data and OBD diagnostics to generate personalized insights.">Our AI is processing your vehicle's performance data and OBD diagnostics to generate personalized insights.</p>
                        <div class="mt-4">
                            <div class="w-64 bg-purple-800/30 rounded-full h-2 mx-auto">
                                <div class="bg-gradient-to-r from-purple-500 to-indigo-500 h-2 rounded-full animate-pulse" style="width: 60%"></div>
                            </div>
                        </div>
                    </div>
                `;
                
    
                
                // Get current date range (same as analytics)
                const rangeType = document.getElementById('dateRangeSelector')?.value || 'last7days';
                const dateRange = getDateRange(rangeType);
                
                // Get current language for AI report
                const currentLang = window.i18n ? window.i18n.getCurrentLanguage() : 'en';

                
                let reportUrl = `/api/vehicle/${certificateData.deviceId}/ai-report?lang=${currentLang}`;
                if (dateRange && dateRange.start && dateRange.end) {
                    reportUrl += `&startDate=${dateRange.start}&endDate=${dateRange.end}`;
                }

                
                // Create abort controller for timeout
                const controller = new AbortController();
                const timeoutId = setTimeout(() => {
                    controller.abort();
                    console.error('🕐 Request timeout after 60 seconds');
                }, 60000);
                
                const response = await fetch(reportUrl, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);

                
                if (!response.ok) {
                    console.error('❌ HTTP Error:', response.status, response.statusText);
                    const errorText = await response.text();
                    console.error('❌ Error body:', errorText);
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    aiReportData = result;
                    displayAIReport(result);
                } else {
                    throw new Error(result.error || 'Failed to generate AI report');
                }
                
            } catch (error) {
                console.error('❌ Error generating AI report:', error);
                displayAIReportError(error.message);
            } finally {
                // Reset button
                generateBtn.disabled = false;
                generateBtn.innerHTML = `
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                    </svg>
                    Generate Report
                `;
            }
        }

        // Display AI Report
        function displayAIReport(reportData) {
            const contentDiv = document.getElementById('aiReportContent');
            
            if (!contentDiv) {
                console.error('❌ aiReportContent element not found');
                return;
            }
            
            if (!reportData) {
                console.error('❌ No AI report data provided');
                contentDiv.innerHTML = '<div class="text-red-500 p-4" data-it="Errore: Nessun dato del report AI fornito" data-en="Error: No AI report data provided">Error: No AI report data provided</div>';
                return;
            }
            
            if (!reportData.success) {
                console.error('❌ AI report generation failed:', reportData);
                contentDiv.innerHTML = `
                    <div class="text-yellow-500 p-4">
                        <h3 class="font-bold mb-2">DEBUG: AI Report Data Structure Issue</h3>
                        <pre class="text-xs bg-gray-800 p-2 rounded overflow-auto">${JSON.stringify(reportData, null, 2)}</pre>
                    </div>
                `;
                return;
            }
            
            const reportHtml = `
                <!-- Performance Analysis Cards (matching Analytics tab style) -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div class="relative group">
                        <div class="relative bg-white dark:bg-gradient-to-br dark:from-gray-800 dark:via-gray-700 dark:to-gray-900 rounded-2xl p-6 border border-gray-200 dark:border-gray-600/40 shadow-lg hover:border-blue-400/50 transition-all duration-300 hover:shadow-xl">
                            <div class="absolute inset-0 bg-gradient-to-br from-blue-50/30 to-blue-100/20 dark:from-blue-500/10 dark:via-blue-400/5 dark:to-blue-600/10 rounded-2xl opacity-40 group-hover:opacity-60 transition-opacity duration-300"></div>
                            <div class="relative flex flex-col items-center text-center space-y-4">
                                <div class="relative p-4 bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl shadow-lg transition-all duration-300">
                                    <svg class="w-8 h-8 text-white drop-shadow-sm" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-1.447-.894L15 4m0 13V4m-6 3l6-3"/>
                                    </svg>
                                </div>
                                <div class="space-y-2">
                                    <p class="text-xs font-medium text-gray-600 dark:text-gray-300 uppercase tracking-wide" data-it="DISTANZA" data-en="DISTANCE">DISTANCE</p>
                                    <p class="text-2xl font-bold text-gray-900 dark:text-white">${reportData.summary.totalDistance} km</p>
                                </div>
                            </div>
                            <div class="absolute top-0 left-1/4 right-1/4 h-px bg-gradient-to-r from-transparent via-blue-400/50 to-transparent"></div>
                        </div>
                    </div>
                    
                    <div class="relative group">
                        <div class="relative bg-white dark:bg-gradient-to-br dark:from-gray-800 dark:via-gray-700 dark:to-gray-900 rounded-2xl p-6 border border-gray-200 dark:border-gray-600/40 shadow-lg hover:border-green-400/50 transition-all duration-300 hover:shadow-xl">
                            <div class="absolute inset-0 bg-gradient-to-br from-green-50/30 to-green-100/20 dark:from-green-500/10 dark:via-green-400/5 dark:to-green-600/10 rounded-2xl opacity-40 group-hover:opacity-60 transition-opacity duration-300"></div>
                            <div class="relative flex flex-col items-center text-center space-y-4">
                                <div class="relative p-4 bg-gradient-to-br from-green-500 to-green-600 rounded-2xl shadow-lg transition-all duration-300">
                                    <svg class="w-8 h-8 text-white drop-shadow-sm" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                                    </svg>
                                </div>
                                <div class="space-y-2">
                                    <p class="text-xs font-medium text-gray-600 dark:text-gray-300 uppercase tracking-wide" data-it="VIAGGI" data-en="TRIPS">TRIPS</p>
                                    <p class="text-2xl font-bold text-gray-900 dark:text-white">${reportData.summary.totalTrips}</p>
                                </div>
                            </div>
                            <div class="absolute top-0 left-1/4 right-1/4 h-px bg-gradient-to-r from-transparent via-green-400/50 to-transparent"></div>
                        </div>
                    </div>
                    
                    <div class="relative group">
                        <div class="relative bg-white dark:bg-gradient-to-br dark:from-gray-800 dark:via-gray-700 dark:to-gray-900 rounded-2xl p-6 border border-gray-200 dark:border-gray-600/40 shadow-lg hover:border-purple-400/50 transition-all duration-300 hover:shadow-xl">
                            <div class="absolute inset-0 bg-gradient-to-br from-purple-50/30 to-purple-100/20 dark:from-purple-500/10 dark:via-purple-400/5 dark:to-purple-600/10 rounded-2xl opacity-40 group-hover:opacity-60 transition-opacity duration-300"></div>
                            <div class="relative flex flex-col items-center text-center space-y-4">
                                <div class="relative p-4 bg-gradient-to-br from-purple-500 to-purple-600 rounded-2xl shadow-lg transition-all duration-300">
                                    <svg class="w-8 h-8 text-white drop-shadow-sm" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                </div>
                                <div class="space-y-2">
                                    <p class="text-xs font-medium text-gray-600 dark:text-gray-300 uppercase tracking-wide" data-it="TEMPO GUIDA" data-en="DRIVE TIME">DRIVE TIME</p>
                                    <p class="text-2xl font-bold text-gray-900 dark:text-white">${reportData.summary.totalTime}h</p>
                                </div>
                            </div>
                            <div class="absolute top-0 left-1/4 right-1/4 h-px bg-gradient-to-r from-transparent via-purple-400/50 to-transparent"></div>
                        </div>
                    </div>
                    
                    <div class="relative group">
                        <div class="relative bg-white dark:bg-gradient-to-br dark:from-gray-800 dark:via-gray-700 dark:to-gray-900 rounded-2xl p-6 border border-gray-200 dark:border-gray-600/40 shadow-lg hover:border-cyan-400/50 transition-all duration-300 hover:shadow-xl">
                            <div class="absolute inset-0 bg-gradient-to-br from-cyan-50/30 to-cyan-100/20 dark:from-cyan-500/10 dark:via-cyan-400/5 dark:to-cyan-600/10 rounded-2xl opacity-40 group-hover:opacity-60 transition-opacity duration-300"></div>
                            <div class="relative flex flex-col items-center text-center space-y-4">
                                <div class="relative p-4 bg-gradient-to-br from-cyan-500 to-cyan-600 rounded-2xl shadow-lg transition-all duration-300">
                                    <svg class="w-8 h-8 text-white drop-shadow-sm" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-1.447-.894L15 4m0 13V4m-6 3l6-3"/>
                                    </svg>
                                </div>
                                <div class="space-y-2">
                                    <p class="text-xs font-medium text-gray-600 dark:text-gray-300 uppercase tracking-wide" data-it="VELOCITÀ MEDIA" data-en="AVG SPEED">AVG SPEED</p>
                                    <p class="text-2xl font-bold text-gray-900 dark:text-white">${reportData.summary.avgSpeed} km/h</p>
                                </div>
                            </div>
                            <div class="absolute top-0 left-1/4 right-1/4 h-px bg-gradient-to-r from-transparent via-cyan-400/50 to-transparent"></div>
                        </div>
                    </div>
                </div>
                        
                <!-- Period Info with styling -->
                <div class="bg-gradient-to-r from-gray-800/20 to-gray-900/20 rounded-lg p-4 mb-6 border border-gray-600/20">
                    <div class="text-sm text-gray-400">
                        <div class="flex items-center gap-2 mb-1">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                            </svg>
                            <span>Period: ${reportData.reportPeriod}</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            <span>Generated: ${new Date(reportData.generatedAt).toLocaleString()}</span>
                        </div>
                    </div>
                        </div>
                        
                <!-- AI Report Content with enhanced beautiful styling -->
                <div class="relative group">
                    <div class="relative bg-white dark:bg-gradient-to-br dark:from-gray-800 dark:via-gray-700 dark:to-gray-900 rounded-2xl p-8 border border-gray-200 dark:border-gray-600/40 shadow-lg hover:border-purple-400/50 transition-all duration-300 hover:shadow-xl mb-6">
                        <!-- Background glow effect -->
                        <div class="absolute inset-0 bg-gradient-to-br from-purple-50/40 to-purple-100/30 dark:from-purple-500/10 dark:via-purple-400/5 dark:to-purple-600/10 rounded-2xl opacity-40 group-hover:opacity-60 transition-opacity duration-300"></div>
                        
                        <!-- Header with enhanced styling -->
                        <div class="relative flex items-center gap-4 mb-6">
                            <div class="relative p-4 bg-gradient-to-br from-purple-500 to-purple-600 rounded-2xl shadow-lg transition-all duration-300">
                                <svg class="w-8 h-8 text-white drop-shadow-sm" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                                </svg>
                            </div>
                            <div>
                                <h3 class="text-2xl font-bold text-gray-900 dark:text-white" data-it="Report Analisi AI" data-en="AI Analysis Report">AI Analysis Report</h3>
                                <p class="text-sm text-gray-600 dark:text-gray-300" data-it="Insights intelligenti sulle performance del veicolo" data-en="Intelligent vehicle performance insights">Intelligent vehicle performance insights</p>
                            </div>
                        </div>
                        
                        <!-- Structured AI Report Sections -->
                        <div id="aiReportText" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <!-- Vehicle Health Assessment Section -->
                            <div class="relative group">
                                <div class="relative bg-gradient-to-br from-emerald-50 to-emerald-100 dark:from-emerald-900/20 dark:to-emerald-800/20 rounded-xl p-4 border border-emerald-200 dark:border-emerald-600/30 shadow-lg h-full">
                                    <div class="absolute inset-0 bg-gradient-to-br from-emerald-400/5 to-emerald-600/5 rounded-xl"></div>
                                    <div class="relative h-full flex flex-col">
                                        <div class="flex items-center gap-3 mb-3">
                                            <div class="p-2 bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-lg shadow-lg w-9 h-9 flex items-center justify-center">
                                                <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                                </svg>
                                            </div>
                                            <div>
                                                                                <h3 class="text-lg font-bold text-emerald-800 dark:text-emerald-200" data-it="Salute Veicolo" data-en="Vehicle Health">Vehicle Health</h3>
                                <p class="text-xs text-emerald-600 dark:text-emerald-300" data-it="Condizione generale" data-en="Overall condition">Overall condition</p>
                                            </div>
                                        </div>
                                        <div class="text-gray-700 dark:text-gray-200 leading-relaxed flex-1" style="font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; line-height: 1.6; font-size: 0.9rem;">
                                            ${reportData.sections?.vehicleHealth || 'Loading vehicle health assessment...'}
                                        </div>
                                    </div>
                                    <div class="absolute top-0 left-1/4 right-1/4 h-px bg-gradient-to-r from-transparent via-emerald-400/50 to-transparent"></div>
                                </div>
                            </div>

                            <!-- Spike Analysis Interpretation Section -->
                            <div class="relative group">
                                <div class="relative bg-gradient-to-br from-blue-50 to-blue-100 dark:from-blue-900/20 dark:to-blue-800/20 rounded-xl p-4 border border-blue-200 dark:border-blue-600/30 shadow-lg h-full">
                                    <div class="absolute inset-0 bg-gradient-to-br from-blue-400/5 to-blue-600/5 rounded-xl"></div>
                                    <div class="relative h-full flex flex-col">
                                        <div class="flex items-center gap-3 mb-3">
                                            <div class="p-2 bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg shadow-lg w-9 h-9 flex items-center justify-center">
                                                <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                                                </svg>
                                            </div>
                                            <div>
                                                                                <h3 class="text-lg font-bold text-blue-800 dark:text-blue-200" data-it="Analisi Picchi" data-en="Spike Analysis">Spike Analysis</h3>
                                <p class="text-xs text-blue-600 dark:text-blue-300" data-it="Insights OBD" data-en="OBD insights">OBD insights</p>
                                            </div>
                                        </div>
                                        <div class="text-gray-700 dark:text-gray-200 leading-relaxed flex-1" style="font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; line-height: 1.6; font-size: 0.9rem;">
                                            ${reportData.sections?.spikeAnalysis || 'Loading spike analysis...'}
                                        </div>
                                    </div>
                                    <div class="absolute top-0 left-1/4 right-1/4 h-px bg-gradient-to-r from-transparent via-blue-400/50 to-transparent"></div>
                                </div>
                            </div>

                            <!-- Maintenance Recommendations Section -->
                            <div class="relative group">
                                <div class="relative bg-gradient-to-br from-amber-50 to-amber-100 dark:from-amber-900/20 dark:to-amber-800/20 rounded-xl p-4 border border-amber-200 dark:border-amber-600/30 shadow-lg h-full">
                                    <div class="absolute inset-0 bg-gradient-to-br from-amber-400/5 to-amber-600/5 rounded-xl"></div>
                                    <div class="relative h-full flex flex-col">
                                        <div class="flex items-center gap-3 mb-3">
                                            <div class="p-2 bg-gradient-to-br from-amber-500 to-amber-600 rounded-lg shadow-lg w-9 h-9 flex items-center justify-center">
                                                <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                                </svg>
                                            </div>
                                            <div>
                                                                                <h3 class="text-lg font-bold text-amber-800 dark:text-amber-200" data-it="Manutenzione" data-en="Maintenance">Maintenance</h3>
                                <p class="text-xs text-amber-600 dark:text-amber-300" data-it="Raccomandazioni servizio" data-en="Service recommendations">Service recommendations</p>
                                            </div>
                                        </div>
                                        <div class="text-gray-700 dark:text-gray-200 leading-relaxed flex-1" style="font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; line-height: 1.6; font-size: 0.9rem;">
                                            ${reportData.sections?.maintenance || 'Loading maintenance recommendations...'}
                                        </div>
                                    </div>
                                    <div class="absolute top-0 left-1/4 right-1/4 h-px bg-gradient-to-r from-transparent via-amber-400/50 to-transparent"></div>
                                </div>
                            </div>

                            <!-- Performance Analysis Section -->
                            <div class="relative group">
                                <div class="relative bg-gradient-to-br from-purple-50 to-purple-100 dark:from-purple-900/20 dark:to-purple-800/20 rounded-xl p-4 border border-purple-200 dark:border-purple-600/30 shadow-lg h-full">
                                    <div class="absolute inset-0 bg-gradient-to-br from-purple-400/5 to-purple-600/5 rounded-xl"></div>
                                    <div class="relative h-full flex flex-col">
                                        <div class="flex items-center gap-3 mb-3">
                                            <div class="p-2 bg-gradient-to-br from-purple-500 to-purple-600 rounded-lg shadow-lg w-9 h-9 flex items-center justify-center">
                                                <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                                                </svg>
                                            </div>
                                            <div>
                                                                                <h3 class="text-lg font-bold text-purple-800 dark:text-purple-200" data-it="Performance" data-en="Performance">Performance</h3>
                                <p class="text-xs text-purple-600 dark:text-purple-300" data-it="Modelli di guida" data-en="Driving patterns">Driving patterns</p>
                                            </div>
                                        </div>
                                        <div class="text-gray-700 dark:text-gray-200 leading-relaxed flex-1" style="font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; line-height: 1.6; font-size: 0.9rem;">
                                            ${reportData.sections?.performance || 'Loading performance analysis...'}
                                        </div>
                                    </div>
                                    <div class="absolute top-0 left-1/4 right-1/4 h-px bg-gradient-to-r from-transparent via-purple-400/50 to-transparent"></div>
                                </div>
                            </div>

                            <!-- Potential Issues Section -->
                            <div class="relative group">
                                <div class="relative bg-gradient-to-br from-red-50 to-red-100 dark:from-red-900/20 dark:to-red-800/20 rounded-xl p-4 border border-red-200 dark:border-red-600/30 shadow-lg h-full">
                                    <div class="absolute inset-0 bg-gradient-to-br from-red-400/5 to-red-600/5 rounded-xl"></div>
                                    <div class="relative h-full flex flex-col">
                                        <div class="flex items-center gap-3 mb-3">
                                            <div class="p-2 bg-gradient-to-br from-red-500 to-red-600 rounded-lg shadow-lg">
                                                <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"/>
                                                </svg>
                                            </div>
                                            <div>
                                                                                <h3 class="text-lg font-bold text-red-800 dark:text-red-200" data-it="Problemi Potenziali" data-en="Potential Issues">Potential Issues</h3>
                                <p class="text-xs text-red-600 dark:text-red-300" data-it="Segnali di avvertimento" data-en="Warning signs">Warning signs</p>
                                            </div>
                                        </div>
                                        <div class="text-gray-700 dark:text-gray-200 leading-relaxed flex-1" style="font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; line-height: 1.6; font-size: 0.9rem;">
                                            ${reportData.sections?.issues || 'Loading potential issues...'}
                                        </div>
                                    </div>
                                    <div class="absolute top-0 left-1/4 right-1/4 h-px bg-gradient-to-r from-transparent via-red-400/50 to-transparent"></div>
                                </div>
                            </div>

                            <!-- Commercial Opportunities Section -->
                            <div class="relative group">
                                <div class="relative bg-gradient-to-br from-indigo-50 to-indigo-100 dark:from-indigo-900/20 dark:to-indigo-800/20 rounded-xl p-4 border border-indigo-200 dark:border-indigo-600/30 shadow-lg h-full">
                                    <div class="absolute inset-0 bg-gradient-to-br from-indigo-400/5 to-indigo-600/5 rounded-xl"></div>
                                    <div class="relative h-full flex flex-col">
                                        <div class="flex items-center gap-3 mb-3">
                                            <div class="p-2 bg-gradient-to-br from-indigo-500 to-indigo-600 rounded-lg shadow-lg">
                                                <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
                                                </svg>
                                            </div>
                                            <div>
                                                                                <h3 class="text-lg font-bold text-indigo-800 dark:text-indigo-200" data-it="Opportunità" data-en="Opportunities">Opportunities</h3>
                                <p class="text-xs text-indigo-600 dark:text-indigo-300" data-it="Potenziale business" data-en="Business potential">Business potential</p>
                                            </div>
                                        </div>
                                        <div class="text-gray-700 dark:text-gray-200 leading-relaxed flex-1" style="font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; line-height: 1.6; font-size: 0.9rem;">
                                            ${reportData.sections?.opportunities || 'Loading commercial opportunities...'}
                                        </div>
                                    </div>
                                    <div class="absolute top-0 left-1/4 right-1/4 h-px bg-gradient-to-r from-transparent via-indigo-400/50 to-transparent"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Top highlight -->
                        <div class="absolute top-0 left-1/4 right-1/4 h-px bg-gradient-to-r from-transparent via-purple-400/50 to-transparent"></div>
                    </div>
                </div>
                    
                <!-- Data Sources with styling -->
                <div class="bg-gradient-to-r from-gray-800/20 to-gray-900/20 rounded-lg p-4 border border-gray-600/20">
                    <div class="text-center text-sm text-gray-400">
                        <div class="flex items-center justify-center gap-6">
                            <span class="flex items-center gap-2">
                                <svg class="w-4 h-4 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                                </svg>
                                ${reportData.dataPoints.analyticsRecords} analytics records
                            </span>
                            <span class="flex items-center gap-2">
                                <svg class="w-4 h-4 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                </svg>
                                ${reportData.dataPoints.obdSamples} OBD samples
                            </span>
                            <span class="flex items-center gap-2">
                                <svg class="w-4 h-4 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                                </svg>
                                Powered by OpenAI
                            </span>
                        </div>
                    </div>
                </div>
            `;
            
            contentDiv.innerHTML = reportHtml;
            

            
            // Setup toggle functionality for AI report
            setupAIReportToggle();
        }

        // Setup AI Report Toggle Functionality
        function setupAIReportToggle() {
            const toggleButton = document.getElementById('toggleAIReport');
            const reportText = document.getElementById('aiReportText');
            const toggleIcon = document.getElementById('toggleIcon');
            const toggleTextSpan = document.getElementById('toggleText');
            const fadeGradient = document.getElementById('fadeGradient');
            
            if (!toggleButton || !reportText || !toggleIcon || !toggleTextSpan || !fadeGradient) {
                return;
            }
            
            let isExpanded = true; // Start expanded by default
            
            // Force initial expanded state
            reportText.style.maxHeight = 'none';
            reportText.style.overflow = 'visible';
            fadeGradient.style.display = 'none';
            toggleTextSpan.textContent = 'Show Less';
            toggleIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/>';
            
            
            
            toggleButton.addEventListener('click', function() {
                isExpanded = !isExpanded;
                
                if (isExpanded) {
                    // Expand
                    reportText.style.maxHeight = 'none';
                    reportText.style.overflow = 'visible';
                    fadeGradient.style.display = 'none';
                    toggleTextSpan.textContent = 'Show Less';
                    toggleIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/>';
                    
                } else {
                    // Collapse
                    reportText.style.maxHeight = '300px'; // Increased from 200px to 300px
                    reportText.style.overflow = 'hidden';
                    fadeGradient.style.display = 'block';
                    toggleTextSpan.textContent = 'Show Full Report';
                    toggleIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>';
                    
                }
            });
        }

        // Display AI Report Error
        function displayAIReportError(errorMessage) {
            const contentDiv = document.getElementById('aiReportContent');
            contentDiv.innerHTML = `
                <div class="text-center py-8">
                    <div class="inline-flex items-center justify-center w-16 h-16 bg-red-600/20 rounded-full mb-4">
                        <svg class="w-8 h-8 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"/>
                        </svg>
                    </div>
                                                    <h3 class="text-xl font-semibold text-white mb-2" data-it="Generazione Report Fallita" data-en="Report Generation Failed">Report Generation Failed</h3>
                                <p class="text-red-300 mb-4">${errorMessage}</p>
                                <p class="text-gray-400 text-sm" data-it="Controlla la configurazione dell'API OpenAI o riprova più tardi." data-en="Please check your OpenAI API configuration or try again later.">Please check your OpenAI API configuration or try again later.</p>
                </div>
            `;
        }
        
        // Date Range Utilities
        function getDateRange(rangeType) {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            
            // Helper function to format date as yyyy-MM-dd for API calls
            function formatDateForAPI(date) {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }
            
            switch(rangeType) {
                case 'today':
                    return { 
                        start: formatDateForAPI(today), 
                        end: formatDateForAPI(new Date(today.getTime() + 24 * 60 * 60 * 1000)) 
                    };
                case 'yesterday':
                    const yesterday = new Date(today.getTime() - 24 * 60 * 60 * 1000);
                    return { 
                        start: formatDateForAPI(yesterday), 
                        end: formatDateForAPI(today) 
                    };
                case 'thisWeek':
                    const startOfWeek = new Date(today);
                    startOfWeek.setDate(today.getDate() - today.getDay());
                    return { 
                        start: formatDateForAPI(startOfWeek), 
                        end: formatDateForAPI(new Date(today.getTime() + 24 * 60 * 60 * 1000)) 
                    };
                case 'lastWeek':
                    const lastWeekEnd = new Date(today);
                    lastWeekEnd.setDate(today.getDate() - today.getDay());
                    const lastWeekStart = new Date(lastWeekEnd);
                    lastWeekStart.setDate(lastWeekEnd.getDate() - 7);
                    return { 
                        start: formatDateForAPI(lastWeekStart), 
                        end: formatDateForAPI(lastWeekEnd) 
                    };
                case 'thisMonth':
                    const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
                    return { 
                        start: formatDateForAPI(startOfMonth), 
                        end: formatDateForAPI(new Date(today.getTime() + 24 * 60 * 60 * 1000)) 
                    };
                case 'lastMonth':
                    const lastMonthStart = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                    const lastMonthEnd = new Date(today.getFullYear(), today.getMonth(), 1);
                    return { 
                        start: formatDateForAPI(lastMonthStart), 
                        end: formatDateForAPI(lastMonthEnd) 
                    };
                case 'last7days':
                    const last7Days = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
                    return { 
                        start: formatDateForAPI(last7Days), 
                        end: formatDateForAPI(new Date(today.getTime() + 24 * 60 * 60 * 1000)) 
                    };
                case 'last30days':
                    const last30Days = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);
                    return { 
                        start: formatDateForAPI(last30Days), 
                        end: formatDateForAPI(new Date(today.getTime() + 24 * 60 * 60 * 1000)) 
                    };
                case 'last90days':
                    const last90Days = new Date(today.getTime() - 90 * 24 * 60 * 60 * 1000);
                    return { 
                        start: formatDateForAPI(last90Days), 
                        end: formatDateForAPI(new Date(today.getTime() + 24 * 60 * 60 * 1000)) 
                    };
                case 'thisYear':
                    const startOfYear = new Date(today.getFullYear(), 0, 1);
                    return { 
                        start: formatDateForAPI(startOfYear), 
                        end: formatDateForAPI(new Date(today.getTime() + 24 * 60 * 60 * 1000)) 
                    };
                case 'custom':
                    const startDate = document.getElementById('startDateInput').value;
                    const endDate = document.getElementById('endDateInput').value;
                    if (startDate && endDate) {
                        return { 
                            start: startDate, 
                            end: endDate 
                        };
                    }
                    return null;
                default:
                    return null;
            }
        }
        
        // Load Analytics Tab
        function loadAnalytics() {
            
            // Load analytics data when tab is accessed
            loadAnalyticsData();
            setupAnalyticsEventHandlers();
        }
        

        
        // NOTE: generateVehicleMaintenanceReport function is defined at line 2245 to avoid duplication
        
        // DUPLICATE FUNCTION REMOVED - displayMaintenanceReport is defined at line 2300+
        
        // Display Maintenance Error
        function displayMaintenanceError(message) {
            const maintenanceContent = document.getElementById('maintenanceContent');
            if (!maintenanceContent) return;
            
            maintenanceContent.innerHTML = `
                <div class="text-center py-8">
                    <div class="inline-flex items-center justify-center w-12 h-12 bg-red-600/20 rounded-full mb-4">
                        <svg class="w-6 h-6 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"/>
                        </svg>
                    </div>
                    <p class="text-red-500 dark:text-red-400">${message}</p>
                </div>
            `;
        }
        
        // Load Analytics Data
        async function loadAnalyticsData() {
            
            
            
            if (!certificateData || !certificateData.deviceId) {
                console.warn('No device ID available for analytics');
                return;
            }
            
            try {
                const rangeType = document.getElementById('dateRangeSelector').value;
                
                
                const dateRange = getDateRange(rangeType);
                
                
                if (!dateRange) {
                    console.warn('Invalid date range');
                    return;
                }
                
                // Show loading state
                showAnalyticsLoading();
                
                
                
                // Load analytics data
                const analyticsUrl = `/api/vehicle/${certificateData.deviceId}/analytics?startDate=${dateRange.start}&endDate=${dateRange.end}`;
                
                const analyticsResponse = await secureApiCall(analyticsUrl);
                if (!analyticsResponse) {
                    console.error('❌ Failed to authenticate for analytics data');
                    hideAnalyticsLoading();
                    showAnalyticsError('Authentication failed');
                    return;
                }
                const analyticsResult = await analyticsResponse.json();
                
                
                // Load summary data with the same date range
                const summaryUrl = `/api/vehicle/${certificateData.deviceId}/summary?startDate=${dateRange.start}&endDate=${dateRange.end}`;
                
                const summaryResponse = await secureApiCall(summaryUrl);
                if (!summaryResponse) {
                    console.error('❌ Failed to authenticate for summary data');
                    hideAnalyticsLoading();
                    showAnalyticsError('Authentication failed');
                    return;
                }
                const summaryResult = await summaryResponse.json();
                
                
                if (analyticsResult.success) {
                    analyticsData = analyticsResult.data;
                    
    
                    
                    
                    
                } else {
                    console.error('❌ Analytics API failed:', analyticsResult);
                }
                
                if (summaryResult.success) {
                    summaryData = summaryResult.summary;
                    
    
                    
                } else {
                    console.error('❌ Summary API failed:', summaryResult);
                }
                
                // Update the dashboard
                
                updateSummaryStats();
                
                updateCharts();
                
                // Hide loading state
                hideAnalyticsLoading();
                
                
            } catch (error) {
                console.error('❌ Error loading analytics data:', error);
                hideAnalyticsLoading();
                showAnalyticsError('Failed to load analytics data');
            }
        }
        

        


        
        // Update Summary Statistics
        function updateSummaryStats() {
            
            
            
            const container = document.getElementById('summaryStats');
            
            // Get current language
            const currentLanguage = document.documentElement.lang || 'it';
            
            const stats = [
                {
                    title: 'Distanza Totale',
                    titleEn: 'Total Distance',
                    value: `${summaryData.total_distance_km || 0} km`,
                    icon: 'M3 13h1l1-3h2l1 3h2l1-3h2l1 3h2l1-3h2l1 3h1v-2h-1l-1-3h-2l-1 3h-2l-1-3h-2l-1 3h-2l-1-3h-2l-1 3H3v2zm0-4h18v2H3V9zm1 1h2v1H4v-1zm4 0h2v1H8v-1zm4 0h2v1h-2v-1zm4 0h2v1h-2v-1zm4 0h2v1h-2v-1zM5 7c0-.6.4-1 1-1s1 .4 1 1-.4 1-1 1-1-.4-1-1zm6 0c0-.6.4-1 1-1s1 .4 1 1-.4 1-1 1-1-.4-1-1zm6 0c0-.6.4-1 1-1s1 .4 1 1-.4 1-1 1-1-.4-1-1z',
                    color: 'blue'
                },
                {
                    title: 'Viaggi Totali',
                    titleEn: 'Total Trips',
                    value: summaryData.total_trips || 0,
                    icon: 'M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5zM7 20h10l-2 2H9l-2-2zm5-18v2c2.76 0 5 2.24 5 5h2c0-3.87-3.13-7-7-7z',
                    color: 'green'
                },
                {
                    title: 'Tempo di Viaggio',
                    titleEn: 'Driving Time',
                    value: `${summaryData.total_time_hours || 0}h`,
                    icon: 'M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm4.64 12.36l-4.36-2.73V7h2v3.73l3.64 2.28-.64 1.35zM12 4c4.41 0 8 3.59 8 8s-3.59 8-8 8-8-3.59-8-8 3.59-8 8-8zm0-2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z',
                    color: 'purple'
                },
                {
                    title: 'Velocità Media',
                    titleEn: 'Average Speed',
                    value: `${summaryData.avg_speed_kmh || 0} km/h`,
                    icon: 'M20.5 3l-.16.03L15 5.1 9 3 3.36 4.9c-.21.07-.36.25-.36.48V20.5c0 .28.22.5.5.5l.16-.03L9 18.9l6 2.1 5.64-1.9c.21-.07.36-.25.36-.48V3.5c0-.28-.22-.5-.5-.5zM10 5.47l4 1.4v11.66l-4-1.4V5.47zm-5 .99l3-1.01v11.7l-3 1.01V6.46zm14 11.08l-3 1.01V6.86l3-1.01v11.69z',
                    color: 'cyan'
                },
                {
                    title: 'Media Batteria',
                    titleEn: 'Battery Average',
                    value: `${summaryData.avg_battery_v || 0}V`,
                    icon: 'M15.67 4H14V2c0-1.1-.9-2-2-2s-2 .9-2 2v2H8.33C7.6 4 7 4.6 7 5.33v15.33C7 21.4 7.6 22 8.33 22h7.33c.74 0 1.34-.6 1.34-1.33V5.33C17 4.6 16.4 4 15.67 4zM11 20v-5.5H9L13 9v5.5h2L11 20zm1-16c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1z',
                    color: 'green'
                },
                {
                    title: 'Carburante Utilizzato',
                    titleEn: 'Fuel Consumed',
                    value: `${summaryData.total_fuel_consumption || 0}L`,
                    icon: 'M19.77 7.23l.01-.01-3.72-3.72L15 4.56l2.11 2.11c-.94.36-1.61 1.26-1.61 2.33 0 1.38 1.12 2.5 2.5 2.5.36 0 .69-.08 1-.21v7.21c0 .55-.45 1-1 1s-1-.45-1-1V14c0-1.1-.9-2-2-2h-1V5c0-1.1-.9-2-2-2H6c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h6.5v-2H6V5h6v7h-1c-1.1 0-2 .9-2 2v3c0 1.66 1.34 3 3 3s3-1.34 3-3v-7.17c.59-.34 1-1.07 1-1.83 0-1.38-1.12-2.5-2.5-2.5-.17 0-.33.02-.5.05L19.77 7.23zM18 8.5c.28 0 .5.22.5.5s-.22.5-.5.5-.5-.22-.5-.5.22-.5.5-.5z',
                    color: 'orange'
                }
            ];
            
            container.innerHTML = stats.map(stat => {
                // Use correct language for display
                const displayTitle = currentLanguage === 'en' ? stat.titleEn : stat.title;
                
                
                
                return `
                <div class="relative group">
                    <!-- Modern Card for both light and dark mode -->
                    <div class="relative bg-white dark:bg-gradient-to-br dark:from-gray-800 dark:via-gray-700 dark:to-gray-900 rounded-2xl p-6 border border-gray-200 dark:border-gray-600/40 shadow-lg hover:border-${stat.color}-400/50 transition-all duration-300 hover:shadow-xl">
                        
                        <!-- Light mode background -->
                        <div class="absolute inset-0 bg-gradient-to-br from-${stat.color}-50/30 to-${stat.color}-100/20 dark:from-${stat.color}-500/10 dark:via-${stat.color}-400/5 dark:to-${stat.color}-600/10 rounded-2xl opacity-40 group-hover:opacity-60 transition-opacity duration-300"></div>
                        
                        <!-- Content -->
                        <div class="relative flex flex-col items-center text-center space-y-4">
                            <!-- Modern icon -->
                            <div class="relative p-4 bg-gradient-to-br from-${stat.color}-500 to-${stat.color}-600 rounded-2xl shadow-lg transition-all duration-300">
                                <svg class="w-8 h-8 text-white drop-shadow-sm" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="${stat.icon}"/>
                                </svg>
                        </div>
                            <!-- Text with adaptive colors -->
                            <div class="space-y-2">
                                <p class="text-xs font-medium text-gray-600 dark:text-gray-300 uppercase tracking-wide" data-it="${stat.title}" data-en="${stat.titleEn}">${displayTitle}</p>
                                <p class="text-2xl font-bold text-gray-900 dark:text-white">${stat.value}</p>
                        </div>
                        </div>
                        
                        <!-- Subtle highlight -->
                        <div class="absolute top-0 left-1/4 right-1/4 h-px bg-gradient-to-r from-transparent via-${stat.color}-400/50 to-transparent"></div>
                    </div>
                </div>
            `}).join('');
        }
        
        // Update Charts
        function updateCharts() {
            
            
            
            // Destroy existing charts
            Object.values(analyticsCharts).forEach(chart => {
                if (chart) chart.destroy();
            });
            analyticsCharts = {};
            
            if (!analyticsData || analyticsData.length === 0) {
                console.warn('No analytics data available for charts');
                showChartsNoData();
                return;
            }
            
            // Restore chart display when data is available
            restoreChartsDisplay();
            
            // Prepare data
            const dates = analyticsData.map(d => new Date(d.report_date).toLocaleDateString()).reverse();
            const batteryData = analyticsData.map(d => d.battery_avg_v || 0).reverse();
            const distanceData = analyticsData.map(d => d.total_distance_km || 0).reverse();
            const timeData = analyticsData.map(d => d.total_time_hours || 0).reverse();
            const speedData = analyticsData.map(d => d.max_speed_kmh || 0).reverse();
            const tripsData = analyticsData.map(d => d.total_trips || 0).reverse();
            const eventsData = analyticsData.map(d => d.total_events || 0).reverse();
            const obdErrorsData = analyticsData.map(d => d.total_obd_errors || 0).reverse();
            const crashesData = analyticsData.map(d => d.total_crashes || 0).reverse();
            const positionsData = analyticsData.map(d => d.total_positions || 0).reverse();
            const speedViolationsData = analyticsData.map(d => d.total_speed_violations || 0).reverse();

            const avgSpeedData = analyticsData.map(d => d.avg_speed_kmh || 0).reverse();
            
            // Chart configuration with adaptive colors for light/dark mode
            const isDarkMode = document.documentElement.classList.contains('dark');
            
            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                layout: {
                    padding: 10
                },
                plugins: {
                    legend: {
                        position: 'top',
                        align: 'start',
                        labels: { 
                            color: isDarkMode ? '#e5e7eb' : '#374151',
                            font: {
                                size: 12,
                                weight: '500'
                            },
                            padding: 20,
                            usePointStyle: true,
                            pointStyle: 'circle'
                        }
                    },
                    tooltip: {
                        backgroundColor: isDarkMode ? 'rgba(17, 24, 39, 0.95)' : 'rgba(255, 255, 255, 0.95)',
                        titleColor: isDarkMode ? '#ffffff' : '#111827',
                        bodyColor: isDarkMode ? '#e5e7eb' : '#374151',
                        borderColor: isDarkMode ? '#6b7280' : '#d1d5db',
                        borderWidth: 1,
                        cornerRadius: 8
                    }
                },
                scales: {
                    x: {
                        ticks: { 
                            color: isDarkMode ? '#9ca3af' : '#6b7280',
                            font: {
                                size: 11
                            }
                        },
                        grid: { 
                            color: isDarkMode ? '#374151' : '#e5e7eb',
                            lineWidth: 0.5
                        },
                        border: {
                            color: isDarkMode ? '#4b5563' : '#d1d5db'
                        }
                    },
                    y: {
                        ticks: { 
                            color: isDarkMode ? '#9ca3af' : '#6b7280',
                            font: {
                                size: 11
                            }
                        },
                        grid: { 
                            color: isDarkMode ? '#374151' : '#e5e7eb',
                            lineWidth: 0.5
                        },
                        border: {
                            color: isDarkMode ? '#4b5563' : '#d1d5db'
                        }
                    }
                }
            };
            
            
            // Battery Chart
            analyticsCharts.battery = new Chart(document.getElementById('batteryChart'), {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'Battery Voltage (V)',
                        data: batteryData,
                        borderColor: '#eab308',
                        backgroundColor: 'rgba(234, 179, 8, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: chartOptions
            });
            
            // Distance & Time Chart
            analyticsCharts.distanceTime = new Chart(document.getElementById('distanceTimeChart'), {
                type: 'bar',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: 'Distance (km)',
                            data: distanceData,
                            backgroundColor: '#3b82f6',
                            yAxisID: 'y'
                        },
                        {
                            label: 'Time (hours)',
                            data: timeData,
                            backgroundColor: '#06b6d4',
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    ...chartOptions,
                    scales: {
                        ...chartOptions.scales,
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            ticks: { color: '#9ca3af' },
                            grid: { drawOnChartArea: false }
                        }
                    }
                }
            });
            
            // Speed Chart
            analyticsCharts.speed = new Chart(document.getElementById('speedChart'), {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: 'Max Speed (km/h)',
                            data: speedData,
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            fill: false,
                            tension: 0.4
                        },
                        {
                            label: 'Avg Speed (km/h)',
                            data: avgSpeedData,
                            borderColor: '#06b6d4',
                            backgroundColor: 'rgba(6, 182, 212, 0.1)',
                            fill: true,
                            tension: 0.4
                        }
                    ]
                },
                options: chartOptions
            });
            
            // Trips & Events Chart
            analyticsCharts.tripsEvents = new Chart(document.getElementById('tripsEventsChart'), {
                type: 'bar',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: 'Trips',
                            data: tripsData,
                            backgroundColor: '#8b5cf6'
                        },
                        {
                            label: 'Events',
                            data: eventsData,
                            backgroundColor: '#a855f7'
                        }
                    ]
                },
                options: chartOptions
            });
            
            // System Health Chart
            analyticsCharts.systemHealth = new Chart(document.getElementById('systemHealthChart'), {
                type: 'bar',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: 'OBD Errors',
                            data: obdErrorsData,
                            backgroundColor: '#ef4444'
                        },
                        {
                            label: 'Crashes',
                            data: crashesData,
                            backgroundColor: '#dc2626'
                        },
                        {
                            label: 'Positions',
                            data: positionsData,
                            backgroundColor: '#f59e0b'
                        },
                        {
                            label: 'Speed Violations',
                            data: speedViolationsData,
                            backgroundColor: '#f97316'
                        }
                    ]
                },
                options: chartOptions
            });
        }
        
        // Show Analytics Loading State
        function showAnalyticsLoading() {
            const container = document.getElementById('summaryStats');
            container.innerHTML = `
                <div class="col-span-full bg-blue-600/20 rounded-lg p-4 border border-blue-600/30">
                    <div class="flex items-center gap-3">
                        <svg class="w-5 h-5 text-blue-400 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                        </svg>
                        <div>
                            <p class="text-white font-medium" data-it="Caricamento Analytics..." data-en="Loading Analytics...">Loading Analytics...</p>
                            <p class="text-blue-300 text-sm" data-it="Aggiornamento dati in corso..." data-en="Updating data...">Updating data...</p>
                        </div>
                    </div>
                </div>
            `;
        }

        // Hide Analytics Loading State
        function hideAnalyticsLoading() {
            // Remove loading state from summary stats
            const container = document.getElementById('summaryStats');
            if (container && container.querySelector('.loading-placeholder')) {
                container.querySelector('.loading-placeholder').remove();
            }
        }



        // Show Charts No Data State
        function showChartsNoData() {
            const chartContainers = [
                'batteryChart',
                'distanceTimeChart', 
                'speedChart',
                'tripsEventsChart',
                'systemHealthChart'
            ];
            
            chartContainers.forEach(containerId => {
                const container = document.getElementById(containerId);
                if (container) {
                    // Hide the canvas and show no data message
                    container.style.display = 'none';
                    
                    // Create or update no data message
                    let noDataMessage = container.parentElement.querySelector('.no-data-message');
                    if (!noDataMessage) {
                        noDataMessage = document.createElement('div');
                        noDataMessage.className = 'no-data-message flex items-center justify-center h-64 bg-gray-50 dark:bg-gray-800 rounded-lg border-2 border-dashed border-gray-300 dark:border-gray-600';
                        noDataMessage.innerHTML = `
                            <div class="text-center">
                                <svg class="w-12 h-12 text-gray-400 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                                </svg>
                                <p class="text-gray-500 dark:text-gray-400 text-sm" data-it="Nessun dato disponibile per il periodo selezionato" data-en="No data available for selected period">No data available for selected period</p>
                            </div>
                        `;
                        container.parentElement.appendChild(noDataMessage);
                    }
                    noDataMessage.style.display = 'flex';
                }
            });
        }

        // Restore Charts Display
        function restoreChartsDisplay() {
            const chartContainers = [
                'batteryChart',
                'distanceTimeChart', 
                'speedChart',
                'tripsEventsChart',
                'systemHealthChart'
            ];
            
            chartContainers.forEach(containerId => {
                const container = document.getElementById(containerId);
                if (container) {
                    // Show the canvas
                    container.style.display = 'block';
                    
                    // Hide no data message if it exists
                    const noDataMessage = container.parentElement.querySelector('.no-data-message');
                    if (noDataMessage) {
                        noDataMessage.style.display = 'none';
                    }
                }
            });
        }

        // Show Analytics Error
        function showAnalyticsError(message) {
            const container = document.getElementById('summaryStats');
            container.innerHTML = `
                <div class="col-span-full bg-red-600/20 rounded-lg p-4 border border-red-600/30">
                    <div class="flex items-center gap-3">
                        <svg class="w-5 h-5 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"/>
                        </svg>
                        <div>
                                                            <p class="text-white font-medium" data-it="Errore Analytics" data-en="Analytics Error">Analytics Error</p>
                            <p class="text-red-300 text-sm">${message}</p>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Event Handlers
        function setupAnalyticsEventHandlers() {
            // Date range selector
            const dateRangeSelector = document.getElementById('dateRangeSelector');
            if (dateRangeSelector) {
                dateRangeSelector.addEventListener('change', function() {
                    
                    const customInputs = document.getElementById('customDateInputs');
                    if (customInputs) {
                        if (this.value === 'custom') {
                            customInputs.style.display = 'flex';
                        } else {
                            customInputs.style.display = 'none';
                            // Load data immediately for predefined ranges
                            loadAnalyticsData();
                        }
                    }
                });
            }
            
            // Custom date inputs
            const startDateInput = document.getElementById('startDateInput');
            if (startDateInput) {
                startDateInput.addEventListener('change', function() {
                    
                    if (this.value && document.getElementById('endDateInput').value) {
                        loadAnalyticsData();
                    }
                });
            }
            
            const endDateInput = document.getElementById('endDateInput');
            if (endDateInput) {
                endDateInput.addEventListener('change', function() {
                    
                    if (this.value && document.getElementById('startDateInput').value) {
                        loadAnalyticsData();
                    }
                });
            }
            
            // Refresh button
            const refreshBtn = document.getElementById('refreshAnalytics');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', function() {
                    
                    loadAnalyticsData();
                });
            }

            // Generate AI Report button
            const aiReportBtn = document.getElementById('generateAIReportTab');
            if (aiReportBtn) {
                aiReportBtn.addEventListener('click', generateAIReport);
            }
            
            // Generate Maintenance Report button
            const maintenanceBtn = document.getElementById('generateMaintenanceReport');
            if (maintenanceBtn) {
                maintenanceBtn.addEventListener('click', generateMaintenanceReport);
            }
        }

        // Load Client Data
        async function loadClientData() {
            if (!certificateData || !certificateData.deviceId) {
                console.warn('No device ID available for client data');
                return;
            }

            try {
                
                
                const response = await secureApiCall(`/api/device/${certificateData.deviceId}/client`);
                if (!response) {
                    console.error('❌ Failed to authenticate for client data');
                    return;
                }
                const result = await response.json();
                
                if (result.success && result.client) {
                    displayClientData(result.client);
                } else {
                    displayNoClientData(result.message);
                }
                
            } catch (error) {
                console.error('❌ Error loading client data:', error);
                displayClientDataError('Failed to load client information');
            }
        }

        // Display Client Data
        function displayClientData(client) {
            const section = document.getElementById('clientInfoSection');
            
            const clientHtml = `
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Personal Information -->
                    <div class="space-y-4">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center gap-2">
                            <svg class="w-5 h-5 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                            </svg>
                            <span data-i18n="client.personal_info">Informazioni Personali</span>
                        </h3>
                        
                        <div class="space-y-3">
                            <div>
                                <span class="font-bold text-gray-900 dark:text-white">Nome: </span>
                                <span class="text-gray-600 dark:text-gray-300">${client.firstName || ''} ${client.lastName || ''}</span>
                            </div>
                            <div>
                                <span class="font-bold text-gray-900 dark:text-white">Email: </span>
                                <span class="text-gray-600 dark:text-gray-300">${client.email || '-'}</span>
                            </div>
                            <div>
                                <span class="font-bold text-gray-900 dark:text-white">Telefono: </span>
                                <span class="text-gray-600 dark:text-gray-300">${client.phone || '-'}</span>
                            </div>
                            ${client.birthday ? `
                            <div>
                                <span class="font-bold text-gray-900 dark:text-white">Data di Nascita: </span>
                                <span class="text-gray-600 dark:text-gray-300">${new Date(client.birthday).toLocaleDateString()}</span>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                    
                    <!-- Address Information -->
                    <div class="space-y-4">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center gap-2">
                            <svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                            </svg>
                            <span data-i18n="client.address_info">Informazioni Indirizzo</span>
                        </h3>
                        
                        <div class="space-y-3">
                            <div>
                                <span class="font-bold text-gray-900 dark:text-white">Indirizzo: </span>
                                <span class="text-gray-600 dark:text-gray-300">${client.address || '-'}</span>
                            </div>
                            ${client.address2 ? `
                            <div>
                                <span class="font-bold text-gray-900 dark:text-white">Indirizzo 2: </span>
                                <span class="text-gray-600 dark:text-gray-300">${client.address2}</span>
                            </div>
                            ` : ''}
                            <div>
                                <span class="font-bold text-gray-900 dark:text-white">Città: </span>
                                <span class="text-gray-600 dark:text-gray-300">${client.city || '-'}</span>
                            </div>
                            ${client.state ? `
                            <div>
                                <span class="font-bold text-gray-900 dark:text-white">Stato/Provincia: </span>
                                <span class="text-gray-600 dark:text-gray-300">${client.state}</span>
                            </div>
                            ` : ''}
                            ${client.postcode ? `
                            <div>
                                <span class="font-bold text-gray-900 dark:text-white">Codice Postale: </span>
                                <span class="text-gray-600 dark:text-gray-300">${client.postcode}</span>
                            </div>
                            ` : ''}
                            <div>
                                <span class="font-bold text-gray-900 dark:text-white">Paese: </span>
                                <span class="text-gray-600 dark:text-gray-300">${client.country || '-'}</span>
                            </div>
                            ${client.taxCode ? `
                            <div>
                                <span class="font-bold text-gray-900 dark:text-white">Codice Fiscale: </span>
                                <span class="text-gray-600 dark:text-gray-300">${client.taxCode}</span>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                    
                    <!-- Business Information -->
                    <div class="space-y-4">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center gap-2">
                            <svg class="w-5 h-5 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                            </svg>
                            <span data-i18n="client.business_info">Informazioni Aziendali</span>
                        </h3>
                        
                        <div class="space-y-3">
                            ${client.company ? `
                            <div>
                                <span class="font-bold text-gray-900 dark:text-white">Azienda: </span>
                                <span class="text-gray-600 dark:text-gray-300">${client.company}</span>
                            </div>
                            ` : ''}
                            ${client.role ? `
                            <div>
                                <span class="font-bold text-gray-900 dark:text-white">Ruolo: </span>
                                <span class="text-gray-600 dark:text-gray-300">${client.role}</span>
                            </div>
                            ` : ''}
                            ${client.language ? `
                            <div>
                                <span class="font-bold text-gray-900 dark:text-white">Lingua: </span>
                                <span class="text-gray-600 dark:text-gray-300">${client.language}</span>
                            </div>
                            ` : ''}
                            <div>
                                <span class="font-bold text-gray-900 dark:text-white">ID Utente: </span>
                                <span class="text-gray-600 dark:text-gray-300">${client.id}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            section.innerHTML = clientHtml;
        }

        // Display No Client Data
        function displayNoClientData(message) {
            const section = document.getElementById('clientInfoSection');
            section.innerHTML = `
                <div class="text-center py-8">
                    <div class="inline-flex items-center justify-center w-12 h-12 bg-gray-600/20 rounded-full mb-4">
                        <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                        </svg>
                    </div>
                                                    <p class="text-gray-500 dark:text-gray-400" data-it="${message || 'Nessuna informazione cliente disponibile'}" data-en="${message || 'No client information available'}">${message || 'No client information available'}</p>
                </div>
            `;
        }

        // Display Client Data Error
        function displayClientDataError(errorMessage) {
            const section = document.getElementById('clientInfoSection');
            section.innerHTML = `
                <div class="text-center py-8">
                    <div class="inline-flex items-center justify-center w-12 h-12 bg-red-600/20 rounded-full mb-4">
                        <svg class="w-6 h-6 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"/>
                        </svg>
                    </div>
                    <p class="text-red-400">${errorMessage}</p>
                </div>
            `;
        }

        // Load Throttle Data
        async function loadThrottleData() {
            if (!certificateData || !certificateData.deviceId) {
                console.warn('No device ID available for throttle data');
                return;
            }

            try {
                
                
                const response = await secureApiCall(`/api/device/${certificateData.deviceId}/throttle`);
                if (!response) {
                    console.error('❌ Failed to authenticate for throttle data');
                    return;
                }
                const result = await response.json();
                
                if (result.success && result.throttleData) {
                    window.throttleData = result.throttleData;
                    window.throttleStats = result.statistics;
                    
                    
                } else {
                    console.warn('No throttle data available');
                }
                
            } catch (error) {
                console.error('❌ Error loading throttle data:', error);
            }
        }

        // Generate Maintenance Report
        async function generateMaintenanceReport() {
            if (!vehicleData || !certificateData) {
                console.warn('No vehicle data available for maintenance report');
                return;
            }

            const generateBtn = document.getElementById('generateMaintenanceReport');
            const contentDiv = document.getElementById('maintenanceContent');
            
            try {
                // Show loading state
                generateBtn.disabled = true;
                generateBtn.innerHTML = `
                    <svg class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Analyzing...
                `;
                
                contentDiv.innerHTML = `
                    <div class="text-center py-12">
                        <div class="inline-flex items-center justify-center w-16 h-16 bg-orange-600/20 rounded-full mb-4">
                            <svg class="w-8 h-8 text-orange-400 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 7.172V5L8 4z"/>
                            </svg>  
                        </div>
                                                        <h3 class="text-xl font-semibold text-white mb-2" data-it="Analizzando le Specifiche del Veicolo..." data-en="Analyzing Vehicle Specifications...">Analyzing Vehicle Specifications...</h3>
                                <p class="text-orange-200" data-it="Generazione raccomandazioni di manutenzione predittiva basate sui problemi comuni di ${vehicleData.brand} ${vehicleData.model} ${vehicleData.year} e dati OBD." data-en="Generating predictive maintenance recommendations based on ${vehicleData.brand} ${vehicleData.model} ${vehicleData.year} common issues and OBD data.">Generating predictive maintenance recommendations based on ${vehicleData.brand} ${vehicleData.model} ${vehicleData.year} common issues and OBD data.</p>
                    </div>
                `;
                
                // Generate maintenance report based on vehicle data
                const maintenanceReport = await generateVehicleMaintenanceReport(vehicleData, certificateData);
                displayMaintenanceReport(maintenanceReport);
                
            } catch (error) {
                console.error('❌ Error generating maintenance report:', error);
                displayMaintenanceReportError(error.message);
            } finally {
                // Reset button
                generateBtn.disabled = false;
                generateBtn.innerHTML = `
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    Generate Analysis
                `;
            }
        }

        // Functions to translate OBD analysis messages to Italian
        function translateAlertMessage(message, lang = 'en') {
            if (lang === 'it') {
                const translations = {
                    'High average RPM': 'Alti giri motore medi',
                    'indicates aggressive driving or engine stress': 'indica guida aggressiva o stress motore',
                    'Very low idle RPM': 'Giri minimi molto bassi',
                    'may indicate engine problems': 'può indicare problemi motore',
                    'High coolant temperature': 'Alta temperatura liquido',
                    'indicates overheating risk': 'indica rischio surriscaldamento',
                    'Elevated coolant temperature': 'Temperatura liquido elevata',
                    'Low battery voltage': 'Bassa tensione batteria',
                    'indicates charging issues': 'indica problemi di ricarica',
                    'High voltage': 'Alta tensione',
                    'indicates overcharging': 'indica sovraccarica',
                    'High average throttle usage': 'Alto utilizzo farfalla medio',
                    'indicates aggressive driving': 'indica guida aggressiva',
                    'High engine load': 'Alto carico motore',
                    'may indicate restricted airflow or fuel delivery issues': 'può indicare problemi di flusso aria o erogazione carburante',
                    'High intake air temperature': 'Alta temperatura aria aspirazione',
                    'reduces engine efficiency': 'riduce efficienza motore'
                };
                
                let translatedMessage = message;
                Object.keys(translations).forEach(key => {
                    translatedMessage = translatedMessage.replace(key, translations[key]);
                });
                return translatedMessage;
            }
            return message;
        }

        function translateRecommendationText(text, lang = 'en') {
            if (lang === 'it') {
                const translations = {
                    'Engine oil service': 'Servizio olio motore',
                    'High RPM operation': 'Funzionamento ad alti giri',
                    'accelerates oil degradation': 'accelera degradazione olio',
                    'Schedule engine oil and filter replacement within 1000km': 'Programma sostituzione olio e filtro motore entro 1000km',
                    'Engine diagnostics': 'Diagnostica motore',
                    'Abnormally low RPM': 'Giri anormalmente bassi',
                    'suggests idle control issues': 'suggerisce problemi controllo minimi',
                    'Immediate engine inspection required': 'Ispezione motore immediata richiesta',
                    'check idle air control valve': 'controlla valvola controllo aria minimi',
                    'Cooling system service': 'Servizio sistema raffreddamento',
                    'Overheating detected': 'Surriscaldamento rilevato',
                    'Normal range': 'Intervallo normale',
                    'URGENT: Check thermostat, water pump, radiator, and coolant level': 'URGENTE: Controlla termostato, pompa acqua, radiatore e livello liquido',
                    'Cooling system inspection': 'Ispezione sistema raffreddamento',
                    'Temperature slightly high': 'Temperatura leggermente alta',
                    'Optimal': 'Ottimale',
                    'Check coolant level, radiator cleanliness, and thermostat operation': 'Controlla livello liquido, pulizia radiatore e funzionamento termostato',
                    'Thermostat check': 'Controllo termostato',
                    'Low operating temperature': 'Bassa temperatura operativa',
                    'may indicate faulty thermostat': 'può indicare termostato difettoso',
                    'Monitor thermostat operation': 'Monitora funzionamento termostato',
                    'may be stuck open': 'può essere bloccato aperto',
                    'Battery and charging system': 'Batteria e sistema ricarica',
                    'Low voltage': 'Bassa tensione',
                    'Normal': 'Normale',
                    'Test battery, alternator, and charging system immediately': 'Testa batteria, alternatore e sistema ricarica immediatamente',
                    'Charging system regulation': 'Regolazione sistema ricarica',
                    'Overcharging detected': 'Sovraccarica rilevata',
                    'Risk of battery damage': 'Rischio danno batteria',
                    'Check alternator voltage regulator and wiring': 'Controlla regolatore tensione alternatore e cablaggio',
                    'Air intake system service': 'Servizio sistema aspirazione aria',
                    'Heavy throttle usage': 'Pesante utilizzo farfalla',
                    'increases air filter contamination': 'aumenta contaminazione filtro aria',
                    'Replace air filter and inspect throttle body for carbon buildup': 'Sostituisci filtro aria e ispeziona corpo farfalla per accumulo carbonio'
                };
                
                let translatedText = text;
                Object.keys(translations).forEach(key => {
                    translatedText = translatedText.replace(key, translations[key]);
                });
                return translatedText;
            }
            return text;
        }

        // Intelligent OBD-II Data Analysis Function
        async function analyzeOBDData() {
            // Get current language from document or default to English
            const currentLanguage = document.documentElement.getAttribute('data-lang') || 'en';
            const analysis = {
                parameters: {},
                alerts: [],
                recommendations: [],
                riskLevel: 'low',
                score: 100
            };
            
            // Extract OBD data from AI report if available, otherwise fetch directly
            let obdData = {};
            if (aiReportData && aiReportData.obdInsights) {
                obdData = aiReportData.obdInsights;
                
            } else {
                // If AI report not available, try to fetch OBD data directly
                
                try {
                    const response = await secureApiCall(`/api/vehicle/${certificateData.deviceId}/ai-report?lang=it`);
                    if (!response) {
                        console.error('❌ Failed to authenticate for AI report data');
                        return analyzeOBDData({});
                    }
                    const result = await response.json();
                    if (result.success && result.obdInsights) {
                        obdData = result.obdInsights;
                        
                    }
                } catch (error) {
                    console.warn('⚠️ Could not fetch OBD data:', error);
                }
            }
            
            // Extract throttle statistics if available
            let throttleStats = {};
            if (window.throttleData && window.throttleData.statistics) {
                throttleStats = window.throttleData.statistics;
                
            } else {
                
            }
            
            
            
            
            // 1. ENGINE RPM ANALYSIS
            if (obdData.avgEngineRPM !== undefined) {
                const rpm = parseFloat(obdData.avgEngineRPM) || 0;
                analysis.parameters.engineRPM = rpm;
                
                if (rpm > 3500) {
                    analysis.alerts.push({
                        level: 'warning',
                        parameter: 'Engine RPM',
                        value: rpm,
                        message: translateAlertMessage(`High average RPM (${rpm.toFixed(0)}) indicates aggressive driving or engine stress`, currentLanguage)
                    });
                    analysis.recommendations.push({
                        priority: 'high',
                        issue: translateRecommendationText('Engine oil service', currentLanguage),
                        reason: `High RPM operation (${rpm.toFixed(0)}) accelerates oil degradation`,
                        action: translateRecommendationText('Schedule engine oil and filter replacement within 1000km', currentLanguage)
                    });
                    analysis.score -= 15;
                }
                
                if (rpm < 500 && rpm > 0) {
                    analysis.alerts.push({
                        level: 'critical',
                        parameter: 'Engine RPM',
                        value: rpm,
                        message: translateAlertMessage(`Very low idle RPM (${rpm.toFixed(0)}) may indicate engine problems`, currentLanguage)
                    });
                    analysis.recommendations.push({
                        priority: 'critical',
                        issue: translateRecommendationText('Engine diagnostics', currentLanguage),
                        reason: translateRecommendationText(`Abnormally low RPM (${rpm.toFixed(0)}) suggests idle control issues`, currentLanguage),
                        action: translateRecommendationText('Immediate engine inspection required - check idle air control valve', currentLanguage)
                    });
                    analysis.score -= 30;
                }
            }
            
            // 2. COOLANT TEMPERATURE ANALYSIS
            if (obdData.avgCoolantTemp !== undefined) {
                const temp = parseFloat(obdData.avgCoolantTemp) || 0;
                analysis.parameters.coolantTemp = temp;
                
                if (temp > 105) {
                    analysis.alerts.push({
                        level: 'critical',
                        parameter: 'Coolant Temperature',
                        value: temp,
                        message: translateAlertMessage(`High coolant temperature (${temp.toFixed(1)}°C) indicates overheating risk`, currentLanguage)
                    });
                    analysis.recommendations.push({
                        priority: 'critical',
                        issue: translateRecommendationText('Cooling system service', currentLanguage),
                        reason: translateRecommendationText(`Overheating detected (${temp.toFixed(1)}°C). Normal range: 85-95°C`, currentLanguage),
                        action: translateRecommendationText('URGENT: Check thermostat, water pump, radiator, and coolant level', currentLanguage)
                    });
                    analysis.score -= 40;
                } else if (temp > 95) {
                    analysis.alerts.push({
                        level: 'warning',
                        parameter: 'Coolant Temperature',
                        value: temp,
                        message: translateAlertMessage(`Elevated coolant temperature (${temp.toFixed(1)}°C)`, currentLanguage)
                    });
                    analysis.recommendations.push({
                        priority: 'medium',
                        issue: translateRecommendationText('Cooling system inspection', currentLanguage),
                        reason: translateRecommendationText(`Temperature slightly high (${temp.toFixed(1)}°C). Optimal: 85-90°C`, currentLanguage),
                        action: translateRecommendationText('Check coolant level, radiator cleanliness, and thermostat operation', currentLanguage)
                    });
                    analysis.score -= 10;
                }
                
                if (temp < 70 && temp > 0) {
                    analysis.recommendations.push({
                        priority: 'low',
                        issue: translateRecommendationText('Thermostat check', currentLanguage),
                        reason: translateRecommendationText(`Low operating temperature (${temp.toFixed(1)}°C) may indicate faulty thermostat`, currentLanguage),
                        action: translateRecommendationText('Monitor thermostat operation - may be stuck open', currentLanguage)
                    });
                    analysis.score -= 5;
                }
            }
            
            // 3. BATTERY VOLTAGE ANALYSIS
            if (obdData.avgVoltage !== undefined) {
                const voltage = parseFloat(obdData.avgVoltage) || 0;
                analysis.parameters.batteryVoltage = voltage;
                
                if (voltage < 12.4 && voltage > 0) {
                    analysis.alerts.push({
                        level: 'warning',
                        parameter: 'Battery Voltage',
                        value: voltage,
                        message: `Low battery voltage (${voltage.toFixed(2)}V) indicates charging issues`
                    });
                    analysis.recommendations.push({
                        priority: 'high',
                        issue: 'Battery and charging system',
                        reason: `Low voltage (${voltage.toFixed(2)}V). Normal: 12.6-14.4V`,
                        action: 'Test battery, alternator, and charging system immediately'
                    });
                    analysis.score -= 20;
                }
                
                if (voltage > 14.8) {
                    analysis.alerts.push({
                        level: 'warning',
                        parameter: 'Battery Voltage',
                        value: voltage,
                        message: `High voltage (${voltage.toFixed(2)}V) indicates overcharging`
                    });
                    analysis.recommendations.push({
                        priority: 'high',
                        issue: 'Charging system regulation',
                        reason: `Overcharging detected (${voltage.toFixed(2)}V). Risk of battery damage`,
                        action: 'Check alternator voltage regulator and wiring'
                    });
                    analysis.score -= 15;
                }
            }
            
            // 4. THROTTLE POSITION ANALYSIS
            if (throttleStats.averageThrottle !== undefined && !isNaN(throttleStats.averageThrottle)) {
                const avgThrottle = parseFloat(throttleStats.averageThrottle);
                analysis.parameters.avgThrottle = avgThrottle;
                
                if (avgThrottle > 60) {
                    analysis.alerts.push({
                        level: 'info',
                        parameter: 'Throttle Usage',
                        value: avgThrottle,
                        message: `High average throttle usage (${avgThrottle.toFixed(1)}%) indicates aggressive driving`
                    });
                    analysis.recommendations.push({
                        priority: 'medium',
                        issue: 'Air intake system service',
                        reason: `Heavy throttle usage (${avgThrottle.toFixed(1)}%) increases air filter contamination`,
                        action: 'Replace air filter and inspect throttle body for carbon buildup'
                    });
                    analysis.score -= 5;
                }
            }
            
            // 5. ENGINE LOAD ANALYSIS
            if (obdData.avgEngineLoad !== undefined) {
                const load = parseFloat(obdData.avgEngineLoad) || 0;
                analysis.parameters.engineLoad = load;
                
                if (load > 80) {
                    analysis.recommendations.push({
                        priority: 'medium',
                        issue: 'Engine performance check',
                        reason: translateRecommendationText(`High engine load (${load.toFixed(1)}%) may indicate restricted airflow or fuel delivery issues`, currentLanguage),
                        action: 'Inspect air filter, fuel filter, and perform engine diagnostics'
                    });
                    analysis.score -= 10;
                }
            }
            
            // 6. MASS AIR FLOW (MAF) ANALYSIS  
            if (obdData.avgMAF !== undefined && obdData.avgMAF > 0) {
                const maf = parseFloat(obdData.avgMAF);
                analysis.parameters.maf = maf;
                
                // MAF values are vehicle-specific, but extreme values indicate problems
                if (maf > 150 || maf < 5) {
                    analysis.recommendations.push({
                        priority: 'medium',
                        issue: 'Air intake system service',
                        reason: `Abnormal mass air flow reading (${maf.toFixed(2)}g/sec) suggests MAF sensor or air filter issues`,
                        action: 'Clean/replace MAF sensor and air filter'
                    });
                    analysis.score -= 8;
                }
            }
            
            // 7. INTAKE TEMPERATURE ANALYSIS
            if (obdData.avgIntakeTemp !== undefined && obdData.avgIntakeTemp > 0) {
                const intakeTemp = parseFloat(obdData.avgIntakeTemp);
                analysis.parameters.intakeTemp = intakeTemp;
                
                if (intakeTemp > 60) {
                    analysis.recommendations.push({
                        priority: 'low',
                        issue: 'Air intake temperature optimization',
                        reason: translateRecommendationText(`High intake air temperature (${intakeTemp.toFixed(1)}°C) reduces engine efficiency`, currentLanguage),
                        action: 'Check air intake routing and consider heat shield inspection'
                    });
                    analysis.score -= 3;
                }
            }
            
            // 8. DIAGNOSTIC TROUBLE CODES (DTC) ANALYSIS
            if (obdData.totalDTCs !== undefined && obdData.totalDTCs > 0) {
                analysis.alerts.push({
                    level: 'critical',
                    parameter: 'Diagnostic Codes',
                    value: obdData.totalDTCs,
                    message: `${obdData.totalDTCs} active diagnostic trouble codes detected`
                });
                analysis.recommendations.push({
                    priority: 'critical',
                    issue: 'Diagnostic code resolution',
                    reason: `${obdData.totalDTCs} active error codes require immediate attention`,
                    action: 'URGENT: Perform complete OBD-II scan and resolve all active codes'
                });
                analysis.score -= (obdData.totalDTCs * 10);
            }
            
            // DETERMINE OVERALL RISK LEVEL
            if (analysis.score >= 85) {
                analysis.riskLevel = 'low';
            } else if (analysis.score >= 70) {
                analysis.riskLevel = 'medium';
            } else if (analysis.score >= 50) {
                analysis.riskLevel = 'high';
            } else {
                analysis.riskLevel = 'critical';
            }
            
            // Sort recommendations by priority
            const priorityOrder = { 'critical': 0, 'high': 1, 'medium': 2, 'low': 3 };
            analysis.recommendations.sort((a, b) => priorityOrder[a.priority] - priorityOrder[b.priority]);
            
            return analysis;
        }

        // Generate OBD-II Data-Driven Maintenance Report
        async function generateVehicleMaintenanceReport(vehicle, certificate) {
            const brand = vehicle.brand?.toLowerCase() || '';
            const model = vehicle.model?.toLowerCase() || '';
            const year = parseInt(vehicle.year) || new Date().getFullYear();
            const fuelType = vehicle.fuelType?.toLowerCase() || 'gasoline';
            const age = new Date().getFullYear() - year;
            const odometer = certificate.odometer || 0;
            
            
            

            // Common issues database by brand and age
            const knownIssues = {
                dacia: {
                    common: ['Air conditioning system', 'Electrical issues', 'Suspension components'],
                    age_related: age > 5 ? ['Engine mounts', 'Timing belt', 'Brake system'] : [],
                    mileage_related: odometer > 100000 ? ['Clutch replacement', 'Transmission service'] : []
                },
                bmw: {
                    common: ['Water pump', 'Thermostat', 'Cooling system', 'Electronic components'],
                    age_related: age > 7 ? ['Turbocharger', 'High-pressure fuel pump', 'Carbon buildup'] : [],
                    mileage_related: odometer > 120000 ? ['Timing chain', 'Injectors'] : []
                },
                mercedes: {
                    common: ['Air suspension', 'SBC brake system', 'Electrical harness'],
                    age_related: age > 6 ? ['Engine mounts', 'Transmission conductor plate'] : [],
                    mileage_related: odometer > 150000 ? ['Diesel particulate filter', 'Turbocharger'] : []
                },
                audi: {
                    common: ['Oil consumption', 'Carbon buildup', 'DSG transmission'],
                    age_related: age > 5 ? ['Timing chain tensioner', 'Water pump'] : [],
                    mileage_related: odometer > 100000 ? ['Turbocharger', 'DPF system'] : []
                },
                volkswagen: {
                    common: ['DSG transmission', 'Timing chain', 'Water pump'],
                    age_related: age > 6 ? ['Thermostat housing', 'Carbon buildup'] : [],
                    mileage_related: odometer > 120000 ? ['Fuel injectors', 'EGR valve'] : []
                }
            };

            // Fuel type specific issues
            const fuelIssues = {
                gasoline: ['Spark plugs', 'Ignition coils', 'Fuel pump', 'Air filter'],
                diesel: ['DPF system', 'EGR valve', 'Glow plugs', 'Diesel filter'],
                hybrid: ['Battery pack', 'Inverter', 'Electric motor', 'Hybrid system coolant']
            };

            // SMART OBD-II DATA ANALYSIS
            const obdAnalysis = await analyzeOBDData();
            
            
            // Get brand-specific issues
            const vehicleIssues = knownIssues[brand] || knownIssues.dacia; // Default fallback
            
            // Combine static issues with OBD-driven insights
            const staticIssues = [
                ...vehicleIssues.common,
                ...vehicleIssues.age_related,
                ...vehicleIssues.mileage_related,
                ...(fuelIssues[fuelType] || fuelIssues.gasoline)
            ];
            
            // Smart OBD-II derived issues
            const obdDrivenIssues = obdAnalysis.recommendations.map(rec => rec.issue);
            
            // Combine all issues
            const allIssues = [...staticIssues, ...obdDrivenIssues];

            // Generate maintenance schedule
            const maintenanceSchedule = [];
            
            if (odometer < 15000) {
                maintenanceSchedule.push('First service inspection');
            }
            if (odometer > 30000 && odometer < 40000) {
                maintenanceSchedule.push('Major service due');
            }
            if (age > 3) {
                maintenanceSchedule.push('Brake fluid replacement');
            }
            if (age > 4) {
                maintenanceSchedule.push('Timing belt inspection');
            }

            return {
                vehicleInfo: `${vehicle.brand} ${vehicle.model} ${vehicle.year}`,
                age: age,
                odometer: odometer,
                fuelType: fuelType,
                knownIssues: [...new Set(allIssues)], // Remove duplicates
                maintenanceSchedule: maintenanceSchedule,
                urgency: age > 7 || odometer > 150000 ? 'high' : age > 4 || odometer > 100000 ? 'medium' : 'low',
                obdAnalysis: obdAnalysis // Include OBD-II analysis results
            };
        }

        // Function to translate OBD parameter names to Italian
        function getParamNameIt(param) {
            const paramTranslations = {
                'Engine Load': 'Carico Motore',
                'Coolant Temperature': 'Temperatura Liquido',
                'Engine RPM': 'Giri Motore',
                'Timing Advance': 'Anticipo Accensione',
                'Absolute Load': 'Carico Assoluto',
                'Short Fuel Trim': 'Correzione Carburante',
                'Fuel Level': 'Livello Carburante',
                'Barometric Pressure': 'Pressione Barometrica',
                'Intake MAP': 'Pressione Aspirazione',
                'Intake Air Temperature': 'Temperatura Aria',
                'Throttle Position': 'Posizione Farfalla',
                'Number of DTCs': 'Numero Errori',
                'Vehicle Speed': 'Velocità Veicolo',
                'Control Module Voltage': 'Tensione Modulo',
                'Engine Load Calc': 'Carico Motore Calc',
                'Absolute Load Value': 'Valore Carico Assoluto',
                'Intake MAP2': 'Pressione Aspirazione 2',
                'Fuel Rail Pressure': 'Pressione Rail Carburante',
                'Run Time': 'Tempo Funzionamento',
                'Distance MIL': 'Distanza Spia Motore',
                'Distance Codes Cleared': 'Distanza Codici Cancellati',
                'Ambient Temp': 'Temperatura Ambiente',
                'Absolute Fuel Rail Pressure': 'Pressione Rail Carburante Assoluta',
                'Fuel Injection Timing': 'Tempo Iniezione Carburante',
                'Engine Fuel Rate': 'Consumo Carburante Motore',
                'Commanded Equivalence': 'Equivalenza Comandata'
            };
            
            return paramTranslations[param] || param.replace(/([A-Z])/g, ' $1').trim();
        }

        // Display Smart OBD-II Based Maintenance Report
        function displayMaintenanceReport(report) {
            

            
            const contentDiv = document.getElementById('maintenanceContent');
            
            
            if (!contentDiv) {
                console.error('❌ maintenanceContent element not found');
                return;
            }
            
            if (!report) {
                console.error('❌ No report data provided');
                contentDiv.innerHTML = '<div class="text-red-500 p-4" data-it="Errore: Nessun dato del report di manutenzione disponibile" data-en="Error: No maintenance report data available">Error: No maintenance report data available</div>';
                return;
            }
            
            // Add debug info to check data structure
            if (!report.obdAnalysis) {
                console.error('❌ Report missing obdAnalysis property');
                contentDiv.innerHTML = `
                    <div class="text-yellow-500 p-4">
                        <h3 class="font-bold mb-2">DEBUG: Report Data Structure Issue</h3>
                        <pre class="text-xs bg-gray-800 p-2 rounded overflow-auto">${JSON.stringify(report, null, 2)}</pre>
                    </div>
                `;
                return;
            }
            const obd = report.obdAnalysis || {};
            
            // Risk level colors
            const riskColors = {
                low: { bg: 'from-green-800/20 to-emerald-800/20', border: 'border-green-500/30', text: 'text-green-400', icon: '✅' },
                medium: { bg: 'from-yellow-800/20 to-orange-800/20', border: 'border-yellow-500/30', text: 'text-yellow-400', icon: '⚠️' },
                high: { bg: 'from-orange-800/20 to-red-800/20', border: 'border-orange-500/30', text: 'text-orange-400', icon: '🚨' },
                critical: { bg: 'from-red-800/20 to-red-900/20', border: 'border-red-500/30', text: 'text-red-400', icon: '🔥' }
            };
            
            const riskLevel = obd.riskLevel || 'low';
            const riskStyle = riskColors[riskLevel];
            const healthScore = obd.score || 100;
            
            // Priority colors for recommendations
            const priorityColors = {
                critical: 'bg-red-600/20 border-red-500/50 text-red-300',
                high: 'bg-orange-600/20 border-orange-500/50 text-orange-300',
                medium: 'bg-yellow-600/20 border-yellow-500/50 text-yellow-300',
                low: 'bg-blue-600/20 border-blue-500/50 text-blue-300'
            };

            const reportHtml = `
                <div class="space-y-6">
                    <!-- OBD-II Health Score Header -->
                    <div class="bg-gradient-to-r ${riskStyle.bg} rounded-xl p-6 border ${riskStyle.border}">
                        <div class="flex items-center justify-between mb-6">
                            <div>
                                <h3 class="text-2xl font-bold text-white flex items-center gap-2">
                                    ${riskStyle.icon} Smart Predictive Analysis
                                </h3>
                                <p class="text-sm text-gray-300" data-it="Basato su dati di telemetria OBD-II reali" data-en="Based on real OBD-II telemetry data">Based on real OBD-II telemetry data</p>
                            </div>
                            <div class="text-right">
                                <div class="text-3xl font-bold ${riskStyle.text}">${healthScore}/100</div>
                                <div class="text-sm text-gray-300" data-it="Punteggio Salute" data-en="Health Score">Health Score</div>
                            </div>
                        </div>
                        
                        <!-- Health Score Progress Bar -->
                        <div class="mb-4">
                            <div class="flex justify-between text-sm text-gray-300 mb-2">
                                <span>Vehicle Health</span>
                                <span>${riskLevel.toUpperCase()} RISK</span>
                            </div>
                            <div class="w-full bg-gray-700 rounded-full h-3">
                                <div class="h-3 rounded-full transition-all duration-500 ${healthScore >= 85 ? 'bg-green-500' : healthScore >= 70 ? 'bg-yellow-500' : healthScore >= 50 ? 'bg-orange-500' : 'bg-red-500'}" 
                                     style="width: ${healthScore}%"></div>
                            </div>
                        </div>
                        
                        <!-- Quick Vehicle Stats -->
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="text-center p-3 bg-white/5 rounded-lg">
                                <div class="text-lg font-bold text-white">${report.vehicleInfo}</div>
                                <div class="text-xs text-gray-300" data-it="Veicolo" data-en="Vehicle">Vehicle</div>
                            </div>
                            <div class="text-center p-3 bg-white/5 rounded-lg">
                                <div class="text-lg font-bold text-white" data-it="${report.age} anni" data-en="${report.age} years">${report.age} years</div>
                                <div class="text-xs text-gray-300" data-it="Età" data-en="Age">Age</div>
                            </div>
                            <div class="text-center p-3 bg-white/5 rounded-lg">
                                <div class="text-lg font-bold text-white">${report.odometer.toLocaleString()} km</div>
                                <div class="text-xs text-gray-300" data-it="Chilometraggio" data-en="Mileage">Mileage</div>
                            </div>
                            <div class="text-center p-3 bg-white/5 rounded-lg">
                                <div class="text-lg font-bold text-white">${report.fuelType.toUpperCase()}</div>
                                <div class="text-xs text-gray-300" data-it="Tipo Carburante" data-en="Fuel Type">Fuel Type</div>
                            </div>
                        </div>
                    </div>
                    
                    ${obd.alerts && obd.alerts.length > 0 ? `
                    <!-- OBD-II Critical Alerts -->
                    <div class="bg-gradient-to-br from-red-900/30 to-red-800/30 rounded-xl p-6 border border-red-500/30">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="p-2 bg-red-600/20 rounded-lg">
                                <svg class="w-5 h-5 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"/>
                                </svg>
                            </div>
                                                            <h4 class="text-lg font-semibold text-gray-900 dark:text-white" data-it="🚨 Allerte Parametri OBD-II" data-en="🚨 OBD-II Parameter Alerts">🚨 OBD-II Parameter Alerts</h4>
                        </div>
                        
                        <div class="space-y-3">
                            ${obd.alerts.map(alert => `
                                <div class="flex items-start gap-3 p-4 bg-red-800/20 rounded-lg border border-red-600/30">
                                    <div class="flex-shrink-0 w-2 h-2 rounded-full ${alert.level === 'critical' ? 'bg-red-500' : alert.level === 'warning' ? 'bg-yellow-500' : 'bg-blue-500'} mt-2"></div>
                                    <div class="flex-1">
                                        <div class="flex items-center gap-2 mb-1">
                                            <span class="font-semibold text-white">${alert.parameter}</span>
                                            <span class="px-2 py-1 text-xs rounded-full ${alert.level === 'critical' ? 'bg-red-600 text-white' : alert.level === 'warning' ? 'bg-yellow-600 text-white' : 'bg-blue-600 text-white'}">${alert.level.toUpperCase()}</span>
                                        </div>
                                        <p class="text-sm text-gray-300">${alert.message}</p>
                                        <div class="text-xs text-gray-400 mt-1" data-it="Valore Attuale:" data-en="Current Value:">Current Value: <span class="text-white font-mono">${alert.value}</span></div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}
                    
                    ${obd.recommendations && obd.recommendations.length > 0 ? `
                    <!-- Smart OBD-II Recommendations -->
                    <div class="bg-gradient-to-br from-purple-900/30 to-indigo-900/30 rounded-xl p-6 border border-purple-500/30">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="p-2 bg-purple-600/20 rounded-lg">
                                <svg class="w-5 h-5 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                                </svg>
                            </div>
                                                            <h4 class="text-lg font-semibold text-gray-900 dark:text-white" data-it="🧠 Raccomandazioni di Manutenzione Guidate dall'AI" data-en="🧠 AI-Driven Maintenance Recommendations">🧠 AI-Driven Maintenance Recommendations</h4>
                        </div>
                        
                        <div class="space-y-4">
                            ${obd.recommendations.map(rec => `
                                <div class="p-4 rounded-lg border ${priorityColors[rec.priority]}">
                                    <div class="flex items-start justify-between mb-2">
                                        <div class="flex items-center gap-2">
                                            <span class="px-2 py-1 text-xs rounded-full font-semibold ${rec.priority === 'critical' ? 'bg-red-600 text-white' : rec.priority === 'high' ? 'bg-orange-600 text-white' : rec.priority === 'medium' ? 'bg-yellow-600 text-black' : 'bg-blue-600 text-white'}">${rec.priority.toUpperCase()}</span>
                                            <h5 class="font-semibold text-white">${rec.issue}</h5>
                                        </div>
                                    </div>
                                    <p class="text-sm text-gray-300 mb-2">${rec.reason}</p>
                                    <div class="flex items-start gap-2">
                                        <svg class="w-4 h-4 text-green-400 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                        </svg>
                                        <span class="text-sm text-green-300 font-medium">${rec.action}</span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}
                    
                    ${Object.keys(obd.parameters || {}).length > 0 ? `
                    <!-- OBD-II Parameters Monitored -->
                    <div class="bg-gradient-to-br from-gray-800/30 to-gray-900/30 rounded-xl p-6 border border-gray-600/30">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="p-2 bg-gray-600/20 rounded-lg">
                                <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                                </svg>
                            </div>
                                                            <h4 class="text-lg font-semibold text-gray-900 dark:text-white" data-it="📊 Parametri OBD-II Analizzati" data-en="📊 OBD-II Parameters Analyzed">📊 OBD-II Parameters Analyzed</h4>
                        </div>
                        
                        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                            ${Object.entries(obd.parameters).map(([param, value]) => {
                                const displayValue = typeof value === 'number' ? value.toFixed(param.includes('Temp') ? 1 : param.includes('voltage') || param.includes('Voltage') ? 2 : 0) : value;
                                const unit = param.includes('Temp') ? '°C' : param.includes('voltage') || param.includes('Voltage') ? 'V' : param.includes('RPM') ? ' RPM' : param.includes('throttle') || param.includes('Load') ? '%' : param.includes('maf') || param.includes('MAF') ? 'g/s' : '';
                                return `
                                <div class="text-center p-3 bg-gray-700/20 rounded-lg">
                                    <div class="text-lg font-bold text-white">${displayValue}${unit}</div>
                                    <div class="text-xs text-gray-300" data-it="${getParamNameIt(param)}" data-en="${param.replace(/([A-Z])/g, ' $1').trim()}">${param.replace(/([A-Z])/g, ' $1').trim()}</div>
                                </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                    ` : ''}
                    
                    <!-- Traditional Known Issues (if any) -->
                    ${report.knownIssues && report.knownIssues.length > 0 ? `
                    <div class="bg-gradient-to-br from-orange-800/30 to-red-800/30 rounded-xl p-6 border border-orange-600/30">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="p-2 bg-orange-600/20 rounded-lg">
                                <svg class="w-5 h-5 text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"/>
                                </svg>
                            </div>
                                                            <h4 class="text-lg font-semibold text-gray-900 dark:text-white" data-it="🔧 Elementi di Manutenzione Tradizionale" data-en="🔧 Traditional Maintenance Items">🔧 Traditional Maintenance Items</h4>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            ${report.knownIssues.map(issue => `
                                <div class="flex items-center gap-3 p-3 bg-orange-700/20 rounded-lg">
                                    <svg class="w-4 h-4 text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                    <span class="text-orange-200 text-sm">${issue}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}
                    
                    <!-- Data Sources Footer -->
                    <div class="text-center text-sm text-gray-400">
                        <div class="flex items-center justify-center gap-6 flex-wrap">
                            <span>🔬 ${Object.keys(obd.parameters || {}).length} OBD-II parameters analyzed</span>
                            <span>⚡ Real-time telemetry data</span>
                            <span>🧠 AI-powered analysis</span>
                            <span>📊 Health Score: ${healthScore}/100</span>
                        </div>
                    </div>
                </div>
            `;
            
            contentDiv.innerHTML = reportHtml;
        }

        // Display Maintenance Report Error
        function displayMaintenanceReportError(errorMessage) {
            const contentDiv = document.getElementById('maintenanceContent');
            contentDiv.innerHTML = `
                <div class="text-center py-8">
                    <div class="inline-flex items-center justify-center w-16 h-16 bg-red-600/20 rounded-full mb-4">
                        <svg class="w-8 h-8 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"/>
                        </svg>
                    </div>
                                                    <h3 class="text-xl font-semibold text-white mb-2" data-it="Analisi Fallita" data-en="Analysis Failed">Analysis Failed</h3>
                    <p class="text-red-300 mb-4">${errorMessage}</p>
                    <p class="text-gray-400 text-sm" data-it="Riprova o contatta il supporto." data-en="Please try again or contact support.">Please try again or contact support.</p>
                </div>
            `;
        }

        // Initialize page - REMOVED DUPLICATE DOMContentLoaded

        // ========================================
        // SMART MARKETING COMMUNICATIONS SYSTEM
        // ========================================

        // Get Dealer Company Name from database via API
        function getDealerCompanyName() {
            try {
                
                
                // PRIORITY 1: Use dealer data loaded from database API
                if (window.dealerData) {
                    
                    // Try different possible company name fields from database
                    const companyName = window.dealerData.company || 
                                      window.dealerData.companyName || 
                                      window.dealerData.name ||
                                      window.dealerData.dealerName;
                    if (companyName && companyName.trim() !== '') {
        
                        return companyName.trim();
                    }
                }

                // PRIORITY 2: Check localStorage for cached dealer information
                const authData = localStorage.getItem('user') || localStorage.getItem('authData');
                if (authData) {
                    const userData = JSON.parse(authData);
                    const companyName = userData.company || userData.companyName || userData.dealerName || userData.name;
                    if (companyName && companyName.trim() !== '') {
        
                        return companyName.trim();
                    }
                }
                
                // PRIORITY 3: Final fallback based on authenticated email domain  
                if (authData) {
                    const userData = JSON.parse(authData);
                    if (userData.email) {
                        const domain = userData.email.split('@')[1];
                        if (domain === 'mobisat.com') {
                            
                            return 'Mobisat S.r.l.';
                        }
                        // Extract company name from domain for other dealers
                        const companyFromDomain = domain.split('.')[0];
                        const fallbackName = companyFromDomain.charAt(0).toUpperCase() + companyFromDomain.slice(1) + ' S.r.l.';
                        
                        return fallbackName;
                    }
                }
                
                console.warn('⚠️ No dealer company name found, using fallback');
                return 'Concessionaria';
            } catch (error) {
                console.warn('❌ Error getting dealer company name:', error);
                return 'Concessionaria';
            }
        }

        // Load dealer data if not available
        async function ensureDealerData() {
            if (!window.dealerData) {
                try {
                    
                    const authData = localStorage.getItem('user') || localStorage.getItem('authData');
                    
                    if (authData) {
                        const userData = JSON.parse(authData);
                        const dealerId = userData.dealerId || 1; // Default to dealer 1 if not specified
                        
                        
                        const response = await secureApiCall(`/api/dealer/${dealerId}`);
                        if (!response) {
                            console.error('❌ Failed to authenticate for dealer data');
                            return 'Unknown Company';
                        }
                        
                        if (response.ok) {
                            window.dealerData = await response.json();
                            
                        } else {
                            console.error('❌ Failed to load dealer data:', response.status, response.statusText);
                        }
                    }
                } catch (error) {
                    console.warn('❌ Could not load dealer data:', error);
                }
            } else {
                
            }
        }

        // Generate Smart Marketing Communications
        async function generateSmartCommunications() {
            
            
            
            
            
            const contentDiv = document.getElementById('communicationsContent');
            
            // Check if element exists before proceeding
            if (!contentDiv) {
                console.error('❌ communicationsContent div not found in DOM');
                return;
            }
            
            try {
                // Show loading state
                contentDiv.innerHTML = `
                    <div class="text-center py-8">
                        <div class="inline-flex items-center justify-center w-16 h-16 bg-green-600/20 rounded-full mb-4 animate-pulse">
                            <svg class="w-8 h-8 text-green-400 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                            </svg>
                        </div>
                        <h3 class="text-xl font-semibold text-white mb-2">Analyzing Vehicle & Generating Communications...</h3>
                        <p class="text-green-200">First generating AI report, then creating personalized messages with real telematic data</p>
                    </div>
                `;
                
                // STEP 1: Ensure we have fresh AI report data with all telematic insights
                
                
                // Force refresh AI report to get latest data
                // Try multiple sources for deviceId
                let deviceId = window.certificateData?.deviceId || 
                              window.vehicleData?.deviceId || 
                              window.analytics?.deviceId ||
                              (window.certificateData && window.certificateData.id);
                
                // Fallback: Extract from URL parameters if global variables not ready
                if (!deviceId) {
                    const urlParams = new URLSearchParams(window.location.search);
                    const vehicleDataParam = urlParams.get('vehicleData');
                    if (vehicleDataParam) {
                        try {
                            const parsedData = JSON.parse(decodeURIComponent(vehicleDataParam));
                            deviceId = parsedData.deviceId;
                            
                        } catch (e) {
                            console.warn('⚠️ Could not parse vehicleData from URL:', e);
                        }
                    }
                }
                

                
                if (!deviceId) {
                    throw new Error('Device ID not available. Check that vehicle data is loaded properly.');
                }
                
                
                
                // Get comprehensive AI report with all OBD data
                const aiResponse = await secureApiCall(`/api/vehicle/${deviceId}/ai-report?lang=it`);
                if (!aiResponse) {
                    throw new Error('Failed to authenticate for AI report');
                }
                if (!aiResponse.ok) {
                    throw new Error('Failed to generate AI report');
                }
                const aiReportData = await aiResponse.json();
                
                
                // STEP 2: Ensure dealer data is loaded from database
                await ensureDealerData();
                
                // STEP 3: Get current data
                const clientData = window.certificateData?.client;
                const vehicleData = window.certificateData?.vehicle;
                const certificate = window.certificateData;
                
                // Debug: Log all data sources
                
                
                

                
                // If client data is not loaded, use URL parameter data as fallback
                let finalClientData = clientData;
                let finalVehicleData = vehicleData;
                
                if (!finalClientData || !finalVehicleData) {
                    
                    const urlParams = new URLSearchParams(window.location.search);
                    const vehicleDataParam = urlParams.get('vehicleData');
                    if (vehicleDataParam) {
                        try {
                            const parsedData = JSON.parse(decodeURIComponent(vehicleDataParam));
                            
                            
                            finalClientData = finalClientData || parsedData.client;
                            finalVehicleData = finalVehicleData || parsedData.vehicle;
                            
                            
                            
                        } catch (e) {
                            console.error('❌ Could not parse vehicle data from URL:', e);
                        }
                    }
                }
                
                if (!finalClientData) {
                    throw new Error('Client data not available for communications');
                }
                
                if (!finalVehicleData) {
                    throw new Error('Vehicle data not available for communications');
                }
                
                // STEP 4: Generate communications with REAL AI data
                const communications = generateCommunicationContent(finalClientData, finalVehicleData, certificate, aiReportData);
                
                
                
                if (!communications) {
                    throw new Error('Failed to generate communications - check input data');
                }
                
                displayCommunications(communications);
                
            } catch (error) {
                console.error('❌ Error generating communications:', error);
                displayCommunicationError(error.message);
            }
        }

        // Generate Communication Content
        function generateCommunicationContent(client, vehicle, certificate, aiReportData) {
            
            
            // Always use real client name with proper Italian greeting
            const clientFirstName = client?.firstName || '';
            const clientLastName = client?.lastName || '';
            const fullClientName = clientFirstName && clientLastName ? `${clientFirstName} ${clientLastName}` : 'Cliente';
            
            // Generate proper Italian greeting based on gender (heuristic: names ending in 'a' are typically female)
            const greeting = clientFirstName ? 
                (clientFirstName.toLowerCase().endsWith('a') ? 'Cara' : 'Caro') + ` ${clientFirstName}` :
                'Gentile Cliente';
            
            const vehicleName = vehicle ? `${vehicle.brand} ${vehicle.model} ${vehicle.year}` : 'il Suo veicolo';
            
            // Get dealer company name from database (loaded in window.dealerData)
            const dealerName = getDealerCompanyName() || 'Concessionaria';
            
            
            // Extract real OBD insights from AI report
            const keyInsights = [];
            const healthScore = 85; // Default fallback
            let actualHealthScore = healthScore;
            
            // Extract insights from AI report data
            if (aiReportData) {
                
                
                // Look for OBD insights in the AI report
                if (aiReportData.obdInsights) {
                    const obd = aiReportData.obdInsights;
                    
                    
                    // Generate specific insights based on real OBD data
                    if (obd.avgCoolantTemp && parseFloat(obd.avgCoolantTemp) > 95) {
                        keyInsights.push({
                            message: `Temperatura liquido di raffreddamento elevata (${obd.avgCoolantTemp}°C)`,
                            reason: 'Controllo sistema di raffreddamento consigliato',
                            priority: 'high'
                        });
                    }
                    
                    if (obd.avgEngineRPM && parseFloat(obd.avgEngineRPM) > 2500) {
                        keyInsights.push({
                            message: `Regime motore medio elevato (${obd.avgEngineRPM} RPM)`,
                            reason: 'Stile di guida sportivo - controllo usura componenti',
                            priority: 'medium'
                        });
                    }
                    
                    if (obd.avgVoltage && parseFloat(obd.avgVoltage) < 12.5) {
                        keyInsights.push({
                            message: `Tensione batteria bassa (${obd.avgVoltage}V)`,
                            reason: 'Test batteria e sistema di ricarica necessario',
                            priority: 'high'
                        });
                    }
                    
                    if (obd.avgThrottle && parseFloat(obd.avgThrottle) > 30) {
                        keyInsights.push({
                            message: `Utilizzo frequente dell'acceleratore (${obd.avgThrottle}%)`,
                            reason: 'Controllo sistema di alimentazione e filtri',
                            priority: 'medium'
                        });
                    }
                    
                    // Calculate health score based on parameters
                    let score = 100;
                    if (obd.avgCoolantTemp && parseFloat(obd.avgCoolantTemp) > 95) score -= 15;
                    if (obd.avgVoltage && parseFloat(obd.avgVoltage) < 12.5) score -= 20;
                    if (obd.avgThrottle && parseFloat(obd.avgThrottle) > 40) score -= 10;
                    actualHealthScore = Math.max(score, 50);
                }
                
                // If no specific OBD insights, use AI report text to extract key points
                if (keyInsights.length === 0 && aiReportData.report) {
                    
                    // Parse common patterns from AI report text
                    const reportText = aiReportData.report.toLowerCase();
                    
                    if (reportText.includes('temperatura') && reportText.includes('alta')) {
                        keyInsights.push({
                            message: 'Temperatura motore sopra la norma rilevata',
                            reason: 'Controllo sistema di raffreddamento raccomandato',
                            priority: 'high'
                        });
                    }
                    
                    if (reportText.includes('batteria') || reportText.includes('tensione')) {
                        keyInsights.push({
                            message: 'Parametri elettrici da monitorare',
                            reason: 'Verifica sistema elettrico e batteria',
                            priority: 'medium'
                        });
                    }
                    
                    if (reportText.includes('prestazioni') || reportText.includes('potenza')) {
                        keyInsights.push({
                            message: 'Prestazioni motore da ottimizzare',
                            reason: 'Controllo generale delle prestazioni',
                            priority: 'medium'
                        });
                    }
                }
            }
            
            // Fallback insights if none found
            if (keyInsights.length === 0) {
                keyInsights.push({
                    message: 'Parametri di funzionamento monitorati',
                    reason: 'Controllo preventivo consigliato per mantenere prestazioni ottimali',
                    priority: 'low'
                });
            }
            
            
            
            // Determine urgency level based on insights priorities
            const urgencyLevel = keyInsights.some(insight => insight.priority === 'high') ? 'alta' : 
                                keyInsights.some(insight => insight.priority === 'medium') ? 'media' : 'bassa';
            
            
            
            return {
                email: {
                    friendly: generateFriendlyEmail(greeting, fullClientName, vehicleName, dealerName, keyInsights, actualHealthScore, urgencyLevel),
                    professional: generateProfessionalEmail(greeting, fullClientName, vehicleName, dealerName, keyInsights, actualHealthScore, urgencyLevel),
                    neutral: generateNeutralEmail(greeting, fullClientName, vehicleName, dealerName, keyInsights, actualHealthScore, urgencyLevel)
                },
                sms: generateSMS(greeting, fullClientName, vehicleName, dealerName, keyInsights, urgencyLevel),
                whatsapp: generateWhatsApp(greeting, fullClientName, vehicleName, dealerName, keyInsights, actualHealthScore, urgencyLevel)
            };
        }

        // Email Templates
        function generateFriendlyEmail(greeting, fullClientName, vehicleName, dealerName, insights, healthScore, urgency) {
            const isFirstPerson = greeting.includes('Caro') || greeting.includes('Cara');
            const firstName = greeting.split(' ')[1] || fullClientName;
            
            const subject = `🚗 ${firstName}, il ${isFirstPerson ? 'tuo' : 'Suo'} ${vehicleName} ha bisogno di attenzioni!`;
            
            const body = `${greeting},

${isFirstPerson ? 'Spero tu stia bene! 😊' : 'Speriamo che stia bene! 😊'}

${isFirstPerson ? 'Ti scrivo' : 'Le scriviamo'} perché la nostra intelligenza artificiale ha appena completato un'analisi approfondita del ${isFirstPerson ? 'tuo' : 'Suo'} ${vehicleName}, e abbiamo scoperto alcune cose interessanti che potrebbero interessar${isFirstPerson ? 'ti' : 'Le'}.

🔍 Cosa abbiamo trovato:
${isFirstPerson ? 'La tua auto' : 'Il Suo veicolo'} ha un punteggio di salute generale di ${healthScore}/100, il che è ${healthScore >= 80 ? 'abbastanza buono' : 'da monitorare'}! Tuttavia, la nostra analisi AI ha identificato alcuni punti che meritano ${isFirstPerson ? 'la tua' : 'la Sua'} attenzione${urgency === 'alta' ? ' con una certa urgenza' : ''}:

${insights.map(insight => `• ${insight.message} - ${insight.reason}`).join('\n')}

💡 Perché ${isFirstPerson ? 'te lo stiamo dicendo' : 'glielo stiamo comunicando'}?
Crediamo nella trasparenza totale con i nostri clienti. Questi dati non arrivano da supposizioni, ma da un'analisi intelligente dei parametri reali del ${isFirstPerson ? 'tuo' : 'Suo'} veicolo (OBD-II) che monitoriamo costantemente per ${isFirstPerson ? 'il tuo' : 'il Suo'} bene.

🎯 Cosa possiamo fare insieme:
Sono sicuro che insieme possiamo risolvere tutto questo rapidamente e mantenere ${isFirstPerson ? 'la tua' : 'la Sua'} ${vehicleName} in perfetta forma. Il nostro team di esperti è pronto ad accoglier${isFirstPerson ? 'ti' : 'La'} con un servizio su misura per le ${isFirstPerson ? 'tue' : 'Sue'} specifiche esigenze.

⏰ Prendiamo un appuntamento?
${isFirstPerson ? 'Chiamaci' : 'Ci chiami'} oggi stesso al nostro numero verde o ${isFirstPerson ? 'passa' : 'passi'} direttamente in concessionaria. Saremo felici di prenderci cura del ${isFirstPerson ? 'tuo' : 'Suo'} ${vehicleName} con la professionalità e l'attenzione che merit${isFirstPerson ? 'i' : 'a'}.

${isFirstPerson ? 'Ti aspettiamo' : 'La aspettiamo'} presto!

Un caro saluto,
Il Team ${dealerName}

P.S. Ricorda che la prevenzione è sempre meno costosa della riparazione! 💪`;
            
            return { subject, body };
        }

        function generateProfessionalEmail(greeting, fullClientName, vehicleName, dealerName, insights, healthScore, urgency) {
            const isFirstPerson = greeting.includes('Caro') || greeting.includes('Cara');
            const firstName = greeting.split(' ')[1] || fullClientName;
            
            const subject = `Analisi tecnica completata - ${vehicleName}${isFirstPerson ? ` di ${firstName}` : ''}`;
            const body = `${greeting.replace('Caro', 'Gentile').replace('Cara', 'Gentile')},

La contatto in seguito all'analisi tecnica computerizzata effettuata sui parametri di funzionamento del Suo ${vehicleName}.

RISULTATI DELL'ANALISI AI:
Il nostro sistema di intelligenza artificiale ha elaborato i dati telemetrici del Suo veicolo, generando un punteggio di salute complessivo di ${healthScore}/100.

RILEVAZIONI SIGNIFICATIVE:
L'analisi ha evidenziato i seguenti elementi che richiedono la Sua attenzione${urgency === 'alta' ? ' prioritaria' : ''}:

${insights.map((insight, index) => `${index + 1}. ${insight.message} - ${insight.reason}`).join('\n')}

TRASPARENZA E METODOLOGIA:
Questa comunicazione è stata generata automaticamente sulla base di dati reali OBD-II del Suo veicolo. Il nostro approccio basato sull'intelligenza artificiale ci consente di identificare precocemente potenziali problematiche, nell'interesse della Sua sicurezza e del contenimento dei costi di manutenzione.

AZIONE CONSIGLIATA:
La invitiamo a contattare il nostro servizio clienti per programmare un intervento tecnico mirato. Il nostro staff qualificato è a Sua disposizione per fornire un servizio personalizzato e risolutivo.

CONTATTI:
Per fissare un appuntamento, può contattarci telefonicamente o recarsi direttamente presso la nostra sede.

Restiamo a Sua completa disposizione per ogni chiarimento.

Cordiali saluti,

${dealerName}
Servizio Assistenza Tecnica

---
Questa comunicazione è stata personalizzata attraverso analisi AI per garantire la massima precisione e rilevanza per il Suo specifico veicolo.`;
            
            return { subject, body };
        }

        function generateNeutralEmail(greeting, fullClientName, vehicleName, dealerName, insights, healthScore, urgency) {
            const subject = `Controllo veicolo completato - ${vehicleName}`;
            const formalGreeting = greeting.replace('Caro', 'Gentile').replace('Cara', 'Gentile');
            const body = `${formalGreeting},

Abbiamo completato il controllo automatico del Suo ${vehicleName}.

RISULTATI:
Punteggio generale: ${healthScore}/100
Stato: ${urgency === 'alta' ? 'Richiede attenzione' : 'Monitoraggio normale'}

ELEMENTI RILEVATI:
${insights.map((insight, index) => `• ${insight.message} - ${insight.reason}`).join('\n')}

INFORMAZIONI:
Questi dati provengono dall'analisi AI dei parametri OBD-II del veicolo. Il sistema analizza automaticamente le prestazioni per identificare necessità di manutenzione.

PROSSIMI PASSI:
Contatti ${dealerName} per programmare un controllo tecnico.

Il nostro team è disponibile per assistenza e chiarimenti.

Saluti,
${dealerName}

---
Messaggio generato automaticamente dall'analisi AI del veicolo`;
            
            return { subject, body };
        }

        // SMS Template
        function generateSMS(greeting, fullClientName, vehicleName, dealerName, insights, urgency) {
            const isFirstPerson = greeting.includes('Caro') || greeting.includes('Cara');
            const firstName = greeting.split(' ')[1] || fullClientName;
            const mainIssue = insights.length > 0 ? insights[0].message : 'alcuni parametri da controllare';
            const possessive = isFirstPerson ? 'tuo' : 'Suo';
            const verb = isFirstPerson ? 'Ti' : 'Le';
            const callAction = isFirstPerson ? 'Chiamaci' : 'Ci chiami';
            
            return `🚗 ${firstName}, la nostra analisi AI del ${possessive} ${vehicleName} ha rilevato: ${mainIssue}. ${urgency === 'alta' ? 'Intervento consigliato a breve.' : `${verb} consigliamo un controllo.`} ${callAction} per un appuntamento! - ${dealerName}`;
        }

        // WhatsApp Template  
        function generateWhatsApp(greeting, fullClientName, vehicleName, dealerName, insights, healthScore, urgency) {
            const emoji = urgency === 'alta' ? '🚨' : '🔍';
            const isFirstPerson = greeting.includes('Caro') || greeting.includes('Cara');
            const firstName = greeting.split(' ')[1] || fullClientName;
            const whatsappGreeting = isFirstPerson ? `Ciao ${firstName}!` : 'Salve!';
            const possessive = isFirstPerson ? 'tuo' : 'Suo';
            const pronoun = isFirstPerson ? 'te' : 'Lei';
            const verb = isFirstPerson ? 'ti' : 'Le';
            const verb2 = isFirstPerson ? 'Chiamaci' : 'Ci chiami';
            const verb3 = isFirstPerson ? 'passa' : 'passi';
            const verb4 = isFirstPerson ? 'accoglierti' : 'accoglierLa';
            
            return `${emoji} ${whatsappGreeting}

La nostra AI ha appena analizzato il ${possessive} *${vehicleName}* e abbiamo alcuni aggiornamenti per ${pronoun}:

📊 *Punteggio Salute:* ${healthScore}/100
${urgency === 'alta' ? '⚠️ *Priorità:* Alta' : '✅ *Stato:* Sotto controllo'}

*Cosa abbiamo trovato:*
${insights.slice(0, 2).map(insight => `• ${insight.message} - ${insight.reason}`).join('\n')}

💡 *Perché ${verb} scriviamo?*
Crediamo nella trasparenza! Questi dati vengono dalla nostra analisi AI dei parametri reali del ${possessive} veicolo.

🎯 *Cosa facciamo?*
Prendiamoci cura insieme del ${possessive} ${vehicleName}! Il nostro team è pronto ad ${verb4}.

📞 ${verb2} o ${verb3} direttamente in concessionaria.

${dealerName} 🏢
_La prevenzione è sempre più conveniente!_ 💪`;
        }

        // Display Communications
        function displayCommunications(communications) {
            

            
            const contentDiv = document.getElementById('communicationsContent');
            
            
            if (!contentDiv) {
                console.error('❌ communicationsContent element not found');
                return;
            }
            
            if (!communications) {
                console.error('❌ No communications data provided');
                contentDiv.innerHTML = `
                    <div class="text-yellow-500 p-4">
                        <h3 class="font-bold mb-2">DEBUG: No Communications Data</h3>
                        <p>The generateSmartCommunications function may have failed to generate data.</p>
                    </div>
                `;
                return;
            }
            
            // Check if communications data has expected structure
            if (!communications.email && !communications.sms) {
                console.error('❌ Communications data missing email and sms properties');
                contentDiv.innerHTML = `
                    <div class="text-yellow-500 p-4">
                        <h3 class="font-bold mb-2">DEBUG: Communications Data Structure Issue</h3>
                        <pre class="text-xs bg-gray-800 p-2 rounded overflow-auto">${JSON.stringify(communications, null, 2)}</pre>
                    </div>
                `;
                return;
            }
            
            contentDiv.innerHTML = `
                <div class="space-y-6">
                    <!-- Email Section -->
                    <div class="border border-green-600/30 rounded-lg p-4">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
                            <svg class="w-5 h-5 mr-2 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 7.89a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                            </svg>
                            📧 Email Templates
                        </h3>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                            ${Object.entries(communications.email || {}).map(([tone, email]) => `
                                <div class="bg-gray-800/50 rounded-lg p-4">
                                    <div class="flex items-center justify-between mb-3">
                                        <h4 class="font-medium text-white capitalize">${tone === 'friendly' ? '😊 Amichevole' : tone === 'professional' ? '🤝 Professionale' : '📄 Neutro'}</h4>
                                        <button class="copy-btn px-3 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700" 
                                                onclick="copyToClipboard('${tone}-email', '${email.subject}\\n\\n${email.body.replace(/'/g, "\\'")}')">
                                            Copy
                                        </button>
                                    </div>
                                    <div class="space-y-2">
                                        <div>
                                            <p class="text-xs text-gray-400 mb-1">Oggetto:</p>
                                            <p class="text-sm text-green-300 font-medium">${email.subject}</p>
                                        </div>
                                        <div>
                                            <p class="text-xs text-gray-400 mb-1">Messaggio:</p>
                                            <div class="max-h-32 overflow-y-auto text-xs text-gray-300 bg-gray-900/50 p-2 rounded">
                                                ${email.body.replace(/\n/g, '<br>')}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <!-- SMS Section -->
                    <div class="border border-green-600/30 rounded-lg p-4">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
                            <svg class="w-5 h-5 mr-2 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"/>
                            </svg>
                            📱 SMS Template
                        </h3>
                        <div class="bg-gray-800/50 rounded-lg p-4">
                            <div class="flex items-center justify-between mb-3">
                                <span class="text-sm text-gray-400">Caratteri: ${(communications.sms || '').length}/160</span>
                                <button class="copy-btn px-3 py-1 bg-yellow-600 text-white text-xs rounded hover:bg-yellow-700" 
                                        onclick="copyToClipboard('sms', '${(communications.sms || '').replace(/'/g, "\\'")}')">
                                    Copy SMS
                                </button>
                            </div>
                            <div class="text-sm text-gray-300 bg-gray-900/50 p-3 rounded">
                                ${communications.sms || 'SMS content not available'}
                            </div>
                        </div>
                    </div>

                    <!-- WhatsApp Section -->
                    <div class="border border-green-600/30 rounded-lg p-4">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
                            <svg class="w-5 h-5 mr-2 text-green-400" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893A11.821 11.821 0 0020.885 3.488"/>
                            </svg>
                            💬 WhatsApp Template
                        </h3>
                        <div class="bg-gray-800/50 rounded-lg p-4">
                            <div class="flex items-center justify-between mb-3">
                                <span class="text-sm text-gray-400">Formato WhatsApp</span>
                                <button class="copy-btn px-3 py-1 bg-green-600 text-white text-xs rounded hover:bg-green-700" 
                                        onclick="copyToClipboard('whatsapp', '${(communications.whatsapp || '').replace(/'/g, "\\'")}')">
                                    Copy WhatsApp
                                </button>
                            </div>
                            <div class="text-sm text-gray-300 bg-gray-900/50 p-3 rounded whitespace-pre-wrap">
                                ${communications.whatsapp || 'WhatsApp content not available'}
                            </div>
                        </div>
                    </div>

                    <!-- Instructions -->
                    <div class="bg-green-800/20 border border-green-600/30 rounded-lg p-4">
                        <h4 class="text-white font-medium mb-2">💡 Come utilizzare:</h4>
                        <ul class="text-sm text-green-200 space-y-1">
                            <li>• Clicca "Copy" per copiare il messaggio negli appunti</li>
                            <li>• Personalizza ulteriormente il contenuto se necessario</li>
                            <li>• Invia tramite il tuo sistema di comunicazione preferito</li>
                            <li>• I messaggi sono basati sui dati OBD reali del veicolo</li>
                        </ul>
                    </div>
                </div>
            `;
        }

        // Copy to Clipboard Function
        function copyToClipboard(type, text) {
            navigator.clipboard.writeText(text).then(function() {
                // Show success feedback
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = '✓ Copiato!';
                btn.classList.add('bg-green-600');
                
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.classList.remove('bg-green-600');
                }, 2000);
            }).catch(function(err) {
                console.error('Error copying to clipboard:', err);
                alert('Errore nel copiare il testo. Prova a selezionarlo manualmente.');
            });
        }

        // Display Communication Error
        function displayCommunicationError(message) {
            const contentDiv = document.getElementById('communicationsContent');
            contentDiv.innerHTML = `
                <div class="text-center py-8">
                    <div class="inline-flex items-center justify-center w-16 h-16 bg-red-600/20 rounded-full mb-4">
                        <svg class="w-8 h-8 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                    </div>
                    <h3 class="text-xl font-semibold text-white mb-2">Generation Error</h3>
                    <p class="text-red-200 mb-4">Error generating communications: ${message}</p>
                    <button onclick="generateSmartCommunications()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                        Try Again
                    </button>
                </div>
            `;
        }

        // Initialize Tabs System
        function initializeTabs() {
            // Get all tab buttons and panels
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabPanels = document.querySelectorAll('.tab-panel');
            
            // Add click listeners to tab buttons
            tabButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    switchTab(tabId);
                });
            });
            
            // Show the first tab by default (overview)
            switchTab('overview');
        }
        
        // Switch Tab Function
        function switchTab(tabId) {
            // Hide all tab panels
            const tabPanels = document.querySelectorAll('.tab-panel');
            tabPanels.forEach(panel => {
                panel.classList.add('hidden');
            });
            
            // Remove active state from all buttons (including old blue classes)
            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(button => {
                // Remove gray-dark active classes
                button.classList.remove('bg-gray-800', 'text-white', 'shadow-lg', 'border-b-4', 'border-gray-900');
                // Remove old blue classes (cleanup)
                button.classList.remove('border-blue-500', 'text-blue-600', 'dark:text-blue-400', 'border-transparent');
                // Add inactive classes
                button.classList.add('bg-gray-100', 'text-gray-700', 'hover:bg-gray-200', 'hover:text-gray-900', 'dark:bg-gray-700', 'dark:text-gray-300', 'dark:hover:bg-gray-600');
            });
            
            // Show the selected tab panel
            const selectedPanel = document.getElementById(`content-${tabId}`);
            if (selectedPanel) {
                selectedPanel.classList.remove('hidden');
            }
            
            // Add active state to selected button
            const selectedButton = document.querySelector(`[data-tab="${tabId}"]`);
            if (selectedButton) {
                // Remove inactive classes
                selectedButton.classList.remove('bg-gray-100', 'text-gray-700', 'hover:bg-gray-200', 'hover:text-gray-900', 'dark:bg-gray-700', 'dark:text-gray-300', 'dark:hover:bg-gray-600');
                // Remove any blue classes (final cleanup)
                selectedButton.classList.remove('border-blue-500', 'text-blue-600', 'dark:text-blue-400', 'border-transparent');
                // Add gray-dark active classes
                selectedButton.classList.add('bg-gray-800', 'text-white', 'shadow-lg', 'border-b-4', 'border-gray-900');
            }
            
            // Load tab-specific content
            loadTabContent(tabId);
        }
        
        // Load Tab Content - AUTO-GENERATE CONTENT WHEN TABS ARE CLICKED
        function loadTabContent(tabId) {
            switch(tabId) {
                case 'overview':
                    // Overview is static, no loading needed
                    break;
                case 'analytics':
                    // Load analytics data (if not already loaded)
                    if (typeof loadAnalyticsData === 'function') {
                        loadAnalyticsData();
                    }
                    break;
                case 'client':
                    // Load client data (if not already loaded)
                    if (typeof loadClientData === 'function') {
                        loadClientData();
                    }
                    break;
                case 'ai-report':
                    // AI Report tab is ready to generate reports on demand
                    // Load AI metrics when tab is opened
                    loadAIMetrics();
                    break;
                case 'obd-errors':
                    // OBD Errors tab - under construction
                    break;
                case 'obd-data':
                    // Load OBD data when tab is activated
                    
                    loadOBDData();
                    break;

                default:
                    console.warn(`⚠️ Unknown tab: ${tabId}`);
            }
        }

        // OBD Data Management Functions
        async function loadOBDData() {
            try {
                
                
                

                
                // Show loading state
                document.getElementById('obdDataLoading').style.display = 'block';
                document.getElementById('obdDataContent').style.display = 'none';
                
                // Get device ID from certificate data
                const deviceId = window.certificateData?.deviceId;
                
                
                if (!deviceId) {
                    console.error('❌ Device ID not available. Certificate data:', window.certificateData);
                    throw new Error('Device ID not available');
                }
                
                // Calculate date range (last 7 days)
                const endDate = new Date();
                const startDate = new Date();
                startDate.setDate(endDate.getDate() - 7);
                
                const startDateStr = startDate.toISOString().split('T')[0];
                const endDateStr = endDate.toISOString().split('T')[0];
                
                
                
                // Fetch OBD data from server
                const url = `/api/vehicle/${deviceId}/obd?startDate=${startDateStr}&endDate=${endDateStr}`;
                
                const response = await fetch(url);
                
                
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                
                console.log('🔧 Response data keys:', Object.keys(data));
                
                if (!data.success) {
                    throw new Error(data.message || 'Failed to fetch OBD data');
                }
                
                // Handle both data formats (positions or data field)
                
                
                
                
                const positions = data.positions || data.data || [];
                
                
                
                // Update summary information
                updateOBDSummary(data, startDateStr, endDateStr);
                
                // Process and create charts
                await createOBDCharts(positions);
                
                // Show content
                document.getElementById('obdDataLoading').style.display = 'none';
                document.getElementById('obdDataContent').style.display = 'block';
                
            } catch (error) {
                console.error('❌ Error loading OBD data:', error);
                document.getElementById('obdDataLoading').innerHTML = `
                    <div class="text-center py-12">
                        <div class="inline-flex items-center justify-center w-12 h-12 bg-red-600/20 rounded-full mb-4">
                            <svg class="w-6 h-6 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                        </div>
                        <p class="text-red-600 dark:text-red-400 font-medium" data-it="Errore nel caricamento dei dati OBD" data-en="Error loading OBD data">Errore nel caricamento dei dati OBD</p>
                        <p class="text-gray-600 dark:text-gray-300 text-sm mt-2">${error.message}</p>
                    </div>
                `;
            }
        }

        function updateOBDSummary(data, startDate, endDate) {
            const positionsCount = (data.positions || data.data || []).length;
            const deviceInfo = window.certificateData?.imei || 'N/A';
            
            // Format dates based on current language
            const currentLang = document.documentElement.lang || 'it';
            const dateFormat = currentLang === 'it' ? 'dd/MM/yyyy' : 'MM/dd/yyyy';
            
            const startDateFormatted = formatDate(new Date(startDate), dateFormat);
            const endDateFormatted = formatDate(new Date(endDate), dateFormat);
            const dateRange = `${startDateFormatted} - ${endDateFormatted}`;
            
            document.getElementById('obdDateRange').textContent = dateRange;
            document.getElementById('obdPositionsCount').textContent = positionsCount.toLocaleString();
            document.getElementById('obdDeviceInfo').textContent = deviceInfo;
        }

        function formatDate(date, format) {
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            
            if (format === 'dd/MM/yyyy') {
                return `${day}/${month}/${year}`;
            } else if (format === 'dd/MM') {
                return `${day}/${month}`;
            } else if (format === 'MM/dd') {
                return `${month}/${day}`;
            } else {
                return `${month}/${day}/${year}`;
            }
        }

        async function createOBDCharts(positions) {
            
            
            
            if (!positions || positions.length === 0) {
                console.warn('⚠️ No OBD positions available for charts');
                return;
            }

            // Define PID mappings with descriptions
            const pidMappings = {
                // Engine Performance & Load
                31: { name: 'Engine Load', it: 'Carico Motore', unit: '%' },
                32: { name: 'Coolant Temperature', it: 'Temperatura Liquido', unit: '°C' },
                36: { name: 'Engine RPM', it: 'Giri Motore', unit: 'RPM' },
                38: { name: 'Timing Advance', it: 'Anticipo Accensione', unit: '°' },
                52: { name: 'Absolute Load Value', it: 'Valore Carico Assoluto', unit: '%' },
                
                // Fuel System & Efficiency
                33: { name: 'Short Fuel Trim', it: 'Correzione Carburante Breve', unit: '%' },
                34: { name: 'Fuel Pressure', it: 'Pressione Carburante', unit: 'kPa' },
                40: { name: 'Mass Air Flow', it: 'Portata Massa Aria', unit: 'g/s' },
                44: { name: 'Relative Fuel Rail Pressure', it: 'Pressione Rail Carburante Relativa', unit: 'kPa' },
                45: { name: 'Direct Fuel Rail Pressure', it: 'Pressione Rail Carburante Diretta', unit: 'kPa' },
                46: { name: 'Commanded EGR', it: 'EGR Comandato', unit: '%' },
                47: { name: 'EGR Error', it: 'Errore EGR', unit: '%' },
                48: { name: 'Fuel Level', it: 'Livello Carburante', unit: '%' },
                50: { name: 'Barometric Pressure', it: 'Pressione Barometrica', unit: 'kPa' },
                
                // Air & Intake System
                35: { name: 'Intake MAP', it: 'Pressione Aspirazione', unit: 'kPa' },
                39: { name: 'Intake Air Temperature', it: 'Temperatura Aria Aspirazione', unit: '°C' },
                41: { name: 'Throttle Position', it: 'Posizione Farfalla', unit: '%' },
                
                // Operational Metrics & Diagnostics
                30: { name: 'Number of DTCs', it: 'Numero DTC', unit: '' },
                37: { name: 'Vehicle Speed', it: 'Velocità Veicolo', unit: 'km/h' },
                42: { name: 'Runtime Since Engine Start', it: 'Tempo di Funzionamento', unit: 'min' },
                43: { name: 'Distance Traveled with MIL On', it: 'Distanza con Spia Accesa', unit: 'km' },
                49: { name: 'Distance Since Codes Cleared', it: 'Distanza da Reset Codici', unit: 'km' },
                51: { name: 'Control Module Voltage', it: 'Tensione Modulo Controllo', unit: 'V' }
            };

            // Group PIDs by section
            const sections = {
                enginePerformance: [31, 32, 36, 38, 52],
                fuelSystem: [33, 34, 40, 44, 45, 46, 47, 48, 50],
                airIntake: [35, 39, 41],
                operationalMetrics: [30, 37, 42, 43, 49, 51]
            };

            // Create charts for each section
            for (const [sectionName, pids] of Object.entries(sections)) {
                const containerId = `${sectionName}Charts`;
                const container = document.getElementById(containerId);
                
                if (!container) {
                    console.warn(`⚠️ Container not found: ${containerId}`);
                    continue;
                }
                
                container.innerHTML = ''; // Clear existing content
                
                for (const pid of pids) {
                    const pidData = extractPIDData(positions, pid);
                    
                    if (pidData && pidData.dailyAverages && pidData.dailyAverages.length > 0) {
                        const chartElement = createChartElement(pid, pidMappings[pid], pidData);
                        container.appendChild(chartElement);
                    }
                }
            }
        }

        function extractPIDData(positions, pid) {
            if (!positions || !Array.isArray(positions)) {
                console.error('❌ positions is not an array:', positions);
                return null;
            }
            
            // Group data by day
            const dailyData = {};
            
            positions.forEach((position, index) => {
                if (position.data && position.data[pid] !== undefined) {
                    const value = parseFloat(position.data[pid]);
                    if (!isNaN(value)) {
                        const date = new Date(position.createdAt);
                        const dayKey = date.toISOString().split('T')[0]; // YYYY-MM-DD format
                        
                        if (!dailyData[dayKey]) {
                            dailyData[dayKey] = {
                                values: [],
                                date: date,
                                dayKey: dayKey
                            };
                        }
                        
                        dailyData[dayKey].values.push(value);
                    }
                }
            });
            
            if (Object.keys(dailyData).length === 0) return null;
            
            // Calculate daily statistics
            const days = Object.keys(dailyData).sort();
            const dailyAverages = [];
            const dailyMins = [];
            const dailyMaxs = [];
            const labels = [];
            
            days.forEach(dayKey => {
                const dayData = dailyData[dayKey];
                const values = dayData.values;
                
                if (values.length > 0) {
                    dailyAverages.push(values.reduce((a, b) => a + b, 0) / values.length);
                    dailyMins.push(Math.min(...values));
                    dailyMaxs.push(Math.max(...values));
                    
                    // Format date for display
                    const currentLang = document.documentElement.lang || 'it';
                    const dateFormat = currentLang === 'it' ? 'dd/MM' : 'MM/dd';
                    labels.push(formatDate(dayData.date, dateFormat));
                }
            });
            
            return {
                labels,
                dailyAverages,
                dailyMins,
                dailyMaxs,
                totalAverage: dailyAverages.reduce((a, b) => a + b, 0) / dailyAverages.length,
                totalMin: Math.min(...dailyMins),
                totalMax: Math.max(...dailyMaxs)
            };
        }

        function createChartElement(pid, mapping, data) {
            const currentLang = document.documentElement.lang || 'it';
            const title = currentLang === 'it' ? mapping.it : mapping.name;
            
            const chartId = `obd-chart-${pid}`;
            
            const chartElement = document.createElement('div');
            chartElement.className = 'relative group';
            chartElement.innerHTML = `
                <div class="relative bg-white dark:bg-gradient-to-br dark:from-gray-800 dark:via-gray-700 dark:to-gray-900 rounded-2xl p-6 border border-gray-200 dark:border-gray-600/40 shadow-lg hover:shadow-xl transition-all duration-300">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="p-2 bg-indigo-600/20 rounded-lg">
                            <svg class="w-5 h-5 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                            </svg>
                        </div>
                        <div>
                            <h4 class="font-semibold text-gray-900 dark:text-white">${title}</h4>
                            <p class="text-xs text-gray-600 dark:text-gray-300">PID ${pid} - ${mapping.unit}</p>
                        </div>
                    </div>
                    <div class="h-48 bg-gray-50 dark:bg-gray-900/80 rounded-lg p-3 border border-gray-200 dark:border-gray-700/50">
                        <canvas id="${chartId}"></canvas>
                    </div>
                    <div class="mt-3 grid grid-cols-3 gap-2 text-xs">
                        <div class="text-center p-2 bg-green-50 dark:bg-green-900/20 rounded">
                            <div class="font-semibold text-green-700 dark:text-green-300">${data.totalAverage.toFixed(1)}</div>
                            <div class="text-green-600 dark:text-green-400" data-it="Media" data-en="Avg">Media</div>
                        </div>
                        <div class="text-center p-2 bg-blue-50 dark:bg-blue-900/20 rounded">
                            <div class="font-semibold text-blue-700 dark:text-blue-300">${data.totalMin.toFixed(1)}</div>
                            <div class="text-blue-600 dark:text-blue-400" data-it="Min" data-en="Min">Min</div>
                        </div>
                        <div class="text-center p-2 bg-red-50 dark:bg-red-900/20 rounded">
                            <div class="font-semibold text-red-700 dark:text-red-300">${data.totalMax.toFixed(1)}</div>
                            <div class="text-red-600 dark:text-red-400" data-it="Max" data-en="Max">Max</div>
                        </div>
                    </div>
                </div>
            `;
            
            // Create the chart after the element is added to DOM
            setTimeout(() => {
                createOBDChart(chartId, data, title, mapping.unit);
            }, 100);
            
            return chartElement;
        }

        function createOBDChart(canvasId, data, title, unit) {
            
            const ctx = document.getElementById(canvasId);
            if (!ctx) {
                console.error('❌ Canvas element not found:', canvasId);
                return;
            }
            
            const isDark = document.documentElement.classList.contains('dark');
            const textColor = isDark ? '#f3f4f6' : '#374151';
            const gridColor = isDark ? '#374151' : '#e5e7eb';
            
            
            if (typeof Chart === 'undefined') {
                console.error('❌ Chart.js is not loaded!');
                return;
            }
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.labels,
                    datasets: [
                        {
                            label: 'Average Value',
                            data: data.dailyAverages,
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.4
                        },
                        {
                            label: 'Lowest Peak',
                            data: data.dailyMins,
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.4
                        },
                        {
                            label: 'Highest Peak',
                            data: data.dailyMaxs,
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: isDark ? '#374151' : '#ffffff',
                            titleColor: textColor,
                            bodyColor: textColor,
                            borderColor: gridColor,
                            borderWidth: 1,
                            callbacks: {
                                title: function(context) {
                                    return context[0].label;
                                },
                                label: function(context) {
                                    const currentLang = document.documentElement.lang || 'it';
                                    const labels = {
                                        'Average Value': currentLang === 'it' ? 'Media' : 'Average',
                                        'Lowest Peak': currentLang === 'it' ? 'Minimo' : 'Min',
                                        'Highest Peak': currentLang === 'it' ? 'Massimo' : 'Max'
                                    };
                                    return `${labels[context.dataset.label] || context.dataset.label}: ${context.parsed.y.toFixed(1)} ${unit}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            grid: {
                                color: gridColor,
                                drawBorder: false
                            },
                            ticks: {
                                color: textColor,
                                font: {
                                    size: 10
                                }
                            }
                        },
                        y: {
                            display: true,
                            grid: {
                                color: gridColor,
                                drawBorder: false
                            },
                            ticks: {
                                color: textColor,
                                font: {
                                    size: 10
                                }
                            }
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    }
                }
            });
        }

        function formatTime(date) {
            const currentLang = document.documentElement.lang || 'it';
            const timeFormat = currentLang === 'it' ? 'HH:mm' : 'h:mm a';
            
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            
            if (timeFormat === 'HH:mm') {
                return `${hours}:${minutes}`;
            } else {
                const ampm = date.getHours() >= 12 ? 'PM' : 'AM';
                const hour12 = date.getHours() % 12 || 12;
                return `${hour12}:${minutes} ${ampm}`;
            }
        }

        // AI Report Functions
        async function loadAIMetrics() {
            try {
                const deviceId = window.certificateData?.deviceId;
                if (!deviceId) {
                    console.error('❌ Device ID not available for AI metrics');
                    return;
                }

                // Calculate date range (last 90 days)
                const endDate = new Date();
                const startDate = new Date();
                startDate.setDate(endDate.getDate() - 90);
                
                const startDateStr = startDate.toISOString().split('T')[0];
                const endDateStr = endDate.toISOString().split('T')[0];
                
                
                
                // Fetch analytics data for the 90-day period
                const response = await fetch(`/api/vehicle/${deviceId}/analytics?startDate=${startDateStr}&endDate=${endDateStr}`);
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.message || 'Failed to fetch analytics data');
                }
                
                // Update metrics cards
                updateAIMetricsCards(data);
                
            } catch (error) {
                console.error('❌ Error loading AI metrics:', error);
            }
        }

        function updateAIMetricsCards(data) {
            // Total Odometer
            const totalOdometer = data.summary?.totalDistance || 0;
            document.getElementById('aiTotalOdometer').textContent = `${totalOdometer.toLocaleString()} km`;
            
            // Distance Last 90 Days
            const distance90Days = data.summary?.totalDistance || 0;
            document.getElementById('aiDistance90Days').textContent = `${distance90Days.toLocaleString()} km`;
            
            // Number of Trips (estimated from position count)
            const trips90Days = data.summary?.totalPositions || 0;
            document.getElementById('aiTrips90Days').textContent = trips90Days.toLocaleString();
            
            // Driving Time (estimated from position count * 30 seconds per position)
            const drivingTimeSeconds = (data.summary?.totalPositions || 0) * 30;
            const drivingHours = Math.floor(drivingTimeSeconds / 3600);
            const drivingMinutes = Math.floor((drivingTimeSeconds % 3600) / 60);
            document.getElementById('aiDrivingTime90Days').textContent = `${drivingHours}h ${drivingMinutes}m`;
            
            // Average Battery (placeholder - would need battery data from OBD)
            const avgBattery = 85; // Placeholder value
            document.getElementById('aiAvgBattery90Days').textContent = `${avgBattery}%`;
            
            // Average Speed
            const avgSpeed = data.summary?.averageSpeed || 0;
            document.getElementById('aiAvgSpeed90Days').textContent = `${avgSpeed.toFixed(1)} km/h`;
            
            // OBD Errors (placeholder - would need error count from OBD data)
            const obdErrors = 0; // Placeholder value
            document.getElementById('aiOBDErrors90Days').textContent = obdErrors;
            
            
        }

        async function generateAIReport() {
            try {
                const button = document.getElementById('generateAIReportTab');
                const loadingSpan = document.getElementById('aiReportLoading');
                const normalSpan = button.querySelector('span:not(#aiReportLoading)');
                
                // Show loading state
                normalSpan.classList.add('hidden');
                loadingSpan.classList.remove('hidden');
                button.disabled = true;
                
                // Load metrics first
                await loadAIMetrics();
                
                // Simulate AI processing time
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // Generate AI report (placeholder for now)
                const aiReportContent = `
                    <h4>🚗 Vehicle Performance Analysis</h4>
                    <p>Based on the collected data from the last 90 days, your vehicle shows:</p>
                    <ul>
                        <li><strong>Distance Traveled:</strong> ${document.getElementById('aiDistance90Days').textContent}</li>
                        <li><strong>Average Speed:</strong> ${document.getElementById('aiAvgSpeed90Days').textContent}</li>
                        <li><strong>Driving Time:</strong> ${document.getElementById('aiDrivingTime90Days').textContent}</li>
                        <li><strong>Total Trips:</strong> ${document.getElementById('aiTrips90Days').textContent}</li>
                    </ul>
                    <h4>🔍 AI Insights</h4>
                    <p>Your driving patterns indicate efficient vehicle usage with consistent performance metrics. The vehicle appears to be well-maintained based on the collected OBD data.</p>
                    <h4>📋 Recommendations</h4>
                    <ul>
                        <li>Continue regular maintenance schedule</li>
                        <li>Monitor fuel efficiency trends</li>
                        <li>Consider eco-driving techniques for better efficiency</li>
                    </ul>
                `;
                
                // Show results
                document.getElementById('aiReportContent').innerHTML = aiReportContent;
                document.getElementById('aiReportResults').classList.remove('hidden');
                
                // Reset button state
                normalSpan.classList.remove('hidden');
                loadingSpan.classList.add('hidden');
                button.disabled = false;
                

                
            } catch (error) {
                console.error('❌ Error generating AI report:', error);
                
                // Reset button state on error
                const button = document.getElementById('generateAIReportTab');
                const loadingSpan = document.getElementById('aiReportLoading');
                const normalSpan = button.querySelector('span:not(#aiReportLoading)');
                normalSpan.classList.remove('hidden');
                loadingSpan.classList.add('hidden');
                button.disabled = false;
            }
        }

        // Page Initialization - COMPLETE INITIALIZATION
        
        // Add event listeners after DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // AI Report button event listener
            const generateAIReportBtn = document.getElementById('generateAIReportTab');
            if (generateAIReportBtn) {
                generateAIReportBtn.addEventListener('click', generateAIReport);
            }
        });
        
        // Clean up sessionStorage when leaving the page (but keep it for refresh)
        window.addEventListener('beforeunload', function() {
            // Don't remove sessionStorage on refresh - only on actual navigation away
            // This allows data to persist during page refresh
        });
        
        // Clean up sessionStorage when actually navigating away (not on refresh)
        window.addEventListener('pagehide', function(event) {
            // Only remove if it's not a page refresh
            if (event.persisted === false) {
                sessionStorage.removeItem('vehiclePageData');
                console.log('🧹 Cleaned up sessionStorage on navigation away');
            }
        });
        document.addEventListener('DOMContentLoaded', async function() {
            // STEP 0: 🛡️ SECURITY CHECK - MUST BE FIRST
            const isAuthenticated = checkAuthenticationStatus();
            if (!isAuthenticated) {
                return; // Stop execution if not authenticated
            }
            
            // STEP 1: Initialize theme and translations with error handling
            try {
                if (window.themeManager) {
                    window.themeManager.init();
                }
            } catch (error) {
                console.error('❌ Error initializing theme system:', error);
            }
            
            try {
                if (window.i18n) {
                    window.i18n.init();
                }
            } catch (error) {
                console.error('❌ Error initializing I18N system:', error);
            }
            
            // STEP 2: Update header logo
            updateHeaderLogo();
            
            // STEP 3: Load vehicle data FIRST (this populates certificateData) - WAIT FOR COMPLETION
            try {
                await loadVehicleData();
            } catch (error) {
                console.error('❌ Error loading vehicle data:', error);
                // Show user-friendly error message
                const errorDiv = document.createElement('div');
                errorDiv.className = 'bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4';
                errorDiv.innerHTML = '<strong>Errore:</strong> Impossibile caricare i dati del veicolo. Riprova più tardi.';
                document.querySelector('.container')?.prepend(errorDiv);
            }
            

            
            // STEP 4: Setup analytics event handlers
            setupAnalyticsEventHandlers();
            
            // STEP 5: Set up logo error handling
            const logo = document.getElementById('sidebarLogo');
            if (logo) {
                setTimeout(() => {
                    if (logo.naturalWidth === 0) {
                        handleLogoError();
                    }
                }, 1000);
            }
            
            // STEP 6: Initialize tabs system
            initializeTabs();
            
            // STEP 6.5: CLEANUP BLUE BORDERS (Final nuclear cleanup)
            setTimeout(() => {
                const allTabButtons = document.querySelectorAll('.tab-button');
                allTabButtons.forEach(button => {
                    // Remove ALL blue-related classes (nuclear cleanup)
                    button.classList.remove('border-blue-500', 'text-blue-600', 'dark:text-blue-400', 'border-transparent');
                    // Force remove outline and box-shadow
                    button.style.outline = 'none';
                    button.style.boxShadow = 'none';
                    // Force override any browser default focus styles
                    button.setAttribute('style', button.getAttribute('style') + '; outline: none !important; box-shadow: none !important;');
                });
                
                // Force refresh the currently selected tab to apply gray-dark styling
                const activeTab = document.querySelector('.tab-button.bg-gray-800') || document.querySelector('[data-tab="overview"]');
                if (activeTab) {
                    const tabId = activeTab.getAttribute('data-tab');
                    switchTab(tabId);
                }
            }, 100);
            
            // STEP 7: Connect event listeners for buttons in tabs
            setTimeout(() => {
                // No problematic tab event listeners needed
            }, 100);
            

        });
    </script>
</body>
</html>

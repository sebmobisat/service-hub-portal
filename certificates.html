<!DOCTYPE html>
<html lang="it" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Certificati - Service Hub Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/css/styles.css">
    <!-- Authentication Guard -->
    <script src="/js/auth-guard.js"></script>
    <script src="/js/vehicleImageService.js"></script>
    <link rel="icon" type="image/x-icon" href="/favicon/favicon.ico">
    <link rel="icon" type="image/svg+xml" href="/favicon/favicon.svg">
    <link rel="icon" type="image/png" href="/favicon/favicon-16x16.png" sizes="16x16">
    <link rel="icon" type="image/png" href="/favicon/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/favicon/favicon-48x48.png" sizes="48x48">
    <link rel="apple-touch-icon" href="/favicon/apple-touch-icon.png" sizes="180x180">
    <link rel="manifest" href="/favicon/manifest.json">
    
    <!-- Authentication Configuration -->
    <script src="/js/auth-config.js"></script>
    <!-- Custom Dialog -->
    <script src="/js/custom-dialog.js"></script>
    
    <style>
        /* Certificate Cards Theme Support */
        .certificate-card {
            /* Default Light Theme */
            background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
            border-color: #e5e7eb;
            color: #111827;
        }
        
        .certificate-card .card-title {
            color: #111827;
        }
        
        .certificate-card .card-subtitle {
            color: #6b7280;
        }
        
        .certificate-card .card-id {
            color: #059669;
        }
        
        .certificate-card .vehicle-container {
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
            border-color: #d1d5db;
        }
        
        .certificate-card .client-section {
            background-color: #eff6ff;
            border-color: #dbeafe;
        }
        
        .certificate-card .client-section h3 {
            color: #1d4ed8;
        }
        
        .certificate-card .vehicle-section {
            background-color: #f0fdf4;
            border-color: #bbf7d0;
        }
        
        .certificate-card .vehicle-section h3 {
            color: #059669;
        }
        
        .certificate-card .device-section {
            background-color: #faf5ff;
            border-color: #e9d5ff;
        }
        
        .certificate-card .device-section h3 {
            color: #7c3aed;
        }
        
        .certificate-card .field-label {
            color: #6b7280;
        }
        
        .certificate-card .field-value {
            color: #111827;
            word-wrap: break-word;
            overflow-wrap: break-word;
            line-height: 1.4;
        }
        
        .certificate-card .field-value-secondary {
            color: #374151;
            word-wrap: break-word;
            overflow-wrap: break-word;
            line-height: 1.4;
        }
        
        /* Dark Theme Overrides */
        html.dark .certificate-card {
            background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
            border-color: rgba(75, 85, 99, 0.5);
            color: #ffffff;
        }
        
        html.dark .certificate-card .card-title {
            color: #ffffff;
        }
        
        html.dark .certificate-card .card-subtitle {
            color: #9ca3af;
        }
        
        html.dark .certificate-card .card-id {
            color: #34d399;
        }
        
        html.dark .certificate-card .vehicle-container {
            background: linear-gradient(135deg, #374151 0%, #1f2937 100%);
            border-color: rgba(75, 85, 99, 0.3);
        }
        
        html.dark .certificate-card .client-section {
            background-color: rgba(59, 130, 246, 0.05);
            border-color: rgba(59, 130, 246, 0.2);
        }
        
        html.dark .certificate-card .client-section h3 {
            color: #60a5fa;
        }
        
        html.dark .certificate-card .vehicle-section {
            background-color: rgba(34, 197, 94, 0.05);
            border-color: rgba(34, 197, 94, 0.2);
        }
        
        html.dark .certificate-card .vehicle-section h3 {
            color: #4ade80;
        }
        
        html.dark .certificate-card .device-section {
            background-color: rgba(168, 85, 247, 0.05);
            border-color: rgba(168, 85, 247, 0.2);
        }
        
        html.dark .certificate-card .device-section h3 {
            color: #a78bfa;
        }
        
        html.dark .certificate-card .field-label {
            color: #9ca3af;
        }
        
        html.dark .certificate-card .field-value {
            color: #ffffff;
            word-wrap: break-word;
            overflow-wrap: break-word;
            line-height: 1.4;
        }
        
        html.dark .certificate-card .field-value-secondary {
            color: #d1d5db;
            word-wrap: break-word;
            overflow-wrap: break-word;
            line-height: 1.4;
        }
        

        
        
        /* Dropdown and Select Fixes for Light Mode */
        select, 
        select option {
            /* Light Mode - Dark text on light background */
            color: #374151 !important;
            background-color: #ffffff !important;
        }
        
        html.dark select, 
        html.dark select option {
            /* Dark Mode - Light text on dark background */
            color: #ffffff !important;
            background-color: #374151 !important;
        }
        
        /* Input fields fixes */
        input[type="text"],
        input[type="search"] {
            /* Light Mode */
            color: #1f2937 !important; /* gray-800 for better contrast */
            background-color: #ffffff !important;
        }

        /* Force heading color for search section in light theme */
        html:not(.dark) h3[data-i18n="certificates.search.title"] {
            color: #111827 !important; /* gray-900 nearly black */
        }
        /* Ensure the main search input is readable in light mode */
        #dynamicTextInput {
            color: #1f2937 !important;
            background-color: #ffffff !important;
        }
        #dynamicTextInput::placeholder,
        input[type="search"]::placeholder {
            color: #6b7280 !important; /* gray-500 */
        }
        
                  html.dark input[type="text"],
          html.dark input[type="search"] {
              /* Dark Mode */
              color: #ffffff !important;
              background-color: #374151 !important;
          }
          
          /* Subtle Card Hover Effects */
          .certificate-card {
              transition: opacity 0.3s ease-in-out;
          }
          
          .certificate-card:hover {
              opacity: 0.85;
          }
          
          /* Subtle icon hover effect */
          .certificate-card .cursor-pointer:hover {
              opacity: 0.7;
              transition: opacity 0.2s ease-in-out;
          }

        /* Beautiful Draggable Tags Styles */
        .draggable-tag {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            cursor: grab;
            user-select: none;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 2px solid transparent;
            position: relative;
            overflow: hidden;
        }

        .draggable-tag::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s;
        }

        .draggable-tag:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6);
            border-color: rgba(255, 255, 255, 0.3);
        }

        .draggable-tag:hover::before {
            left: 100%;
        }

        .draggable-tag:active {
            cursor: grabbing;
            transform: translateY(-1px) scale(1.02);
        }

        .draggable-tag.dragging {
            opacity: 0.8;
            transform: rotate(5deg) scale(1.1);
            z-index: 1000;
        }

        /* Uniform tag colors - all using NOME purple color */
        .draggable-tag[data-type="client"] {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .draggable-tag[data-type="vehicle"] {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .draggable-tag[data-type="technical"] {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .draggable-tag[data-type="contact"] {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .draggable-tag[data-type="cta"] {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .draggable-tag .tag-icon {
            width: 14px;
            height: 14px;
            opacity: 0.9;
        }

        /* Drop zone highlighting */
        .drop-zone-active {
            border-color: #10b981 !important;
            background-color: rgba(16, 185, 129, 0.1) !important;
            box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2) !important;
        }

        /* Tag insertion animation */
        @keyframes tagInsert {
            0% {
                background-color: rgba(16, 185, 129, 0.3);
                transform: scale(1.05);
            }
            100% {
                background-color: transparent;
                transform: scale(1);
            }
        }

        .tag-inserted {
            animation: tagInsert 0.5s ease-out;
        }

        /* AI Tags Drag and Drop Styles */
        .tag-item {
            transition: all 0.2s ease;
        }

        .tag-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .tag-item.dragging {
            opacity: 0.5;
            transform: rotate(5deg) scale(1.1);
            z-index: 1000;
        }

        #aiResults.drag-over,
        #emailSubjectInput.drag-over {
            background-color: rgba(16, 185, 129, 0.1) !important;
            border-color: rgba(16, 185, 129, 0.5) !important;
            box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.3) !important;
        }
          
          .certificate-card .cursor-pointer:active {
              transform: scale(0.95) !important;
          }
          
          /* Responsive improvements */
          .certificate-card {
              min-width: 280px;
              max-width: 100%;
          }
          
          /* Long text should wrap naturally instead of being cut */
          .certificate-card .field-value.long-text,
          .certificate-card .field-value-secondary.long-text {
              white-space: normal;
              overflow: visible;
              text-overflow: clip;
              word-break: break-word;
              overflow-wrap: anywhere;
              max-width: 100%;
          }
          
          /* Responsive grid adjustments for better text fitting */
          @media (max-width: 640px) {
              #cardsView {
                  grid-template-columns: 1fr !important;
                  gap: 1rem;
              }
              .certificate-card {
                  min-width: auto;
              }
          }
          
          @media (min-width: 641px) and (max-width: 768px) {
              #cardsView {
                  grid-template-columns: repeat(1, 1fr) !important;
                  gap: 1rem;
              }
          }
          
          @media (min-width: 769px) and (max-width: 1024px) {
              #cardsView {
                  grid-template-columns: repeat(2, 1fr) !important;
                  gap: 1rem;
              }
          }
          
          @media (min-width: 1025px) and (max-width: 1280px) {
              #cardsView {
                  grid-template-columns: repeat(3, 1fr) !important;
                  gap: 1.5rem;
              }
          }
          
          @media (min-width: 1281px) and (max-width: 1536px) {
              #cardsView {
                  grid-template-columns: repeat(4, 1fr) !important;
                  gap: 1.5rem;
              }
          }
          
          @media (min-width: 1537px) {
              #cardsView {
                  grid-template-columns: repeat(5, 1fr) !important;
                  gap: 2rem;
              }
          }
          
          /* Fix for vehicle fields grid on smaller cards */
          @media (max-width: 1024px) {
              .certificate-card .grid.grid-cols-2 {
                  grid-template-columns: 1fr !important;
                  gap: 0.5rem;
              }
          }
          
          /* Ensure text doesn't break the layout */
          .certificate-card .flex-1 {
              min-width: 0;
              overflow: hidden;
          }
          
          /* Copy notification positioning */
          #copyNotification {
              z-index: 9999 !important;
          }
    </style>
</head>
<body class="min-h-screen theme-transition">
    <!-- Sidebar -->
    <div class="sidebar fixed left-0 top-0 h-full w-16 flex flex-col py-4 z-50">
        <!-- Logo -->
        <div class="flex items-center justify-center mb-8">
            <img src="/images/greenbox-logo.png" alt="Service Hub" class="w-10 h-10 object-contain" onerror="handleLogoError()" id="sidebarLogo">
            <!-- Fallback logo if image fails -->
            <div class="w-10 h-10 bg-green-600 rounded-lg flex items-center justify-center text-white font-bold text-xs" style="display: none;" id="logoFallback">
                SH
            </div>
        </div>
        
        <!-- Menu Items (only icons) -->
        <nav class="flex-1 py-4">
            <!-- Dashboard Page -->
            <div class="relative group">
                <button onclick="window.location.href='/'" class="w-full p-3 flex justify-center rounded-lg text-gray-300 hover:bg-gray-700 hover:text-white transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                    </svg>
                </button>
                <!-- Tooltip -->
                <div class="absolute left-full ml-2 px-2 py-1 bg-gray-900 text-white text-sm rounded opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none whitespace-nowrap z-60" data-i18n="nav.dashboard">
                </div>
            </div>
            
            <!-- Certificates Page (Active) -->
            <div class="relative group mt-2">
                <button class="w-full p-3 flex justify-center rounded-lg bg-green-600 text-white hover:bg-green-700 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                </button>
                <!-- Tooltip -->
                <div class="absolute left-full ml-2 px-2 py-1 bg-gray-900 text-white text-sm rounded opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none whitespace-nowrap z-60" data-i18n="nav.certificates">
                </div>
            </div>
            
            <!-- Billing / Credit -->
            <div class="relative group mt-2">
                <button onclick="window.location.href='/billing.html'" class="w-full p-3 flex justify-center rounded-lg text-gray-300 hover:bg-gray-700 hover:text-white transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M5 6h14a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2zm4 10h.01M8 14h8" />
                    </svg>
                </button>
                <div class="sidebar-tooltip absolute left-full ml-2 px-2 py-1 text-sm rounded opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none whitespace-nowrap z-60" data-i18n="nav.billing"></div>
            </div>

            <!-- Settings -->
            <div class="relative group mt-2">
                <button onclick="window.location.href='/settings.html'" class="w-full p-3 flex justify-center rounded-lg text-gray-300 hover:bg-gray-700 hover:text-white transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                </button>
                <!-- Tooltip -->
                <div class="absolute left-full ml-2 px-2 py-1 bg-gray-900 text-white text-sm rounded opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none whitespace-nowrap z-60" data-i18n="nav.settings">
                </div>
            </div>
        </nav>
        
        <!-- Logout -->
        <div class="relative group mt-auto">
            <button onclick="logout()" class="w-full p-3 flex justify-center rounded-lg text-gray-300 hover:bg-red-600 hover:text-white transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                </svg>
            </button>
            <!-- Tooltip -->
            <div class="absolute left-full ml-2 px-2 py-1 bg-gray-900 text-white text-sm rounded opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none whitespace-nowrap z-60" data-i18n="nav.logout">
            </div>
        </div>
    </div>

    <!-- Main content with left margin for sidebar -->
    <div style="margin-left: 64px;">
        <!-- Header -->
                    <header class="bg-gray-800 border-b border-gray-700 px-4 py-3">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-xl font-semibold text-white" data-i18n="page.certificates.title"></h1>
                        <p class="text-gray-400 text-sm" data-i18n="page.certificates.subtitle"></p>
                    </div>
                                 <div class="flex items-center space-x-4 pr-4">
                     <img id="headerLogo" src="/images/header_logo_dark_theme.png?v10" alt="Mobisat" class="h-8 w-auto object-contain">
                 </div>
            </div>
        </header>

        <!-- Main Content -->
        <div class="max-w-[95%] mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Professional Control Panel -->
            <div class="bg-white dark:bg-gradient-to-r dark:from-gray-900 dark:via-gray-800 dark:to-gray-900 rounded-2xl shadow-2xl border border-gray-200/50 dark:border-gray-700/50 overflow-hidden mb-8">
                
                <!-- Search Section -->
                <div class="bg-gray-50 dark:bg-gray-800 px-6 py-4 border-b border-gray-300/60 dark:border-gray-700/50">
                    <div class="flex items-center justify-between">
                        <!-- Search Header -->
                        <div class="flex items-center gap-3">
                            <div class="p-2 bg-blue-100 dark:bg-blue-600/20 rounded-lg">
                                <svg class="w-5 h-5 text-blue-600 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                                </svg>
                            </div>
                            <div>
                                <h3 class="text-gray-900 dark:text-white font-semibold text-sm" data-i18n="certificates.search.title">Ricerca e Filtri</h3>
                                <p class="text-gray-700 dark:text-gray-400 text-xs" data-i18n="certificates.search.description">Trova certificati usando diversi criteri</p>
                            </div>
                        </div>
                        
                        <!-- Advanced Search Button -->
                        <button id="advancedSearchBtn" onclick="openAdvancedSearchModal()" class="px-4 py-2 bg-gradient-to-r from-slate-600 to-slate-700 hover:from-slate-700 hover:to-slate-800 dark:from-slate-600 dark:to-slate-700 dark:hover:from-slate-700 dark:hover:to-slate-800 text-white rounded-lg text-sm font-medium transition-all duration-200 flex items-center gap-2 shadow-md">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7"></path>
                            </svg>
                            <span data-i18n="certificates.search.advanced">Ricerca Avanzata</span>
                        </button>
                    </div>
                    
                    <!-- Search Controls -->
                    <div class="flex flex-wrap items-center gap-4 mt-4">
                        <!-- Search Type -->
                        <div class="flex items-center gap-2">
                            <label class="text-sm font-medium text-gray-700 dark:text-gray-400" data-i18n="certificates.search.type">Search by:</label>
                            <select id="searchTypeSelector" class="bg-white dark:bg-gray-700/80 backdrop-blur border border-gray-300 dark:border-gray-600/50 text-gray-900 dark:text-gray-100 text-sm rounded-lg px-3 py-2 min-w-[160px] focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50 transition-all">
                                <option value="" data-i18n="certificates.search.select_type">Select search type</option>
                                <option value="global" data-i18n="certificates.search.global">Global Search</option>
                                <option value="client" data-i18n="certificates.search.client">Client</option>
                                <option value="plate" data-i18n="certificates.search.plate">License Plate</option>
                                <option value="certificate" data-i18n="certificates.search.certificate">Certificate #</option>
                                <option value="imei" data-i18n="certificates.search.imei">IMEI</option>
                                <option value="brand" data-i18n="certificates.search.brand">Brand</option>
                                <option value="model" data-i18n="certificates.search.model">Model</option>
                                <option value="fuel" data-i18n="certificates.search.fuel">Fuel Type</option>
                                
                                <option value="year" data-i18n="certificates.search.year">Year</option>
                            </select>
                        </div>
                        
                        <!-- Dynamic Search Field Container -->
                        <div id="dynamicSearchContainer" class="flex items-center gap-3" style="display: none;">
                            <!-- Text Input -->
                            <input type="text" id="dynamicTextInput" class="bg-white dark:bg-gray-700/80 backdrop-blur border border-gray-300 dark:border-gray-600/50 text-gray-900 dark:text-gray-100 text-sm rounded-lg px-3 py-2 w-64 focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50 transition-all placeholder-gray-500 dark:placeholder-gray-400" placeholder="Enter search term..." style="display: none;">
                            
                            <!-- Dropdown Input -->
                            <select id="dynamicDropdownInput" class="bg-white dark:bg-gray-700/80 backdrop-blur border border-gray-300 dark:border-gray-600/50 text-gray-900 dark:text-gray-100 text-sm rounded-lg px-3 py-2 min-w-[160px] focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50 transition-all" style="display: none;">
                                <option value="" data-i18n="certificates.filters.select">Select option</option>
                            </select>
                        </div>
                        
                        <!-- Clear Search Button -->
                        <div id="clearSearchContainer" style="display: none;">
                            <button id="clearSearchBtn" class="px-3 py-2 bg-gradient-to-r from-red-600 to-red-700 text-white rounded-lg text-sm font-medium hover:from-red-700 hover:to-red-800 transition-all duration-200 flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                                <span data-i18n="certificates.search.clear">Clear</span>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Actions & View Controls Section -->
                <div class="px-6 py-4 bg-white dark:bg-gray-800/50 border-t border-gray-200/80 dark:border-gray-700/50" data-theme-section="actions-bar">
                    <div class="flex items-center justify-between">
                        <!-- Left Side - View Controls -->
                        <div class="flex items-center gap-4">
                            <div class="flex items-center gap-2">
                                <span class="text-sm font-medium text-gray-800 dark:text-gray-300" data-i18n="certificates.view.label">Visualizza:</span>
                                <div class="flex bg-gray-300/60 dark:bg-gray-700/50 rounded-lg p-1 border border-gray-400/40 dark:border-gray-600/50">
                                    <button id="cardsViewBtn" onclick="showCardView()" class="px-4 py-2 rounded-md text-sm font-medium transition-all duration-200 flex items-center gap-2 text-gray-700 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-200">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path>
                                        </svg>
                                        <span data-i18n="certificates.view.cards">Schede</span>
                                    </button>
                                    
                                    <button id="tableViewBtn" onclick="showTableView()" class="px-4 py-2 rounded-md text-sm font-medium transition-all duration-200 flex items-center gap-2 bg-emerald-500 dark:bg-emerald-600 text-white shadow-md" style="color: white !important;">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18m-9-4v8m-7 0V4a1 1 0 011-1h3M3 20h18V4a1 1 0 00-1-1H4a1 1 0 00-1 1v16z"></path>
                                        </svg>
                                        <span data-i18n="certificates.view.table">Tabella</span>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Action Buttons -->
                            <div class="h-6 w-px bg-gray-500/50 dark:bg-gray-600"></div>
                            <div class="flex items-center gap-2">
                                <button onclick="loadCertificates()" class="px-4 py-2 bg-gradient-to-r from-emerald-500 to-emerald-600 hover:from-emerald-600 hover:to-emerald-700 dark:from-emerald-600 dark:to-emerald-700 dark:hover:from-emerald-700 dark:hover:to-emerald-800 text-white rounded-lg text-sm font-medium transition-all duration-200 flex items-center gap-2 shadow-md" style="color: white !important;">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                    </svg>
                                    <span data-i18n="certificates.action.refresh">Aggiorna</span>
                                </button>
                                
                                <button onclick="openCustomizeModal()" class="px-4 py-2 bg-gradient-to-r from-slate-600 to-slate-700 hover:from-slate-700 hover:to-slate-800 dark:from-slate-600 dark:to-slate-700 dark:hover:from-slate-700 dark:hover:to-slate-800 text-white rounded-lg text-sm font-medium transition-all duration-200 flex items-center gap-2 shadow-md" style="color: white !important;">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 100-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 100-4m0 4v2m0-6V4"/>
                                    </svg>
                                    <span data-i18n="certificates.action.customize">Personalizza</span>
                                </button>
                            </div>
                            
                            <!-- Group Filter -->
                            <div class="h-6 w-px bg-gray-500/50 dark:bg-gray-600"></div>
                            <div class="flex items-center gap-2">
                                <button onclick="openGroupFilterModal()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors flex items-center gap-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"/>
                                    </svg>
                                    <span data-it="Filtra per Gruppo" data-en="Filter by Group">Filtra per Gruppo</span>
                                    <span id="selectedGroupsCount" class="bg-blue-800 text-white text-xs px-2 py-1 rounded-full">0</span>
                                </button>
                            </div>
                            
                            <!-- Vehicle Groups Management -->
                            <div class="h-6 w-px bg-gray-500/50 dark:bg-gray-600"></div>
                            <div class="flex items-center gap-2">
                                <button onclick="openVehicleGroupsModal()" class="px-4 py-2 bg-gradient-to-r from-indigo-500 to-indigo-600 hover:from-indigo-600 hover:to-indigo-700 dark:from-indigo-600 dark:to-indigo-700 dark:hover:from-indigo-700 dark:hover:to-indigo-800 text-white rounded-lg text-sm font-medium transition-all duration-200 flex items-center gap-2 shadow-md" style="color: white !important;">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                                    </svg>
                                    <span data-it="Gestione Gruppi" data-en="Manage Groups">Gestione Gruppi</span>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Right Side - Statistics -->
                        <div class="flex items-center gap-4">
                            <div class="flex items-center gap-2 px-4 py-2 bg-gray-50 dark:bg-gray-700/30 rounded-lg border border-gray-200/50 dark:border-gray-600/30">
                                <div class="p-1.5 bg-emerald-100 dark:bg-emerald-600/20 rounded-md">
                                    <svg class="w-4 h-4 text-emerald-700 dark:text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                    </svg>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-600 dark:text-gray-300" data-i18n="certificates.active.title">Certificati Attivi</p>
                                    <p class="text-gray-800 dark:text-white font-semibold" id="certificateCount">Loading...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Loading State -->
            <div id="loadingState" class="text-center py-12">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-green-500"></div>
                <p class="mt-4 text-gray-400" data-i18n="certificates.loading"></p>
            </div>

            <!-- Error State -->
            <div id="errorState" class="hidden bg-red-900/20 border border-red-500 rounded-lg p-6 text-center">
                <p class="text-red-400 mb-4" data-i18n="certificates.error"></p>
                <button onclick="loadCertificates()" class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg transition-colors" data-i18n="certificates.retry">
                </button>
            </div>

            <!-- Certificates Container -->
            <div id="certificatesContainer" class="hidden">
                <!-- Cards View -->
                <div id="cardsView" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-4">
                    <!-- Cards will be populated here -->
                </div>

                <!-- Table View -->
                <div id="tableView" class="bg-gray-800 rounded-lg border border-gray-700 overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="table w-full text-sm">
                            <thead class="bg-gray-700">
                                <tr>
                                    <!-- Dynamic headers will be generated by JavaScript -->
                                </tr>
                            </thead>
                            <tbody id="tableBody" class="bg-gray-800 divide-y divide-gray-700">
                                <!-- Table rows will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Customization Modal -->
    <div id="customizeModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 rounded-lg p-6 w-full max-w-4xl max-h-[80vh] overflow-y-auto border border-gray-700">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-white" data-i18n="customize.title">Personalizza Vista</h2>
                <button onclick="closeCustomizeModal()" class="text-gray-400 hover:text-white transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Table Column Customization -->
                <div class="space-y-4">
                    <h3 class="text-lg font-semibold text-white flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18m-9-4v8m-7 0V4a1 1 0 011-1h3M3 20h18V4a1 1 0 00-1-1H4a1 1 0 00-1 1v16z"/>
                        </svg>
                        <span data-i18n="customize.table.title">Colonne Tabella</span>
                    </h3>
                    <p class="text-gray-300 text-sm" data-i18n="customize.table.description">Scegli quali colonne visualizzare nella vista tabella</p>
                    
                    <div class="space-y-2 max-h-96 overflow-y-auto bg-gray-900 rounded p-4">
                        <div class="flex items-center justify-between">
                            <button onclick="toggleAllTableColumns(true)" class="text-xs text-green-400 hover:text-green-300" data-i18n="customize.select_all">Seleziona Tutto</button>
                            <button onclick="toggleAllTableColumns(false)" class="text-xs text-red-400 hover:text-red-300" data-i18n="customize.deselect_all">Deseleziona Tutto</button>
                        </div>
                        <div id="tableColumnsSettings"></div>
                    </div>
                </div>

                <!-- Card Field Customization -->
                <div class="space-y-4">
                    <h3 class="text-lg font-semibold text-white flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"/>
                        </svg>
                        <span data-i18n="customize.cards.title">Campi Schede</span>
                    </h3>
                    <p class="text-gray-300 text-sm" data-i18n="customize.cards.description">Scegli quali campi visualizzare nelle schede</p>
                    
                    <div class="space-y-4 max-h-96 overflow-y-auto bg-gray-900 rounded p-4">
                        <div class="flex items-center justify-between">
                            <button onclick="toggleAllCardFields(true)" class="text-xs text-green-400 hover:text-green-300" data-i18n="customize.select_all">Seleziona Tutto</button>
                            <button onclick="toggleAllCardFields(false)" class="text-xs text-red-400 hover:text-red-300" data-i18n="customize.deselect_all">Deseleziona Tutto</button>
                        </div>
                        
                        <!-- Client Data Section -->
                        <div class="space-y-2">
                            <h4 class="text-sm font-medium text-blue-400" data-i18n="card.client_data">Dati Cliente</h4>
                            <div id="clientFieldsSettings" class="ml-4 space-y-2"></div>
                        </div>
                        
                        <!-- Vehicle Data Section -->
                        <div class="space-y-2">
                            <h4 class="text-sm font-medium text-green-400" data-i18n="card.vehicle_data">Dati Veicolo</h4>
                            <div id="vehicleFieldsSettings" class="ml-4 space-y-2"></div>
                        </div>
                        
                        <!-- Device Data Section -->
                        <div class="space-y-2">
                            <h4 class="text-sm font-medium text-purple-400" data-i18n="card.device_data">Dati Dispositivo</h4>
                            <div id="deviceFieldsSettings" class="ml-4 space-y-2"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="flex justify-end gap-3 mt-6 pt-4 border-t border-gray-700">
                <button onclick="resetCustomization()" class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700 transition-colors" data-i18n="customize.reset">
                    Ripristina Predefiniti
                </button>
                <button onclick="closeCustomizeModal()" class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700 transition-colors" data-i18n="common.cancel">
                    Annulla
                </button>
                                        <button onclick="saveCustomization()" class="px-4 py-2 bg-slate-600 hover:bg-slate-700 dark:bg-slate-600 dark:hover:bg-slate-700 text-white rounded transition-colors" data-i18n="common.save">
                    Salva
                </button>
            </div>
        </div>
    </div>

    <!-- Advanced Search Modal -->
    <div id="advancedSearchModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 rounded-lg p-6 w-full max-w-6xl max-h-[85vh] overflow-y-auto border border-gray-700">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-white flex items-center gap-2">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7"></path>
                    </svg>
                    <span data-i18n="advanced_search.title">Advanced Search</span>
                </h2>
                <button onclick="closeAdvancedSearchModal()" class="text-gray-400 hover:text-white transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>

            <!-- Search Criteria Container -->
            <div class="space-y-4 mb-6">
                <div class="flex items-center justify-between">
                    <p class="text-gray-300 text-sm" data-i18n="advanced_search.description">
                        Create complex search queries with multiple criteria and operators
                    </p>
                                            <button onclick="addSearchCriteria()" class="px-3 py-1 bg-emerald-500 hover:bg-emerald-600 dark:bg-emerald-600 dark:hover:bg-emerald-700 text-white rounded text-sm transition-colors flex items-center gap-1" style="color: white !important;">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                        </svg>
                        <span data-i18n="advanced_search.add_criteria">Add Criteria</span>
                    </button>
                </div>
                
                <!-- Search Criteria List -->
                <div id="searchCriteriaContainer" class="space-y-3">
                    <!-- Criteria will be added dynamically -->
                </div>
            </div>

            <!-- Quick Date Range Presets -->
            <div class="mb-6 p-4 bg-gray-900 rounded border border-gray-700">
                <h3 class="text-lg font-semibold text-white mb-3" data-i18n="advanced_search.quick_filters">Quick Filters</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                    <button onclick="applyQuickFilter('today')" class="px-3 py-2 bg-blue-600 text-white rounded text-sm hover:bg-blue-700 transition-colors" data-i18n="advanced_search.today" style="color: white !important;">Today</button>
                    <button onclick="applyQuickFilter('this_week')" class="px-3 py-2 bg-blue-600 text-white rounded text-sm hover:bg-blue-700 transition-colors" data-i18n="advanced_search.this_week" style="color: white !important;">This Week</button>
                    <button onclick="applyQuickFilter('this_month')" class="px-3 py-2 bg-blue-600 text-white rounded text-sm hover:bg-blue-700 transition-colors" data-i18n="advanced_search.this_month" style="color: white !important;">This Month</button>
                    <button onclick="applyQuickFilter('this_year')" class="px-3 py-2 bg-blue-600 text-white rounded text-sm hover:bg-blue-700 transition-colors" data-i18n="advanced_search.this_year" style="color: white !important;">This Year</button>
                    <button onclick="applyQuickFilter('last_30_days')" class="px-3 py-2 bg-indigo-600 text-white rounded text-sm hover:bg-indigo-700 transition-colors" data-i18n="advanced_search.last_30_days" style="color: white !important;">Last 30 Days</button>
                    <button onclick="applyQuickFilter('last_90_days')" class="px-3 py-2 bg-indigo-600 text-white rounded text-sm hover:bg-indigo-700 transition-colors" data-i18n="advanced_search.last_90_days" style="color: white !important;">Last 90 Days</button>
                                            <button onclick="applyQuickFilter('new_cars_2024')" class="px-3 py-2 bg-slate-600 hover:bg-slate-700 dark:bg-slate-600 dark:hover:bg-slate-700 text-white rounded text-sm transition-colors" data-i18n="advanced_search.new_cars_2024" style="color: white !important;">New Cars 2024+</button>
                    <button onclick="applyQuickFilter('high_mileage')" class="px-3 py-2 bg-orange-600 text-white rounded text-sm hover:bg-orange-700 transition-colors" data-i18n="advanced_search.high_mileage" style="color: white !important;">High Mileage</button>
                </div>
            </div>

            <!-- Search Results Preview -->
            <div class="mb-6 p-4 bg-gray-900 rounded border border-gray-700">
                <h3 class="text-lg font-semibold text-white mb-3" data-i18n="advanced_search.preview">Search Preview</h3>
                <div class="flex items-center justify-between mb-2">
                    <span class="text-gray-300 text-sm" data-i18n="advanced_search.matching_certificates">Matching Certificates:</span>
                    <span id="advancedSearchCount" class="text-green-400 font-bold">0</span>
                </div>
                <div id="advancedSearchQuery" class="text-xs text-gray-400 bg-gray-800 p-2 rounded font-mono max-h-20 overflow-y-auto">
                    <!-- Generated SQL query will be shown here -->
                </div>
                <div class="text-xs text-gray-500 mt-1">
                    <span data-i18n="advanced_search.query_note">ℹ️ Questa query è solo per riferimento. Il filtro viene applicato lato client sui dati già caricati.</span>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex justify-end gap-3 pt-4 border-t border-gray-700">
                <button onclick="clearAdvancedSearch()" class="px-4 py-2 bg-gray-300 text-gray-800 rounded hover:bg-gray-400 transition-colors" data-i18n="advanced_search.clear" style="color: #1f2937 !important;">
                    Clear All
                </button>
                                        <button onclick="saveAdvancedSearch()" class="px-4 py-2 bg-slate-600 hover:bg-slate-700 dark:bg-slate-600 dark:hover:bg-slate-700 text-white rounded transition-colors" data-i18n="advanced_search.save" style="color: white !important;">
                    Save Search
                </button>
                <button onclick="closeAdvancedSearchModal()" class="px-4 py-2 bg-gray-300 text-gray-800 rounded hover:bg-gray-400 transition-colors" data-i18n="common.cancel" style="color: #1f2937 !important;">
                    Cancel
                </button>
                                        <button onclick="applyAdvancedSearch()" class="px-4 py-2 bg-emerald-500 hover:bg-emerald-600 dark:bg-emerald-600 dark:hover:bg-emerald-700 text-white rounded transition-colors" data-i18n="advanced_search.apply" style="color: white !important;">
                    Apply Search
                </button>
            </div>
        </div>
    </div>

    <!-- Vehicle Groups Management Modal -->
    <div id="vehicleGroupsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 rounded-lg p-6 w-full max-w-6xl max-h-[85vh] overflow-y-auto border border-gray-700">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-white flex items-center gap-2">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                    </svg>
                    <span data-it="Gestione Gruppi Veicoli" data-en="Vehicle Groups Management">Gestione Gruppi Veicoli</span>
                </h2>
                <button onclick="closeVehicleGroupsModal()" class="text-gray-400 hover:text-white transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>

            <!-- AI Suggestions Section -->
            <div class="mb-8 p-4 bg-gradient-to-r from-blue-900/50 to-purple-900/50 rounded-lg border border-blue-700/50">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-3">
                        <div class="p-2 bg-blue-600/20 rounded-lg">
                            <svg class="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                            </svg>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-white" data-it="Suggerimenti AI" data-en="AI Suggestions">Suggerimenti AI</h3>
                            <p class="text-blue-300 text-sm" data-it="Gruppi suggeriti automaticamente basati sui tuoi veicoli" data-en="Automatically suggested groups based on your vehicles">Gruppi suggeriti automaticamente basati sui tuoi veicoli</p>
                        </div>
                    </div>
                    <button onclick="loadAISuggestions()" class="px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white rounded text-sm transition-colors flex items-center gap-2" style="color: white !important;">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                        </svg>
                        <span data-it="Aggiorna" data-en="Refresh">Aggiorna</span>
                    </button>
                </div>
                
                <!-- AI Suggestions List -->
                <div id="aiSuggestionsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                    <!-- AI suggestions will be loaded here -->
                </div>
                
                <!-- AI Loading State -->
                <div id="aiLoadingState" class="text-center py-6 hidden">
                    <div class="inline-flex items-center justify-center w-8 h-8 bg-blue-600/20 rounded-full mb-3">
                        <svg class="w-4 h-4 text-blue-400 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                        </svg>
                    </div>
                    <p class="text-blue-300 text-sm" data-it="Analizzando i veicoli..." data-en="Analyzing vehicles...">Analizzando i veicoli...</p>
                </div>
            </div>

            <!-- Groups Overview -->
            <div class="mb-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-white" data-it="Gruppi Esistenti" data-en="Existing Groups">Gruppi Esistenti</h3>
                    <button onclick="openCreateGroupModal()" class="px-4 py-2 bg-emerald-500 hover:bg-emerald-600 text-white rounded text-sm transition-colors flex items-center gap-2" style="color: white !important;">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                        </svg>
                        <span data-it="Nuovo Gruppo" data-en="New Group">Nuovo Gruppo</span>
                    </button>
                </div>
                
                <!-- Groups List -->
                <div id="vehicleGroupsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Groups will be loaded here -->
                </div>
            </div>

            <!-- Loading State -->
            <div id="groupsLoadingState" class="text-center py-8 hidden">
                <div class="inline-flex items-center justify-center w-8 h-8 bg-blue-600/20 rounded-full mb-4">
                    <svg class="w-4 h-4 text-blue-400 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                    </svg>
                </div>
                <p class="text-gray-400" data-it="Caricamento gruppi..." data-en="Loading groups...">Caricamento gruppi...</p>
            </div>

            <!-- Error State -->
            <div id="groupsErrorState" class="text-center py-8 hidden">
                <div class="inline-flex items-center justify-center w-8 h-8 bg-red-600/20 rounded-full mb-4">
                    <svg class="w-4 h-4 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                </div>
                <p class="text-red-400" data-it="Errore nel caricamento dei gruppi" data-en="Error loading groups">Errore nel caricamento dei gruppi</p>
            </div>
        </div>
    </div>

    <!-- Create/Edit Group Modal -->
    <div id="createGroupModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-gray-800 rounded-lg p-6 w-full max-w-md border border-gray-700">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-bold text-white" id="createGroupModalTitle" data-it="Nuovo Gruppo" data-en="New Group">Nuovo Gruppo</h3>
                <button onclick="closeCreateGroupModal()" class="text-gray-400 hover:text-white transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>

            <form id="createGroupForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2" data-it="Nome Gruppo" data-en="Group Name">Nome Gruppo</label>
                    <input type="text" id="groupName" name="name" required class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded text-white placeholder-gray-400 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2" data-it="Descrizione" data-en="Description">Descrizione</label>
                    <textarea id="groupDescription" name="description" rows="3" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded text-white placeholder-gray-400 focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2" data-it="Colore" data-en="Color">Colore</label>
                        <input type="color" id="groupColor" name="color" value="#3B82F6" class="w-full h-10 bg-gray-700 border border-gray-600 rounded cursor-pointer">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2" data-it="Icona" data-en="Icon">Icona</label>
                        <select id="groupIcon" name="icon" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="car">🚗 Auto</option>
                            <option value="truck">🚛 Camion</option>
                            <option value="motorcycle">🏍️ Moto</option>
                            <option value="fuel">⛽ Carburante</option>
                            <option value="electric">⚡ Elettrico</option>
                            <option value="hybrid">🔋 Ibrido</option>
                            <option value="fleet">🚐 Flotta</option>
                            <option value="vip">👑 VIP</option>
                        </select>
                    </div>
                </div>

                <div class="flex justify-end gap-3 pt-4 border-t border-gray-700">
                    <button type="button" onclick="closeCreateGroupModal()" class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700 transition-colors" data-it="Annulla" data-en="Cancel">Annulla</button>
                    <button type="submit" class="px-4 py-2 bg-emerald-500 hover:bg-emerald-600 text-white rounded transition-colors" data-it="Salva Gruppo" data-en="Save Group">Salva Gruppo</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Vehicle Management Modal -->
    <div id="vehicleManagementModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 rounded-lg p-6 w-full max-w-6xl max-h-[85vh] overflow-y-auto border border-gray-700">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-bold text-white" id="vehicleManagementModalTitle" data-it="Gestione Veicoli del Gruppo" data-en="Group Vehicle Management">Gestione Veicoli del Gruppo</h3>
                <button onclick="closeVehicleManagementModal()" class="text-gray-400 hover:text-white transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>



            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 h-[calc(90vh-120px)]">
                <!-- Available Vehicles -->
                <div class="bg-gray-700 rounded-lg p-4">
                    <h4 class="text-md font-semibold text-white mb-4" data-it="Veicoli Disponibili" data-en="Available Vehicles">Veicoli Disponibili</h4>
                    
                    <!-- Search -->
                    <div class="mb-4">
                        <input type="text" id="availableVehiclesSearch" placeholder="Cerca veicoli..." class="w-full px-3 py-2 bg-gray-600 border border-gray-500 rounded text-white placeholder-gray-400 focus:ring-2 focus:ring-blue-500 focus:border-transparent" data-it-placeholder="Cerca veicoli..." data-en-placeholder="Search vehicles...">
                    </div>
                    
                    <!-- Available Vehicles List -->
                    <div id="availableVehiclesList" class="space-y-2 max-h-[calc(90vh-280px)] overflow-y-auto">
                        <!-- Loading state -->
                        <div id="availableVehiclesLoading" class="text-center py-4">
                            <div class="inline-flex items-center justify-center w-8 h-8 border-2 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
                            <p class="text-blue-400 text-sm mt-2" data-it="Caricamento veicoli..." data-en="Loading vehicles...">Caricamento veicoli...</p>
                        </div>
                    </div>
                </div>

                <!-- Group Vehicles -->
                <div class="bg-gray-700 rounded-lg p-4">
                    <h4 class="text-md font-semibold text-white mb-4" data-it="Veicoli nel Gruppo" data-en="Group Vehicles">Veicoli nel Gruppo</h4>
                    
                    <!-- Group Vehicles List -->
                    <div id="groupVehiclesList" class="space-y-2 max-h-[calc(90vh-280px)] overflow-y-auto">
                        <!-- Loading state -->
                        <div id="groupVehiclesLoading" class="text-center py-4">
                            <div class="inline-flex items-center justify-center w-8 h-8 border-2 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
                            <p class="text-blue-400 text-sm mt-2" data-it="Caricamento veicoli del gruppo..." data-en="Loading group vehicles...">Caricamento veicoli del gruppo...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Theme System -->
    <script src="/js/theme.js"></script>
    <script src="/js/i18n.js"></script>
    
    <script>
        // Logo switcher function
        function updateHeaderLogo() {
            const logo = document.getElementById('headerLogo');
            if (!logo) return;
            
            const isDark = document.documentElement.classList.contains('dark');
            
            if (isDark) {
                // Dark mode -> use header_logo_dark_theme.png
                logo.src = '/images/header_logo_dark_theme.png?v10';
        
            } else {
                // Light mode -> use header_logo_light_theme.png  
                logo.src = '/images/header_logo_light_theme.png?v10';
                console.log('☀️ Light mode: Using header_logo_light_theme.png');
            }
        }
        
        // Logo will be updated in main DOMContentLoaded
        
        // Watch for theme changes
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                    updateHeaderLogo();
                }
            });
        });
        
        // Start observing
        observer.observe(document.documentElement, {
            attributes: true,
            attributeFilter: ['class']
        });
    </script>
        
        <!-- Bulk Contact Dialog (clean UI) -->
        <div id="bulkContactDialog" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4">
            <div class="bg-gray-900 border border-gray-700 rounded-lg w-full max-w-4xl p-6 max-h-[85vh] overflow-y-auto">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold" data-i18n="contact.dialog.title">Comunicazione AI ai selezionati</h3>
                    <button onclick="closeBulkContactDialog()" class="text-gray-400 hover:text-white">✕</button>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="space-y-5">
                        <div>
                            <p class="text-xs text-gray-400 mb-2" data-i18n="contact.channel">Canale</p>
                            <div id="channelToggleGroup" class="flex gap-2">
                                <button type="button" class="px-3 py-1.5 border border-gray-600 rounded-full text-sm hover:border-emerald-500" data-value="email">Email</button>
                                <button type="button" class="px-3 py-1.5 border border-gray-600 rounded-full text-sm hover:border-emerald-500" data-value="whatsapp">WhatsApp</button>
                            </div>
                        </div>

                        <!-- Template Selector -->
                        <div class="space-y-2 bg-gray-800 border border-gray-700 rounded p-3">
                            <label class="text-xs text-gray-400" data-i18n="contact.use_template">📋 Usa Template</label>
                            <select id="templateSelectorAI" class="w-full rounded bg-gray-900 border border-gray-700 p-2 text-sm" onchange="onTemplateSelectedAI()">
                                <option value="">-- Seleziona Template --</option>
                            </select>
                        </div>



                        <div>
                            <p class="text-xs text-gray-400 mb-2" data-i18n="contact.style">Stile</p>
                            <div id="styleToggleGroup" class="flex flex-wrap gap-2">
                                <button type="button" class="px-3 py-1.5 border border-gray-600 rounded-full text-sm hover:border-emerald-500" data-value="formal" data-i18n="contact.style.formal">Formale</button>
                                <button type="button" class="px-3 py-1.5 border border-gray-600 rounded-full text-sm hover:border-emerald-500" data-value="informal" data-i18n="contact.style.informal">Informale</button>
                                <button type="button" class="px-3 py-1.5 border border-gray-600 rounded-full text-sm hover:border-emerald-500" data-value="professional" data-i18n="contact.style.professional">Professionale</button>
                            </div>
                        </div>

                        <div>
                            <p class="text-xs text-gray-400 mb-2" data-i18n="contact.fields">Dati da includere</p>
                            <div id="fieldsChipGroup" class="flex flex-wrap gap-2">
                                <button type="button" class="px-3 py-1 border border-gray-600 rounded-full text-sm hover:border-emerald-500" data-field="name" data-i18n="contact.field.client">Cliente</button>
                                <button type="button" class="px-3 py-1 border border-gray-600 rounded-full text-sm hover:border-emerald-500" data-field="email" data-i18n="contact.field.email">Email</button>
                                <button type="button" class="px-3 py-1 border border-gray-600 rounded-full text-sm hover:border-emerald-500" data-field="phone" data-i18n="contact.field.phone">Telefono</button>
                                <button type="button" class="px-3 py-1 border border-gray-600 rounded-full text-sm hover:border-emerald-500" data-field="brandModel" data-i18n="contact.field.vehicle">Veicolo</button>
                                <button type="button" class="px-3 py-1 border border-gray-600 rounded-full text-sm hover:border-emerald-500" data-field="plate" data-i18n="contact.field.plate">Targa</button>
                                <button type="button" class="px-3 py-1 border border-gray-600 rounded-full text-sm hover:border-emerald-500" data-field="year" data-i18n="contact.field.year">Anno</button>
                                <button type="button" class="px-3 py-1 border border-gray-600 rounded-full text-sm hover:border-emerald-500" data-field="fuel" data-i18n="contact.field.fuel">Carburante</button>
                                <button type="button" class="px-3 py-1 border border-gray-600 rounded-full text-sm hover:border-emerald-500" data-field="km" data-i18n="contact.field.km">Km</button>
                                <button type="button" class="px-3 py-1 border border-gray-600 rounded-full text-sm hover:border-emerald-500" data-field="vin" data-i18n="contact.field.vin">VIN</button>
                                <button type="button" class="px-3 py-1 border border-gray-600 rounded-full text-sm hover:border-emerald-500" data-field="serial" data-i18n="contact.field.serial">Serial</button>

                            </div>
                            <!-- Firma dealer selector -->
                            <div class="space-y-2 bg-gray-800 border border-gray-700 rounded p-3 mt-2">
                                <label class="text-xs text-gray-400" data-i18n="contact.dealer_signature">Firma dealer</label>
                                <select id="dealerSignatureSelect" class="w-full rounded bg-gray-900 border border-gray-700 p-2">
                                    <option value="none" data-i18n="contact.no_signature">Nessuna firma</option>
                                </select>
                            </div>
                            <!-- Invio ai clienti test -->
                            <label class="inline-flex items-center gap-2 mt-2 text-sm">
                                <input id="sendToTestClients" type="checkbox" class="form-checkbox h-4 w-4 text-green-500" onchange="toggleTestClientsButtonAI()">
                                <span data-i18n="contact.send_to_test_clients">Invia comunicazione ai clienti test</span>
                            </label>
                        </div>
                    </div>

                    <div class="lg:col-span-2 space-y-4">
                        <div>
                            <p class="text-xs text-gray-400 mb-2" data-i18n="contact.prompt">Prompt per l'AI</p>
                            <textarea id="aiPromptInput" rows="6" class="w-full rounded bg-gray-800 border border-gray-700 p-3" data-i18n-placeholder="contact.prompt.placeholder" placeholder="Scrivi qui le istruzioni per l'AI..."></textarea>
                        </div>
                        <!-- Dealer balance (read-only) -->
                        <div class="mt-2 flex items-center justify-between">
                            <p class="text-xs text-gray-400" data-i18n="billing.balance">Credito disponibile</p>
                            <p id="dealerBalanceText" class="text-sm font-semibold">-</p>
                        </div>
                        <!-- Email Subject Field (shown only for email) -->
                        <div id="emailSubjectField" class="hidden">
                            <p class="text-xs text-gray-400 mb-2" data-i18n="contact.email_subject">Oggetto Email</p>
                            <input id="emailSubjectInput" type="text" class="w-full rounded bg-gray-800 border border-gray-700 p-2 text-sm mb-3" data-i18n-placeholder="contact.email_subject_placeholder" placeholder="L'AI genererà l'oggetto automaticamente...">
                        </div>

                        <div>
                            <p class="text-xs text-gray-400 mb-2" data-i18n="contact.preview">Anteprima messaggi (editabile)</p>
                            <textarea id="aiResults" class="h-48 w-full bg-gray-800 border border-gray-700 rounded p-3 text-sm resize-none" data-i18n-placeholder="contact.message_preview_placeholder" placeholder="L'anteprima del messaggio generato dall'AI apparirà qui..."></textarea>
                            <div id="costSummary" class="mt-2 text-xs text-gray-300"></div>
                        </div>

                        <!-- Tags trascinabili per AI -->
                        <div>
                            <p class="text-xs text-gray-400 mb-2" data-i18n="contact.available_tags">Tags disponibili (trascina nell'anteprima)</p>
                            <div id="availableTagsAI" class="flex flex-wrap gap-2 p-3 bg-gray-800 border border-gray-700 rounded min-h-[60px]">
                                <div class="tag-item cursor-move px-2 py-1 bg-emerald-600 text-white rounded text-xs" draggable="true" data-tag="NOME" data-i18n="ai.tags.nome">{NOME}</div>
                                <div class="tag-item cursor-move px-2 py-1 bg-emerald-600 text-white rounded text-xs" draggable="true" data-tag="COGNOME" data-i18n="ai.tags.cognome">{COGNOME}</div>
                                <div class="tag-item cursor-move px-2 py-1 bg-emerald-600 text-white rounded text-xs" draggable="true" data-tag="EMAIL" data-i18n="ai.tags.email">{EMAIL}</div>
                                <div class="tag-item cursor-move px-2 py-1 bg-emerald-600 text-white rounded text-xs" draggable="true" data-tag="TELEFONO" data-i18n="ai.tags.telefono">{TELEFONO}</div>
                                <div class="tag-item cursor-move px-2 py-1 bg-emerald-600 text-white rounded text-xs" draggable="true" data-tag="VEICOLO" data-i18n="ai.tags.veicolo">{VEICOLO}</div>
                                <div class="tag-item cursor-move px-2 py-1 bg-emerald-600 text-white rounded text-xs" draggable="true" data-tag="TARGA" data-i18n="ai.tags.targa">{TARGA}</div>
                                <div class="tag-item cursor-move px-2 py-1 bg-emerald-600 text-white rounded text-xs" draggable="true" data-tag="ANNO" data-i18n="ai.tags.anno">{ANNO}</div>
                                <div class="tag-item cursor-move px-2 py-1 bg-emerald-600 text-white rounded text-xs" draggable="true" data-tag="CARBURANTE" data-i18n="ai.tags.carburante">{CARBURANTE}</div>
                                <div class="tag-item cursor-move px-2 py-1 bg-emerald-600 text-white rounded text-xs" draggable="true" data-tag="KM" data-i18n="ai.tags.km">{KM}</div>
                                <div class="tag-item cursor-move px-2 py-1 bg-emerald-600 text-white rounded text-xs" draggable="true" data-tag="VIN" data-i18n="ai.tags.vin">{VIN}</div>
                                <div class="tag-item cursor-move px-2 py-1 bg-emerald-600 text-white rounded text-xs" draggable="true" data-tag="SERIAL" data-i18n="ai.tags.serial">{SERIAL}</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex justify-end gap-2 mt-6 flex-wrap">
                    <button onclick="generateAIContent()" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded text-white text-sm min-w-fit whitespace-nowrap" data-i18n="contact.generate">Genera bozza</button>
                    <button onclick="saveTemplateFromAI()" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 rounded text-white text-sm min-w-fit whitespace-nowrap" data-i18n="contact.save_template">💾 Salva Template</button>
                    <button id="sendToTestClientsAIBtn" onclick="sendAIToTestClients()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded text-white text-sm hidden min-w-fit whitespace-nowrap" data-i18n="contact.send_to_test_clients_button">Invia comunicazione clienti test</button>
                    <button id="sendAICommunicationsBtn" onclick="sendAICommunications()" class="px-4 py-2 bg-emerald-600 hover:bg-emerald-700 rounded text-white text-sm min-w-fit whitespace-nowrap" data-i18n="contact.send_communications">Invia comunicazioni</button>
                </div>
            </div>
        </div>

        <!-- Bulk Contact WITHOUT AI Dialog -->
        <div id="bulkContactWithoutAIDialog" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4">
            <div class="bg-gray-900 border border-gray-700 rounded-lg w-full max-w-5xl p-6 max-h-[85vh] overflow-y-auto">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold" data-i18n="manual_contact.title">Comunicazione Manuale ai Selezionati</h3>
                    <button onclick="closeBulkContactWithoutAIDialog()" class="text-gray-400 hover:text-white">✕</button>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                    <!-- Left Column: Settings -->
                    <div class="space-y-4">
                        <div>
                            <p class="text-xs text-gray-400 mb-2" data-i18n="manual_contact.channel">Canale</p>
                            <div id="channelToggleGroupNoAI" class="flex gap-2">
                                <button type="button" class="px-3 py-1.5 border border-gray-600 rounded-full text-sm hover:border-emerald-500" data-value="email" data-i18n="manual_contact.email">Email</button>
                                <button type="button" class="px-3 py-1.5 border border-gray-600 rounded-full text-sm hover:border-emerald-500" data-value="whatsapp" data-i18n="manual_contact.whatsapp">WhatsApp</button>
                            </div>
                        </div>

                        <!-- Template Selector -->
                        <div class="space-y-2 bg-gray-800 border border-gray-700 rounded p-3">
                            <label class="text-xs text-gray-400" data-i18n="manual_contact.use_template">📋 Usa Template</label>
                            <select id="templateSelectorNoAI" class="w-full rounded bg-gray-900 border border-gray-700 p-2 text-sm" onchange="onTemplateSelectedManual()">
                                <option value="">-- Seleziona Template --</option>
                            </select>
                        </div>

                        <!-- Dealer Signature -->
                        <div class="space-y-2 bg-gray-800 border border-gray-700 rounded p-3">
                            <label class="text-xs text-gray-400" data-i18n="manual_contact.dealer_signature">Firma Dealer</label>
                            <select id="dealerSignatureSelectNoAI" class="w-full rounded bg-gray-900 border border-gray-700 p-2">
                                <option value="none" data-i18n="manual_contact.no_signature">Nessuna firma</option>
                            </select>
                        </div>

                        <!-- Send to Test Clients -->
                        <label class="inline-flex items-center gap-2 text-sm">
                            <input id="sendToTestClientsNoAI" type="checkbox" class="form-checkbox h-4 w-4 text-green-500" checked>
                            <span data-i18n="manual_contact.send_to_test_clients">Invia ai clienti test</span>
                        </label>

                        <!-- Test Client Selection for Preview -->
                        <div id="testClientSelectorNoAI" class="space-y-2 bg-gray-800 border border-gray-700 rounded p-3">
                            <label class="text-xs text-gray-400" data-i18n="manual_contact.preview_with_test_client">Anteprima con Cliente Test</label>
                            <select id="testClientSelectNoAI" class="w-full rounded bg-gray-900 border border-gray-700 p-2 text-sm">
                                <option value="sample" data-i18n="manual_contact.sample_data">Dati di Esempio</option>
                            </select>
                        </div>
                    </div>

                    <!-- Middle Column: Draggable Tags -->
                    <div class="space-y-4">
                        <div>
                            <p class="text-xs text-gray-400 mb-3" data-i18n="manual_contact.available_data_tags">Tags Dati Disponibili</p>
                            <div class="text-xs text-gray-500 mb-3" data-i18n="manual_contact.drag_tags_into_message">Trascina i tags nel messaggio</div>
                            <div id="draggableTagsContainer" class="space-y-2">
                                <!-- Tags will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>

                    <!-- Right Column: Message Composition -->
                    <div class="lg:col-span-2 space-y-4">
                        <!-- Email Subject Field (shown only for email) -->
                        <div id="emailSubjectFieldNoAI" class="hidden">
                            <p class="text-xs text-gray-400 mb-2" data-i18n="manual_contact.email_subject_required">Oggetto Email (Obbligatorio)</p>
                            <input id="emailSubjectInputNoAI" type="text" class="w-full rounded bg-gray-800 border border-gray-700 p-2 text-sm" data-i18n-placeholder="manual_contact.email_subject_placeholder" placeholder="Inserisci l'oggetto dell'email...">
                        </div>

                        <div>
                            <p class="text-xs text-gray-400 mb-2" data-i18n="manual_contact.your_message">Il Tuo Messaggio</p>
                            <textarea id="manualMessageInput" rows="8" class="w-full rounded bg-gray-800 border border-gray-700 p-3 font-mono text-sm" 
                                data-i18n-placeholder="manual_contact.message_placeholder" placeholder="Scrivi qui il tuo messaggio personalizzato...&#10;&#10;Puoi trascinare i tags dai dati disponibili per inserire informazioni dinamiche.&#10;&#10;Esempio:&#10;Gentile {NOME},&#10;il suo veicolo {VEICOLO} con targa {TARGA}..."></textarea>
                        </div>
                        
                        <!-- Message Preview -->
                        <div>
                            <p class="text-xs text-gray-400 mb-2" data-i18n="manual_contact.preview">Anteprima</p>
                            <div id="manualMessagePreview" class="h-32 overflow-auto bg-gray-800 border border-gray-700 rounded p-3 text-sm"></div>
                        </div>

                        <!-- Dealer Balance -->
                        <div class="flex items-center justify-between">
                            <p class="text-xs text-gray-400" data-i18n="manual_contact.available_credit">Credito Disponibile</p>
                            <p id="dealerBalanceTextNoAI" class="text-sm font-semibold">-</p>
                        </div>
                        <!-- Cost Information -->
                        <div class="text-xs text-gray-500 mt-2">
                            <p data-i18n="manual_contact.cost_email">📧 Email: €0,05 per invio</p>
                            <p data-i18n="manual_contact.cost_whatsapp">📱 WhatsApp: €0,10 per invio</p>
                        </div>
                    </div>
                </div>

                <div class="flex justify-end gap-2 mt-6">
                    <button onclick="saveTemplateFromManual()" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded text-white text-sm" data-i18n="manual_contact.save_template">💾 Salva Template</button>
                    <button id="sendToTestClientsBtn" onclick="sendToTestClients()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded text-white text-sm hidden" data-i18n="manual_contact.send_to_test_clients_button">Invia ai Clienti Test</button>
                    <button id="sendToSelectedBtn" onclick="sendToSelected()" class="px-4 py-2 bg-emerald-600 hover:bg-emerald-700 rounded text-white text-sm" data-i18n="manual_contact.send_to_selected">Invia ai Selezionati</button>
                </div>
            </div>
        </div>

        <script>
        async function confirmAndSend(){
            const language = document.documentElement.lang || 'it';
            const dealerId = getCurrentDealerId();
            const selected = getSelectedCertificates();
            // Costi: email 5c, whatsapp 10c, openAI 20x (mostriamo stima base 0.20€ se 1c provider)
            const channel = document.querySelector('#channelToggleGroup .active-chip')?.dataset.value || 'email';
            const n = selected.length;
            const emailCost = channel==='email' ? n*0.05 : 0;
            const waCost = channel==='whatsapp' ? n*0.10 : 0;
            const openaiCost = 0.20; // stima (20x di 0.01€)
            const total = (emailCost + waCost + openaiCost).toFixed(2);
            const msg = language==='it'
                ? `Sei sicuro? Spenderai:\n- Email: €${emailCost.toFixed(2)}\n- WhatsApp: €${waCost.toFixed(2)}\n- OpenAI: ~€${openaiCost.toFixed(2)}\nTotale stimato: ~€${total}`
                : `Are you sure? You will spend:\n- Email: €${emailCost.toFixed(2)}\n- WhatsApp: €${waCost.toFixed(2)}\n- OpenAI: ~€${openaiCost.toFixed(2)}\nEstimated total: ~€${total}`;
            const proceed = window.confirm(msg);
            if (!proceed) return;
            // Se ho una bozza pronta, invio senza rigenerare
            if (lastDraft && lastDraft.recipients && lastDraft.recipients.length) {
                try {
                    const res = await fetch('/api/communications/generate', {
                        method:'POST', headers:{'Content-Type':'application/json'},
                        body: JSON.stringify({
                            channel: lastDraft.channel,
                            style: document.querySelector('#styleToggleGroup .active-chip')?.dataset.value || 'professional',
                            prompt: document.getElementById('aiPromptInput').value || '',
                            recipients: lastDraft.recipients,
                            useFields: {}, language: lastDraft.language, send: true, dealerId: lastDraft.dealerId,
                            baseMessage: lastDraft.baseMessage,
                            emailSubject: lastDraft.emailSubject
                        })
                    });
                    if (!res.ok) throw new Error(await res.text());
                    // opzionale: feedback visivo
                } catch (e) {
                    alert((language==='it'?'Errore invio: ':'Send error: ')+e.message);
                }
            } else {
                await generateAndOptionallySend(true);
            }
        }
        </script>

        <script>
        // Global variables
        let allCertificates = [];
        let filteredCertificates = [];
        let currentView = 'table';
        let sortField = '';
        let sortOrder = 'asc';
        let lastDraft = null;

        // Get current dealer ID from authentication
        function getCurrentDealerId() {
            // Check for servicehub authentication first (new system)
            const servicehubUser = localStorage.getItem('servicehub-user');
            if (servicehubUser) {
                try {
                    const parsed = JSON.parse(servicehubUser);
                    if (parsed.id) {
                        return parsed.id;
                    }
                } catch (e) {
                    console.warn('⚠️ Invalid servicehub-user format');
                }
            }
            
            // Fallback to legacy authData system
            const authData = localStorage.getItem('authData');
            if (authData) {
                try {
                    const parsed = JSON.parse(authData);
                    if (parsed.dealerId) {
                        return parsed.dealerId;
                    }
                } catch (e) {
                    console.warn('⚠️ Invalid authData format');
                }
            }
            
            // No authentication found
            console.error('❌ No dealer ID found - redirecting to login');
            window.location.href = '/pages/login.html';
            return null;
        }

        // Load certificates for current dealer
        async function loadCertificates() {
            const loadingState = document.getElementById('loadingState');
            const errorState = document.getElementById('errorState');
            const certificatesContainer = document.getElementById('certificatesContainer');
            
            // Show loading state
            if (loadingState) loadingState.classList.remove('hidden');
            if (errorState) errorState.classList.add('hidden');
            if (certificatesContainer) certificatesContainer.classList.add('hidden');
            
            try {
                const dealerId = getCurrentDealerId();
        
                
                const response = await fetch(`/api/certificates/${dealerId}`);
                const data = await response.json();
                

                
                if (data.success && data.data) {
                    allCertificates = data.data.map(cert => {
                        // Helper functions to handle JSON data
                        const getClientName = (clientData) => {
                            if (!clientData) return 'N/A';
                            if (typeof clientData === 'string') return clientData;
                            if (typeof clientData === 'object') {
                                const firstName = clientData.firstName || '';
                                const lastName = clientData.lastName || '';
                                return `${firstName} ${lastName}`.trim() || 'N/A';
                            }
                            return 'N/A';
                        };
                        
                        const getClientEmail = (clientData) => {
                            if (!clientData) return 'N/A';
                            if (typeof clientData === 'object' && clientData.email) {
                                return clientData.email.toLowerCase(); // Forza minuscolo
                            }
                            return 'N/A';
                        };
                        
                        const getClientPhone = (clientData) => {
                            if (!clientData) return 'N/A';
                            if (typeof clientData === 'object') {
                                // Cerca vari possibili nomi per il campo telefono
                                return clientData.phone || clientData.telefono || clientData.mobile || clientData.cellulare || 'N/A';
                            }
                            return 'N/A';
                        };
                        
                        const getVehicleInfo = (vehicleData) => {
                            if (!vehicleData) return 'N/A';
                            if (typeof vehicleData === 'string') return vehicleData;
                            if (typeof vehicleData === 'object') {
                                const brand = vehicleData.brand || '';
                                const model = vehicleData.model || '';
                                const year = vehicleData.year || '';
                                return `${brand} ${model} ${year}`.trim() || 'N/A';
                            }
                            return 'N/A';
                        };
                        
                        const getVehiclePlate = (vehicleData) => {
                            if (!vehicleData) return 'N/A';
                            if (typeof vehicleData === 'object' && vehicleData.plate) {
                                return vehicleData.plate.toUpperCase();
                            }
                            return 'N/A';
                        };
                        
                        const getVehicleBrand = (vehicleData) => {
                            if (!vehicleData) return 'N/A';
                            if (typeof vehicleData === 'object' && vehicleData.brand) {
                                return vehicleData.brand;
                            }
                            return 'N/A';
                        };
                        
                        const getVehicleModel = (vehicleData) => {
                            if (!vehicleData) return 'N/A';
                            if (typeof vehicleData === 'object' && vehicleData.model) {
                                return vehicleData.model;
                            }
                            return 'N/A';
                        };
                        
                        const getFuelType = (vehicleData) => {
                            if (!vehicleData) return 'N/A';
                            if (typeof vehicleData === 'object' && vehicleData.fuelType) {
                                return vehicleData.fuelType;
                            }
                            return 'N/A';
                        };
                        
                        const getVIN = (vehicleData) => {
                            if (!vehicleData) return 'N/A';
                            if (typeof vehicleData === 'object' && vehicleData.vin) {
                                return vehicleData.vin.toUpperCase();
                            }
                            return 'N/A';
                        };
                        
                        const getVehicleYear = (vehicleData) => {
                            if (!vehicleData) return 'N/A';
                            if (typeof vehicleData === 'object' && vehicleData.year) {
                                return vehicleData.year.toString();
                            }
                            return 'N/A';
                        };
                        
                        const formatName = (name) => {
                            if (!name || name === 'N/A') return name;
                            return name.toLowerCase().split(' ')
                                .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                                .join(' ');
                        };
                        
                        return {
                            ...cert,
                            clientName: formatName(getClientName(cert.client)),
                            clientEmail: getClientEmail(cert.client),
                            clientPhone: getClientPhone(cert.client),
                            vehicleInfo: getVehicleInfo(cert.vehicle),
                            vehiclePlate: getVehiclePlate(cert.vehicle),
                            vehicleBrand: getVehicleBrand(cert.vehicle),
                            vehicleModel: getVehicleModel(cert.vehicle),
                            vehicleYear: getVehicleYear(cert.vehicle),
                            fuelType: getFuelType(cert.vehicle),
                            vin: getVIN(cert.vehicle),
                            installerName: formatName(cert.installerName || 'N/A'),
                            status: cert.active ? 'active' : 'inactive'
                        };
                    });
                    
                    // Initialize filteredCertificates with all certificates
                    filteredCertificates = allCertificates;
                    
                    // Hide loading, show container
                    if (loadingState) loadingState.classList.add('hidden');
                    if (certificatesContainer) certificatesContainer.classList.remove('hidden');
                    
                    // Initialize filters and display
                    initializeFilters();
                    
                } else {
                    console.error('❌ API call failed or no data:', data);
                    throw new Error(data.message || 'Errore sconosciuto');
                }
                
            } catch (error) {
                console.error('Errore caricamento certificati:', error);
                
                // Show error state
                if (loadingState) loadingState.classList.add('hidden');
                if (errorState) {
                    errorState.classList.remove('hidden');
                    errorState.querySelector('p').textContent = `Errore: ${error.message}`;
                }
            }
        }



        // Display certificates based on current view
        function displayCertificates() {
            if (currentView === 'cards') {
                displayCardView();
            } else {
                displayTableView();
            }
        }

        // Show card view
        function showCardView() {
            currentView = 'cards';
            
            // SELEZIONATO: Verde con testo/icona bianchi
            document.getElementById('cardsViewBtn').className = 'px-4 py-2 rounded-md text-sm font-medium transition-all duration-200 flex items-center gap-2 bg-emerald-500 dark:bg-emerald-600 text-white shadow-md';
            document.getElementById('cardsViewBtn').style.setProperty('color', 'white', 'important');
            const cardSpan = document.getElementById('cardsViewBtn').querySelector('span');
            if (cardSpan) cardSpan.style.setProperty('color', 'white', 'important');
            
            // NON SELEZIONATO: Grigio con testo/icona neri
            document.getElementById('tableViewBtn').className = 'px-4 py-2 rounded-md text-sm font-medium transition-all duration-200 flex items-center gap-2 text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200';
            document.getElementById('tableViewBtn').style.setProperty('color', '#374151', 'important');
            const tableSpan = document.getElementById('tableViewBtn').querySelector('span');
            if (tableSpan) tableSpan.style.setProperty('color', '#374151', 'important');
            
            document.getElementById('cardsView').classList.remove('hidden');
            document.getElementById('tableView').classList.add('hidden');
            displayCardView(); // This will automatically call loadVehicleImages()
        }

        // Show table view
        function showTableView() {
            currentView = 'table';
            
            // SELEZIONATO: Verde con testo/icona bianchi
            document.getElementById('tableViewBtn').className = 'px-4 py-2 rounded-md text-sm font-medium transition-all duration-200 flex items-center gap-2 bg-emerald-500 dark:bg-emerald-600 text-white shadow-md';
            document.getElementById('tableViewBtn').style.setProperty('color', 'white', 'important');
            const tableSpan = document.getElementById('tableViewBtn').querySelector('span');
            if (tableSpan) tableSpan.style.setProperty('color', 'white', 'important');
            
            // NON SELEZIONATO: Grigio con testo/icona neri
            document.getElementById('cardsViewBtn').className = 'px-4 py-2 rounded-md text-sm font-medium transition-all duration-200 flex items-center gap-2 text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200';
            document.getElementById('cardsViewBtn').style.setProperty('color', '#374151', 'important');
            const cardSpan = document.getElementById('cardsViewBtn').querySelector('span');
            if (cardSpan) cardSpan.style.setProperty('color', '#374151', 'important');
            
            document.getElementById('tableView').classList.remove('hidden');
            document.getElementById('cardsView').classList.add('hidden');
            displayTableView();
        }
                // Generate client data section for cards
        function generateClientSection(cert, settings) {
            const clientFields = Object.entries(settings.cardFields)
                .filter(([fieldId, fieldInfo]) => fieldInfo.section === 'client' && fieldInfo.enabled)
                .map(([fieldId, fieldInfo]) => {
                    switch(fieldId) {
                        case 'clientName':
                            return `
                                <div class="flex items-center gap-3">
                                    <div class="flex-shrink-0 w-8 h-8 bg-blue-100 dark:bg-blue-500/20 rounded-full flex items-center justify-center cursor-pointer" ondblclick="copyToClipboard('${cert.clientName}', 'Client Name')">
                                        <svg class="w-4 h-4 text-blue-600 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                                        </svg>
                                    </div>
                                    <div class="flex-1">
                                        <p class="field-label text-xs uppercase tracking-wide">${t('card.client_name')}</p>
                                        <p class="field-value font-medium">${cert.clientName}</p>
                                    </div>
                                </div>`;
                        case 'clientEmail':
                            return `
                                <div class="flex items-center gap-3">
                                    <div class="flex-shrink-0 w-8 h-8 bg-blue-100 dark:bg-blue-500/20 rounded-full flex items-center justify-center cursor-pointer" ondblclick="copyToClipboard('${cert.clientEmail}', 'Email')">
                                        <svg class="w-4 h-4 text-blue-600 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                                        </svg>
                                    </div>
                                    <div class="flex-1">
                                        <p class="field-label text-xs uppercase tracking-wide">${t('card.client_email')}</p>
                                        <p class="field-value-secondary long-text text-sm" title="${cert.clientEmail}">${cert.clientEmail}</p>
                                    </div>
                                </div>`;
                        case 'clientPhone':
                            return `
                                <div class="flex items-center gap-3">
                                    <div class="flex-shrink-0 w-8 h-8 bg-blue-100 dark:bg-blue-500/20 rounded-full flex items-center justify-center cursor-pointer" ondblclick="copyToClipboard('${cert.clientPhone}', 'Phone')">
                                        <svg class="w-4 h-4 text-blue-600 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
                                        </svg>
                                    </div>
                                    <div class="flex-1">
                                        <p class="field-label text-xs uppercase tracking-wide">Telefono</p>
                                        <p class="field-value-secondary long-text text-sm" title="${cert.clientPhone}">${cert.clientPhone}</p>
                                    </div>
                                </div>`;
                        default:
                            return '';
                    }
                }).join('');

            if (!clientFields) return '';
            
            return `
                <div class="client-section border rounded-lg p-4">
                    <h3 class="text-sm font-semibold mb-3 flex items-center gap-2">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                        </svg>
                        ${t('card.client_data')}
                    </h3>
                    <div class="space-y-3">
                        ${clientFields}
                    </div>
                </div>`;
        }

        // Generate vehicle data section for cards
        function generateVehicleSection(cert, settings) {
            const vehicleFields = Object.entries(settings.cardFields)
                .filter(([fieldId, fieldInfo]) => fieldId !== 'vehicleImage' && fieldInfo.section === 'vehicle' && fieldInfo.enabled);

            // Check if model field is enabled (it gets special treatment)
            const hasModel = vehicleFields.some(([fieldId]) => fieldId === 'vehicleInfo');
            
            // Get other vehicle fields (non-model)
            const otherFields = vehicleFields
                .filter(([fieldId]) => fieldId !== 'vehicleInfo')
                .map(([fieldId, fieldInfo]) => {
                    switch(fieldId) {
                        case 'vehicleYear':
                            return `
                                <div class="flex items-center gap-2">
                                    <div class="flex-shrink-0 w-8 h-8 bg-green-100 dark:bg-green-500/20 rounded-full flex items-center justify-center cursor-pointer" ondblclick="copyToClipboard('${cert.vehicleYear}', 'Year')">
                                        <svg class="w-4 h-4 text-green-600 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 11v4"/>
                                        </svg>
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <p class="field-label text-xs uppercase tracking-wide">Anno</p>
                                        <p class="field-value font-semibold text-base">${cert.vehicleYear}</p>
                                    </div>
                                </div>`;
                        case 'vehiclePlate':
                            return `
                                <div class="flex items-center gap-2">
                                    <div class="flex-shrink-0 w-8 h-8 bg-green-100 dark:bg-green-500/20 rounded-full flex items-center justify-center cursor-pointer" ondblclick="copyToClipboard('${cert.vehiclePlate}', 'License Plate')">
                                        <svg class="w-4 h-4 text-green-600 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <rect x="3" y="6" width="18" height="12" rx="2" ry="2" stroke-width="2"/>
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 10h10M7 14h6"/>
                                            <circle cx="20" cy="8" r="1" fill="currentColor"/>
                                            <circle cx="20" cy="16" r="1" fill="currentColor"/>
                                        </svg>
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <p class="field-label text-xs uppercase tracking-wide">${t('table.plate')}</p>
                                        <p class="field-value long-text font-semibold text-base" title="${cert.vehiclePlate}">${cert.vehiclePlate}</p>
                                    </div>
                                </div>`;
                        case 'odometer':
                            return `
                                <div class="flex items-center gap-2">
                                    <div class="flex-shrink-0 w-8 h-8 bg-green-100 dark:bg-green-500/20 rounded-full flex items-center justify-center cursor-pointer" ondblclick="copyToClipboard('${cert.odometer ? cert.odometer.toLocaleString('it-IT') + ' km' : 'N/A'}', 'Odometer')">
                                        <svg class="w-4 h-4 text-green-600 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 20l4-16m2 16l4-16M6 9h14M4 15h14"/>
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 11v4"/>
                                            <circle cx="12" cy="12" r="2" fill="currentColor"/>
                                        </svg>
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <p class="field-label text-xs uppercase tracking-wide">${t('card.odometer')}</p>
                                        <p class="field-value text-sm font-medium">${cert.odometer ? cert.odometer.toLocaleString('it-IT') + ' km' : 'N/A'}</p>
                                    </div>
                                </div>`;
                        case 'fuelType':
                            return `
                                <div class="flex items-center gap-2">
                                    <div class="flex-shrink-0 w-8 h-8 bg-green-100 dark:bg-green-500/20 rounded-full flex items-center justify-center cursor-pointer" ondblclick="copyToClipboard('${cert.fuelType}', 'Fuel Type')">
                                        <svg class="w-4 h-4 text-green-600 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 18.657A8 8 0 016.343 7.343S7 9 9 10c0-2 .5-5 2.986-7C14 5 16.09 5.777 17.656 7.343A7.975 7.975 0 0120 13a7.975 7.975 0 01-2.343 5.657z"/>
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.879 16.121A3 3 0 1012.015 11L11 14H9c0 .768.293 1.536.879 2.121z"/>
                                        </svg>
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <p class="field-label text-xs uppercase tracking-wide">${t('table.fuel')}</p>
                                        <p class="field-value-secondary long-text text-sm">${cert.fuelType}</p>
                                    </div>
                                </div>`;
                        case 'vin':
                            return `
                                <div class="flex items-center gap-2">
                                    <div class="flex-shrink-0 w-8 h-8 bg-green-100 dark:bg-green-500/20 rounded-full flex items-center justify-center cursor-pointer" ondblclick="copyToClipboard('${cert.vin || 'N/A'}', 'VIN Number')">
                                        <svg class="w-4 h-4 text-green-600 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 20l4-16m2 16l4-16M6 9h14M4 15h14"/>
                                        </svg>
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <p class="field-label text-xs uppercase tracking-wide">${t('card.vin_number')}</p>
                                        <p class="field-value-secondary font-mono text-xs">${cert.vin || 'N/A'}</p>
                                    </div>
                                </div>`;
                        default:
                            return '';
                    }
                }).join('');

            if (!hasModel && !otherFields) return '';
            
            return `
                <div class="vehicle-section border rounded-lg p-4">
                    <h3 class="text-sm font-semibold mb-3 flex items-center gap-2">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.22.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0-1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM5 11l1.5-4.5h11L19 11H5z"/>
                        </svg>
                        ${t('card.vehicle_data')}
                    </h3>
                    <div class="space-y-3">
                        ${hasModel ? `
                            <!-- Model Field (Full Width) -->
                            <div class="flex items-center gap-3 mb-2">
                                <div class="flex-shrink-0 w-8 h-8 bg-green-100 dark:bg-green-500/20 rounded-full flex items-center justify-center cursor-pointer" ondblclick="copyToClipboard('${cert.vehicleInfo || 'N/A'}', 'Vehicle Model')">
                                    <svg class="w-4 h-4 text-green-600 dark:text-green-400" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.22.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0-1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM5 11l1.5-4.5h11L19 11H5z"/>
                                    </svg>
                                </div>
                                <div class="flex-1">
                                    <p class="field-label text-xs uppercase tracking-wide">Modello</p>
                                    <p class="field-value font-semibold text-base">${cert.vehicleInfo || 'N/A'}</p>
                                </div>
                            </div>` : ''}
                        
                        ${otherFields ? `<div class="grid grid-cols-1 gap-3">${otherFields}</div>` : ''}
                    </div>
                </div>`;
        }

        // Generate device data section for cards
        function generateDeviceSection(cert, settings) {
            const deviceFields = Object.entries(settings.cardFields)
                .filter(([fieldId, fieldInfo]) => fieldInfo.section === 'device' && fieldInfo.enabled)
                .map(([fieldId, fieldInfo]) => {
                    switch(fieldId) {
                        case 'deviceId':
                            return `
                                <div class="flex items-center gap-3">
                                    <div class="flex-shrink-0 w-8 h-8 bg-purple-100 dark:bg-purple-500/20 rounded-full flex items-center justify-center cursor-pointer" ondblclick="copyToClipboard('${cert.deviceId || 'N/A'}', 'Device ID')">
                                        <svg class="w-4 h-4 text-purple-600 dark:text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"/>
                                        </svg>
                                    </div>
                                    <div class="flex-1">
                                        <p class="field-label text-xs uppercase tracking-wide">${t('card.device_id')}</p>
                                        <p class="field-value long-text font-mono text-sm" title="${cert.deviceId || 'N/A'}">${cert.deviceId || 'N/A'}</p>
                                    </div>
                                </div>`;
                        case 'imei':
                            // Show Serial instead of IMEI in cards
                            return `
                                <div class="flex items-center gap-3">
                                    <div class="flex-shrink-0 w-8 h-8 bg-purple-100 dark:bg-purple-500/20 rounded-full flex items-center justify-center cursor-pointer" ondblclick="copyToClipboard('${cert.serial || 'N/A'}', 'Serial')">
                                        <svg class="w-4 h-4 text-purple-600 dark:text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 20l4-16m2 16l4-16M6 9h14M4 15h14"/>
                                            <rect x="3" y="3" width="18" height="18" rx="2" stroke-width="1" opacity="0.3"/>
                                        </svg>
                                    </div>
                                    <div class="flex-1">
                                        <p class="field-label text-xs uppercase tracking-wide">Serial</p>
                                        <p class="field-value long-text font-mono text-sm" title="${cert.serial || 'N/A'}">${cert.serial || 'N/A'}</p>
                                    </div>
                                </div>`;
                        case 'installerName':
                            return `
                                <div class="flex items-center gap-3">
                                    <div class="flex-shrink-0 w-8 h-8 bg-purple-100 dark:bg-purple-500/20 rounded-full flex items-center justify-center cursor-pointer" ondblclick="copyToClipboard('${cert.installerName || 'N/A'}', 'Installer')">
                                        <svg class="w-4 h-4 text-purple-600 dark:text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                        </svg>
                                    </div>
                                    <div class="flex-1">
                                        <p class="field-label text-xs uppercase tracking-wide">${t('card.installer')}</p>
                                        <p class="field-value-secondary">${cert.installerName || 'N/A'}</p>
                                    </div>
                                </div>`;
                        case 'installationPoint':
                            return `
                                <div class="flex items-center gap-3">
                                    <div class="flex-shrink-0 w-8 h-8 bg-purple-100 dark:bg-purple-500/20 rounded-full flex items-center justify-center cursor-pointer" ondblclick="copyToClipboard('${cert.installationPoint || 'N/A'}', 'Installation Point')">
                                        <svg class="w-4 h-4 text-purple-600 dark:text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                                        </svg>
                                    </div>
                                    <div class="flex-1">
                                        <p class="field-label text-xs uppercase tracking-wide">${t('card.installation_point')}</p>
                                        <p class="field-value-secondary">${cert.installationPoint || 'N/A'}</p>
                                    </div>
                                </div>`;
                        default:
                            return '';
                    }
                }).join('');

            if (!deviceFields) return '';
            
            return `
                <div class="device-section border rounded-lg p-4">
                    <h3 class="text-sm font-semibold mb-3 flex items-center gap-2">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M17 1H7c-1.1 0-2 .9-2 2v18c0 1.1.9 2 2 2h10c1.1 0 2-.9 2-2V3c0-1.1-.9-2-2-2zM7 4V3h10v1H7zm0 14V6h10v12H7zm0 3v-1h10v1H7z"/>
                        </svg>
                        ${t('card.device_data')}
                    </h3>
                    <div class="space-y-3">
                        ${deviceFields}
                    </div>
                </div>`;
        }

        // Display cards
        function displayCardView() {
            const cardsContainer = document.getElementById('cardsView');
            const settings = loadCustomizationSettings();
            
                         if (filteredCertificates.length === 0) {
                cardsContainer.innerHTML = `
                    <div class="col-span-full bg-yellow-900/20 border border-yellow-500 rounded-lg p-6 text-center">
                        <p class="text-yellow-400">${t('certificates.empty.title')}</p>
                        <p class="text-gray-300 mt-2">${t('certificates.empty.description')}</p>
                    </div>
                `;
                return;
            }

            cardsContainer.innerHTML = filteredCertificates.map(cert => {
                // Generate sections based on customization settings
                const clientSection = generateClientSection(cert, settings);
                const vehicleSection = generateVehicleSection(cert, settings);
                const deviceSection = generateDeviceSection(cert, settings);
                
                // Check if vehicle image is enabled
                const isVehicleImageEnabled = settings.cardFields.vehicleImage && settings.cardFields.vehicleImage.enabled;
                
                // Only show sections that have enabled fields
                const sectionsHtml = [clientSection, vehicleSection, deviceSection]
                    .filter(section => section.trim() !== '')
                    .join('');
                
                return `
                    <div class="certificate-card rounded-xl shadow-xl p-6 border hover:border-green-500/50 transition-all duration-300 ease-in-out">
                        
                        <!-- Card Header -->
                        <div class="flex justify-between items-start mb-6">
                            <div>
                                <h2 class="card-title text-xl font-bold mb-1">${t('card.title')}</h2>
                                <p class="card-subtitle text-sm">${new Date(cert.createdAt).toLocaleDateString('it-IT')}</p>
                            </div>
                            <div class="flex items-center gap-3">
                                <span class="card-id text-2xl font-bold">#${cert.id}</span>
                                <!-- Edit Vehicle Button -->
                                <button onclick="openVehiclePage(${cert.id})" 
                                        class="p-2 text-gray-400 hover:text-green-500 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors"
                                        title="${t('vehicle.open_details')}">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        
                        ${isVehicleImageEnabled ? `
                        <!-- Vehicle Image -->
                        <div class="vehicle-container mb-6 relative overflow-hidden rounded-xl border shadow-inner" style="height: 160px;">
                            <div class="absolute inset-0 bg-gradient-to-br from-blue-50/30 to-green-50/30 dark:from-gray-600/20 dark:to-gray-700/20"></div>
                            <img id="vehicle-image-${cert.id}" 
                                 src="/images/placeholder-vehicle.svg" 
                                 alt="Vehicle Image" 
                                 class="w-full h-full object-contain transition-all duration-300 ease-out relative z-10"
                                 style="opacity: 0.95; padding: 15px; filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.1));">
                            <div class="absolute inset-0 bg-gradient-to-t from-gray-200/20 dark:from-gray-800/30 via-transparent to-transparent pointer-events-none"></div>
                            
                            <!-- Decorative elements -->
                            <div class="absolute top-3 left-3 w-2 h-2 bg-green-400 rounded-full opacity-60 animate-pulse"></div>
                            <div class="absolute top-3 right-3 w-1.5 h-1.5 bg-blue-400 rounded-full opacity-50"></div>
                            <div class="absolute bottom-3 left-3 w-1 h-1 bg-purple-400 rounded-full opacity-40"></div>
                        </div>
                        ` : ''}
                        
                        <!-- Dynamic Card Content Based on Customization -->
                        <div class="space-y-5">
                            ${sectionsHtml}
                        </div>
                    </div>
                `;
            }).join('');
            // Load vehicle images after rendering cards (only if vehicle image is enabled)
            const isVehicleImageEnabled = settings.cardFields.vehicleImage && settings.cardFields.vehicleImage.enabled;
            if (isVehicleImageEnabled) {
                loadVehicleImages();
            }
        }

                         // Load vehicle images for all certificates (only for visible images)
        async function loadVehicleImages() {
            if (typeof window.vehicleImageService === 'undefined') {
                console.warn('⚠️ VehicleImageService not loaded');
                return;
            }

            console.log('🚗 Loading vehicle images...');
            
            for (const cert of filteredCertificates) {
                const imageElement = document.getElementById(`vehicle-image-${cert.id}`);
                // Only load image if the element exists (meaning vehicle image is enabled for this card)
                if (imageElement) {
                     try {
                         // Extract vehicle data for image loading
                         let vehicleData = cert.vehicle;
                         if (typeof vehicleData === 'string') {
                             vehicleData = JSON.parse(vehicleData);
                         }
                         
                         const brand = vehicleData?.brand || 'Generic';
                         const model = vehicleData?.model || 'Car';
                         const year = vehicleData?.year || new Date().getFullYear();
                         const color = vehicleData?.color || 'white';
                         const type = vehicleData?.type || 'sedan';
                         const fuelType = vehicleData?.fuelType || 'gasoline';
                         
                         // Use vehicleImageService instance with correct object parameter
                         const vehicleObj = { brand, model, year, color, type, fuelType };
                         const imageUrl = await window.vehicleImageService.getVehicleImage(vehicleObj);
                         
                         if (imageUrl && imageUrl !== '/images/placeholder-vehicle.svg') {
                             imageElement.src = imageUrl;
                             imageElement.style.opacity = '1';
                         }
                         
                     } catch (error) {
                         // Silent error handling
                     }
                 }
             }
         }

        // Display table
        function displayTableView() {
            const tableBody = document.getElementById('tableBody');
            const settings = loadCustomizationSettings();
            
            // Get visible columns and sort by order
            const visibleColumns = Object.entries(settings.tableColumns)
                .filter(([_, columnInfo]) => columnInfo.enabled)
                .sort((a, b) => a[1].order - b[1].order);
            
            // Update table header to match visible columns
            updateTableHeader(visibleColumns);
            ensureBulkActionsBar();
                         
            if (filteredCertificates.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="${visibleColumns.length + 1}" class="px-6 py-8 text-center">
                            <div class="text-yellow-400">${t('certificates.empty.title')}</div>
                            <div class="text-gray-300 text-sm mt-2">${t('certificates.empty.description')}</div>
                        </td>
                    </tr>
                `;
                return;
            }

            tableBody.innerHTML = filteredCertificates.map(cert => `
                <tr class="hover:bg-gray-700 transition-colors">
                    <!-- Actions Column (First) -->
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-center flex items-center gap-2">
                        <input type="checkbox" class="form-checkbox h-4 w-4 text-green-500" data-row-checkbox data-id="${cert.id}" onchange="toggleRowSelection(${cert.id}, this.checked)" />
                        <button onclick="openVehiclePage(${cert.id})" 
                                class="p-1.5 text-gray-400 hover:text-green-500 hover:bg-gray-600 rounded transition-colors"
                                title="${t('vehicle.open_details')}">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                            </svg>
                        </button>
                    </td>
                    ${visibleColumns.map(([columnId]) => generateTableCell(cert, columnId)).join('')}
                </tr>
            `).join('');
            updateSelectionUI();
        }

        function ensureBulkActionsBar() {
            if (document.getElementById('bulkActionsBar')) return;
            const container = document.querySelector('#tableView');
            const bar = document.createElement('div');
            bar.id = 'bulkActionsBar';
            bar.className = 'hidden mb-3 flex items-center justify-between bg-gray-800 border border-gray-700 rounded p-3';
            bar.innerHTML = `
                <div class="text-sm text-gray-300">
                    <span id="selectedCount">0</span> ${t('selected.items') || 'selected'}
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="openBulkContactDialog(); initChipGroups(); initDragDropTagsAI();" class="px-3 py-2 bg-emerald-600 hover:bg-emerald-700 rounded text-white text-sm" data-i18n="contact.with_ai">${t('contact.with_ai')}</button>
                                            <button onclick="openBulkContactWithoutAIDialog(); initDragDropTags();" class="px-3 py-2 bg-blue-600 hover:bg-blue-700 rounded text-white text-sm ml-2" data-i18n="manual_contact.contact_without_ai">${t('manual_contact.contact_without_ai')}</button>
                    <button onclick="toggleSelectAll(false)" class="px-3 py-2 bg-gray-700 hover:bg-gray-600 rounded text-sm">${t('clear.selection') || 'Pulisci selezione'}</button>
                </div>
            `;
            container.parentNode.insertBefore(bar, container);
            
            // Update translations for the newly created elements
            if (window.i18n && typeof window.i18n.updateAllTranslations === 'function') {
                window.i18n.updateAllTranslations();
            }
        }

        // Update table header based on visible columns
        function updateTableHeader(visibleColumns) {
            const tableHeader = document.querySelector('#tableView thead tr');
            if (!tableHeader) return;
            
            tableHeader.innerHTML = `
                <!-- Actions Column Header (First) -->
                <th class="px-4 py-3 text-center text-xs font-medium text-gray-300 uppercase tracking-wider" style="white-space: nowrap !important; min-width: 110px;">
                    <label class="inline-flex items-center gap-2">
                        <input id="selectAllCheckbox" type="checkbox" class="form-checkbox h-4 w-4 text-green-500" onchange="toggleSelectAll(this.checked)" />
                        <span data-i18n="table.actions">Actions</span>
                    </label>
                </th>
            ` + visibleColumns.map(([columnId, columnInfo]) => `
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider cursor-pointer hover:bg-gray-600" onclick="sortTable('${columnId}')" style="white-space: nowrap !important; min-width: ${getColumnMinWidth(columnId)};">
                    <span id="sort-${columnId}" data-field="${columnInfo.key}">↑↓</span>
                </th>
            `).join('');
            
            // Update sort indicators with translations
            document.querySelectorAll('[id^="sort-"]').forEach(span => {
                const fieldName = span.id.replace('sort-', '');
                const translationKey = span.getAttribute('data-field');
                const translatedText = translationKey ? t(translationKey) : '';
                
                if (fieldName === sortField) {
                    span.textContent = `${translatedText} ${sortOrder === 'asc' ? '↑' : '↓'}`;
                } else {
                    span.textContent = `${translatedText} ↑↓`;
                }
            });
        }

        // Generate table cell content
        function generateTableCell(cert, columnId) {
            let value, displayValue, copyValue, copyLabel;
            
            switch(columnId) {
                case 'id':
                    value = `#${cert.id}`;
                    copyValue = cert.id;
                    copyLabel = 'Certificate #';
                    displayValue = `<td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-white cursor-pointer hover:bg-blue-600/20 transition-colors" ondblclick="copyToClipboard('${copyValue}', '${copyLabel}')" title="Double-click to copy">${value}</td>`;
                    break;
                case 'createdAt':
                    value = new Date(cert.createdAt).toLocaleDateString('it-IT');
                    copyValue = value;
                    copyLabel = 'Date';
                    displayValue = `<td class="px-4 py-3 whitespace-nowrap text-sm text-gray-300 cursor-pointer hover:bg-blue-600/20 transition-colors" ondblclick="copyToClipboard('${copyValue}', '${copyLabel}')" title="Double-click to copy">${value}</td>`;
                    break;
                case 'clientName':
                    value = cert.clientName;
                    copyValue = value;
                    copyLabel = 'Client Name';
                    displayValue = `<td class="px-4 py-3 whitespace-nowrap text-sm text-gray-300 cursor-pointer hover:bg-blue-600/20 transition-colors" ondblclick="copyToClipboard('${copyValue}', '${copyLabel}')" title="Double-click to copy">${value}</td>`;
                    break;
                case 'clientEmail':
                    value = cert.clientEmail;
                    copyValue = value;
                    copyLabel = 'Email';
                    displayValue = `<td class="px-4 py-3 whitespace-nowrap text-sm text-gray-300 cursor-pointer hover:bg-blue-600/20 transition-colors" ondblclick="copyToClipboard('${copyValue}', '${copyLabel}')" title="Double-click to copy">${value}</td>`;
                    break;
                case 'clientPhone':
                    value = cert.clientPhone;
                    copyValue = value;
                    copyLabel = 'Phone';
                    displayValue = `<td class="px-4 py-3 whitespace-nowrap text-sm text-gray-300 cursor-pointer hover:bg-blue-600/20 transition-colors" ondblclick="copyToClipboard('${copyValue}', '${copyLabel}')" title="Double-click to copy">${value}</td>`;
                    break;
                case 'vehicleInfo':
                    value = cert.vehicleInfo;
                    copyValue = value;
                    copyLabel = 'Vehicle';
                    displayValue = `<td class="px-4 py-3 whitespace-nowrap text-sm text-gray-300 cursor-pointer hover:bg-blue-600/20 transition-colors" ondblclick="copyToClipboard('${copyValue}', '${copyLabel}')" title="Double-click to copy">${value}</td>`;
                    break;
                case 'vehicleYear':
                    value = cert.vehicleYear;
                    copyValue = value;
                    copyLabel = 'Year';
                    displayValue = `<td class="px-4 py-3 whitespace-nowrap text-sm text-gray-300 font-bold cursor-pointer hover:bg-blue-600/20 transition-colors" ondblclick="copyToClipboard('${copyValue}', '${copyLabel}')" title="Double-click to copy">${value}</td>`;
                    break;
                case 'fuelType':
                    value = cert.fuelType;
                    copyValue = value;
                    copyLabel = 'Fuel Type';
                    displayValue = `<td class="px-4 py-3 whitespace-nowrap text-sm text-gray-300 cursor-pointer hover:bg-blue-600/20 transition-colors" ondblclick="copyToClipboard('${copyValue}', '${copyLabel}')" title="Double-click to copy">${value}</td>`;
                    break;
                case 'vehiclePlate':
                    value = cert.vehiclePlate;
                    copyValue = value;
                    copyLabel = 'License Plate';
                    displayValue = `<td class="px-4 py-3 whitespace-nowrap text-sm text-gray-300 font-mono font-bold cursor-pointer hover:bg-blue-600/20 transition-colors" ondblclick="copyToClipboard('${copyValue}', '${copyLabel}')" title="Double-click to copy">${value}</td>`;
                    break;
                case 'odometer':
                    value = cert.odometer ? cert.odometer.toLocaleString('it-IT') + ' km' : 'N/A';
                    copyValue = value;
                    copyLabel = 'Odometer';
                    displayValue = `<td class="px-4 py-3 whitespace-nowrap text-sm text-gray-300 cursor-pointer hover:bg-blue-600/20 transition-colors" ondblclick="copyToClipboard('${copyValue}', '${copyLabel}')" title="Double-click to copy">${value}</td>`;
                    break;
                case 'vin':
                    value = cert.vin || 'N/A';
                    copyValue = value;
                    copyLabel = 'VIN';
                    displayValue = `<td class="px-4 py-3 whitespace-nowrap text-sm text-gray-300 font-mono cursor-pointer hover:bg-blue-600/20 transition-colors" ondblclick="copyToClipboard('${copyValue}', '${copyLabel}')" title="Double-click to copy">${value}</td>`;
                    break;
                case 'deviceId':
                    value = cert.deviceId || 'N/A';
                    copyValue = value;
                    copyLabel = 'Device ID';
                    displayValue = `<td class="px-4 py-3 whitespace-nowrap text-sm text-gray-300 font-mono cursor-pointer hover:bg-blue-600/20 transition-colors" ondblclick="copyToClipboard('${copyValue}', '${copyLabel}')" title="Double-click to copy">${value}</td>`;
                    break;
                case 'imei':
                    // Show Serial instead of IMEI in the table view
                    value = cert.serial || 'N/A';
                    copyValue = value;
                    copyLabel = 'Serial';
                    displayValue = `<td class="px-4 py-3 whitespace-nowrap text-sm text-gray-300 font-mono cursor-pointer hover:bg-blue-600/20 transition-colors" ondblclick="copyToClipboard('${copyValue}', '${copyLabel}')" title="Double-click to copy">${value}</td>`;
                    break;
                case 'installerName':
                    value = cert.installerName || 'N/A';
                    copyValue = value;
                    copyLabel = 'Installer';
                    displayValue = `<td class="px-4 py-3 whitespace-nowrap text-sm text-gray-300 cursor-pointer hover:bg-blue-600/20 transition-colors" ondblclick="copyToClipboard('${copyValue}', '${copyLabel}')" title="Double-click to copy">${value}</td>`;
                    break;
                case 'installationPoint':
                    value = cert.installationPoint || 'N/A';
                    copyValue = value;
                    copyLabel = 'Installation Point';
                    displayValue = `<td class="px-4 py-3 whitespace-nowrap text-sm text-gray-300 cursor-pointer hover:bg-blue-600/20 transition-colors" ondblclick="copyToClipboard('${copyValue}', '${copyLabel}')" title="Double-click to copy">${value}</td>`;
                    break;
                default:
                    displayValue = '<td class="px-4 py-3 whitespace-nowrap text-sm text-gray-300">-</td>';
            }
            
            return displayValue;
        }

        // Selection state
        const selectedCertificateIds = new Set();

        function toggleRowSelection(id, isChecked) {
            if (isChecked) {
                selectedCertificateIds.add(id);
            } else {
                selectedCertificateIds.delete(id);
            }
            updateSelectionUI();
        }

        function toggleSelectAll(checked) {
            // Apply to all filtered results, not just visible DOM rows
            if (checked) {
                filteredCertificates.forEach(c => selectedCertificateIds.add(c.id));
            } else {
                selectedCertificateIds.clear();
            }
            // Reflect state on current DOM checkboxes
            document.querySelectorAll('[data-row-checkbox]').forEach(cb => {
                cb.checked = checked;
            });
            updateSelectionUI();
        }

        function updateSelectionUI() {
            const count = selectedCertificateIds.size;
            const bar = document.getElementById('bulkActionsBar');
            if (bar) {
                bar.classList.toggle('hidden', count === 0);
                const counter = document.getElementById('selectedCount');
                if (counter) counter.textContent = count.toString();
            }
            
            // Update button counter in manual communication dialog
            updateSelectedCountInButton();
            // Update AI button counters
            updateAIButtonCounters();
            // Update tri-state for header checkbox
            const master = document.getElementById('selectAllCheckbox');
            if (master) {
                const total = filteredCertificates.length;
                master.indeterminate = count > 0 && count < total;
                master.checked = count > 0 && count === total;
            }
        }

        function getSelectedCertificates() {
            const set = new Set(Array.from(selectedCertificateIds));
            return filteredCertificates.filter(c => set.has(c.id));
        }

        async function openBulkContactDialog() {
            const selected = getSelectedCertificates();
            const dialog = document.getElementById('bulkContactDialog');
            if (!dialog) return;
            dialog.classList.remove('hidden');
            document.getElementById('aiPromptInput').value = '';
            document.getElementById('aiResults').value = '';

            // Carica firme dealer per il select
            try {
                const dealerId = getCurrentDealerId();
                const r = await fetch(`/api/communications/signatures/${dealerId}`).then(r=>r.json());
                const list = r?.data || [];
                const sel = document.getElementById('dealerSignatureSelect');
                if (sel) {
                    sel.innerHTML = '<option value="none">Nessuna firma</option>' +
                        list.map(s=>`<option value="${encodeURIComponent(JSON.stringify(s))}">${(s.company_name||'Firma')}${s.phone? ' • '+s.phone:''}${s.email? ' • '+s.email:''}</option>`).join('');
                }
            } catch {}

            // Load templates for AI dialog
            try {
                const currentChannel = document.querySelector('#channelToggleGroup .active-chip')?.dataset.value || 'email';
                await populateTemplateDropdown('templateSelectorAI', 'ai', currentChannel);
            } catch (error) {
                console.error('Error loading templates:', error);
            }
            // Carica saldo dealer
            try {
                const dealerId = getCurrentDealerId();
                const b = await fetch(`/api/billing/balance/${dealerId}`).then(r=>r.json());
                const text = (b?.balance_cents!=null) ? (b.balance_cents/100).toLocaleString(undefined,{style:'currency',currency:(b.currency||'EUR')}) : '-';
                const el = document.getElementById('dealerBalanceText');
                if (el) el.textContent = text;
            } catch {}
            
            // Update AI button counters
            updateAIButtonCounters();
        }

        function closeBulkContactDialog() {
            const dialog = document.getElementById('bulkContactDialog');
            if (dialog) dialog.classList.add('hidden');
        }
        async function generateAndOptionallySend(sendNow = false) {
            const channel = document.querySelector('#channelToggleGroup .active-chip')?.dataset.value || 'email';
            const style = document.querySelector('#styleToggleGroup .active-chip')?.dataset.value || 'professional';
            const language = document.documentElement.lang || 'it';
            const prompt = document.getElementById('aiPromptInput').value || '';
            const useFields = {};
            document.querySelectorAll('#fieldsChipGroup .active-chip').forEach(chip => {
                useFields[chip.dataset.field] = true;
            });

            const selectedCerts = getSelectedCertificates();
            // Carica clienti test come destinatari principali
            const dealerId = getCurrentDealerId();
            const testClients = await fetch(`/api/communications/test-clients/${dealerId}`).then(r=>r.json()).then(j=> j.data||[]);
            const testRecipients = testClients.map(c => ({
                id: c.id,
                clientName: [c.first_name, c.last_name].filter(Boolean).join(' ').trim() || 'Cliente Test',
                clientEmail: (c.email||'').toLowerCase(),
                clientPhone: c.phone||''
            }));
            const sendToTest = document.getElementById('sendToTestClients')?.checked;
            let recipients;
            if (sendToTest) {
                recipients = testRecipients;
                if (!recipients.length) {
                    out.textContent = language==='it' ? 'Nessun cliente test salvato.' : 'No test clients saved.';
                    return;
                }
            } else {

                recipients = selectedCerts.map(cert => ({
                    id: cert.id,
                    clientName: cert.clientName,
                    clientEmail: (cert.clientEmail || '').toLowerCase(),
                    clientPhone: cert.clientPhone || '',
                    // Aggiungi i dati del veicolo per i placeholder
                    vehicle: `${cert.brand || ''} ${cert.model || ''}`.trim(),
                    plate: cert.license_plate || '',
                    year: cert.year || '',
                    fuel: cert.fuel_type || '',
                    km: cert.odometer || '',
                    vin: cert.vin || '',
                    serial: cert.serial || '',
                    // Dati client dettagliati
                    firstName: cert.client?.firstName || '',
                    lastName: cert.client?.lastName || '',
                    companyName: cert.client?.company || ''
                }));

            }

            // Firma dealer selezionata
            let dealerSignatureText = '';
            let dealerCompanyName = '';
            const sel = document.getElementById('dealerSignatureSelect');
            if (sel && sel.value && sel.value !== 'none') {
                try {
                    const sig = JSON.parse(decodeURIComponent(sel.value));
                    dealerCompanyName = sig.company_name || '';
                    dealerSignatureText = `${sig.company_name||''}${sig.address1? `\n${sig.address1}`:''}${sig.postcode||sig.city? `\n${[sig.postcode||'', sig.city||''].filter(Boolean).join(' ')}`:''}${sig.phone? `\nTel: ${sig.phone}`:''}${sig.email? `\nEmail: ${sig.email}`:''}`.trim();
                } catch {}
            }

            const out = document.getElementById('aiResults');
            const genBtn = document.querySelector('#bulkContactDialog [data-i18n="contact.generate"]') || document.querySelector('#bulkContactDialog button:nth-last-child(2)');
            const sendBtn = document.querySelector('#bulkContactDialog [data-i18n="contact.send"]') || document.querySelector('#bulkContactDialog button:nth-last-child(1)');
            
            if (!sendToTest && !selectedCerts.length) {
                out.textContent = language === 'it' ? 'Seleziona almeno un certificato.' : 'Please select at least one certificate.';
                return;
            }

            try {
                if (genBtn) { genBtn.disabled = true; genBtn.classList.add('opacity-70','cursor-not-allowed'); }
                if (sendBtn) { sendBtn.disabled = true; sendBtn.classList.add('opacity-70','cursor-not-allowed'); }
                out.textContent = language === 'it' ? 'Generazione in corso...' : 'Generating...';

                // Riassunto veicoli selezionati in base ai chip attivi
                const selectedVehicles = (sendToTest ? testClients.map(c=>({
                    name: [c.first_name, c.last_name].filter(Boolean).join(' ').trim(),
                    firstName: c.first_name || '',
                    lastName: c.last_name || '',
                    companyName: c.company || '',
                    email: (c.email||'').toLowerCase(),
                    phone: c.phone||'',
                    // SEMPRE includere i dati del veicolo per i placeholder (non dipendere da useFields)
                    vehicle: `${c.vehicle_brand || ''} ${c.vehicle_model || ''}`.trim(),
                    plate: c.vehicle_plate || '',
                    year: c.vehicle_year || '',
                    fuel: c.vehicle_fuel || c.vehicle_fuelType || '',
                    km: c.vehicle_km || c.vehicle_odometer || '',
                    vin: c.vehicle_vin || '',
                    serial: c.vehicle_serial || ''
                })) : selectedCerts.map(c => ({
                    name: c.clientName,
                    firstName: c.client?.firstName || '',
                    lastName: c.client?.lastName || '',
                    companyName: c.client?.company || '',
                    email: c.clientEmail,
                    phone: c.clientPhone,
                    // SEMPRE includere i dati del veicolo per i placeholder (non dipendere da useFields)
                    vehicle: `${c.vehicle?.brand || c.brand || ''} ${c.vehicle?.model || c.model || ''}`.trim(),
                    plate: c.vehicle?.plate || c.license_plate || '',
                    year: c.vehicle?.year || c.year || '',
                    fuel: c.vehicle?.fuelType || c.fuel_type || '',
                    km: c.odometer || '',
                    vin: c.vin || '',
                    serial: c.serial || ''
                                })));



                const response = await fetch('/api/communications/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ channel, style, prompt, recipients, useFields, language, send: sendNow, dealerSignatureText, dealerCompanyName, selectedVehicles, dealerId, selectedCount: selectedCerts.length, sendToTestClients: sendToTest })
                });
                const ct = response.headers.get('content-type') || '';
                if (!response.ok) {
                    const msg = ct.includes('application/json') ? (await response.json()).error : await response.text();
                    throw new Error(msg || ('HTTP ' + response.status));
                }
                const data = ct.includes('application/json') ? await response.json() : { success: false, error: 'Invalid content-type' };

                if (!data.success) {
                    out.textContent = (language === 'it' ? 'Errore: ' : 'Error: ') + (data.error || 'unknown');
                    return;
                }
                // Show messages based on mode
                if (sendToTest && data.results && data.results.length > 1) {
                    // Test mode: show ALL personalized messages
                    const messagesHtml = data.results.map((result, index) => {
                        const msg = (result.message || '').replace(/</g,'&lt;');
                        const recipient = recipients[index];
                        const recipientName = recipient?.clientName || `Cliente ${index + 1}`;
                        return `<div class="p-3 border border-gray-600 rounded mb-2">
                            <div class="text-sm font-medium text-gray-400 mb-2">📧 ${recipientName}</div>
                            <pre class="whitespace-pre-wrap text-sm">${msg}</pre>
                        </div>`;
                    }).join('');
                    out.innerHTML = messagesHtml;
                } else {
                    // Normal mode: show only ONE base message
                    const baseMsg = (data.base_message || data.results?.[0]?.message || '').replace(/</g,'&lt;');
                    out.innerHTML = `<div class="p-3 border border-gray-600 rounded mb-2"><pre class="whitespace-pre-wrap text-sm">${baseMsg}</pre></div>`;
                }

                // Cost summary
                if (data.costs) {
                    window.lastCosts = data.costs;
                    const el = document.getElementById('costSummary');
                    if (el) {
                        const euro = (c)=> (c/100).toLocaleString('it-IT',{style:'currency',currency:'EUR'});
                        el.textContent = `Costo invio: Email ${euro(data.costs.email_cents)} • WhatsApp ${euro(data.costs.whatsapp_cents)} • OpenAI ${euro(data.costs.openai_cents)} • Totale ${euro(data.costs.total_cents)}`;
                    }
                }

                // Update email subject field if AI generated one
                if (channel === 'email' && data.email_subject) {
                    const subjectInput = document.getElementById('emailSubjectInput');
                    if (subjectInput) {
                        // Pulisci l'oggetto da eventuali caratteri di escape
                        const cleanSubject = data.email_subject.replace(/\\n/g, ' ').replace(/\\"/g, '"').trim();
                        subjectInput.value = cleanSubject;
                        subjectInput.placeholder = 'Oggetto generato dall\'AI';
                        console.log('✅ Email subject populated:', cleanSubject);
                    }
                }

                // Salva la bozza per l'invio (non rigenerare all'Invia)
                lastDraft = {
                    dealerId,
                    channel,
                    language,
                    recipients,
                    baseMessage: (data.base_message || data.results?.[0]?.message || ''),
                    emailSubject: data.email_subject || '',
                    costs: data.costs || null
                };
            } catch (err) {
                out.textContent = (language === 'it' ? 'Errore di rete: ' : 'Network error: ') + err.message;
            } finally {
                if (genBtn) { genBtn.disabled = false; genBtn.classList.remove('opacity-70','cursor-not-allowed'); }
                if (sendBtn) { sendBtn.disabled = false; sendBtn.classList.remove('opacity-70','cursor-not-allowed'); }
            }
        }

        // Chip/toggle helpers for modern UI
        function initChipGroups() {
            // Channel group
            document.querySelectorAll('#channelToggleGroup button').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('#channelToggleGroup button').forEach(b => b.classList.remove('active-chip','border-emerald-500','bg-emerald-600/10'));
                    btn.classList.add('active-chip','border-emerald-500','bg-emerald-600/10');
                    
                    // Show/hide email subject field for AI dialog
                    const emailSubjectField = document.getElementById('emailSubjectField');
                    if (btn.dataset.value === 'email') {
                        emailSubjectField?.classList.remove('hidden');
                    } else {
                        emailSubjectField?.classList.add('hidden');
                    }
                    
                    // Refresh templates for new channel
                    populateTemplateDropdown('templateSelectorAI', 'ai', btn.dataset.value);
                });
            });
            const firstChannel = document.querySelector('#channelToggleGroup button[data-value="email"]');
            if (firstChannel) firstChannel.click();

            // Style group
            document.querySelectorAll('#styleToggleGroup button').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('#styleToggleGroup button').forEach(b => b.classList.remove('active-chip','border-emerald-500','bg-emerald-600/10'));
                    btn.classList.add('active-chip','border-emerald-500','bg-emerald-600/10');
                });
            });
            const defaultStyle = document.querySelector('#styleToggleGroup button[data-value="professional"]');
            if (defaultStyle) defaultStyle.click();

            // Fields chips
            document.querySelectorAll('#fieldsChipGroup button').forEach(btn => {
                btn.addEventListener('click', () => {
                    btn.classList.toggle('active-chip');
                    btn.classList.toggle('border-emerald-500');
                    btn.classList.toggle('bg-emerald-600/10');
                    if (btn.dataset.field === 'dealerSignature') {
                        const box = document.getElementById('dealerSignatureBox');
                        if (box) box.classList.toggle('hidden', !btn.classList.contains('active-chip'));
                    }
                });
            });
            // Preselect useful fields
                            ['name','brandModel','plate'].forEach(f => {
                const chip = document.querySelector(`#fieldsChipGroup button[data-field="${f}"]`);
                if (chip && !chip.classList.contains('active-chip')) chip.click();
            });
        }


        // Get minimum width for columns
        function getColumnMinWidth(columnId) {
            const widths = {
                'id': '100px',
                'createdAt': '120px',
                'clientName': '120px',
                'clientEmail': '150px',
                'clientPhone': '120px',
                'vehicleInfo': '140px',
                'vehicleYear': '80px',
                'fuelType': '100px',
                'vehiclePlate': '100px',
                'odometer': '100px',
                'vin': '140px',
                'deviceId': '100px',
                'imei': '140px',
                'installerName': '120px',
                'installationPoint': '120px'
            };
            return widths[columnId] || '100px';
        }

        // Sort table
        function sortTable(field) {
            
            if (sortField === field) {
                sortOrder = sortOrder === 'asc' ? 'desc' : 'asc';
            } else {
                sortField = field;
                sortOrder = 'asc';
            }
            
            filteredCertificates.sort((a, b) => {
                let aVal = a[field];
                let bVal = b[field];
                
                // Handle null/undefined values
                if (aVal == null && bVal == null) return 0;
                if (aVal == null) return sortOrder === 'asc' ? 1 : -1;
                if (bVal == null) return sortOrder === 'asc' ? -1 : 1;
                
                if (field === 'createdAt') {
                    aVal = new Date(aVal);
                    bVal = new Date(bVal);
                } else if (field === 'id' || field === 'deviceId' || field === 'odometer' || field === 'vehicleYear') {
                    // Handle numeric fields
                    aVal = parseInt(aVal) || 0;
                    bVal = parseInt(bVal) || 0;
                } else if (typeof aVal === 'string' && typeof bVal === 'string') {
                    aVal = aVal.toLowerCase();
                    bVal = bVal.toLowerCase();
                }
                
                let result;
                if (sortOrder === 'asc') {
                    result = aVal > bVal ? 1 : aVal < bVal ? -1 : 0;
                } else {
                    result = aVal < bVal ? 1 : aVal > bVal ? -1 : 0;
                }
                
                return result;
            });
            
                         // Update sort indicators with translations
             document.querySelectorAll('[id^="sort-"]').forEach(span => {
                 const fieldName = span.id.replace('sort-', '');
                 const translationKey = span.getAttribute('data-field');
                 const translatedText = translationKey ? t(translationKey) : '';
                 
                 if (fieldName === field) {
                     span.textContent = `${translatedText} ${sortOrder === 'asc' ? '↑' : '↓'}`;
                 } else {
                     span.textContent = `${translatedText} ↑↓`;
                 }
             });
            
            displayCertificates();
        }

                // Apply filters (only show active certificates)
        function applyFilters() {
        const customerIdFilter = document.getElementById('customerIdFilter').value;
        const vehicleBrandFilter = document.getElementById('vehicleBrandFilter').value;
        const vehicleModelFilter = document.getElementById('vehicleModelFilter').value;
        const fuelTypeFilter = document.getElementById('fuelTypeFilter').value;
        const deviceIdFilter = document.getElementById('deviceIdFilter').value.toLowerCase();
        const vinFilter = document.getElementById('vinFilter').value.toLowerCase();
        const imeiFilter = document.getElementById('imeiFilter').value.toLowerCase();
        const licensePlateFilter = document.getElementById('licensePlateFilter').value.toLowerCase();

        filteredCertificates = allCertificates.filter(cert => {
            return cert.status === 'active' && // Solo certificati attivi
                   (!customerIdFilter || cert.id.toString() === customerIdFilter) &&
                   (!vehicleBrandFilter || cert.vehicleBrand === vehicleBrandFilter) &&
                   (!vehicleModelFilter || cert.vehicleModel === vehicleModelFilter) &&
                   (!fuelTypeFilter || cert.fuelType === fuelTypeFilter) &&
                   (!deviceIdFilter || (cert.deviceId && cert.deviceId.toString().toLowerCase().includes(deviceIdFilter))) &&
                   (!vinFilter || cert.vin.toLowerCase().includes(vinFilter)) &&
                   (!imeiFilter || (cert.imei && cert.imei.toLowerCase().includes(imeiFilter))) &&
                   (!licensePlateFilter || cert.vehiclePlate.toLowerCase().includes(licensePlateFilter));
        });
            
            displayCertificates(); // This will call displayCardView() which calls loadVehicleImages() 
            updateCertificateCount();
        }

        // Update certificate count (ONLY ACTIVE CERTIFICATES)
        function updateCertificateCount() {
            const countElement = document.getElementById('certificateCount');
            if (countElement) {
                // filteredCertificates always contains only active certificates
                // due to filtering in initializeFilters() and all search functions
                // Use direct string interpolation to avoid template issues
            const currentLang = window.i18n.getCurrentLanguage();
            const countText = currentLang === 'it' 
                ? `Totale: ${filteredCertificates.length} certificati`
                : `Total: ${filteredCertificates.length} certificates`;
            
            countElement.textContent = countText;
            }
        }

        // Smart Search System - Variables
        let searchData = {
            brands: new Set(),
            models: new Set(),
            fuels: new Set(),
            
            years: new Set()
        };
        
        // Initialize search data from certificates
        function initializeSearchData() {
            if (!allCertificates || allCertificates.length === 0) {
                console.log('⚠️ No certificates data available for search');
                return;
            }
            
            // Clear existing data
            searchData.brands.clear();
            searchData.models.clear();
            searchData.fuels.clear();
            
            searchData.years.clear();
            
            // Extract unique values from certificates
            allCertificates.forEach(cert => {
                try {
                    let vehicleData = cert.vehicle;
                    if (typeof vehicleData === 'string') {
                        vehicleData = JSON.parse(vehicleData);
                    }
                    
                    if (vehicleData) {
                        if (vehicleData.brand) searchData.brands.add(vehicleData.brand);
                        if (vehicleData.model) searchData.models.add(vehicleData.model);
                        if (vehicleData.fuelType) searchData.fuels.add(vehicleData.fuelType);
                        
                        if (vehicleData.year) searchData.years.add(vehicleData.year);
                    }
                } catch (e) {
                    console.warn('Error parsing vehicle data:', e);
                }
            });
        }
        
        // Handle search type selection
        function handleSearchTypeChange() {
            const searchTypeSelector = document.getElementById('searchTypeSelector');
            const dynamicSearchContainer = document.getElementById('dynamicSearchContainer');
            const dynamicTextInput = document.getElementById('dynamicTextInput');
            const dynamicDropdownInput = document.getElementById('dynamicDropdownInput');
            const clearSearchContainer = document.getElementById('clearSearchContainer');
            
            if (!searchTypeSelector) {
                console.error('❌ Search type selector not found');
                return;
            }
            
            const selectedType = searchTypeSelector.value;
            
            if (!selectedType) {
                // Hide all dynamic elements
                if (dynamicSearchContainer) dynamicSearchContainer.style.display = 'none';
                if (clearSearchContainer) clearSearchContainer.style.display = 'none';
                if (dynamicTextInput) dynamicTextInput.style.display = 'none';
                if (dynamicDropdownInput) dynamicDropdownInput.style.display = 'none';
                
                // Apply search without any type to show all certificates
                applySmartSearch();
                return;
            }
            
            // Show dynamic container and clear button
            dynamicSearchContainer.style.display = 'flex';
            clearSearchContainer.style.display = 'block';
            
            // Clear previous inputs
            dynamicTextInput.value = '';
            dynamicDropdownInput.value = '';
            
            // Show appropriate input type
            if (['global', 'client', 'plate', 'certificate', 'imei'].includes(selectedType)) {
                // Text input for search fields
                dynamicTextInput.style.display = 'block';
                dynamicDropdownInput.style.display = 'none';
                
                // Set appropriate placeholder
                const placeholderKey = `search.placeholder.${selectedType}`;
                dynamicTextInput.placeholder = window.i18n.t(placeholderKey);
                
                dynamicTextInput.focus();
                
            } else if (['brand', 'model', 'fuel', 'year'].includes(selectedType)) {
                // Dropdown for predefined options
                dynamicTextInput.style.display = 'none';
                dynamicDropdownInput.style.display = 'block';
                
                // Populate dropdown based on type
                populateDynamicDropdown(selectedType);
            }
            
            console.log('🎯 Search type changed to:', selectedType);
        }
        // Populate dynamic dropdown based on search type
        function populateDynamicDropdown(type) {
            const dropdown = document.getElementById('dynamicDropdownInput');
            dropdown.innerHTML = `<option value="" data-i18n="certificates.filters.select"></option>`;
            
            let options = [];
            
            switch(type) {
                case 'brand':
                    options = [...searchData.brands].sort();
                    break;
                case 'model':
                    options = [...searchData.models].sort();
                    break;
                case 'fuel':
                    options = [...searchData.fuels].sort();
                    break;
                
                    break;
                case 'year':
                    options = [...searchData.years].sort((a, b) => b - a); // Descending
                    break;
            }
            
            options.forEach(option => {
                dropdown.innerHTML += `<option value="${option}">${option}</option>`;
            });
            
            // Update translations
            window.i18n.updateAllTranslations();
            

        }
        
        // Apply smart search filters
        function applySmartSearch() {
            if (!allCertificates) {
                console.log('⚠️ No certificates data available for search');
                return;
            }
            
            const searchTypeSelector = document.getElementById('searchTypeSelector');
            const dynamicTextInput = document.getElementById('dynamicTextInput');
            const dynamicDropdownInput = document.getElementById('dynamicDropdownInput');
            
            const searchType = searchTypeSelector ? searchTypeSelector.value : '';
            
            let searchValue = '';
            
            // Get search value based on input type
            if (['global', 'client', 'plate', 'certificate', 'imei'].includes(searchType)) {
                searchValue = dynamicTextInput ? dynamicTextInput.value.toLowerCase().trim() : '';
            } else if (['brand', 'model', 'fuel', 'year'].includes(searchType)) {
                searchValue = dynamicDropdownInput ? dynamicDropdownInput.value : '';
            }
            
            filteredCertificates = allCertificates.filter(cert => {
                try {
                    // Parse client and vehicle data
                    let clientData = cert.client;
                    let vehicleData = cert.vehicle;
                    
                    if (typeof clientData === 'string') {
                        clientData = JSON.parse(clientData);
                    }
                    if (typeof vehicleData === 'string') {
                        vehicleData = JSON.parse(vehicleData);
                    }
                    
                    // Solo certificati attivi
                    if (cert.status !== 'active') return false;
                    
                    // If no search type selected, show all (filtered by status only)
                    if (!searchType || !searchValue) return true;
                    
                    // Apply specific search based on type
                    switch(searchType) {
                        case 'global':
                            const searchableText = [
                                cert.id?.toString(),
                                cert.imei,
                                clientData?.name || (clientData?.firstName + ' ' + clientData?.lastName),
                                clientData?.email,
                                vehicleData?.brand,
                                vehicleData?.model,
                                vehicleData?.plate,
                                vehicleData?.fuelType,
                                
                                vehicleData?.year?.toString(),
                                cert.status
                            ].filter(Boolean).join(' ').toLowerCase();
                            return searchableText.includes(searchValue);
                            
                        case 'client':
                            const clientName = clientData?.name || 
                                             (clientData?.firstName + ' ' + clientData?.lastName) || '';
                            return clientName.toLowerCase().includes(searchValue);
                            
                        case 'plate':
                            const plate = vehicleData?.plate || '';
                            return plate.toLowerCase().includes(searchValue);
                            
                        case 'certificate':
                            return cert.id?.toString().includes(searchValue);
                            
                        case 'imei':
                            return cert.imei?.toLowerCase().includes(searchValue);
                            
                        case 'brand':
                            return vehicleData?.brand === searchValue;
                            
                        case 'model':
                            return vehicleData?.model === searchValue;
                            
                        case 'fuel':
                            return vehicleData?.fuelType === searchValue;
                            
                        
                            
                        case 'year':
                            return vehicleData?.year?.toString() === searchValue;
                            
                        default:
                            return true;
                    }
                    
                } catch (error) {
                    console.error('Error filtering certificate:', error, cert);
                    return false;
                }
            });
            
            // Update display
            displayCertificates();
            updateCertificateCount();
        }
        
        // Clear active search
        function clearActiveSearch() {
            const searchTypeSelector = document.getElementById('searchTypeSelector');
            const dynamicTextInput = document.getElementById('dynamicTextInput');
            const dynamicDropdownInput = document.getElementById('dynamicDropdownInput');
            
            if (searchTypeSelector) searchTypeSelector.value = '';
            if (dynamicTextInput) dynamicTextInput.value = '';
            if (dynamicDropdownInput) dynamicDropdownInput.value = '';
            
            // Hide dynamic elements
            const dynamicSearchContainer = document.getElementById('dynamicSearchContainer');
            const clearSearchContainer = document.getElementById('clearSearchContainer');
            
            if (dynamicSearchContainer) dynamicSearchContainer.style.display = 'none';
            if (clearSearchContainer) clearSearchContainer.style.display = 'none';
            
            // Revert to all certificates (with status filter only)
            applySmartSearch();
        }

        // Initialize filtered certificates on page load
        function initializeFilters() {
            if (!allCertificates) {
                return;
            }
            
            // Set initial filtered certificates to only active certificates
            filteredCertificates = allCertificates.filter(cert => cert.status === 'active');
            
            // Initialize search data
            initializeSearchData();
            
            // Show initial display
            displayCertificates();
            updateCertificateCount();
        }
        
        // Setup event listeners for smart search system
        function setupEventListeners() {
            // Search type selector
            const searchTypeSelector = document.getElementById('searchTypeSelector');
            if (searchTypeSelector) {
                searchTypeSelector.addEventListener('change', handleSearchTypeChange);
            }
            
            // Dynamic text input
            const dynamicTextInput = document.getElementById('dynamicTextInput');
            if (dynamicTextInput) {
                dynamicTextInput.addEventListener('input', applySmartSearch);
            }
            
            // Dynamic dropdown input
            const dynamicDropdownInput = document.getElementById('dynamicDropdownInput');
            if (dynamicDropdownInput) {
                dynamicDropdownInput.addEventListener('change', applySmartSearch);
            }
            
            // Status filter removed - now showing only active certificates by default
            
            // Clear search button
            const clearSearchBtn = document.getElementById('clearSearchBtn');
            if (clearSearchBtn) {
                clearSearchBtn.addEventListener('click', clearActiveSearch);
            }
            

                }

        // === CUSTOMIZATION SYSTEM ===
        
        // Default column and field configurations
        const DEFAULT_TABLE_COLUMNS = {
            'id': { enabled: true, order: 1, key: 'table.certificate' },
            'createdAt': { enabled: true, order: 2, key: 'table.date' },
            'clientName': { enabled: true, order: 3, key: 'table.client' },
            'clientEmail': { enabled: true, order: 4, key: 'table.email' },
            'clientPhone': { enabled: true, order: 5, key: 'table.phone' },
            'vehicleInfo': { enabled: true, order: 6, key: 'table.vehicle' },
            'vehicleYear': { enabled: true, order: 7, key: 'table.year' },
            'fuelType': { enabled: true, order: 8, key: 'table.fuel' },
            'vehiclePlate': { enabled: true, order: 9, key: 'table.plate' },
            'odometer': { enabled: true, order: 10, key: 'table.odometer' },
            'vin': { enabled: true, order: 11, key: 'table.vin' },
            'deviceId': { enabled: true, order: 12, key: 'table.device' },
            'imei': { enabled: true, order: 13, key: 'table.serial' },
            'installerName': { enabled: true, order: 14, key: 'table.installer' },
            'installationPoint': { enabled: true, order: 15, key: 'table.installation' }
        };

        const DEFAULT_CARD_FIELDS = {
            // Client fields
            'clientName': { enabled: true, section: 'client', key: 'card.client_name' },
            'clientEmail': { enabled: true, section: 'client', key: 'card.client_email' },
            'clientPhone': { enabled: true, section: 'client', key: 'table.phone' },
            // Vehicle fields
            'vehicleImage': { enabled: true, section: 'vehicle', key: 'card.vehicle_image' },
            'vehicleInfo': { enabled: true, section: 'vehicle', key: 'table.vehicle' },
            'vehicleYear': { enabled: true, section: 'vehicle', key: 'table.year' },
            'vehiclePlate': { enabled: true, section: 'vehicle', key: 'table.plate' },
            'odometer': { enabled: true, section: 'vehicle', key: 'card.odometer' },
            'fuelType': { enabled: true, section: 'vehicle', key: 'table.fuel' },
            'vin': { enabled: true, section: 'vehicle', key: 'card.vin_number' },
            // Device fields
            'deviceId': { enabled: true, section: 'device', key: 'card.device_id' },
            'imei': { enabled: true, section: 'device', key: 'card.serial' },
            'installerName': { enabled: true, section: 'device', key: 'card.installer' },
            'installationPoint': { enabled: true, section: 'device', key: 'card.installation_point' }
        };

        // Cookie storage keys (prefixed with dealer ID for multi-dealer support)
        const COOKIE_KEYS = {
            tableColumns: 'dealer_table_columns',
            cardFields: 'dealer_card_fields'
        };

        // Cookie utility functions
        function setCookie(name, value, days = 365) {
            const expires = new Date();
            expires.setTime(expires.getTime() + (days * 24 * 60 * 60 * 1000));
            document.cookie = `${name}=${encodeURIComponent(value)};expires=${expires.toUTCString()};path=/;SameSite=Lax`;
        }

        function getCookie(name) {
            const nameEQ = name + "=";
            const ca = document.cookie.split(';');
            for (let i = 0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) === ' ') c = c.substring(1, c.length);
                if (c.indexOf(nameEQ) === 0) {
                    return decodeURIComponent(c.substring(nameEQ.length, c.length));
                }
            }
            return null;
        }

        function deleteCookie(name) {
            document.cookie = `${name}=;expires=Thu, 01 Jan 1970 00:00:00 UTC;path=/;`;
        }

        // Get dealer-specific cookie names
        function getDealerCookieNames() {
            const dealerId = getCurrentDealerId(); // We'll need to implement this
            return {
                tableColumns: `${COOKIE_KEYS.tableColumns}_${dealerId}`,
                cardFields: `${COOKIE_KEYS.cardFields}_${dealerId}`
            };
        }

        // getCurrentDealerId function is defined earlier in the file - this duplicate has been removed

        // Load customization settings from cookies
        function loadCustomizationSettings() {
            const cookieNames = getDealerCookieNames();
            
            const savedTableColumns = getCookie(cookieNames.tableColumns);
            const savedCardFields = getCookie(cookieNames.cardFields);
            
            let tableColumns = { ...DEFAULT_TABLE_COLUMNS };
            let cardFields = { ...DEFAULT_CARD_FIELDS };
            
            try {
                if (savedTableColumns) {
                    const parsed = JSON.parse(savedTableColumns);
                    // Merge with defaults to ensure new fields are included
                    tableColumns = { ...DEFAULT_TABLE_COLUMNS, ...parsed };
                }
            } catch (error) {
                console.warn('Failed to parse table columns from cookie:', error);
            }
            
            try {
                if (savedCardFields) {
                    const parsed = JSON.parse(savedCardFields);
                    // Merge with defaults to ensure new fields are included
                    cardFields = { ...DEFAULT_CARD_FIELDS, ...parsed };
        
                }
            } catch (error) {
                console.warn('Failed to parse card fields from cookie:', error);
            }
            
            return {
                tableColumns: tableColumns,
                cardFields: cardFields
            };
        }
        // Save customization settings to cookies
        function saveCustomizationSettings(tableColumns, cardFields) {
            const cookieNames = getDealerCookieNames();
            const dealerId = getCurrentDealerId();
            
            try {
                setCookie(cookieNames.tableColumns, JSON.stringify(tableColumns), 365);
                setCookie(cookieNames.cardFields, JSON.stringify(cardFields), 365);
                
    
            } catch (error) {
                console.error('Failed to save customization settings to cookies:', error);
                // Fallback to localStorage if cookies fail
                localStorage.setItem(`certificates-table-columns-${dealerId}`, JSON.stringify(tableColumns));
                localStorage.setItem(`certificates-card-fields-${dealerId}`, JSON.stringify(cardFields));
                console.log('⚠️ Fallback: Saved to localStorage instead');
            }
        }

        // Migration function - move existing localStorage data to cookies and update with new fields
        function migrateFromLocalStorageToCookies() {
            const dealerId = getCurrentDealerId();
            const cookieNames = getDealerCookieNames();
            let migrationCount = 0;
            
            // Check for old localStorage data
            const oldTableColumns = localStorage.getItem('certificates-table-columns');
            const oldCardFields = localStorage.getItem('certificates-card-fields');
            
            if (oldTableColumns && !getCookie(cookieNames.tableColumns)) {
                setCookie(cookieNames.tableColumns, oldTableColumns, 365);
                localStorage.removeItem('certificates-table-columns');

                migrationCount++;
            }
            
            if (oldCardFields && !getCookie(cookieNames.cardFields)) {
                setCookie(cookieNames.cardFields, oldCardFields, 365);
                localStorage.removeItem('certificates-card-fields');

                migrationCount++;
            }
            
            // Check if existing cookies need to be updated with new fields
            const existingCardFields = getCookie(cookieNames.cardFields);
            if (existingCardFields) {
                try {
                    const parsed = JSON.parse(existingCardFields);
                    // Check if vehicleImage field is missing
                    if (!parsed.vehicleImage) {
                        const updatedFields = { ...DEFAULT_CARD_FIELDS, ...parsed };
                        setCookie(cookieNames.cardFields, JSON.stringify(updatedFields), 365);
                        console.log(`🆕 Added new vehicleImage field to existing settings for dealer ${dealerId}`);
                        migrationCount++;
                    }
                } catch (error) {
                    console.warn('Failed to parse existing card fields:', error);
                }
            }
            
            // Show migration notification if any data was migrated
            if (migrationCount > 0) {
                setTimeout(() => {
                    showCopyNotification(
                        t('customize.migrated') || 'Settings migrated from localStorage to cookies', 
                        'success'
                    );
                }, 1000); // Delay to ensure page is fully loaded
            }
        }

        // Debug function to view all customization cookies
        function debugCustomizationCookies() {
            const dealerId = getCurrentDealerId();
            const cookieNames = getDealerCookieNames();
            
            const tableData = getCookie(cookieNames.tableColumns);
            const cardData = getCookie(cookieNames.cardFields);
            
            // Check specifically for vehicleImage
            if (cardData) {
                const parsedCardData = JSON.parse(cardData);
            }
        }

        // Force refresh customization settings (utility function for debugging)
        function forceRefreshCustomization() {
            const dealerId = getCurrentDealerId();
            const cookieNames = getDealerCookieNames();
            
            // Get current settings
            const currentCardFields = getCookie(cookieNames.cardFields);
            if (currentCardFields) {
                try {
                    const parsed = JSON.parse(currentCardFields);
                    const updated = { ...DEFAULT_CARD_FIELDS, ...parsed };
                    setCookie(cookieNames.cardFields, JSON.stringify(updated), 365);
                } catch (error) {
                    console.error('❌ Failed to update card fields:', error);
                }
            } else {
                // No existing settings, use defaults
                setCookie(cookieNames.cardFields, JSON.stringify(DEFAULT_CARD_FIELDS), 365);
            }
        }

        // Clean up old dealer cookies (utility function)
        function cleanupOldDealerCookies(oldDealerId) {
            const oldCookieNames = {
                tableColumns: `${COOKIE_KEYS.tableColumns}_${oldDealerId}`,
                cardFields: `${COOKIE_KEYS.cardFields}_${oldDealerId}`
            };
            
            deleteCookie(oldCookieNames.tableColumns);
            deleteCookie(oldCookieNames.cardFields);
            

        }

        // Open customization modal
        function openCustomizeModal() {
            const modal = document.getElementById('customizeModal');
            modal.classList.remove('hidden');
            
            // Load current settings
            const settings = loadCustomizationSettings();
            
            // Debug: Check if vehicleImage is present
            
            // Populate table columns settings
            populateTableColumnsSettings(settings.tableColumns);
            
            // Populate card fields settings
            populateCardFieldsSettings(settings.cardFields);
            
            // Update translations
            window.i18n.updateAllTranslations();
        }

        // Close customization modal
        function closeCustomizeModal() {
            const modal = document.getElementById('customizeModal');
            modal.classList.add('hidden');
        }

        // Populate table columns settings
        function populateTableColumnsSettings(tableColumns) {
            const container = document.getElementById('tableColumnsSettings');
            container.innerHTML = '';
            
            // Sort columns by order
            const sortedColumns = Object.entries(tableColumns).sort((a, b) => a[1].order - b[1].order);
            
            sortedColumns.forEach(([columnId, columnInfo]) => {
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between p-2 bg-gray-800 rounded border border-gray-700';
                div.innerHTML = `
                    <label class="flex items-center gap-3 flex-1 cursor-pointer">
                        <input type="checkbox" 
                               id="table-${columnId}" 
                               ${columnInfo.enabled ? 'checked' : ''} 
                               class="w-4 h-4 text-green-600 bg-gray-700 border-gray-600 rounded focus:ring-green-500 focus:ring-2">
                        <span class="text-sm text-gray-300">${t(columnInfo.key)}</span>
                    </label>
                    <div class="flex items-center gap-2">
                        <button onclick="moveTableColumn('${columnId}', 'up')" class="text-gray-400 hover:text-white text-xs p-1">↑</button>
                        <button onclick="moveTableColumn('${columnId}', 'down')" class="text-gray-400 hover:text-white text-xs p-1">↓</button>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        // Populate card fields settings
        function populateCardFieldsSettings(cardFields) {
            const clientContainer = document.getElementById('clientFieldsSettings');
            const vehicleContainer = document.getElementById('vehicleFieldsSettings');
            const deviceContainer = document.getElementById('deviceFieldsSettings');
            
            // Clear containers
            clientContainer.innerHTML = '';
            vehicleContainer.innerHTML = '';
            deviceContainer.innerHTML = '';
            
            Object.entries(cardFields).forEach(([fieldId, fieldInfo]) => {
                const div = document.createElement('div');
                div.className = 'flex items-center p-2 bg-gray-800 rounded border border-gray-700';
                div.innerHTML = `
                    <label class="flex items-center gap-3 flex-1 cursor-pointer">
                        <input type="checkbox" 
                               id="card-${fieldId}" 
                               ${fieldInfo.enabled ? 'checked' : ''} 
                               class="w-4 h-4 text-green-600 bg-gray-700 border-gray-600 rounded focus:ring-green-500 focus:ring-2">
                        <span class="text-sm text-gray-300">${t(fieldInfo.key)}</span>
                    </label>
                `;
                
                // Add to appropriate container
                if (fieldInfo.section === 'client') {
                    clientContainer.appendChild(div);
                } else if (fieldInfo.section === 'vehicle') {
                    vehicleContainer.appendChild(div);
                } else if (fieldInfo.section === 'device') {
                    deviceContainer.appendChild(div);
                }
            });
        }

        // Move table column up/down
        function moveTableColumn(columnId, direction) {
            const settings = loadCustomizationSettings();
            const columns = settings.tableColumns;
            const currentOrder = columns[columnId].order;
            
            // Find column to swap with
            const sortedColumns = Object.entries(columns).sort((a, b) => a[1].order - b[1].order);
            const currentIndex = sortedColumns.findIndex(([id]) => id === columnId);
            
            if (direction === 'up' && currentIndex > 0) {
                const swapColumn = sortedColumns[currentIndex - 1];
                columns[columnId].order = swapColumn[1].order;
                columns[swapColumn[0]].order = currentOrder;
            } else if (direction === 'down' && currentIndex < sortedColumns.length - 1) {
                const swapColumn = sortedColumns[currentIndex + 1];
                columns[columnId].order = swapColumn[1].order;
                columns[swapColumn[0]].order = currentOrder;
            }
            
            // Repopulate the settings
            populateTableColumnsSettings(columns);
        }

        // Toggle all table columns
        function toggleAllTableColumns(enabled) {
            const checkboxes = document.querySelectorAll('#tableColumnsSettings input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = enabled;
            });
        }

        // Toggle all card fields
        function toggleAllCardFields(enabled) {
            const checkboxes = document.querySelectorAll('#clientFieldsSettings input[type="checkbox"], #vehicleFieldsSettings input[type="checkbox"], #deviceFieldsSettings input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = enabled;
            });
        }

        // Save customization
        function saveCustomization() {
            const settings = loadCustomizationSettings();
            
            // Update table columns
            Object.keys(settings.tableColumns).forEach(columnId => {
                const checkbox = document.getElementById(`table-${columnId}`);
                if (checkbox) {
                    settings.tableColumns[columnId].enabled = checkbox.checked;
                }
            });
            
            // Update card fields
            Object.keys(settings.cardFields).forEach(fieldId => {
                const checkbox = document.getElementById(`card-${fieldId}`);
                if (checkbox) {
                    settings.cardFields[fieldId].enabled = checkbox.checked;
                }
            });
            
            // Save to localStorage
            saveCustomizationSettings(settings.tableColumns, settings.cardFields);
            
            // Close modal
            closeCustomizeModal();
            
            // Refresh the display
            displayCertificates();
            
            // Show success notification
            showCopyNotification(t('customize.saved') || 'Customization saved!', 'success');
        }

        // Reset customization
        function resetCustomization() {
            if (confirm(t('customize.confirm_reset') || 'Are you sure you want to reset to default settings?')) {
                const cookieNames = getDealerCookieNames();
                const dealerId = getCurrentDealerId();
                
                // Clear cookies
                deleteCookie(cookieNames.tableColumns);
                deleteCookie(cookieNames.cardFields);
                
                // Also clear localStorage fallback if it exists
                localStorage.removeItem(`certificates-table-columns-${dealerId}`);
                localStorage.removeItem(`certificates-card-fields-${dealerId}`);
                
                // Repopulate with defaults
                populateTableColumnsSettings(DEFAULT_TABLE_COLUMNS);
                populateCardFieldsSettings(DEFAULT_CARD_FIELDS);
                
    
                showCopyNotification(t('customize.reset_success') || 'Settings reset to defaults!', 'success');
            }
        }

        // Copy to clipboard function
        async function copyToClipboard(value, fieldName) {
            try {
                // Clean the value from quotes and normalize it
                const cleanValue = value.replace(/['"]/g, '').trim();
                
                if (cleanValue === 'N/A' || cleanValue === '' || cleanValue === 'undefined') {
                    // Show warning for empty values
                    showCopyNotification(`${fieldName} is empty - nothing to copy`, 'warning');
                    return;
                }
                
                // Try modern clipboard API first
                if (navigator.clipboard && window.isSecureContext) {
                    await navigator.clipboard.writeText(cleanValue);
                } else {
                    // Fallback for older browsers
                    const textArea = document.createElement('textarea');
                    textArea.value = cleanValue;
                    textArea.style.position = 'fixed';
                    textArea.style.left = '-999999px';
                    textArea.style.top = '-999999px';
                    document.body.appendChild(textArea);
                    textArea.focus();
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                }
                
                // Show success notification
                showCopyNotification(`${fieldName} copied: ${cleanValue}`, 'success');
    
                
            } catch (error) {
                console.error('Failed to copy to clipboard:', error);
                showCopyNotification(`Failed to copy ${fieldName}`, 'error');
            }
        }
        // Show copy notification
        function showCopyNotification(message, type = 'success') {
            // Remove existing notification
            const existingNotification = document.getElementById('copyNotification');
            if (existingNotification) {
                existingNotification.remove();
            }
            
            // Create notification element
            const notification = document.createElement('div');
            notification.id = 'copyNotification';
            notification.className = `fixed top-4 right-4 px-4 py-3 rounded-lg shadow-lg z-50 transition-all duration-300 transform translate-x-0 ${
                type === 'success' ? 'bg-green-500 text-white' :
                type === 'warning' ? 'bg-yellow-500 text-black' :
                'bg-red-500 text-white'
            }`;
            notification.innerHTML = `
                <div class="flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        ${type === 'success' ? 
                            '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>' :
                            type === 'warning' ?
                            '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.34 16.5c-.77.833.192 2.5 1.732 2.5z"/>' :
                            '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"/>'
                        }
                    </svg>
                    <span class="text-sm font-medium">${message}</span>
                </div>
            `;
            
            // Add to page
            document.body.appendChild(notification);
            
            // Auto remove after 3 seconds
            setTimeout(() => {
                notification.style.transform = 'translateX(100%)';
                notification.style.opacity = '0';
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 3000);
        }

        // Logout function
        async function logout() {
            const confirmed = await window.customDialog.confirm(
                'Conferma Logout',
                t('message.logout_confirm'),
                'Esci',
                'Annulla'
            );
            
            if (confirmed) {
                localStorage.clear();
                window.location.href = '/pages/login.html';
            }
        }

                 // Initialize table headers with translations
         function initializeTableHeaders() {
             document.querySelectorAll('[id^="sort-"]').forEach(span => {
                 const translationKey = span.getAttribute('data-field');
                 if (translationKey) {
                     span.textContent = `${t(translationKey)} ↑↓`;
                 }
             });
         }

         // Handle logo loading error
         function handleLogoError() {
             const logo = document.getElementById('sidebarLogo');
             const fallback = document.getElementById('logoFallback');
             if (logo && fallback) {
                 logo.style.display = 'none';
                 fallback.style.display = 'flex';
                 console.log('Logo fallback activated');
             }
         }

                         // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Migrate existing localStorage data to cookies
            migrateFromLocalStorageToCookies();
            
            // Initialize table headers with translations
            initializeTableHeaders();
            
            // Update header logo
            updateHeaderLogo();
            
            loadCertificates();
            
            // Load vehicle groups after certificates are loaded
            setTimeout(() => {
                loadVehicleGroups().catch(error => {
                    console.error('❌ Error loading vehicle groups:', error);
                });
            }, 1000); // Wait 1 second for certificates to load
            
            setupEventListeners();
             
                         // Check authentication - support both new and legacy systems
            const hasServicehubAuth = localStorage.getItem('servicehub-auth-token') && localStorage.getItem('servicehub-user');
            const hasLegacyAuth = localStorage.getItem('authData');
            
            if (!hasServicehubAuth && !hasLegacyAuth) {
                window.location.href = '/pages/login.html';
                return;
            }

             // Set up logo error handling
             const logo = document.getElementById('sidebarLogo');
             if (logo) {
                 // Test if logo loads
                 setTimeout(() => {
                     if (logo.naturalWidth === 0) {
                         handleLogoError();
                     }
                 }, 1000);
             }
         });

        // ===== ADVANCED SEARCH SYSTEM =====
        let advancedSearchCriteria = [];
        let criteriaIdCounter = 0;

        // Open Advanced Search Modal
        function openAdvancedSearchModal() {
            const modal = document.getElementById('advancedSearchModal');
            modal.classList.remove('hidden');
            
            // Initialize with one empty criteria if none exist
            if (advancedSearchCriteria.length === 0) {
                addSearchCriteria();
            }
            
            updateAdvancedSearchPreview();
            window.i18n.updateAllTranslations();
            
            // FORCE CORRECT COLORS ON ALL MODAL BUTTONS
            setTimeout(() => {
                // Modal action buttons (dark background = white text)
                const whiteTextModalButtons = [
                    document.querySelector('button[onclick="addSearchCriteria()"]'),
                    document.querySelector('button[onclick="saveAdvancedSearch()"]'),
                    document.querySelector('button[onclick="applyAdvancedSearch()"]')
                ];
                whiteTextModalButtons.forEach(btn => {
                    if (btn) {
                        btn.style.setProperty('color', 'white', 'important');
                        const span = btn.querySelector('span');
                        if (span) span.style.setProperty('color', 'white', 'important');
                    }
                });
                
                // Gray modal buttons (light background = black text)
                const blackTextModalButtons = [
                    document.querySelector('button[onclick="clearAdvancedSearch()"]'),
                    document.querySelector('button[onclick="closeAdvancedSearchModal()"]')
                ];
                blackTextModalButtons.forEach(btn => {
                    if (btn) {
                        btn.style.setProperty('color', '#1f2937', 'important');
                        const span = btn.querySelector('span');
                        if (span) span.style.setProperty('color', '#1f2937', 'important');
                    }
                });
                
                // Quick filter buttons
                const quickFilterButtons = document.querySelectorAll('button[onclick^="applyQuickFilter("]');
                quickFilterButtons.forEach(btn => {
                    if (btn) {
                        btn.style.setProperty('color', 'white', 'important');
                    }
                });
                
    
            }, 100);
        }

        // Close Advanced Search Modal
        function closeAdvancedSearchModal() {
            const modal = document.getElementById('advancedSearchModal');
            modal.classList.add('hidden');
        }

        // Add new search criteria
        function addSearchCriteria() {
            const criteriaId = 'criteria_' + (++criteriaIdCounter);
            const criteria = {
                id: criteriaId,
                field: '',
                operator: '',
                value: '',
                value2: '', // For between operator
                logicalOperator: advancedSearchCriteria.length > 0 ? 'AND' : ''
            };
            
            advancedSearchCriteria.push(criteria);
            renderSearchCriteria();
            updateAdvancedSearchPreview();
        }

        // Remove search criteria
        function removeSearchCriteria(criteriaId) {
            advancedSearchCriteria = advancedSearchCriteria.filter(c => c.id !== criteriaId);
            // Remove logical operator from first criteria if it exists
            if (advancedSearchCriteria.length > 0) {
                advancedSearchCriteria[0].logicalOperator = '';
            }
            renderSearchCriteria();
            updateAdvancedSearchPreview();
        }

        // Update search criteria
        function updateSearchCriteria(criteriaId, property, value) {
            const criteria = advancedSearchCriteria.find(c => c.id === criteriaId);
            if (criteria) {
                criteria[property] = value;
                
                // Reset dependent values when field changes
                if (property === 'field') {
                    criteria.operator = '';
                    criteria.value = '';
                    criteria.value2 = '';
                }
                
                renderSearchCriteria();
                updateAdvancedSearchPreview();
            }
        }

        // Render all search criteria
        function renderSearchCriteria() {
            const container = document.getElementById('searchCriteriaContainer');
            
            if (advancedSearchCriteria.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-center py-4" data-i18n="advanced_search.no_criteria">No search criteria added</p>';
                return;
            }
            
            container.innerHTML = advancedSearchCriteria.map((criteria, index) => `
                <div class="bg-gray-900 rounded p-4 border border-gray-700">
                    <div class="flex items-center gap-3 mb-3">
                        ${index > 0 ? `
                            <select onchange="updateSearchCriteria('${criteria.id}', 'logicalOperator', this.value)" class="bg-gray-700 border border-gray-600 text-white text-sm rounded px-2 py-1">
                                <option value="AND" ${criteria.logicalOperator === 'AND' ? 'selected' : ''}>${t('advanced_search.and')}</option>
                                <option value="OR" ${criteria.logicalOperator === 'OR' ? 'selected' : ''}>${t('advanced_search.or')}</option>
                            </select>
                        ` : ''}
                        
                        <div class="flex-1 grid grid-cols-1 md:grid-cols-4 gap-2">
                            <!-- Field Selection -->
                            <select onchange="updateSearchCriteria('${criteria.id}', 'field', this.value)" class="bg-gray-700 border border-gray-600 text-white text-sm rounded px-2 py-1">
                                <option value="" data-i18n="advanced_search.select_field">Select Field</option>
                                <optgroup label="${t('advanced_search.dates')}">
                                    <option value="createdAt" ${criteria.field === 'createdAt' ? 'selected' : ''}>${t('advanced_search.field_created_date')}</option>
                                    <option value="updatedAt" ${criteria.field === 'updatedAt' ? 'selected' : ''}>${t('advanced_search.field_updated_date')}</option>
                                </optgroup>
                                <optgroup label="${t('advanced_search.certificate')}">
                                    <option value="id" ${criteria.field === 'id' ? 'selected' : ''}>${t('advanced_search.field_certificate_id')}</option>
                                    <option value="deviceId" ${criteria.field === 'deviceId' ? 'selected' : ''}>${t('advanced_search.field_device_id')}</option>
                                    <option value="imei" ${criteria.field === 'imei' ? 'selected' : ''}>${t('advanced_search.field_imei')}</option>
                                </optgroup>
                                <optgroup label="${t('advanced_search.client')}">
                                    <option value="clientName" ${criteria.field === 'clientName' ? 'selected' : ''}>${t('advanced_search.field_client_name')}</option>
                                    <option value="clientEmail" ${criteria.field === 'clientEmail' ? 'selected' : ''}>${t('advanced_search.field_client_email')}</option>
                                </optgroup>
                                <optgroup label="${t('advanced_search.vehicle')}">
                                    <option value="vehicleBrand" ${criteria.field === 'vehicleBrand' ? 'selected' : ''}>${t('advanced_search.field_vehicle_brand')}</option>
                                    <option value="vehicleModel" ${criteria.field === 'vehicleModel' ? 'selected' : ''}>${t('advanced_search.field_vehicle_model')}</option>
                                    <option value="vehicleYear" ${criteria.field === 'vehicleYear' ? 'selected' : ''}>${t('advanced_search.field_vehicle_year')}</option>
                                    <option value="vehiclePlate" ${criteria.field === 'vehiclePlate' ? 'selected' : ''}>${t('advanced_search.field_vehicle_plate')}</option>
                                    <option value="vehicleFuel" ${criteria.field === 'vehicleFuel' ? 'selected' : ''}>${t('advanced_search.field_vehicle_fuel')}</option>
                                    <option value="odometer" ${criteria.field === 'odometer' ? 'selected' : ''}>${t('advanced_search.field_odometer')}</option>
                                </optgroup>
                            </select>
                            
                            <!-- Operator Selection -->
                            <select onchange="updateSearchCriteria('${criteria.id}', 'operator', this.value)" class="bg-gray-700 border border-gray-600 text-white text-sm rounded px-2 py-1" ${!criteria.field ? 'disabled' : ''}>
                                ${getOperatorOptions(criteria.field, criteria.operator)}
                            </select>
                            
                            <!-- Value Input(s) -->
                            <div class="col-span-2 flex gap-2">
                                ${getValueInputs(criteria)}
                            </div>
                        </div>
                        
                        <button onclick="removeSearchCriteria('${criteria.id}')" class="text-red-400 hover:text-red-300 transition-colors" title="${t('advanced_search.remove_criteria')}">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                            </svg>
                        </button>
                    </div>
                </div>
            `).join('');
            
            // Update translations after rendering
            window.i18n.updateAllTranslations();
        }

        // Get operator options based on field type
        function getOperatorOptions(field, selectedOperator) {
            if (!field) return '<option value="" data-i18n="advanced_search.select_operator">Select Operator</option>';
            
            const dateFields = ['createdAt', 'updatedAt'];
            const numericFields = ['id', 'deviceId', 'vehicleYear', 'odometer'];
            const textFields = ['imei', 'clientName', 'clientEmail', 'vehicleBrand', 'vehicleModel', 'vehiclePlate', 'vehicleFuel'];
            
            let options = '<option value="" data-i18n="advanced_search.select_operator">Select Operator</option>';
            
            if (dateFields.includes(field)) {
                // For date fields, = means "same day" and != means "different day"
                options += `
                    <option value="=" ${selectedOperator === '=' ? 'selected' : ''}>${t('advanced_search.op_equals')}</option>
                    <option value="!=" ${selectedOperator === '!=' ? 'selected' : ''}>${t('advanced_search.op_not_equals')}</option>
                    <option value=">" ${selectedOperator === '>' ? 'selected' : ''}>${t('advanced_search.op_greater')}</option>
                    <option value=">=" ${selectedOperator === '>=' ? 'selected' : ''}>${t('advanced_search.op_greater_equal')}</option>
                    <option value="<" ${selectedOperator === '<' ? 'selected' : ''}>${t('advanced_search.op_less')}</option>
                    <option value="<=" ${selectedOperator === '<=' ? 'selected' : ''}>${t('advanced_search.op_less_equal')}</option>
                    <option value="BETWEEN" ${selectedOperator === 'BETWEEN' ? 'selected' : ''}>${t('advanced_search.op_between')}</option>
                `;
            } else if (numericFields.includes(field)) {
                // For numeric fields, = means exact equality
                options += `
                    <option value="=" ${selectedOperator === '=' ? 'selected' : ''}>${t('advanced_search.op_exact_equals')}</option>
                    <option value="!=" ${selectedOperator === '!=' ? 'selected' : ''}>${t('advanced_search.op_exact_not_equals')}</option>
                    <option value=">" ${selectedOperator === '>' ? 'selected' : ''}>${t('advanced_search.op_greater')}</option>
                    <option value=">=" ${selectedOperator === '>=' ? 'selected' : ''}>${t('advanced_search.op_greater_equal')}</option>
                    <option value="<" ${selectedOperator === '<' ? 'selected' : ''}>${t('advanced_search.op_less')}</option>
                    <option value="<=" ${selectedOperator === '<=' ? 'selected' : ''}>${t('advanced_search.op_less_equal')}</option>
                    <option value="BETWEEN" ${selectedOperator === 'BETWEEN' ? 'selected' : ''}>${t('advanced_search.op_between')}</option>
                `;
            }
            
            if (textFields.includes(field)) {
                options += `
                    <option value="=" ${selectedOperator === '=' ? 'selected' : ''}>${t('advanced_search.op_exact_equals')}</option>
                    <option value="!=" ${selectedOperator === '!=' ? 'selected' : ''}>${t('advanced_search.op_exact_not_equals')}</option>
                    <option value="LIKE" ${selectedOperator === 'LIKE' ? 'selected' : ''}>${t('advanced_search.op_contains')}</option>
                    <option value="NOT LIKE" ${selectedOperator === 'NOT LIKE' ? 'selected' : ''}>${t('advanced_search.op_not_contains')}</option>
                    <option value="STARTS_WITH" ${selectedOperator === 'STARTS_WITH' ? 'selected' : ''}>${t('advanced_search.op_starts_with')}</option>
                    <option value="ENDS_WITH" ${selectedOperator === 'ENDS_WITH' ? 'selected' : ''}>${t('advanced_search.op_ends_with')}</option>
                `;
            }
            
            return options;
        }
        // Get value inputs based on field type and operator
        function getValueInputs(criteria) {
            if (!criteria.field || !criteria.operator) {
                return '<input type="text" disabled class="bg-gray-700 border border-gray-600 text-white text-sm rounded px-2 py-1 flex-1" placeholder="Select field and operator first">';
            }
            
            const dateFields = ['createdAt', 'updatedAt'];
            const numericFields = ['id', 'deviceId', 'vehicleYear', 'odometer'];
            
            if (criteria.operator === 'BETWEEN') {
                const inputType = dateFields.includes(criteria.field) ? 'datetime-local' : 'number';
                return `
                    <input type="${inputType}" value="${criteria.value}" onchange="updateSearchCriteria('${criteria.id}', 'value', this.value)" class="bg-gray-700 border border-gray-600 text-white text-sm rounded px-2 py-1 flex-1" placeholder="${t('advanced_search.from')}">
                    <span class="text-gray-400 text-sm py-1">${t('advanced_search.to')}</span>
                    <input type="${inputType}" value="${criteria.value2}" onchange="updateSearchCriteria('${criteria.id}', 'value2', this.value)" class="bg-gray-700 border border-gray-600 text-white text-sm rounded px-2 py-1 flex-1" placeholder="${t('advanced_search.to')}">
                `;
            }
            
            if (dateFields.includes(criteria.field)) {
                return `<input type="datetime-local" value="${criteria.value}" onchange="updateSearchCriteria('${criteria.id}', 'value', this.value)" class="bg-gray-700 border border-gray-600 text-white text-sm rounded px-2 py-1 flex-1">`;
            }
            
            if (numericFields.includes(criteria.field)) {
                return `<input type="number" value="${criteria.value}" onchange="updateSearchCriteria('${criteria.id}', 'value', this.value)" class="bg-gray-700 border border-gray-600 text-white text-sm rounded px-2 py-1 flex-1" placeholder="${t('advanced_search.enter_number')}">`;
            }
            
            return `<input type="text" value="${criteria.value}" onchange="updateSearchCriteria('${criteria.id}', 'value', this.value)" class="bg-gray-700 border border-gray-600 text-white text-sm rounded px-2 py-1 flex-1" placeholder="${t('advanced_search.enter_text')}">`;
        }

        // Update advanced search preview
        function updateAdvancedSearchPreview() {
            const validCriteria = advancedSearchCriteria.filter(c => c.field && c.operator && c.value);
            
            // Count matching certificates (client-side preview)
            let matchingCount = 0;
            if (validCriteria.length > 0 && allCertificates) {
                matchingCount = allCertificates.filter(cert => {
                    return evaluateAdvancedSearchCriteria(cert, validCriteria);
                }).length;
            } else if (allCertificates) {
                matchingCount = allCertificates.filter(cert => cert.status === 'active').length;
            }
            
            document.getElementById('advancedSearchCount').textContent = matchingCount;
            
            // Generate query preview
            const queryPreview = generateQueryPreview(validCriteria);
            document.getElementById('advancedSearchQuery').textContent = queryPreview;
        }

        // Generate SQL query preview
        function generateQueryPreview(criteria) {
            if (criteria.length === 0) {
                return 'SELECT * FROM certificate WHERE active = true AND dealerId = ?';
            }
            
            let whereClause = 'WHERE active = true AND dealerId = ?';
            
            criteria.forEach((c, index) => {
                if (index > 0) {
                    whereClause += ` ${c.logicalOperator}`;
                } else {
                    whereClause += ' AND';
                }
                
                whereClause += ` (${generateFieldCondition(c)})`;
            });
            
            return `SELECT * FROM certificate ${whereClause} ORDER BY createdAt DESC`;
        }

        // Generate field condition for SQL preview
        function generateFieldCondition(criteria) {
            const { field, operator, value, value2 } = criteria;
            
            // Map frontend fields to database fields
            const fieldMapping = {
                'createdAt': 'c."createdAt"',
                'updatedAt': 'c."updatedAt"',
                'id': 'c.id',
                'deviceId': 'c."deviceId"',
                'imei': 'c.imei',
                'clientName': 'clientData.name',
                'clientEmail': 'clientData.email',
                'vehicleBrand': 'vehicleData.brand',
                'vehicleModel': 'vehicleData.model',
                'vehicleYear': 'vehicleData.year',
                'vehiclePlate': 'vehicleData.plate',
                'vehicleFuel': 'vehicleData.fuelType',
                'odometer': 'c.odometer'
            };
            
            const dbField = fieldMapping[field] || field;
            const dateFields = ['createdAt', 'updatedAt'];
            
            switch (operator) {
                case '=':
                    // For date fields, equality means "same day"
                    if (dateFields.includes(field)) {
                        const date = new Date(value);
                        const startOfDay = new Date(date);
                        startOfDay.setHours(0, 0, 0, 0);
                        const endOfDay = new Date(date);
                        endOfDay.setHours(23, 59, 59, 999);
                        return `${dbField} BETWEEN '${startOfDay.toISOString()}' AND '${endOfDay.toISOString()}'`;
                    }
                    return `${dbField} = '${value}'`;
                case '!=':
                    // For date fields, inequality means "not same day"
                    if (dateFields.includes(field)) {
                        const date = new Date(value);
                        const startOfDay = new Date(date);
                        startOfDay.setHours(0, 0, 0, 0);
                        const endOfDay = new Date(date);
                        endOfDay.setHours(23, 59, 59, 999);
                        return `${dbField} NOT BETWEEN '${startOfDay.toISOString()}' AND '${endOfDay.toISOString()}'`;
                    }
                    return `${dbField} != '${value}'`;
                case 'BETWEEN':
                    return `${dbField} BETWEEN '${value}' AND '${value2}'`;
                case 'LIKE':
                    return `${dbField} LIKE '%${value}%'`;
                case 'NOT LIKE':
                    return `${dbField} NOT LIKE '%${value}%'`;
                case 'STARTS_WITH':
                    return `${dbField} LIKE '${value}%'`;
                case 'ENDS_WITH':
                    return `${dbField} LIKE '%${value}'`;
                default:
                    return `${dbField} ${operator} '${value}'`;
            }
        }

        // Evaluate advanced search criteria against a certificate (client-side)
        function evaluateAdvancedSearchCriteria(cert, criteria) {
            if (criteria.length === 0) return true;
            
            let result = evaluateSingleCriteria(cert, criteria[0]); // First criteria
            
            for (let i = 1; i < criteria.length; i++) {
                const c = criteria[i];
                const conditionResult = evaluateSingleCriteria(cert, c);
                
                // The logical operator belongs to the CURRENT criterion and applies BEFORE it
                if (c.logicalOperator === 'AND') {
                    result = result && conditionResult;
                } else if (c.logicalOperator === 'OR') {
                    result = result || conditionResult;
                } else {
                    // Default to AND if no operator specified
                    result = result && conditionResult;
                }
                
    
            }
            
            return result;
        }

        // Evaluate single criteria against a certificate
        function evaluateSingleCriteria(cert, criteria) {
            const { field, operator, value, value2 } = criteria;
            
            // Get actual value from certificate
            let actualValue = getCertificateFieldValue(cert, field);
            
            if (actualValue === null || actualValue === undefined) {
                return false;
            }
            
            // Convert to appropriate type for comparison
            const dateFields = ['createdAt', 'updatedAt'];
            const numericFields = ['id', 'deviceId', 'vehicleYear', 'odometer'];
            
            if (dateFields.includes(field)) {
                actualValue = new Date(actualValue);
                const compareValue = new Date(value);
                const compareValue2 = value2 ? new Date(value2) : null;
                
                switch (operator) {
                    case '=': 
                        // For date equality, compare if they are on the same day
                        return isSameDay(actualValue, compareValue);
                    case '!=': 
                        // For date inequality, check if they are NOT on the same day
                        return !isSameDay(actualValue, compareValue);
                    case '>': return actualValue > compareValue;
                    case '>=': return actualValue >= compareValue;
                    case '<': return actualValue < compareValue;
                    case '<=': return actualValue <= compareValue;
                    case 'BETWEEN': return actualValue >= compareValue && actualValue <= compareValue2;
                }
            } else if (numericFields.includes(field)) {
                actualValue = parseFloat(actualValue) || 0;
                const compareValue = parseFloat(value) || 0;
                const compareValue2 = value2 ? parseFloat(value2) : null;
                
                switch (operator) {
                    case '=': return actualValue === compareValue;
                    case '!=': return actualValue !== compareValue;
                    case '>': return actualValue > compareValue;
                    case '>=': return actualValue >= compareValue;
                    case '<': return actualValue < compareValue;
                    case '<=': return actualValue <= compareValue;
                    case 'BETWEEN': return actualValue >= compareValue && actualValue <= compareValue2;
                }
            } else {
                // String comparison
                actualValue = String(actualValue).toLowerCase();
                const compareValue = String(value).toLowerCase();
                
                switch (operator) {
                    case '=': 
                        return actualValue === compareValue;
                    case '!=': 
                        return actualValue !== compareValue;
                    case 'LIKE': 
                        return actualValue.includes(compareValue);
                    case 'NOT LIKE': 
                        return !actualValue.includes(compareValue);
                    case 'STARTS_WITH': 
                        return actualValue.startsWith(compareValue);
                    case 'ENDS_WITH': 
                        return actualValue.endsWith(compareValue);
                }
            }
            
            return false;
        }

        // Get certificate field value
        function getCertificateFieldValue(cert, field) {
            try {
                let clientData = cert.client;
                let vehicleData = cert.vehicle;
                
                if (typeof clientData === 'string') {
                    clientData = JSON.parse(clientData);
                }
                if (typeof vehicleData === 'string') {
                    vehicleData = JSON.parse(vehicleData);
                }
                
                let value;
                switch (field) {
                    case 'createdAt': value = cert.createdAt; break;
                    case 'updatedAt': value = cert.updatedAt; break;
                    case 'id': value = cert.id; break;
                    case 'deviceId': value = cert.deviceId; break;
                    case 'imei': value = cert.imei; break;
                    case 'clientName': value = clientData?.name || (clientData?.firstName + ' ' + clientData?.lastName); break;
                    case 'clientEmail': value = clientData?.email; break;
                    case 'vehicleBrand': value = vehicleData?.brand; break;
                    case 'vehicleModel': value = vehicleData?.model; break;
                    case 'vehicleYear': value = vehicleData?.year; break;
                    case 'vehiclePlate': value = vehicleData?.plate; break;
                    case 'vehicleFuel': value = vehicleData?.fuelType; break;
                    case 'odometer': value = cert.odometer; break;
                    default: value = null;
                }
                
                // Only log if value is null/undefined or for debugging specific fields
                if (value === null || value === undefined || ['vehicleBrand', 'deviceId'].includes(field)) {
                    console.log(`📊 Field "${field}" for cert ${cert.id}: "${value}" (type: ${typeof value})`);
                }
                return value;
            } catch (error) {
                console.error('Error getting certificate field value:', error, { cert, field });
                return null;
            }
        }

        // Apply quick filters
        function applyQuickFilter(filterType) {
            clearAdvancedSearch();
            
            const now = new Date();
            
            switch (filterType) {
                case 'today':
                    addDateRangeCriteria('createdAt', getDateStart(now), getDateEnd(now));
                    break;
                case 'this_week':
                    addDateRangeCriteria('createdAt', getWeekStart(now), getDateEnd(now));
                    break;
                case 'this_month':
                    addDateRangeCriteria('createdAt', getMonthStart(now), getDateEnd(now));
                    break;
                case 'this_year':
                    addDateRangeCriteria('createdAt', getYearStart(now), getDateEnd(now));
                    break;
                case 'last_30_days':
                    const thirtyDaysAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                    addDateRangeCriteria('createdAt', getDateStart(thirtyDaysAgo), getDateEnd(now));
                    break;
                case 'last_90_days':
                    const ninetyDaysAgo = new Date(now.getTime() - 90 * 24 * 60 * 60 * 1000);
                    addDateRangeCriteria('createdAt', getDateStart(ninetyDaysAgo), getDateEnd(now));
                    break;
                case 'new_cars_2024':
                    addNumericCriteria('vehicleYear', '>=', 2024);
                    break;
                case 'high_mileage':
                    addNumericCriteria('odometer', '>', 100000);
                    break;
            }
            
            renderSearchCriteria();
            updateAdvancedSearchPreview();
        }

        // Helper function to check if two dates are on the same day
        function isSameDay(date1, date2) {
            return date1.getFullYear() === date2.getFullYear() &&
                   date1.getMonth() === date2.getMonth() &&
                   date1.getDate() === date2.getDate();
        }

        // Helper functions for date ranges
        function getDateStart(date) {
            const d = new Date(date);
            d.setHours(0, 0, 0, 0);
            return d.toISOString().slice(0, 16);
        }

        function getDateEnd(date) {
            const d = new Date(date);
            d.setHours(23, 59, 59, 999);
            return d.toISOString().slice(0, 16);
        }

        function getWeekStart(date) {
            const d = new Date(date);
            const day = d.getDay() || 7; // Convert Sunday (0) to 7
            d.setDate(d.getDate() - day + 1); // Monday
            return getDateStart(d);
        }

        function getMonthStart(date) {
            const d = new Date(date);
            d.setDate(1);
            return getDateStart(d);
        }

        function getYearStart(date) {
            const d = new Date(date);
            d.setMonth(0, 1);
            return getDateStart(d);
        }
        // Helper functions to add specific criteria types
        function addDateRangeCriteria(field, startDate, endDate) {
            const criteriaId = 'criteria_' + (++criteriaIdCounter);
            advancedSearchCriteria.push({
                id: criteriaId,
                field: field,
                operator: 'BETWEEN',
                value: startDate,
                value2: endDate,
                logicalOperator: advancedSearchCriteria.length > 0 ? 'AND' : ''
            });
        }

        function addNumericCriteria(field, operator, value) {
            const criteriaId = 'criteria_' + (++criteriaIdCounter);
            advancedSearchCriteria.push({
                id: criteriaId,
                field: field,
                operator: operator,
                value: value.toString(),
                value2: '',
                logicalOperator: advancedSearchCriteria.length > 0 ? 'AND' : ''
            });
        }

        // Clear all advanced search criteria
        function clearAdvancedSearch() {
            advancedSearchCriteria = [];
            renderSearchCriteria();
            updateAdvancedSearchPreview();
        }

        // Apply advanced search
        function applyAdvancedSearch() {
            const validCriteria = advancedSearchCriteria.filter(c => c.field && c.operator && c.value);
            
            if (validCriteria.length === 0) {
                // No criteria, show all active certificates
                filteredCertificates = allCertificates.filter(cert => cert.status === 'active');
            } else {
                // Apply advanced search criteria
                filteredCertificates = allCertificates.filter(cert => {
                    if (cert.status !== 'active') return false;
                    
                    const matches = evaluateAdvancedSearchCriteria(cert, validCriteria);
                    
                    return matches;
                });
            }
            

            
            // Update display
            displayCertificates();
            updateCertificateCount();
            
            // Close modal
            closeAdvancedSearchModal();
            
            // Show success message
            showCopyNotification(
                `${t('advanced_search.search_applied')}: ${filteredCertificates.length} ${t('advanced_search.certificates_found')}`,
                'success'
            );
        }

        // Save advanced search (placeholder for future implementation)
        function saveAdvancedSearch() {
            const searchName = prompt(t('advanced_search.enter_search_name'));
            if (searchName) {
                // TODO: Implement saved searches functionality
                showCopyNotification(t('advanced_search.search_saved') + ': ' + searchName, 'success');
            }
        }
        // ===== END ADVANCED SEARCH SYSTEM =====
        
        // Open vehicle details page
        function openVehiclePage(certificateId) {
            // Find the certificate data
            const certificate = filteredCertificates.find(cert => cert.id == certificateId) || 
                               allCertificates.find(cert => cert.id == certificateId);
            
            if (!certificate) {
                console.error('Certificate not found:', certificateId);
                return;
            }

            // Prepare the data to pass to the vehicle page
            const vehiclePageData = {
                id: certificate.id,
                deviceId: certificate.deviceId,
                imei: certificate.imei,
                serial: certificate.serial,
                vehicle: certificate.vehicle,
                client: certificate.client,
                installerName: certificate.installerName,
                installationPoint: certificate.installationPoint,
                createdAt: certificate.createdAt,
                updatedAt: certificate.updatedAt,
                odometer: certificate.odometer,
                active: certificate.active
            };

            // Navigate to vehicle page with data
            const vehicleDataParam = encodeURIComponent(JSON.stringify(vehiclePageData));
            window.location.href = `/vehicle.html?vehicleData=${vehicleDataParam}`;
        }
        
    </script>

    <style>
        /* Table hover fix for light mode */
        .table tbody tr:hover {
            background: rgba(55, 65, 81, 0.5) !important;
        }
        
        /* Ensure table cells stay on one line */
        .table th, .table td {
            white-space: nowrap !important;
            text-overflow: ellipsis !important;
            overflow: hidden !important;
        }
        
        /* Sort icons styling */
        .table th span {
            color: #9ca3af !important;
        }

        /* Vehicle Image Container Styling */
        .vehicle-image-container {
            position: relative;
            overflow: hidden;
            border-radius: 12px;
            background: linear-gradient(145deg, #374151, #4b5563);
            box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .vehicle-image-container img {
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            filter: brightness(0.9) contrast(1.1);
        }

        .vehicle-image-container:hover img {
            transform: scale(1.05);
            filter: brightness(1) contrast(1.2);
        }
        
        .vehicle-image-container::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(145deg, transparent, rgba(255, 255, 255, 0.05));
            pointer-events: none;
        }

        /* Loading animation for images */
        .vehicle-image-loading {
            background: linear-gradient(90deg, #374151 25%, #4b5563 50%, #374151 75%);
            background-size: 200% 100%;
            animation: loading 2s infinite;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
    </style>
    
    <!-- Emergency Theme Fix (Light & Dark Mode) -->
    <script>
    function forceEmergencyThemeColors() {
        const isDark = document.documentElement.classList.contains('dark');
        
        if (!isDark) {
            // LIGHT MODE FIXES
            // Force light colors on the actions bar (bottom section)
            const actionsBar = document.querySelector('[data-theme-section="actions-bar"]');
            if (actionsBar) {
                actionsBar.style.backgroundColor = 'white';
                actionsBar.style.color = '#1f2937';
                
                // Force all child text elements
                actionsBar.querySelectorAll('span, p').forEach(el => {
                    // Skip elements inside colored buttons (they have their own colors now)
                    if (!el.closest('button[class*="bg-emerald"]') && !el.closest('button[class*="bg-indigo"]') && !el.closest('button[class*="bg-slate"]')) {
                        el.style.color = '#1f2937';
                    }
                });
            }
            
            // Force light colors on search section (top section)
            const searchSection = document.querySelector('.bg-gray-100.dark\\:bg-gradient-to-r');
            if (searchSection) {
                searchSection.style.backgroundColor = '#f3f4f6';
                
                // Force title and subtitle colors
                const title = searchSection.querySelector('h3');
                const subtitle = searchSection.querySelector('p');
                if (title) title.style.color = '#111827';
                if (subtitle) subtitle.style.color = '#374151';
            }
            
            // Force lighter background for certificates section
            const certsSection = document.querySelector('.bg-gray-50');
            if (certsSection) {
                certsSection.style.backgroundColor = '#fafafa';
            }
            
            // FORCE WHITE TEXT ON GREEN BUTTONS (solo per Aggiorna)
            const greenButtons = [
                document.querySelector('button[onclick="loadCertificates()"]')
            ];
            greenButtons.forEach(btn => {
                if (btn) {
                    btn.style.setProperty('color', 'white', 'important');
                    const span = btn.querySelector('span');
                    if (span) span.style.setProperty('color', 'white', 'important');
                }
            });
            
            // FORCE WHITE TEXT ON DARK GRAY BUTTONS
            const grayButtons = [
                document.querySelector('button[onclick="openCustomizeModal()"]'),
                document.querySelector('button[onclick="openAdvancedSearchModal()"]')
            ];
            grayButtons.forEach(btn => {
                if (btn) {
                    btn.style.setProperty('color', 'white', 'important');
                    const span = btn.querySelector('span');
                    if (span) span.style.setProperty('color', 'white', 'important');
                }
            });
            
            // FORCE WHITE TEXT ON MODAL BUTTONS (solo quelli scuri)
            const whiteTextModalButtons = [
                document.querySelector('button[onclick="addSearchCriteria()"]'),
                document.querySelector('button[onclick="saveAdvancedSearch()"]'),
                document.querySelector('button[onclick="applyAdvancedSearch()"]')
            ];
            whiteTextModalButtons.forEach(btn => {
                if (btn) {
                    btn.style.setProperty('color', 'white', 'important');
                    const span = btn.querySelector('span');
                    if (span) span.style.setProperty('color', 'white', 'important');
                }
            });
            
            // FORCE BLACK TEXT ON GRAY MODAL BUTTONS (quelli chiari)
            const blackTextModalButtons = [
                document.querySelector('button[onclick="clearAdvancedSearch()"]'),
                document.querySelector('button[onclick="closeAdvancedSearchModal()"]')
            ];
            blackTextModalButtons.forEach(btn => {
                if (btn) {
                    btn.style.setProperty('color', '#1f2937', 'important');
                    const span = btn.querySelector('span');
                    if (span) span.style.setProperty('color', '#1f2937', 'important');
                }
            });
            
            // FORCE WHITE TEXT ON QUICK FILTER BUTTONS
            const quickFilterButtons = document.querySelectorAll('button[onclick^="applyQuickFilter("]');
            quickFilterButtons.forEach(btn => {
                if (btn) {
                    btn.style.setProperty('color', 'white', 'important');
                }
            });
            
            // Card/Table buttons are now managed by showCardView() and showTableView() functions
            

        } else {
            // DARK MODE FIXES
            
            // Remove any forced light colors that might interfere
            const actionsBar = document.querySelector('[data-theme-section="actions-bar"]');
            if (actionsBar) {
                actionsBar.style.backgroundColor = '';
                actionsBar.style.color = '';
                
                // Reset child elements
                actionsBar.querySelectorAll('span, p').forEach(el => {
                    if (!el.closest('button')) {
                        el.style.color = '';
                    }
                });
            }
            
            // Force dark theme on search section
            const searchSection = document.querySelector('.bg-gray-100.dark\\:bg-gradient-to-r');
            if (searchSection) {
                // Remove any forced light backgrounds
                searchSection.style.background = '';
                searchSection.style.backgroundColor = '';
                
                // Force dark gradient background directly with !important
                searchSection.style.setProperty('background', 'linear-gradient(to right, rgba(30, 58, 138, 0.2), rgba(88, 28, 135, 0.2))', 'important');
                searchSection.style.setProperty('background-color', '', 'important');
                
                const title = searchSection.querySelector('h3');
                const subtitle = searchSection.querySelector('p');
                if (title) {
                    title.style.color = 'white';
                    title.style.setProperty('color', 'white', 'important');
                }
                if (subtitle) {
                    subtitle.style.color = '#d1d5db';
                    subtitle.style.setProperty('color', '#d1d5db', 'important');
                }
            }
            
            // Force dark theme on certificates section  
            const certsSection = document.querySelector('.bg-gray-50');
            if (certsSection) {
                certsSection.style.backgroundColor = '';
                // Let dark classes take effect
            }
            
            // Force dark theme on main container
            const mainContainer = document.querySelector('.bg-white.dark\\:bg-gradient-to-r');
            if (mainContainer) {
                mainContainer.style.background = '';
                mainContainer.style.backgroundColor = '';
            }
            
            // Keep button colors (they should work for both themes)
            const greenButtons = [
                document.querySelector('button[onclick="loadCertificates()"]')
            ];
            greenButtons.forEach(btn => {
                if (btn) {
                    btn.style.setProperty('color', 'white', 'important');
                    const span = btn.querySelector('span');
                    if (span) span.style.setProperty('color', 'white', 'important');
                }
            });
            
            const grayButtons = [
                document.querySelector('button[onclick="openCustomizeModal()"]'),
                document.querySelector('button[onclick="openAdvancedSearchModal()"]')
            ];
            grayButtons.forEach(btn => {
                if (btn) {
                    btn.style.setProperty('color', 'white', 'important');
                    const span = btn.querySelector('span');
                    if (span) span.style.setProperty('color', 'white', 'important');
                }
            });
            const whiteTextModalButtons = [
                document.querySelector('button[onclick="addSearchCriteria()"]'),
                document.querySelector('button[onclick="saveAdvancedSearch()"]'),
                document.querySelector('button[onclick="applyAdvancedSearch()"]')
            ];
            whiteTextModalButtons.forEach(btn => {
                if (btn) {
                    btn.style.setProperty('color', 'white', 'important');
                    const span = btn.querySelector('span');
                    if (span) span.style.setProperty('color', 'white', 'important');
                }
            });
            
            const blackTextModalButtons = [
                document.querySelector('button[onclick="clearAdvancedSearch()"]'),
                document.querySelector('button[onclick="closeAdvancedSearchModal()"]')
            ];
            blackTextModalButtons.forEach(btn => {
                if (btn) {
                    btn.style.setProperty('color', '#1f2937', 'important');
                    const span = btn.querySelector('span');
                    if (span) span.style.setProperty('color', '#1f2937', 'important');
                }
            });
            
            const quickFilterButtons = document.querySelectorAll('button[onclick^="applyQuickFilter("]');
            quickFilterButtons.forEach(btn => {
                if (btn) {
                    btn.style.setProperty('color', 'white', 'important');
                }
            });
            

        }
    }
    
    // Apply fix on load and theme changes
    document.addEventListener('DOMContentLoaded', function() {
        forceEmergencyThemeColors();
        // Initialize Card/Table buttons with correct colors
        if (typeof showTableView === 'function') {
            showTableView(); // Default to table view with correct colors
        }
        
        // Force dark mode immediately after DOM load
        if (document.documentElement.classList.contains('dark')) {
            setTimeout(() => {
                forceEmergencyThemeColors();
            }, 100);
        }
        
        // Try to populate group filter if groups are already loaded
        setTimeout(() => {
            if (vehicleGroups && vehicleGroups.length > 0) {
                // Groups are already loaded, no need to populate anything
            }
        }, 500);
    });
    // Immediate execution for dark mode
    if (document.documentElement.classList.contains('dark')) {
        forceEmergencyThemeColors();
    }
    
    setTimeout(forceEmergencyThemeColors, 1000);
    
    // Continuous monitoring of button colors
    setInterval(forceEmergencyThemeColors, 2000);
    setTimeout(forceEmergencyThemeColors, 3000);

        // ===== VEHICLE GROUPS MANAGEMENT FUNCTIONS =====

        // Global variables for groups management
        let vehicleGroups = [];
        let currentDealerId = getCurrentDealerId(); // Initialize with current dealer ID
        let currentGroupId = null;
        let availableVehicles = [];
        let groupVehicles = [];

        // Open vehicle groups modal
        async function openVehicleGroupsModal() {
            const modal = document.getElementById('vehicleGroupsModal');
            modal.classList.remove('hidden');
            
            // Load vehicle groups first, then AI suggestions
            console.log('🔄 Loading vehicle groups...');
            await loadVehicleGroups();
            console.log('✅ Vehicle groups loaded, now loading AI suggestions...');
            await loadAISuggestions(); // Load AI suggestions after groups are loaded
            console.log('✅ AI suggestions loaded');
        }

        // Close vehicle groups modal
        function closeVehicleGroupsModal() {
            const modal = document.getElementById('vehicleGroupsModal');
            modal.classList.add('hidden');
        }

        // Load vehicle groups for current dealer
        async function loadVehicleGroups() {
            try {
                // Get current dealer ID from localStorage - support both auth systems
                let dealerId = null;
                
                // Try servicehub-user first (new system)
                const servicehubUser = localStorage.getItem('servicehub-user');
                if (servicehubUser) {
                    try {
                        const parsed = JSON.parse(servicehubUser);
                        dealerId = parsed.id;
                    } catch (e) {
                        console.warn('⚠️ Invalid servicehub-user format');
                    }
                }
                
                // Fallback to legacy authData
                if (!dealerId) {
                    const authData = localStorage.getItem('authData');
                    if (authData) {
                        try {
                            const parsed = JSON.parse(authData);
                            dealerId = parsed.dealerId;
                        } catch (e) {
                            console.warn('⚠️ Invalid authData format');
                        }
                    }
                }
                
                if (!dealerId) {
                    console.error('No dealer ID found. User should be redirected to login.');
                    window.location.href = '/pages/login.html';
                    return;
                }
                
                currentDealerId = dealerId;
                
                // Show loading state
                const loadingState = document.getElementById('groupsLoadingState');
                const errorState = document.getElementById('groupsErrorState');
                const groupsList = document.getElementById('vehicleGroupsList');
                
                if (loadingState) loadingState.classList.remove('hidden');
                if (errorState) errorState.classList.add('hidden');
                if (groupsList) groupsList.innerHTML = '';

                // Fetch groups from API
                const response = await fetch(`/api/vehicle-groups/${currentDealerId}`);
                const data = await response.json();

                if (data.success) {
                    vehicleGroups = data.data;
                    console.log('📁 Vehicle groups loaded:', vehicleGroups.length, 'groups');
                    console.log('📝 Group names:', vehicleGroups.map(g => g.name).join(', '));
                    renderVehicleGroups();
                } else {
                    throw new Error(data.message || 'Failed to load groups');
                }
            } catch (error) {
                console.error('❌ Error loading vehicle groups:', error);
                const errorState = document.getElementById('groupsErrorState');
                if (errorState) {
                    errorState.classList.remove('hidden');
                    const errorMessage = errorState.querySelector('p');
                    if (errorMessage) {
                        errorMessage.textContent = `Errore: ${error.message}`;
                    }
                }
            } finally {
                const loadingState = document.getElementById('groupsLoadingState');
                if (loadingState) loadingState.classList.add('hidden');
            }
        }



        // ===== GROUP FILTER MODAL FUNCTIONS =====

        // Open group filter modal
        async function openGroupFilterModal() {
            // Create modal dynamically with beautiful buttons
            const modalHTML = `
                <div id="dynamicGroupFilterModal" style="
                    position: fixed; 
                    top: 0; 
                    left: 0; 
                    width: 100vw; 
                    height: 100vh; 
                    background-color: rgba(0, 0, 0, 0.8); 
                    z-index: 999999; 
                    display: flex; 
                    align-items: center; 
                    justify-content: center;
                    backdrop-filter: blur(4px);
                    animation: fadeIn 0.3s ease-out;
                ">
                    <div style="
                        background: linear-gradient(135deg, #1f2937 0%, #111827 100%); 
                        border-radius: 16px; 
                        padding: 32px; 
                        width: 90%; 
                        max-width: 700px; 
                        border: 1px solid #374151;
                        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
                        animation: slideUp 0.3s ease-out;
                    ">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px;">
                            <h3 style="
                                font-size: 24px; 
                                font-weight: bold; 
                                color: white;
                                background: linear-gradient(45deg, #00AE5D, #10b981);
                                -webkit-background-clip: text;
                                -webkit-text-fill-color: transparent;
                                background-clip: text;
                            " data-i18n="group_filter.title">Filtra per Gruppo</h3>
                            <button onclick="closeDynamicModal()" style="
                                color: #9ca3af; 
                                background: none; 
                                border: none; 
                                cursor: pointer; 
                                font-size: 28px;
                                padding: 8px;
                                border-radius: 8px;
                                transition: all 0.2s ease;
                            " onmouseover="this.style.backgroundColor='#374151'; this.style.color='white';" onmouseout="this.style.backgroundColor='transparent'; this.style.color='#9ca3af';">×</button>
                        </div>
                        
                        <div style="margin-bottom: 24px;">
                            <div style="
                                display: flex;
                                justify-content: space-between;
                                align-items: center;
                                margin-bottom: 16px;
                            ">
                                <label style="
                                    font-size: 16px; 
                                    font-weight: 600; 
                                    color: #e5e7eb; 
                                " data-i18n="group_filter.select_groups">Seleziona i Gruppi di Veicoli</label>
                                <div style="
                                    background: rgba(17, 24, 39, 0.8);
                                    padding: 4px 12px;
                                    border-radius: 20px;
                                    border: 1px solid #374151;
                                    font-size: 12px;
                                    color: #9ca3af;
                                    transition: all 0.3s ease;
                                ">
                                    <span id="modalSelectedCount">0</span> / <span id="modalTotalCount">0</span> <span data-i18n="group_filter.selected">selezionati</span>
                                </div>
                            </div>
                            
                            <!-- Beautiful button container -->
                            <div id="groupButtonsContainer" class="group-buttons-container" style="
                                display: grid;
                                grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
                                gap: 8px;
                                max-height: 450px;
                                overflow-y: auto;
                                padding: 12px;
                                background: rgba(55, 65, 81, 0.3);
                                border-radius: 12px;
                                border: 1px solid #4b5563;
                                scroll-behavior: smooth;
                            ">
                                <div style="
                                    text-align: center;
                                    color: #9ca3af;
                                    padding: 20px;
                                    font-style: italic;
                                " data-i18n="group_filter.loading">Caricamento gruppi...</div>
                            </div>
                            
                            <div style="
                                display: flex;
                                justify-content: center;
                                align-items: center;
                                gap: 16px;
                                margin-top: 16px;
                                padding: 12px;
                                background: rgba(17, 24, 39, 0.5);
                                border-radius: 8px;
                                border: 1px solid #374151;
                            ">
                                <button onclick="selectAllGroups()" style="
                                    padding: 8px 16px;
                                    background: linear-gradient(45deg, #3b82f6, #1d4ed8);
                                    color: white;
                                    border: none;
                                    border-radius: 8px;
                                    cursor: pointer;
                                    font-weight: 500;
                                    transition: all 0.3s ease;
                                    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
                                " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 20px rgba(59, 130, 246, 0.4)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(59, 130, 246, 0.3)';" data-i18n="group_filter.select_all">
                                    Seleziona Tutti
                                </button>
                                <button onclick="clearAllGroups()" style="
                                    padding: 8px 16px;
                                    background: linear-gradient(45deg, #ef4444, #dc2626);
                                    color: white;
                                    border: none;
                                    border-radius: 8px;
                                    cursor: pointer;
                                    font-weight: 500;
                                    transition: all 0.3s ease;
                                    box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
                                " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 20px rgba(239, 68, 68, 0.4)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(239, 68, 68, 0.3)';" data-i18n="group_filter.deselect_all">
                                    Deseleziona Tutti
                                </button>
                            </div>
                        </div>
                        
                        <div style="display: flex; justify-content: flex-end; gap: 16px; padding-top: 24px; border-top: 1px solid #374151;">
                            <button onclick="closeDynamicModal()" style="
                                padding: 12px 24px; 
                                background: linear-gradient(45deg, #6b7280, #4b5563); 
                                color: white; 
                                border: none; 
                                border-radius: 12px; 
                                cursor: pointer;
                                font-weight: 600;
                                transition: all 0.3s ease;
                                box-shadow: 0 4px 12px rgba(107, 114, 128, 0.3);
                            " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 20px rgba(107, 114, 128, 0.4)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(107, 114, 128, 0.3)';" data-i18n="common.cancel">
                                Annulla
                            </button>
                            <button onclick="applyDynamicFilter()" style="
                                padding: 12px 24px; 
                                background: linear-gradient(45deg, #00AE5D, #10b981); 
                                color: white; 
                                border: none; 
                                border-radius: 12px; 
                                cursor: pointer;
                                font-weight: 600;
                                transition: all 0.3s ease;
                                box-shadow: 0 4px 12px rgba(0, 174, 93, 0.4);
                                position: relative;
                                overflow: hidden;
                            " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 20px rgba(0, 174, 93, 0.5)'; this.querySelector('.shimmer-effect').style.left='100%';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(0, 174, 93, 0.4)'; this.querySelector('.shimmer-effect').style.left='-100%';" data-i18n="group_filter.apply_filter">
                                <span style="position: relative; z-index: 1;" data-i18n="group_filter.apply_filter">Applica Filtro</span>
                                <div style="
                                    position: absolute;
                                    top: 0;
                                    left: -100%;
                                    width: 100%;
                                    height: 100%;
                                    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
                                    transition: left 0.6s ease;
                                " class="shimmer-effect"></div>
                            </button>
                        </div>
                    </div>
                </div>
                
                <style>
                    @keyframes fadeIn {
                        from { opacity: 0; }
                        to { opacity: 1; }
                    }
                    
                    @keyframes slideUp {
                        from { 
                            opacity: 0;
                            transform: translateY(30px) scale(0.95);
                        }
                        to { 
                            opacity: 1;
                            transform: translateY(0) scale(1);
                        }
                    }
                    
                    @keyframes shimmer {
                        0% { left: -100%; }
                        100% { left: 100%; }
                    }
                    
                    .group-button {
                        position: relative;
                        overflow: hidden;
                    }
                    
                    .group-button::before {
                        content: '';
                        position: absolute;
                        top: 0;
                        left: -100%;
                        width: 100%;
                        height: 100%;
                        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
                        transition: left 0.5s ease;
                    }
                    
                    .group-button:hover::before {
                        left: 100%;
                    }
                    
                    .group-button.selected {
                        animation: pulse 2s infinite;
                    }
                    
                    @keyframes pulse {
                        0%, 100% { box-shadow: 0 0 0 0 rgba(0, 174, 93, 0.4); }
                        50% { box-shadow: 0 0 0 8px rgba(0, 174, 93, 0); }
                    }
                    
                    @keyframes sparkle {
                        0% { 
                            opacity: 1;
                            transform: scale(0) rotate(0deg);
                        }
                        50% {
                            opacity: 1;
                            transform: scale(1) rotate(180deg);
                        }
                        100% { 
                            opacity: 0;
                            transform: scale(0) rotate(360deg) translateY(-20px);
                        }
                    }
                    
                    @keyframes checkmarkAppear {
                        0% { 
                            opacity: 0;
                            transform: scale(0) rotate(-180deg);
                        }
                        50% {
                            transform: scale(1.2) rotate(-90deg);
                        }
                        100% { 
                            opacity: 1;
                            transform: scale(1) rotate(0deg);
                        }
                    }
                    
                    @keyframes vibrate {
                        0%, 100% { transform: translateX(0); }
                        10%, 30%, 50%, 70%, 90% { transform: translateX(-2px); }
                        20%, 40%, 60%, 80% { transform: translateX(2px); }
                    }
                    
                    .group-buttons-container::-webkit-scrollbar {
                        width: 6px;
                    }
                    
                    .group-buttons-container::-webkit-scrollbar-track {
                        background: rgba(55, 65, 81, 0.3);
                        border-radius: 3px;
                    }
                    
                    .group-buttons-container::-webkit-scrollbar-thumb {
                        background: linear-gradient(45deg, #00AE5D, #10b981);
                        border-radius: 3px;
                        transition: background 0.3s ease;
                    }
                    
                    .group-buttons-container::-webkit-scrollbar-thumb:hover {
                        background: linear-gradient(45deg, #10b981, #059669);
                    }
                    
                    /* Responsive adjustments for many groups */
                    @media (max-width: 768px) {
                        .group-buttons-container {
                            grid-template-columns: repeat(auto-fit, minmax(110px, 1fr)) !important;
                            gap: 6px !important;
                        }
                    }
                </style>
            `;
            
            // Add modal to body
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Check if groups are already loaded, if not load them
            if (!vehicleGroups || vehicleGroups.length === 0) {
                try {
                    await loadVehicleGroups();
                } catch (error) {
                    console.error('Error loading vehicle groups:', error);
                    // Show error in dropdown
                    const groupFilter = document.getElementById('dynamicGroupFilter');
                    if (groupFilter) {
                        groupFilter.innerHTML = '<option value="">Errore nel caricamento dei gruppi</option>';
                    }
                    return;
                }
            }
            
            // Populate groups
            populateDynamicGroupFilter();
            
            // Initialize modal counters
            updateModalSelectedCount(selectedGroupIds.size);
            updateModalTotalCount(vehicleGroups ? vehicleGroups.length : 0);
            
            // Update translations for the dynamically created modal
            if (window.i18n) {
                window.i18n.updateAllTranslations();
            }
        }
        
        // Close dynamic modal
        function closeDynamicModal() {
            const modal = document.getElementById('dynamicGroupFilterModal');
            if (modal) {
                modal.remove();
            }
        }
        
        // Store selected groups
        let selectedGroupIds = new Set();
        
        // Populate dynamic group filter with beautiful buttons
        function populateDynamicGroupFilter() {
            const groupContainer = document.getElementById('groupButtonsContainer');
            if (!groupContainer) return;
            
            // Clear container
            groupContainer.innerHTML = '';

            // Add "All vehicles" button  
            const allVehiclesText = t('group_filter.all_vehicles');
            const allButton = createGroupButton('', allVehiclesText, 'tutti', true);
            groupContainer.appendChild(allButton);

            // Add group buttons
            if (vehicleGroups && vehicleGroups.length > 0) {
                // Adjust grid layout based on number of groups
                const groupCount = vehicleGroups.length;
                let minWidth = '140px';
                let gap = '8px';
                
                if (groupCount > 20) {
                    minWidth = '120px';
                    gap = '6px';
                    groupContainer.style.gap = gap;
                    groupContainer.style.gridTemplateColumns = `repeat(auto-fit, minmax(${minWidth}, 1fr))`;
                } else if (groupCount > 15) {
                    minWidth = '130px';
                    gap = '7px';
                    groupContainer.style.gap = gap;
                    groupContainer.style.gridTemplateColumns = `repeat(auto-fit, minmax(${minWidth}, 1fr))`;
                }
                
                vehicleGroups.forEach(group => {
                    const button = createGroupButton(group.id, group.name, group.vehicle_count || 0, false);
                    groupContainer.appendChild(button);
                });
            } else {
                const noGroupsText = t('group_filter.no_groups');
                groupContainer.innerHTML = `
                    <div style="
                        text-align: center;
                        color: #9ca3af;
                        padding: 20px;
                        font-style: italic;
                        grid-column: 1 / -1;
                    ">${noGroupsText}</div>
                `;
            }
        }
        
        // Create a beautiful group button
        function createGroupButton(groupId, groupName, vehicleCount, isAllButton = false) {
            const button = document.createElement('button');
            button.className = 'group-button';
            button.dataset.groupId = groupId;
            
            const isSelected = isAllButton ? selectedGroupIds.size === 0 : selectedGroupIds.has(groupId);
            
            button.style.cssText = `
                padding: 10px 12px;
                background: ${isSelected ? 
                    'linear-gradient(45deg, #00AE5D, #10b981)' : 
                    'linear-gradient(45deg, #374151, #4b5563)'
                };
                color: white;
                border: ${isSelected ? '2px solid #00AE5D' : '2px solid transparent'};
                border-radius: 10px;
                cursor: pointer;
                font-weight: 600;
                transition: all 0.3s ease;
                box-shadow: ${isSelected ? 
                    '0 6px 18px rgba(0, 174, 93, 0.4), 0 0 0 1px rgba(0, 174, 93, 0.2), 0 0 15px rgba(0, 174, 93, 0.2)' : 
                    '0 3px 8px rgba(0, 0, 0, 0.3)'
                };
                text-align: center;
                position: relative;
                overflow: hidden;
                min-height: 60px;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                gap: 2px;
                transform: ${isSelected ? 'scale(1.01)' : 'scale(1)'};
                font-size: 13px;
            `;
            
            if (isSelected) {
                button.classList.add('selected');
            }
            
            // Truncate long group names
            const displayName = groupName.length > 15 ? groupName.substring(0, 12) + '...' : groupName;
            
            button.innerHTML = `
                <div style="
                    font-size: 12px;
                    font-weight: 700;
                    margin-bottom: 2px;
                    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
                    line-height: 1.2;
                    max-height: 24px;
                    overflow: hidden;
                " title="${groupName}">${displayName}</div>
                <div style="
                    font-size: 10px;
                    opacity: 0.9;
                    font-weight: 400;
                    line-height: 1;
                ">${isAllButton ? '∞' : vehicleCount} ${t('group_filter.vehicles')}</div>
                ${isSelected ? `
                    <div style="
                        position: absolute;
                        top: 4px;
                        right: 4px;
                        width: 16px;
                        height: 16px;
                        background: rgba(255, 255, 255, 0.9);
                        border-radius: 50%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 10px;
                        color: #00AE5D;
                        font-weight: bold;
                    ">✓</div>
                ` : ''}
            `;
            
            // Add click handler
            button.onclick = () => toggleGroupSelection(groupId, isAllButton);
            
            // Add hover effects
            button.onmouseenter = function() {
                if (!this.classList.contains('selected')) {
                    this.style.transform = 'translateY(-2px) scale(1.02)';
                    this.style.boxShadow = '0 8px 20px rgba(0, 0, 0, 0.4)';
                    this.style.background = 'linear-gradient(45deg, #4b5563, #6b7280)';
                }
            };
            
            button.onmouseleave = function() {
                if (!this.classList.contains('selected')) {
                    this.style.transform = 'scale(1)';
                    this.style.boxShadow = '0 3px 8px rgba(0, 0, 0, 0.3)';
                    this.style.background = 'linear-gradient(45deg, #374151, #4b5563)';
                }
            };
            
            return button;
        }
        
        // Toggle group selection
        function toggleGroupSelection(groupId, isAllButton = false) {
            if (isAllButton) {
                // If "All vehicles" is clicked, clear all selections
                selectedGroupIds.clear();
            } else {
                // Toggle individual group
                if (selectedGroupIds.has(groupId)) {
                    selectedGroupIds.delete(groupId);
                } else {
                    selectedGroupIds.add(groupId);
                }
            }
            
            // Update button appearances
            updateGroupButtonsAppearance();
            
            // Add sparkle effect
            addSparkleEffect(event.target);
            
            // Add vibration effect
            addVibrationEffect(event.target);
            
            // Update counters
            updateSelectedGroupsCount(selectedGroupIds.size);
            updateModalSelectedCount(selectedGroupIds.size);
        }
        
        // Update button appearances based on selection
        function updateGroupButtonsAppearance() {
            const buttons = document.querySelectorAll('.group-button');
            
            buttons.forEach(button => {
                const groupId = button.dataset.groupId;
                const isAllButton = groupId === '';
                const isSelected = isAllButton ? selectedGroupIds.size === 0 : selectedGroupIds.has(groupId);
                
                // Update styles
                if (isSelected) {
                    button.style.background = 'linear-gradient(45deg, #00AE5D, #10b981)';
                    button.style.border = '2px solid #00AE5D';
                    button.style.boxShadow = '0 6px 18px rgba(0, 174, 93, 0.4), 0 0 0 1px rgba(0, 174, 93, 0.2), 0 0 15px rgba(0, 174, 93, 0.2)';
                    button.style.transform = 'scale(1.01)';
                    button.classList.add('selected');
                    
                    // Add checkmark if not present
                    if (!button.querySelector('.checkmark')) {
                        const checkmark = document.createElement('div');
                        checkmark.className = 'checkmark';
                        checkmark.style.cssText = `
                            position: absolute;
                            top: 4px;
                            right: 4px;
                            width: 16px;
                            height: 16px;
                            background: rgba(255, 255, 255, 0.9);
                            border-radius: 50%;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-size: 10px;
                            color: #00AE5D;
                            font-weight: bold;
                            animation: checkmarkAppear 0.3s ease-out;
                        `;
                        checkmark.textContent = '✓';
                        button.appendChild(checkmark);
                    }
                } else {
                    button.style.background = 'linear-gradient(45deg, #374151, #4b5563)';
                    button.style.border = '2px solid transparent';
                    button.style.boxShadow = '0 3px 8px rgba(0, 0, 0, 0.3)';
                    button.style.transform = 'scale(1)';
                    button.classList.remove('selected');
                    
                    // Remove checkmark
                    const checkmark = button.querySelector('.checkmark');
                    if (checkmark) {
                        checkmark.remove();
                    }
                }
            });
        }
        
        // Add sparkle effect
        function addSparkleEffect(element) {
            // Create fewer, smaller sparkle elements for compact buttons
            for (let i = 0; i < 5; i++) {
                const sparkle = document.createElement('div');
                const colors = ['#ffd700', '#ffed4e', '#fbbf24', '#f59e0b', '#ffffff'];
                const randomColor = colors[Math.floor(Math.random() * colors.length)];
                
                sparkle.style.cssText = `
                    position: absolute;
                    width: ${Math.random() * 2 + 1.5}px;
                    height: ${Math.random() * 2 + 1.5}px;
                    background: ${randomColor};
                    border-radius: 50%;
                    pointer-events: none;
                    animation: sparkle ${0.5 + Math.random() * 0.3}s ease-out forwards;
                    box-shadow: 0 0 4px ${randomColor};
                `;
                
                // Random position around the button
                const rect = element.getBoundingClientRect();
                const x = Math.random() * (rect.width - 10) + 5;
                const y = Math.random() * (rect.height - 10) + 5;
                
                sparkle.style.left = x + 'px';
                sparkle.style.top = y + 'px';
                
                element.appendChild(sparkle);
                
                // Remove sparkle after animation
                setTimeout(() => sparkle.remove(), 800);
            }
        }
        
        // Add vibration effect
        function addVibrationEffect(element) {
            element.style.animation = 'vibrate 0.3s ease-in-out';
            
            setTimeout(() => {
                element.style.animation = '';
            }, 300);
        }
        
        // Select all groups
        function selectAllGroups() {
            if (vehicleGroups && vehicleGroups.length > 0) {
                vehicleGroups.forEach(group => {
                    selectedGroupIds.add(group.id);
                });
                updateGroupButtonsAppearance();
                updateSelectedGroupsCount(selectedGroupIds.size);
                updateModalSelectedCount(selectedGroupIds.size);
                
                // Add sparkle effect to all buttons
                document.querySelectorAll('.group-button').forEach((button, index) => {
                    setTimeout(() => {
                        addSparkleEffect(button);
                        addVibrationEffect(button);
                    }, index * 100);
                });
            }
        }
        
        // Clear all groups
        function clearAllGroups() {
            selectedGroupIds.clear();
            updateGroupButtonsAppearance();
            updateSelectedGroupsCount(0);
            updateModalSelectedCount(0);
            
            // Add sparkle effect to all buttons
            document.querySelectorAll('.group-button').forEach((button, index) => {
                setTimeout(() => {
                    addSparkleEffect(button);
                    addVibrationEffect(button);
                }, index * 80);
            });
        }
        
        // Update selected groups count in main button
        function updateSelectedGroupsCount(count) {
            const countElement = document.getElementById('selectedGroupsCount');
            if (countElement) {
                countElement.textContent = count;
                
                // Add animation when count changes
                if (count > 0) {
                    countElement.style.background = '#00AE5D';
                    countElement.style.animation = 'pulse 0.5s ease-out';
                } else {
                    countElement.style.background = '#1e40af';
                    countElement.style.animation = 'none';
                }
                
                setTimeout(() => {
                    countElement.style.animation = 'none';
                }, 500);
            }
        }
        
        // Update selected groups count in modal
        function updateModalSelectedCount(count) {
            const modalCountElement = document.getElementById('modalSelectedCount');
            if (modalCountElement) {
                modalCountElement.textContent = count;
                
                // Add color animation
                const parent = modalCountElement.parentElement;
                if (count > 0) {
                    parent.style.background = 'rgba(0, 174, 93, 0.2)';
                    parent.style.borderColor = '#00AE5D';
                    parent.style.color = '#10b981';
                } else {
                    parent.style.background = 'rgba(17, 24, 39, 0.8)';
                    parent.style.borderColor = '#374151';
                    parent.style.color = '#9ca3af';
                }
            }
        }
        
        // Update total groups count in modal
        function updateModalTotalCount(total) {
            const modalTotalElement = document.getElementById('modalTotalCount');
            if (modalTotalElement) {
                modalTotalElement.textContent = total;
            }
        }
        
        // Apply dynamic filter
        async function applyDynamicFilter() {
            // Check if no groups are selected (means "All vehicles")
            if (selectedGroupIds.size === 0) {
                filteredCertificates = allCertificates;
                displayCertificates();
                updateCertificateCount();
                updateSelectedGroupsCount(0);
                closeDynamicModal();
                return;
            }
            
            // Get selected group IDs as array
            const selectedGroupIdsArray = Array.from(selectedGroupIds);
            
            try {
                // Collect all vehicle IDs from all selected groups
                let allGroupVehicleIds = [];
                
                for (const groupId of selectedGroupIdsArray) {
                    const groupResponse = await fetch(`/api/vehicle-groups/${groupId}/vehicles`);
                    const groupData = await groupResponse.json();
                    
                    if (!groupData.success) {
                        throw new Error(groupData.message || `Failed to load group ${groupId} vehicles`);
                    }
                    
                    const groupVehicleIds = groupData.data.map(v => v.vehicle_id);
                    allGroupVehicleIds = [...allGroupVehicleIds, ...groupVehicleIds];
                }
                
                // Remove duplicates
                allGroupVehicleIds = [...new Set(allGroupVehicleIds)];

                // Get all certificates for the dealer
                const response = await fetch(`/api/certificates/${currentDealerId}`);
                const data = await response.json();

                if (data.success) {
                    // Filter certificates to show vehicles in ANY of the selected groups
                    const rawFilteredCertificates = data.data.filter(cert => 
                        allGroupVehicleIds.includes(cert.vehicle_id)
                    );
                    // Process the filtered certificates with the same formatting logic
                    filteredCertificates = rawFilteredCertificates.map(cert => {
                        // Helper functions to handle JSON data
                        const getClientName = (clientData) => {
                            if (!clientData) return 'N/A';
                            if (typeof clientData === 'string') return clientData;
                            if (typeof clientData === 'object') {
                                const firstName = clientData.firstName || '';
                                const lastName = clientData.lastName || '';
                                return `${firstName} ${lastName}`.trim() || 'N/A';
                            }
                            return 'N/A';
                        };
                        
                        const getClientEmail = (clientData) => {
                            if (!clientData) return 'N/A';
                            if (typeof clientData === 'object' && clientData.email) {
                                return clientData.email.toLowerCase(); // Forza minuscolo
                            }
                            return 'N/A';
                        };
                        
                        const getClientPhone = (clientData) => {
                            if (!clientData) return 'N/A';
                            if (typeof clientData === 'object') {
                                // Cerca vari possibili nomi per il campo telefono
                                return clientData.phone || clientData.telefono || clientData.mobile || clientData.cellulare || 'N/A';
                            }
                            return 'N/A';
                        };
                        
                        const getVehicleInfo = (vehicleData) => {
                            if (!vehicleData) return 'N/A';
                            if (typeof vehicleData === 'string') return vehicleData;
                            if (typeof vehicleData === 'object') {
                                const brand = vehicleData.brand || '';
                                const model = vehicleData.model || '';
                                const year = vehicleData.year || '';
                                return `${brand} ${model} ${year}`.trim() || 'N/A';
                            }
                            return 'N/A';
                        };
                        
                        const getVehiclePlate = (vehicleData) => {
                            if (!vehicleData) return 'N/A';
                            if (typeof vehicleData === 'object' && vehicleData.plate) {
                                return vehicleData.plate.toUpperCase();
                            }
                            return 'N/A';
                        };
                        
                        const getVehicleBrand = (vehicleData) => {
                            if (!vehicleData) return 'N/A';
                            if (typeof vehicleData === 'object' && vehicleData.brand) {
                                return vehicleData.brand;
                            }
                            return 'N/A';
                        };
                        
                        const getVehicleModel = (vehicleData) => {
                            if (!vehicleData) return 'N/A';
                            if (typeof vehicleData === 'object' && vehicleData.model) {
                                return vehicleData.model;
                            }
                            return 'N/A';
                        };
                        
                        const getFuelType = (vehicleData) => {
                            if (!vehicleData) return 'N/A';
                            if (typeof vehicleData === 'object' && vehicleData.fuelType) {
                                return vehicleData.fuelType;
                            }
                            return 'N/A';
                        };
                        
                        const getVIN = (vehicleData) => {
                            if (!vehicleData) return 'N/A';
                            if (typeof vehicleData === 'object' && vehicleData.vin) {
                                return vehicleData.vin.toUpperCase();
                            }
                            return 'N/A';
                        };
                        
                        const getVehicleYear = (vehicleData) => {
                            if (!vehicleData) return 'N/A';
                            if (typeof vehicleData === 'object' && vehicleData.year) {
                                return vehicleData.year.toString();
                            }
                            return 'N/A';
                        };
                        
                        const formatName = (name) => {
                            if (!name || name === 'N/A') return name;
                            return name.toLowerCase().split(' ')
                                .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                                .join(' ');
                        };
                        
                        return {
                            ...cert,
                            clientName: formatName(getClientName(cert.client)),
                            clientEmail: getClientEmail(cert.client),
                            clientPhone: getClientPhone(cert.client),
                            vehicleInfo: getVehicleInfo(cert.vehicle),
                            vehiclePlate: getVehiclePlate(cert.vehicle),
                            vehicleBrand: getVehicleBrand(cert.vehicle),
                            vehicleModel: getVehicleModel(cert.vehicle),
                            vehicleYear: getVehicleYear(cert.vehicle),
                            fuelType: getFuelType(cert.vehicle),
                            vin: getVIN(cert.vehicle),
                            installerName: formatName(cert.installerName || 'N/A'),
                            status: cert.active ? 'active' : 'inactive'
                        };
                    });

                    // Update the certificates display
                    displayCertificates();
                    updateCertificateCount();
                    updateSelectedGroupsCount(selectedGroupIds.size);
                    closeDynamicModal();
                } else {
                    throw new Error(data.message || 'Failed to load certificates');
                }
            } catch (error) {
                console.error('Error filtering certificates by group:', error);
                alert('Errore nel filtraggio: ' + error.message);
            }
        }











        // Load AI suggestions
        async function loadAISuggestions() {
            try {
                // Show loading state
                document.getElementById('aiLoadingState').classList.remove('hidden');
                document.getElementById('aiSuggestionsList').innerHTML = '';

                // Fetch AI suggestions from API
                console.log('🌐 Fetching AI suggestions for dealer:', currentDealerId);
                const response = await fetch(`/api/vehicle-analysis/${currentDealerId}`);
                const data = await response.json();

                if (data.success) {
                    console.log('🔍 AI Suggestions received:', data.data.suggestions.length, 'suggestions');
                    console.log('📋 Suggestion names:', data.data.suggestions.map(s => s.name).join(', '));
                    renderAISuggestions(data.data.suggestions, data.data.statistics);
                } else {
                    throw new Error(data.message || 'Failed to load AI suggestions');
                }
            } catch (error) {
                console.error('Error loading AI suggestions:', error);
                document.getElementById('aiSuggestionsList').innerHTML = `
                    <div class="col-span-full text-center py-4">
                        <p class="text-red-400 text-sm">Errore nel caricamento dei suggerimenti AI: ${error.message}</p>
                    </div>
                `;
            } finally {
                document.getElementById('aiLoadingState').classList.add('hidden');
            }
        }

        // Render AI suggestions
        function renderAISuggestions(suggestions, statistics) {
            const container = document.getElementById('aiSuggestionsList');
            
            if (suggestions.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-4">
                        <div class="inline-flex items-center justify-center w-10 h-10 bg-blue-600/20 rounded-full mb-3">
                            <svg class="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                            </svg>
                        </div>
                        <p class="text-blue-300" data-it="Nessun suggerimento disponibile" data-en="No suggestions available">Nessun suggerimento disponibile</p>
                        <p class="text-blue-400 text-sm mt-1" data-it="Aggiungi più veicoli per ricevere suggerimenti" data-en="Add more vehicles to receive suggestions">Aggiungi più veicoli per ricevere suggerimenti</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = suggestions.map(suggestion => `
                <div class="bg-blue-800/30 rounded-lg p-3 border border-blue-600/50 hover:border-blue-500 transition-colors">
                    <div class="flex items-start justify-between mb-2">
                        <div class="flex items-center gap-2">
                            <div class="w-6 h-6 rounded-full flex items-center justify-center text-white text-xs font-medium" style="background-color: ${suggestion.color}">
                                ${getGroupIcon(suggestion.icon)}
                            </div>
                            <div>
                                <h4 class="text-white font-medium text-sm">${suggestion.name}</h4>
                                <p class="text-blue-300 text-xs">${suggestion.vehicleCount} veicoli</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-1">
                            <span class="text-xs text-blue-400 bg-blue-900/50 px-2 py-1 rounded">
                                ${(suggestion.confidence * 100).toFixed(0)}%
                            </span>
                        </div>
                    </div>
                    
                    <p class="text-blue-200 text-xs mb-3">${suggestion.description}</p>
                    
                    <div class="flex items-center justify-between">
                        <button onclick="createGroupFromSuggestion('${suggestion.name}', '${suggestion.description}', '${suggestion.color}', '${suggestion.icon}')" class="px-2 py-1 bg-blue-600 hover:bg-blue-700 text-white rounded text-xs transition-colors">
                            <span data-it="Crea Gruppo" data-en="Create Group">Crea Gruppo</span>
                        </button>
                        <span class="text-xs text-blue-400">${suggestion.type}</span>
                    </div>
                </div>
            `).join('');
        }

        // Create group from AI suggestion
        async function createGroupFromSuggestion(name, description, color, icon) {
            // Trova e disabilita il pulsante per evitare doppi click
            const buttons = document.querySelectorAll(`button[onclick*="createGroupFromSuggestion('${name}'"]`);
            buttons.forEach(btn => {
                btn.disabled = true;
                btn.innerHTML = '<span class="text-xs">Creazione...</span>';
                btn.classList.add('opacity-50', 'cursor-not-allowed');
            });

            try {
                const groupData = {
                    dealerId: currentDealerId,
                    name: name,
                    description: description,
                    color: color,
                    icon: icon
                };

                const response = await fetch('/api/vehicle-groups', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(groupData)
                });

                const data = await response.json();

                if (data.success) {
                    // Ricarica sia i gruppi esistenti che i suggerimenti AI
                    await loadVehicleGroups();
                    await loadAISuggestions();
                    showNotification('Gruppo creato dal suggerimento AI!', 'success');
                } else {
                    // Handle specific error types
                    if (data.error === 'duplicate_group') {
                        showNotification(`⚠️ ${data.message}`, 'warning');
                        // Reload AI suggestions to remove the duplicate
                        await loadAISuggestions();
                    } else {
                        throw new Error(data.message || 'Failed to create group');
                    }
                }
            } catch (error) {
                console.error('Error creating group from suggestion:', error);
                showNotification(`Errore nella creazione del gruppo: ${error.message}`, 'error');
                
                // Ripristina i pulsanti in caso di errore
                buttons.forEach(btn => {
                    btn.disabled = false;
                    btn.innerHTML = '<span data-it="Crea Gruppo" data-en="Create Group">Crea Gruppo</span>';
                    btn.classList.remove('opacity-50', 'cursor-not-allowed');
                });
            }
        }

        // Render vehicle groups in the modal
        function renderVehicleGroups() {
            const container = document.getElementById('vehicleGroupsList');
            
            if (vehicleGroups.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-8">
                        <div class="inline-flex items-center justify-center w-12 h-12 bg-gray-600/20 rounded-full mb-4">
                            <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                            </svg>
                        </div>
                        <p class="text-gray-400" data-it="Nessun gruppo creato" data-en="No groups created">Nessun gruppo creato</p>
                        <p class="text-gray-500 text-sm mt-1" data-it="Crea il tuo primo gruppo per organizzare i veicoli" data-en="Create your first group to organize vehicles">Crea il tuo primo gruppo per organizzare i veicoli</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = vehicleGroups.map(group => `
                <div class="bg-gray-700 rounded-lg p-4 border border-gray-600 hover:border-gray-500 transition-colors">
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full flex items-center justify-center text-white text-sm font-medium" style="background-color: ${group.color}">
                                ${getGroupIcon(group.icon)}
                            </div>
                            <div>
                                <h4 class="text-white font-semibold">${group.name}</h4>
                                <p class="text-gray-400 text-sm">${group.vehicle_count || 0} veicoli</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-1">
                            <button onclick="editGroup('${group.id}')" class="p-1 text-gray-400 hover:text-blue-400 transition-colors" title="Modifica">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                </svg>
                            </button>
                            <button onclick="deleteGroup('${group.id}')" class="p-1 text-gray-400 hover:text-red-400 transition-colors" title="Elimina">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                    ${group.description ? `<p class="text-gray-300 text-sm mb-3">${group.description}</p>` : ''}
                    
                    <div class="flex items-center justify-between">
                        <button onclick="manageGroupVehicles('${group.id}')" class="px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white rounded text-sm transition-colors">
                            <span data-it="Gestisci Veicoli" data-en="Manage Vehicles">Gestisci Veicoli</span>
                        </button>
                        <span class="text-xs text-gray-500">Creato: ${new Date(group.created_at).toLocaleDateString()}</span>
                    </div>
                </div>
            `).join('');
        }

        // Get group icon emoji
        function getGroupIcon(icon) {
            const icons = {
                'car': '🚗',
                'truck': '🚛',
                'motorcycle': '🏍️',
                'fuel': '⛽',
                'electric': '⚡',
                'hybrid': '🔋',
                'fleet': '🚐',
                'vip': '👑'
            };
            return icons[icon] || '🚗';
        }

        // Open create group modal
        function openCreateGroupModal() {
            const modal = document.getElementById('createGroupModal');
            const title = document.getElementById('createGroupModalTitle');
            const form = document.getElementById('createGroupForm');
            
            title.textContent = 'Nuovo Gruppo';
            form.reset();
            form.dataset.mode = 'create';
            form.dataset.groupId = '';
            
            modal.classList.remove('hidden');
        }

        // Close create group modal
        function closeCreateGroupModal() {
            const modal = document.getElementById('createGroupModal');
            modal.classList.add('hidden');
        }
        // Edit group
        function editGroup(groupId) {
            const group = vehicleGroups.find(g => g.id === groupId);
            if (!group) return;

            const modal = document.getElementById('createGroupModal');
            const title = document.getElementById('createGroupModalTitle');
            const form = document.getElementById('createGroupForm');
            
            title.textContent = 'Modifica Gruppo';
            form.dataset.mode = 'edit';
            form.dataset.groupId = groupId;
            
            // Fill form with group data
            document.getElementById('groupName').value = group.name;
            document.getElementById('groupDescription').value = group.description || '';
            document.getElementById('groupColor').value = group.color || '#3B82F6';
            document.getElementById('groupIcon').value = group.icon || 'car';
            
            modal.classList.remove('hidden');
        }

        // Delete group
        async function deleteGroup(groupId) {
            // Create custom confirmation modal
            const confirmModal = document.createElement('div');
            confirmModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            confirmModal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-md w-full mx-4 shadow-xl">
                    <div class="flex items-center mb-4">
                        <div class="flex-shrink-0">
                            <svg class="w-8 h-8 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"/>
                            </svg>
                        </div>
                        <div class="ml-3">
                            <h3 class="text-lg font-medium text-gray-900 dark:text-white" data-it="Conferma Eliminazione" data-en="Confirm Deletion">Conferma Eliminazione</h3>
                        </div>
                    </div>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mb-6" data-it="Sei sicuro di voler eliminare questo gruppo? Questa azione non può essere annullata." data-en="Are you sure you want to delete this group? This action cannot be undone.">
                        Sei sicuro di voler eliminare questo gruppo? Questa azione non può essere annullata.
                    </p>
                    <div class="flex justify-end space-x-3">
                        <button onclick="closeDeleteModal()" class="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-700 rounded-md hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors" data-it="Annulla" data-en="Cancel">
                            Annulla
                        </button>
                        <button onclick="confirmDeleteGroup('${groupId}')" class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700 transition-colors" data-it="Elimina" data-en="Delete">
                            Elimina
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(confirmModal);
        }
        
        function closeDeleteModal() {
            // Find all modals and remove them
            const modals = document.querySelectorAll('.fixed.inset-0.bg-black.bg-opacity-50');
            modals.forEach(modal => {
                if (modal.innerHTML.includes('Conferma Eliminazione')) {
                    modal.remove();
                }
            });
        }
        
        async function confirmDeleteGroup(groupId) {
            try {
                const response = await fetch(`/api/vehicle-groups/${groupId}`, {
                    method: 'DELETE'
                });
                const data = await response.json();

                if (data.success) {
                    closeDeleteModal(); // Close modal first
                    await loadVehicleGroups();
                    showNotification('Gruppo eliminato con successo', 'success');
                } else {
                    throw new Error(data.message || 'Failed to delete group');
                }
            } catch (error) {
                console.error('Error deleting group:', error);
                showNotification(`Errore nell'eliminazione del gruppo: ${error.message}`, 'error');
                closeDeleteModal(); // Close modal even on error
            }
        }

        // Manage group vehicles
        function manageGroupVehicles(groupId) {
            const group = vehicleGroups.find(g => g.id === groupId);
            if (!group) {
                showNotification('Gruppo non trovato', 'error');
                return;
            }
            
            currentGroupId = groupId;
            openVehicleManagementModal();
            loadAvailableVehicles();
            loadGroupVehicles(groupId);
        }

        // Handle form submission
        document.getElementById('createGroupForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const mode = this.dataset.mode;
            const groupId = this.dataset.groupId;
            
            const groupData = {
                dealerId: currentDealerId,
                name: formData.get('name'),
                description: formData.get('description'),
                color: formData.get('color'),
                icon: formData.get('icon')
            };

            try {
                let response;
                if (mode === 'edit') {
                    response = await fetch(`/api/vehicle-groups/${groupId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(groupData)
                    });
                } else {
                    response = await fetch('/api/vehicle-groups', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(groupData)
                    });
                }

                const data = await response.json();

                if (data.success) {
                    closeCreateGroupModal();
                    await loadVehicleGroups();
                    showNotification(
                        mode === 'edit' ? 'Gruppo aggiornato con successo' : 'Gruppo creato con successo',
                        'success'
                    );
                } else {
                    throw new Error(data.message || 'Failed to save group');
                }
            } catch (error) {
                console.error('Error saving group:', error);
                showNotification(`Errore nel salvataggio del gruppo: ${error.message}`, 'error');
            }
        });

        // ===== VEHICLE MANAGEMENT FUNCTIONS =====

        // Open vehicle management modal
        function openVehicleManagementModal() {
            const modal = document.getElementById('vehicleManagementModal');
            modal.classList.remove('hidden');
            
            // Update modal title with group name
            const group = vehicleGroups.find(g => g.id === currentGroupId);
            if (group) {
                document.getElementById('vehicleManagementModalTitle').textContent = `Gestione Veicoli - ${group.name}`;
            }
            
            // Add event listeners for search functionality
            setTimeout(() => {
                const availableSearch = document.getElementById('availableVehiclesSearch');
                const groupSearch = document.getElementById('groupVehiclesSearch');
                
                if (availableSearch) {
                    availableSearch.removeEventListener('input', filterAvailableVehicles);
                    availableSearch.addEventListener('input', filterAvailableVehicles);
                }
                if (groupSearch) {
                    groupSearch.removeEventListener('input', filterGroupVehicles);
                    groupSearch.addEventListener('input', filterGroupVehicles);
                }
            }, 100);
        }

        // Close vehicle management modal
        function closeVehicleManagementModal() {
            const modal = document.getElementById('vehicleManagementModal');
            modal.classList.add('hidden');
            currentGroupId = null;
            
            // Clear search fields
            const availableSearch = document.getElementById('availableVehiclesSearch');
            const groupSearch = document.getElementById('groupVehiclesSearch');
            if (availableSearch) availableSearch.value = '';
            if (groupSearch) groupSearch.value = '';
        }

        // Filter available vehicles
        function filterAvailableVehicles() {
            const searchTerm = document.getElementById('availableVehiclesSearch').value.toLowerCase();
            const filtered = availableVehicles.filter(vehicle => {
                return vehicle.brand?.toLowerCase().includes(searchTerm) ||
                       vehicle.model?.toLowerCase().includes(searchTerm) ||
                       vehicle.license_plate?.toLowerCase().includes(searchTerm) ||
                       vehicle.fuel_type?.toLowerCase().includes(searchTerm) ||
                       vehicle.year?.toString().includes(searchTerm);
            });
            renderAvailableVehicles(filtered);
        }

        // Filter group vehicles
        function filterGroupVehicles() {
            const searchTerm = document.getElementById('groupVehiclesSearch').value.toLowerCase();
            const filtered = groupVehicles.filter(vehicle => {
                return vehicle.brand?.toLowerCase().includes(searchTerm) ||
                       vehicle.model?.toLowerCase().includes(searchTerm) ||
                       vehicle.license_plate?.toLowerCase().includes(searchTerm) ||
                       vehicle.fuel_type?.toLowerCase().includes(searchTerm) ||
                       vehicle.year?.toString().includes(searchTerm);
            });
            renderGroupVehicles(filtered);
        }

        // Load available vehicles (not in the group)
        async function loadAvailableVehicles() {
            try {
                // Show loading state
                const loadingElement = document.getElementById('availableVehiclesLoading');
                const listElement = document.getElementById('availableVehiclesList');
                
                if (loadingElement) loadingElement.classList.remove('hidden');
                if (listElement) listElement.innerHTML = '';

                // Get all certificates for the dealer
                const response = await fetch(`/api/certificates/${currentDealerId}`);
                const data = await response.json();

                if (data.success) {
                    // Get current group vehicles to filter them out
                    const groupVehiclesResponse = await fetch(`/api/vehicle-groups/${currentGroupId}/vehicles`);
                    const groupVehiclesData = await groupVehiclesResponse.json();
                    const groupVehicleIds = groupVehiclesData.success ? groupVehiclesData.data.map(v => v.vehicle_id) : [];

                    // Filter out vehicles already in the group
                    availableVehicles = data.data.filter(cert => !groupVehicleIds.includes(cert.vehicle_id));
                    renderAvailableVehicles();
                } else {
                    throw new Error(data.message || 'Failed to load vehicles');
                }
            } catch (error) {
                console.error('Error loading available vehicles:', error);
                const listElement = document.getElementById('availableVehiclesList');
                if (listElement) {
                    listElement.innerHTML = `
                        <div class="text-center py-4">
                            <p class="text-red-400 text-sm">Errore nel caricamento dei veicoli: ${error.message}</p>
                        </div>
                    `;
                }
            } finally {
                const loadingElement = document.getElementById('availableVehiclesLoading');
                if (loadingElement) loadingElement.classList.add('hidden');
            }
        }

        // Load group vehicles
        async function loadGroupVehicles(groupId) {
            try {
                // Show loading state
                const loadingElement = document.getElementById('groupVehiclesLoading');
                const listElement = document.getElementById('groupVehiclesList');
                
                if (loadingElement) loadingElement.classList.remove('hidden');
                if (listElement) listElement.innerHTML = '';

                const response = await fetch(`/api/vehicle-groups/${groupId}/vehicles`);
                const data = await response.json();

                if (data.success) {
                    groupVehicles = data.data;
                    renderGroupVehicles();
                } else {
                    throw new Error(data.message || 'Failed to load group vehicles');
                }
            } catch (error) {
                console.error('Error loading group vehicles:', error);
                const listElement = document.getElementById('groupVehiclesList');
                if (listElement) {
                    listElement.innerHTML = `
                        <div class="text-center py-4">
                            <p class="text-red-400 text-sm">Errore nel caricamento dei veicoli del gruppo: ${error.message}</p>
                        </div>
                    `;
                }
            } finally {
                const loadingElement = document.getElementById('groupVehiclesLoading');
                if (loadingElement) loadingElement.classList.add('hidden');
            }
        }

        // Render available vehicles
        function renderAvailableVehicles(vehiclesToRender = null) {
            const container = document.getElementById('availableVehiclesList');
            if (!container) return;
            
            const vehicles = vehiclesToRender || availableVehicles;
            
            if (vehicles.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4">
                        <p class="text-gray-400 text-sm" data-it="Nessun veicolo disponibile" data-en="No vehicles available">Nessun veicolo disponibile</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = vehicles.map(cert => `
                <div class="bg-gray-600 rounded-lg p-3 hover:bg-gray-500 transition-colors cursor-pointer" onclick="addVehicleToGroup('${cert.vehicle_id}')">
                    <div class="flex items-center justify-between">
                        <div class="flex-1">
                            <div class="flex items-center gap-2">
                                <span class="text-white font-medium">${cert.vehicle?.brand || 'N/A'} ${cert.vehicle?.model || ''}</span>
                                <span class="text-gray-300 text-sm">${cert.vehicle?.year || ''}</span>
                            </div>
                            <div class="text-gray-300 text-sm mt-1">
                                <span class="font-medium">${cert.vehicle?.plate || 'N/A'}</span>
                                <span class="mx-2">•</span>
                                <span>${cert.vehicle?.fuelType || 'N/A'}</span>
                            </div>
                        </div>
                        <button class="text-blue-400 hover:text-blue-300 transition-colors">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                            </svg>
                        </button>
                    </div>
                </div>
            `).join('');
        }
        // Render group vehicles
        function renderGroupVehicles(vehiclesToRender = null) {
            const container = document.getElementById('groupVehiclesList');
            if (!container) return;
            
            const vehicles = vehiclesToRender || groupVehicles;
            
            if (vehicles.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4">
                        <p class="text-gray-400 text-sm" data-it="Nessun veicolo nel gruppo" data-en="No vehicles in group">Nessun veicolo nel gruppo</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = vehicles.map(vehicle => `
                <div class="bg-gray-600 rounded-lg p-3">
                    <div class="flex items-center justify-between">
                        <div class="flex-1">
                            <div class="flex items-center gap-2">
                                <span class="text-white font-medium">${vehicle.brand || 'N/A'} ${vehicle.model || ''}</span>
                                <span class="text-gray-300 text-sm">${vehicle.year || ''}</span>
                            </div>
                            <div class="text-gray-300 text-sm mt-1">
                                <span class="font-medium">${vehicle.license_plate || 'N/A'}</span>
                                <span class="mx-2">•</span>
                                <span>${vehicle.fuel_type || 'N/A'}</span>
                            </div>
                        </div>
                        <button onclick="removeVehicleFromGroup('${vehicle.vehicle_id}')" class="text-red-400 hover:text-red-300 transition-colors">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                            </svg>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Add vehicle to group
        async function addVehicleToGroup(vehicleId) {
            try {
                const response = await fetch(`/api/vehicle-groups/${currentGroupId}/vehicles`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        vehicleId: vehicleId
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showNotification('Veicolo aggiunto al gruppo con successo', 'success');
                    // Reload both lists
                    await loadAvailableVehicles();
                    await loadGroupVehicles(currentGroupId);
                    // Update vehicle count in groups list
                    await loadVehicleGroups();
                } else {
                    throw new Error(data.message || 'Failed to add vehicle to group');
                }
            } catch (error) {
                console.error('Error adding vehicle to group:', error);
                showNotification(`Errore nell'aggiunta del veicolo: ${error.message}`, 'error');
            }
        }

        // Remove vehicle from group
        async function removeVehicleFromGroup(vehicleId) {
            try {
                const response = await fetch(`/api/vehicle-groups/${currentGroupId}/vehicles/${vehicleId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    showNotification('Veicolo rimosso dal gruppo con successo', 'success');
                    // Reload both lists
                    await loadAvailableVehicles();
                    await loadGroupVehicles(currentGroupId);
                    // Update vehicle count in groups list
                    await loadVehicleGroups();
                } else {
                    throw new Error(data.message || 'Failed to remove vehicle from group');
                }
            } catch (error) {
                console.error('Error removing vehicle from group:', error);
                showNotification(`Errore nella rimozione del veicolo: ${error.message}`, 'error');
            }
        }

        // Show notification
        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg text-white z-50 transition-all duration-300 transform translate-x-full`;
            
            if (type === 'success') {
                notification.style.backgroundColor = '#059669';
            } else if (type === 'error') {
                notification.style.backgroundColor = '#DC2626';
            } else {
                notification.style.backgroundColor = '#3B82F6';
            }
            
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // Animate in
            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
            }, 100);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.style.transform = 'translateX(full)';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        // ===== CONTACT WITHOUT AI DIALOG FUNCTIONS =====

        // Open the Contact Without AI Dialog
        async function openBulkContactWithoutAIDialog() {
            const selected = getSelectedCertificates();
            const dialog = document.getElementById('bulkContactWithoutAIDialog');
            if (!dialog) return;
            
            dialog.classList.remove('hidden');
            document.getElementById('manualMessageInput').value = '';
            document.getElementById('manualMessagePreview').innerHTML = '';
            document.getElementById('emailSubjectInputNoAI').value = '';

            // Load dealer signatures
            try {
                const dealerId = getCurrentDealerId();
                const r = await fetch(`/api/communications/signatures/${dealerId}`).then(r=>r.json());
                const list = r?.data || [];
                const sel = document.getElementById('dealerSignatureSelectNoAI');
                if (sel) {
                    sel.innerHTML = '<option value="none" data-i18n="manual_contact.no_signature">Nessuna firma</option>' +
                        list.map(s=>`<option value="${encodeURIComponent(JSON.stringify(s))}">${(s.company_name||(window.i18n ? window.i18n.t('manual_contact.signature') : 'Firma'))}${s.phone? ' • '+s.phone:''}${s.email? ' • '+s.email:''}</option>`).join('');
                }
            } catch {}

            // Load templates for manual dialog
            try {
                const currentChannel = document.querySelector('#channelToggleGroupNoAI .active-chip')?.dataset.value || 'email';
                await populateTemplateDropdown('templateSelectorNoAI', 'manual', currentChannel);
            } catch (error) {
                console.error('Error loading templates:', error);
            }

            // Load dealer balance
            try {
                const dealerId = getCurrentDealerId();
                const b = await fetch(`/api/billing/balance/${dealerId}`).then(r=>r.json());
                const text = (b?.balance_cents!=null) ? (b.balance_cents/100).toLocaleString(undefined,{style:'currency',currency:(b.currency||'EUR')}) : '-';
                const el = document.getElementById('dealerBalanceTextNoAI');
                if (el) el.textContent = text;
            } catch {}

            // Load test clients for preview selector
            try {
                const dealerId = getCurrentDealerId();
                const r = await fetch(`/api/communications/test-clients/${dealerId}`).then(r=>r.json());
                const testClients = r?.data || [];
                const sel = document.getElementById('testClientSelectNoAI');
                if (sel) {
                    sel.innerHTML = '<option value="sample" data-i18n="manual_contact.sample_data">Dati di Esempio</option>' +
                        testClients.map(c => {
                            const name = [c.first_name, c.last_name].filter(Boolean).join(' ').trim() || (window.i18n ? window.i18n.t('manual_contact.test_client') : 'Cliente Test');
                            const vehicle = [c.vehicle_brand, c.vehicle_model].filter(Boolean).join(' ') || '';
                            const display = vehicle ? `${name} (${vehicle})` : name;
                            return `<option value="${c.id}">${display}</option>`;
                        }).join('');
                    
                    // Add event listener for preview updates
                    sel.addEventListener('change', () => {
                        updateManualMessagePreview();
                    });
                }
            } catch {}

            // Initialize drag & drop tags (force refresh for current language)
            initDragDropTags();
            
            // Initialize channel toggle functionality
            initChannelToggleNoAI();
            
            // Initialize test clients checkbox listener
            const testClientsCheckbox = document.getElementById('sendToTestClientsNoAI');
            if (testClientsCheckbox) {
                testClientsCheckbox.addEventListener('change', toggleTestClientsButton);
                toggleTestClientsButton(); // Set initial state
            }
            
            // Update selected count in button
            updateSelectedCountInButton();
            
            // Update translations for dynamically created elements
            if (window.i18n && typeof window.i18n.updateAllTranslations === 'function') {
                window.i18n.updateAllTranslations();
            }
            
            // Force update placeholder for current language
            const messageInput = document.getElementById('manualMessageInput');
            if (messageInput && window.i18n) {
                const placeholderText = window.i18n.t('manual_contact.message_placeholder');
                messageInput.placeholder = placeholderText;
            }
            
            // Re-update button counter after translations (fix for counter disappearing)
            setTimeout(() => {
                updateSelectedCountInButton();
            }, 100);
        }

        // Close the Contact Without AI Dialog
        function closeBulkContactWithoutAIDialog() {
            const dialog = document.getElementById('bulkContactWithoutAIDialog');
            if (dialog) dialog.classList.add('hidden');
        }

        // ===============================================
        // NUOVE FUNZIONI AI COMMUNICATION
        // ===============================================

        // Toggle pulsante clienti test per AI
        function toggleTestClientsButtonAI() {
            const checkbox = document.getElementById('sendToTestClients');
            const button = document.getElementById('sendToTestClientsAIBtn');
            
            if (checkbox && button) {
                if (checkbox.checked) {
                    button.classList.remove('hidden');
                } else {
                    button.classList.add('hidden');
                }
            }
        }

        // Genera contenuto AI con conferma billing
        async function generateAIContent() {
            const language = document.documentElement.lang || 'it';
            
            // Conferma spesa AI
            const aiCost = 0.20; // €0.20 per chiamata AI
            const confirmMessage = language === 'it' 
                ? `Generare la bozza costerà €${aiCost.toFixed(2)}. Procedere?`
                : `Generating the draft will cost €${aiCost.toFixed(2)}. Proceed?`;
            
            if (!window.customDialog) {
                const proceed = window.confirm(confirmMessage);
                if (!proceed) return;
            } else {
                const result = await window.customDialog.confirm(
                    language === 'it' ? 'Conferma Generazione' : 'Confirm Generation',
                    confirmMessage
                );
                if (!result) return;
            }

            const channel = document.querySelector('#channelToggleGroup .active-chip')?.dataset.value || 'email';
            const style = document.querySelector('#styleToggleGroup .active-chip')?.dataset.value || 'professional';
            const prompt = document.getElementById('aiPromptInput').value || '';
            const useFields = {};
            document.querySelectorAll('#fieldsChipGroup .active-chip').forEach(chip => {
                useFields[chip.dataset.field] = true;
            });

            const selectedCerts = getSelectedCertificates();
            const dealerId = getCurrentDealerId();
            
            // Carica clienti test
            const testClients = await fetch(`/api/communications/test-clients/${dealerId}`).then(r=>r.json()).then(j=> j.data||[]);

            const testRecipients = testClients.map(c => ({
                id: c.id,
                clientName: [c.first_name, c.last_name].filter(Boolean).join(' ').trim() || 'Cliente Test',
                clientEmail: (c.email||'').toLowerCase(),
                clientPhone: c.phone||'',
                // Aggiungi i dati del veicolo per i clienti test
                vehicle: `${c.vehicle_brand || ''} ${c.vehicle_model || ''}`.trim(),
                plate: c.vehicle_plate || '',
                year: c.vehicle_year || '',
                fuel: c.vehicle_fuel || '',
                km: c.vehicle_km || '',
                vin: c.vehicle_vin || '',
                serial: c.vehicle_serial || '',
                // Dati client
                firstName: c.first_name || '',
                lastName: c.last_name || '',
                companyName: c.company || ''
            }));

            const sendToTest = document.getElementById('sendToTestClients')?.checked;
            let recipients;
            if (sendToTest) {
                recipients = testRecipients;
                if (!recipients.length) {
                    const title = language === 'it' ? 'Attenzione' : 'Warning';
                    const msg = language==='it' ? 'Nessun cliente test salvato.' : 'No test clients saved.';
                    await window.customDialog.alert(title, msg, 'OK');
                    return;
                }
            } else {

                
                recipients = selectedCerts.map(cert => {
                    return {
                        // Check both nested and flat structure
                        brand_flat: cert.brand,
                        brand_nested: cert.vehicle?.brand,
                        model_flat: cert.model,
                        model_nested: cert.vehicle?.model,
                        license_plate: cert.license_plate,
                        plate_nested: cert.vehicle?.plate,
                        year: cert.year,
                        year_nested: cert.vehicle?.year,
                        fuel_type: cert.fuel_type,
                        fuel_nested: cert.vehicle?.fuelType,
                        odometer: cert.odometer,
                        vin: cert.vin,
                        serial: cert.serial
                    };
                    
                    // Use nested data first, then fallback to flat
                    const brand = cert.vehicle?.brand || cert.brand || '';
                    const model = cert.vehicle?.model || cert.model || '';
                    const plate = cert.vehicle?.plate || cert.license_plate || '';
                    const year = cert.vehicle?.year || cert.year || '';
                    const fuel = cert.vehicle?.fuelType || cert.fuel_type || '';
                    const odometer = cert.odometer || '';
                    const vin = cert.vin || '';
                    const serial = cert.serial || '';
                    
                    return {
                        id: cert.id,
                        clientName: cert.clientName,
                        clientEmail: (cert.clientEmail || '').toLowerCase(),
                        clientPhone: cert.clientPhone || '',
                        // Aggiungi i dati del veicolo per i placeholder
                        vehicle: `${brand} ${model}`.trim(),
                        plate: plate,
                        year: year,
                        fuel: fuel,
                        km: odometer,
                        vin: vin,
                        serial: serial,
                        // Dati client dettagliati
                        firstName: cert.client?.firstName || '',
                        lastName: cert.client?.lastName || '',
                        companyName: cert.client?.company || ''
                    };
                });
                
                console.log('🔍 DEBUG: Final recipients sample:', recipients[0]);
            }

            if (!sendToTest && !selectedCerts.length) {
                const title = language === 'it' ? 'Attenzione' : 'Warning';
                const msg = language === 'it' ? 'Seleziona almeno un certificato.' : 'Please select at least one certificate.';
                await window.customDialog.alert(title, msg, 'OK');
                return;
            }

            // Firma dealer
            let dealerSignatureText = '';
            const sel = document.getElementById('dealerSignatureSelect');
            if (sel && sel.value && sel.value !== 'none') {
                try {
                    const sig = JSON.parse(decodeURIComponent(sel.value));
                    dealerSignatureText = `${sig.company_name||''}${sig.address1? `\n${sig.address1}`:''}${sig.postcode||sig.city? `\n${[sig.postcode||'', sig.city||''].filter(Boolean).join(' ')}`:''}${sig.phone? `\nTel: ${sig.phone}`:''}${sig.email? `\nEmail: ${sig.email}`:''}`.trim();
                } catch {}
            }

            const aiResults = document.getElementById('aiResults');
            const emailSubjectInput = document.getElementById('emailSubjectInput');
            
            // Mostra loading
            aiResults.value = language === 'it' ? 'Generazione in corso...' : 'Generating...';
            if (channel === 'email' && emailSubjectInput) {
                emailSubjectInput.value = language === 'it' ? 'Generazione oggetto...' : 'Generating subject...';
            }

            try {
                console.log('🤖 Calling AI generation with:', { channel, style, prompt, recipients: recipients.length, useFields, language, dealerId });
                
                const response = await fetch('/api/communications/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        channel,
                        style,
                        prompt,
                        recipients,
                        useFields,
                        language,
                        send: false, // Solo generazione
                        dealerId,
                        dealerSignatureText
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Errore nella generazione');
                }

                // Mostra risultati
                if (data.base_message) {
                    // Converti \n in interruzioni di riga per textarea
                    const cleanMessage = data.base_message.replace(/\\n/g, '\n');
                    aiResults.value = cleanMessage;
                }

                // FORZA il popolamento dell'oggetto email - NUOVO APPROCCIO
                if (channel === 'email') {
                    // Trova TUTTI i possibili campi oggetto email
                    const possibleSubjectFields = [
                        document.getElementById('emailSubjectInput'),
                        document.querySelector('input[placeholder*="oggetto"]'),
                        document.querySelector('input[placeholder*="Oggetto"]'),
                        document.querySelector('input[placeholder*="subject"]'),
                        document.querySelector('input[placeholder*="Subject"]'),
                        document.querySelector('#emailSubjectField input'),
                        document.querySelector('.email-subject input'),
                        ...document.querySelectorAll('input[type="text"]')
                    ].filter(Boolean);
                    
                    console.log('🔍 Found possible subject fields:', possibleSubjectFields.length);
                    
                    const subjectToUse = data.email_subject;
                    
                    if (!subjectToUse) {
                        console.error('❌ NESSUN OGGETTO EMAIL RICEVUTO DAL SERVER!');
                        console.error('Data completa ricevuta:', data);
                        console.error('Keys in data:', Object.keys(data));
                        console.error('data.email_subject:', data.email_subject);
                        console.error('typeof data.email_subject:', typeof data.email_subject);
                        console.error('data.base_message length:', data.base_message?.length);
                        return;
                    }
                    
                    console.log('📧 Oggetto email ricevuto dal server:', subjectToUse);
                    
                    // FORZA il popolamento su TUTTI i campi possibili
                    possibleSubjectFields.forEach((field, index) => {
                        if (field) {
                            console.log(`📧 Setting subject on field ${index}:`, field.id || field.className);
                            field.value = subjectToUse;
                            field.setAttribute('value', subjectToUse);
                            // Trigger eventi per assicurarsi che il valore sia registrato
                            field.dispatchEvent(new Event('input', { bubbles: true }));
                            field.dispatchEvent(new Event('change', { bubbles: true }));
                        }
                    });
                    
                    console.log('✅ FORCED email subject population:', subjectToUse);
                    
                    // BACKUP: Riprova dopo 500ms nel caso il DOM non fosse pronto
                    setTimeout(() => {
                        const backupField = document.getElementById('emailSubjectInput');
                        if (backupField && (!backupField.value || backupField.value.includes('{'))) {
                            console.log('🔄 BACKUP: Re-setting email subject with:', subjectToUse);
                            backupField.value = subjectToUse;
                            backupField.dispatchEvent(new Event('input', { bubbles: true }));
                        } else if (backupField) {
                            console.log('✅ BACKUP: Field already has correct value:', backupField.value);
                        }
                    }, 500);
                }

                // Mostra costi
                if (data.costs) {
                    const costSummary = document.getElementById('costSummary');
                    if (costSummary) {
                        const euro = (c) => (c/100).toLocaleString('it-IT', {style:'currency', currency:'EUR'});
                        costSummary.textContent = `Costo generazione: OpenAI ${euro(data.costs.openai_cents)}`;
                    }
                }

                // Update credit display dynamically
                if (data.newBalance !== undefined) {
                    const balanceElement = document.getElementById('dealerBalanceText');
                    
                    if (balanceElement) {
                        const currentLanguage = window.i18n?.currentLanguage || 'it';
                        const locale = currentLanguage === 'it' ? 'it-IT' : 'en-US';
                        const newBalanceEuro = (data.newBalance / 100).toLocaleString(locale, {style: 'currency', currency: 'EUR'});
                        
                        balanceElement.textContent = newBalanceEuro;
                        console.log('💰 Balance updated dynamically after AI generation:', newBalanceEuro);
                    } else {
                        console.error('💰 Balance element not found!');
                    }
                } else {
                    console.warn('💰 No newBalance in AI generation response - fetching manually');
                    // Fallback: fetch balance manually
                    await updateDealerBalance();
                }

            } catch (error) {
                console.error('Errore generazione AI:', error);
                aiResults.value = language === 'it' 
                    ? `Errore: ${error.message}` 
                    : `Error: ${error.message}`;
                if (channel === 'email' && emailSubjectInput) {
                    emailSubjectInput.value = '';
                }
            }
        }

        // Invia comunicazioni AI
        async function sendAICommunications() {
            const language = document.documentElement.lang || 'it';
            const selectedCerts = getSelectedCertificates();
            const channel = document.querySelector('#channelToggleGroup .active-chip')?.dataset.value || 'email';
            
            if (!selectedCerts.length) {
                const title = language === 'it' ? 'Attenzione' : 'Warning';
                const msg = language === 'it' ? 'Seleziona almeno un certificato.' : 'Please select at least one certificate.';
                await window.customDialog.alert(title, msg, 'OK');
                return;
            }

            // Calcola costi
            const n = selectedCerts.length;
            const emailCost = channel === 'email' ? n * 0.05 : 0;
            const waCost = channel === 'whatsapp' ? n * 0.10 : 0;
            const total = (emailCost + waCost).toFixed(2);

            // Conferma spesa
            const costMsg = language === 'it'
                ? `Inviare ${n} comunicazioni costerà:\n- Email: €${emailCost.toFixed(2)}\n- WhatsApp: €${waCost.toFixed(2)}\nTotale: €${total}\n\nProcedere?`
                : `Sending ${n} communications will cost:\n- Email: €${emailCost.toFixed(2)}\n- WhatsApp: €${waCost.toFixed(2)}\nTotal: €${total}\n\nProceed?`;

            if (!window.customDialog) {
                const proceed = window.confirm(costMsg);
                if (!proceed) return;
            } else {
                const result = await window.customDialog.confirm(
                    language === 'it' ? 'Conferma Invio' : 'Confirm Sending',
                    costMsg
                );
                if (!result) return;
            }

            await sendAIMessages(false);
        }

        // Invia ai clienti test AI
        async function sendAIToTestClients() {
            const language = document.documentElement.lang || 'it';
            const dealerId = getCurrentDealerId();
            
            // Carica clienti test
            const testClients = await fetch(`/api/communications/test-clients/${dealerId}`).then(r=>r.json()).then(j=> j.data||[]);
            
            if (!testClients.length) {
                const title = language === 'it' ? 'Attenzione' : 'Warning';
                const msg = language==='it' ? 'Nessun cliente test salvato.' : 'No test clients saved.';
                await window.customDialog.alert(title, msg, 'OK');
                return;
            }

            const channel = document.querySelector('#channelToggleGroup .active-chip')?.dataset.value || 'email';
            const n = testClients.length;
            const emailCost = channel === 'email' ? n * 0.05 : 0;
            const waCost = channel === 'whatsapp' ? n * 0.10 : 0;
            const total = (emailCost + waCost).toFixed(2);

            // Conferma spesa
            const costMsg = language === 'it'
                ? `Inviare ${n} comunicazioni test costerà:\n- Email: €${emailCost.toFixed(2)}\n- WhatsApp: €${waCost.toFixed(2)}\nTotale: €${total}\n\nProcedere?`
                : `Sending ${n} test communications will cost:\n- Email: €${emailCost.toFixed(2)}\n- WhatsApp: €${waCost.toFixed(2)}\nTotal: €${total}\n\nProceed?`;

            if (!window.customDialog) {
                const proceed = window.confirm(costMsg);
                if (!proceed) return;
            } else {
                const result = await window.customDialog.confirm(
                    language === 'it' ? 'Conferma Invio Test' : 'Confirm Test Sending',
                    costMsg
                );
                if (!result) return;
            }

            await sendAIMessages(true);
        }

        // Funzione comune per invio messaggi AI
        async function sendAIMessages(isTestMode) {
            const language = document.documentElement.lang || 'it';
            const channel = document.querySelector('#channelToggleGroup .active-chip')?.dataset.value || 'email';
            const style = document.querySelector('#styleToggleGroup .active-chip')?.dataset.value || 'professional';
            const prompt = document.getElementById('aiPromptInput').value || '';
            const dealerId = getCurrentDealerId();
            
            // Prendi il contenuto dall'anteprima editabile
            const aiResults = document.getElementById('aiResults');
            const baseMessage = aiResults.value || '';
            const emailSubject = document.getElementById('emailSubjectInput')?.value || '';

            if (!baseMessage.trim()) {
                const title = language === 'it' ? 'Attenzione' : 'Warning';
                const msg = language === 'it' ? 'Genera prima una bozza.' : 'Generate a draft first.';
                await window.customDialog.alert(title, msg, 'OK');
                return;
            }

            const useFields = {};
            document.querySelectorAll('#fieldsChipGroup .active-chip').forEach(chip => {
                useFields[chip.dataset.field] = true;
            });

            let recipients;
            if (isTestMode) {
                const testClients = await fetch(`/api/communications/test-clients/${dealerId}`).then(r=>r.json()).then(j=> j.data||[]);
                console.log('🔍 DEBUG TEST CLIENTS RAW:', testClients[0]);
                console.log('🔍 DEBUG TEST CLIENTS AVAILABLE KEYS:', Object.keys(testClients[0] || {}));
                
                recipients = testClients.map(c => {
                    console.log('🔍 DEBUG TEST CLIENT MAPPING:', {
                        vehicle_brand: c.vehicle_brand,
                        vehicle_model: c.vehicle_model,
                        fuel_type: c.fuel_type,
                        odometer: c.odometer,
                        plate: c.plate,
                        year: c.year,
                        vin: c.vin,
                        serial: c.serial
                    });
                    
                    return {
                        id: c.id,
                        clientName: [c.first_name, c.last_name].filter(Boolean).join(' ').trim() || 'Cliente Test',
                        clientEmail: (c.email||'').toLowerCase(),
                        clientPhone: c.phone||'',
                        // CORREZIONE: tutti i campi ESISTONO nella tabella test_clients!
                        vehicle: `${c.vehicle_brand || ''} ${c.vehicle_model || ''}`.trim(),
                        plate: c.plate || '',
                        year: c.year || '',
                        fuel: c.fuel_type || '',
                        km: c.odometer || '',
                        vin: c.vin || '',
                        serial: c.serial || ''
                    };
                });
                
                console.log('🔍 DEBUG TEST RECIPIENTS FINAL:', recipients[0]);
            } else {
                const selectedCerts = getSelectedCertificates();
                console.log('🔍 DEBUG MANUAL: selectedCerts sample:', selectedCerts[0]);
                console.log('🔍 DEBUG MANUAL: Available keys:', Object.keys(selectedCerts[0] || {}));
                
                recipients = selectedCerts.map(cert => {
                    console.log('🔍 DEBUG MANUAL: Processing cert:', {
                        id: cert.id,
                        brand: cert.brand,
                        model: cert.model,
                        license_plate: cert.license_plate,
                        year: cert.year,
                        fuel_type: cert.fuel_type,
                        odometer: cert.odometer,
                        vin: cert.vin,
                        serial: cert.serial
                    });
                    
                    return {
                        id: cert.id,
                        clientName: cert.clientName,
                        clientEmail: (cert.clientEmail || '').toLowerCase(),
                        clientPhone: cert.clientPhone || '',
                        // Aggiungi i dati del veicolo per i placeholder MANUAL
                        vehicle: `${cert.brand || ''} ${cert.model || ''}`.trim(),
                        plate: cert.license_plate || '',
                        year: cert.year || '',
                        fuel: cert.fuel_type || '',
                        km: cert.odometer || '',
                        vin: cert.vin || '',
                        serial: cert.serial || '',
                        // Dati client dettagliati
                        firstName: cert.client?.firstName || '',
                        lastName: cert.client?.lastName || '',
                        companyName: cert.client?.company || ''
                    };
                });
                
                console.log('🔍 DEBUG MANUAL: Final recipients sample:', recipients[0]);
            }

            // Firma dealer
            let dealerSignatureText = '';
            const sel = document.getElementById('dealerSignatureSelect');
            if (sel && sel.value && sel.value !== 'none') {
                try {
                    const sig = JSON.parse(decodeURIComponent(sel.value));
                    dealerSignatureText = `${sig.company_name||''}${sig.address1? `\n${sig.address1}`:''}${sig.postcode||sig.city? `\n${[sig.postcode||'', sig.city||''].filter(Boolean).join(' ')}`:''}${sig.phone? `\nTel: ${sig.phone}`:''}${sig.email? `\nEmail: ${sig.email}`:''}`.trim();
                } catch {}
            }

            // Aggiorna UI
            const button = isTestMode ? document.getElementById('sendToTestClientsAIBtn') : document.getElementById('sendAICommunicationsBtn');
            const originalText = button?.textContent || '';
            if (button) {
                button.textContent = language === 'it' ? 'Invio...' : 'Sending...';
                button.disabled = true;
            }

            try {
                const response = await fetch('/api/communications/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        channel,
                        style: style,
                        prompt: '',
                        recipients,
                        selectedVehicles: recipients, // CORREZIONE: passa i dati del veicolo
                        useFields: useFields,
                        language,
                        send: true,
                        dealerId,
                        baseMessage,
                        emailSubject: channel === 'email' ? emailSubject : undefined,
                        dealerSignatureText
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Errore nell\'invio');
                }

                // Update credit display dynamically
                if (data.newBalance !== undefined) {
                    const balanceElement = document.getElementById('dealerBalanceText');
                    
                    if (balanceElement) {
                        const currentLanguage = window.i18n?.currentLanguage || 'it';
                        const locale = currentLanguage === 'it' ? 'it-IT' : 'en-US';
                        const newBalanceEuro = (data.newBalance / 100).toLocaleString(locale, {style: 'currency', currency: 'EUR'});
                        
                        balanceElement.textContent = newBalanceEuro;
                        console.log('💰 Balance updated dynamically:', newBalanceEuro);
                    } else {
                        console.error('💰 Balance element not found!');
                    }
                } else {
                    console.warn('💰 No newBalance in server response - fetching manually');
                    // Fallback: fetch balance manually
                    await updateDealerBalance();
                }

                // Show success message with updated credit info
                const sentCount = data.results ? data.results.filter(r => r.sendResult?.success).length : 0;
                const successMessage = language === 'it' 
                    ? `Inviati ${sentCount} messaggi con successo!`
                    : `Successfully sent ${sentCount} messages!`;
                    
                let fullMessage = successMessage;
                
                if (data.newBalance !== undefined) {
                    const currentLanguage = window.i18n?.currentLanguage || 'it';
                    const locale = currentLanguage === 'it' ? 'it-IT' : 'en-US';
                    const newBalanceEuro = (data.newBalance / 100).toLocaleString(locale, {style: 'currency', currency: 'EUR'});
                    const creditMessage = language === 'it' 
                        ? `Il tuo credito è stato aggiornato a ${newBalanceEuro}`
                        : `Your credit has been updated to ${newBalanceEuro}`;
                    fullMessage += `\n\n${creditMessage}`;
                }
                
                const title = language === 'it' ? 'Successo' : 'Success';
                await window.customDialog.alert(title, fullMessage, 'OK');

                // DON'T close the dialog - keep it open for more communications
                // closeBulkContactDialog();

            } catch (error) {
                console.error('Errore invio:', error);
                const title = language === 'it' ? 'Errore' : 'Error';
                const errorMsg = language === 'it' 
                    ? `Errore: ${error.message}`
                    : `Error: ${error.message}`;
                await window.customDialog.alert(title, errorMsg, 'OK');
            } finally {
                if (button) {
                    button.textContent = originalText;
                    button.disabled = false;
                }
            }
        }

        // Aggiorna balance dealer
        async function updateDealerBalance() {
            try {
                const dealerId = getCurrentDealerId();
                const response = await fetch(`/api/billing/balance/${dealerId}`);
                const data = await response.json();
                
                if (data.success && data.balance_cents !== undefined) {
                    const balanceText = document.getElementById('dealerBalanceText');
                    if (balanceText) {
                        const euro = (data.balance_cents / 100).toLocaleString('it-IT', {style:'currency', currency:'EUR'});
                        balanceText.textContent = euro;
                    }
                }
            } catch (error) {
                console.error('Errore aggiornamento balance:', error);
            }
        }

        // Aggiorna counter sui pulsanti AI
        function updateAIButtonCounters() {
            const selectedCerts = getSelectedCertificates();
            const count = selectedCerts.length;
            
            // Aggiorna pulsante comunicazioni AI
            const sendBtn = document.getElementById('sendAICommunicationsBtn');
            if (sendBtn) {
                const baseText = window.i18n ? window.i18n.t('contact.send_communications') : 'Invia comunicazioni';
                if (count > 0) {
                    sendBtn.textContent = `${baseText} (${count})`;
                    sendBtn.setAttribute('data-has-counter', 'true');
                } else {
                    sendBtn.textContent = baseText;
                    sendBtn.removeAttribute('data-has-counter');
                }
            }
        }

        // Initialize draggable tags for AI
        function initDragDropTagsAI() {
            const container = document.getElementById('availableTagsAI');
            const textarea = document.getElementById('aiResults');
            const emailSubjectInput = document.getElementById('emailSubjectInput');
            
            if (!container || !textarea) return;

            // Add drag and drop functionality to AI tags
            container.querySelectorAll('.tag-item').forEach(tag => {
                tag.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('text/plain', tag.dataset.tag);
                    tag.classList.add('dragging');
                });

                tag.addEventListener('dragend', () => {
                    tag.classList.remove('dragging');
                });
            });

            // Make textarea a drop zone
            textarea.addEventListener('dragover', (e) => {
                e.preventDefault();
                textarea.classList.add('drag-over');
            });

            textarea.addEventListener('dragleave', () => {
                textarea.classList.remove('drag-over');
            });

            textarea.addEventListener('drop', (e) => {
                e.preventDefault();
                textarea.classList.remove('drag-over');
                
                const tagData = e.dataTransfer.getData('text/plain');
                if (tagData) {
                    const cursorPos = textarea.selectionStart;
                    const textBefore = textarea.value.substring(0, cursorPos);
                    const textAfter = textarea.value.substring(cursorPos);
                    
                    textarea.value = textBefore + `{${tagData}}` + textAfter;
                    
                    // Position cursor after inserted tag
                    const newPos = cursorPos + tagData.length + 2;
                    textarea.setSelectionRange(newPos, newPos);
                    textarea.focus();
                    
                    // Visual feedback
                    textarea.classList.add('tag-inserted');
                    setTimeout(() => {
                        textarea.classList.remove('tag-inserted');
                    }, 500);
                }
            });

            // Add drag and drop to email subject input if it exists
            if (emailSubjectInput) {
                emailSubjectInput.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    emailSubjectInput.classList.add('drag-over');
                });

                emailSubjectInput.addEventListener('dragleave', () => {
                    emailSubjectInput.classList.remove('drag-over');
                });

                emailSubjectInput.addEventListener('drop', (e) => {
                    e.preventDefault();
                    emailSubjectInput.classList.remove('drag-over');
                    
                    const tagData = e.dataTransfer.getData('text/plain');
                    if (tagData) {
                        const cursorPos = emailSubjectInput.selectionStart;
                        const textBefore = emailSubjectInput.value.substring(0, cursorPos);
                        const textAfter = emailSubjectInput.value.substring(cursorPos);
                        
                        emailSubjectInput.value = textBefore + `{${tagData}}` + textAfter;
                        
                        // Position cursor after inserted tag
                        const newPos = cursorPos + tagData.length + 2;
                        emailSubjectInput.setSelectionRange(newPos, newPos);
                        emailSubjectInput.focus();
                        
                        // Visual feedback
                        emailSubjectInput.classList.add('tag-inserted');
                        setTimeout(() => {
                            emailSubjectInput.classList.remove('tag-inserted');
                        }, 500);
                    }
                });
            }
        }

        // Initialize draggable tags
        function initDragDropTags() {
            const container = document.getElementById('draggableTagsContainer');
            if (!container) return;

            // Use language-specific tags
            const currentLanguage = window.i18n?.currentLanguage || 'it';
            const isEnglish = currentLanguage === 'en';
            
            const tags = [
                { key: isEnglish ? 'NAME' : 'NOME', translationKey: 'tags.name', type: 'client', icon: '👤' },
                { key: isEnglish ? 'SURNAME' : 'COGNOME', translationKey: 'tags.surname', type: 'client', icon: '👤' },
                { key: 'COMPANY_NAME', translationKey: 'tags.company_name', type: 'client', icon: '🏢' },
                { key: 'EMAIL', translationKey: 'tags.email', type: 'contact', icon: '📧' },
                { key: isEnglish ? 'PHONE' : 'TELEFONO', translationKey: 'tags.phone', type: 'contact', icon: '📱' },
                { key: isEnglish ? 'VEHICLE' : 'VEICOLO', translationKey: 'tags.vehicle', type: 'vehicle', icon: '🚗' },
                { key: isEnglish ? 'PLATE' : 'TARGA', translationKey: 'tags.plate', type: 'vehicle', icon: '🏷️' },
                { key: isEnglish ? 'YEAR' : 'ANNO', translationKey: 'tags.year', type: 'technical', icon: '📅' },
                { key: isEnglish ? 'FUEL' : 'CARBURANTE', translationKey: 'tags.fuel', type: 'technical', icon: '⛽' },
                { key: 'KM', translationKey: 'tags.km', type: 'technical', icon: '📏' },
                { key: 'VIN', translationKey: 'tags.vin', type: 'technical', icon: '🔢' },
                { key: 'SERIAL', translationKey: 'tags.serial', type: 'technical', icon: '🏷️' }
            ];

            container.innerHTML = tags.map(tag => `
                <div class="draggable-tag" 
                     data-type="${tag.type}" 
                     data-key="${tag.key}"
                     data-i18n="${tag.translationKey}"
                     draggable="true">
                    <span class="tag-icon">${tag.icon}</span>
                    <span>${window.i18n ? window.i18n.t(tag.translationKey) : tag.translationKey}</span>
                </div>
            `).join('');

            // Add drag event listeners
            container.querySelectorAll('.draggable-tag').forEach(tag => {
                tag.addEventListener('dragstart', handleDragStart);
                tag.addEventListener('dragend', handleDragEnd);
            });

            // Store tags data for language updates
            window.draggableTagsData = tags;

            // Make textarea a drop zone
            const textarea = document.getElementById('manualMessageInput');
            if (textarea) {
                textarea.addEventListener('dragover', handleDragOver);
                textarea.addEventListener('drop', handleDrop);
                textarea.addEventListener('dragenter', handleDragEnter);
                textarea.addEventListener('dragleave', handleDragLeave);
                
                // Update preview on input
                textarea.addEventListener('input', () => {
                    updateManualMessagePreview();
                });
            }
            
            // Add listener for email subject input to update preview
            const emailSubjectInput = document.getElementById('emailSubjectInputNoAI');
            if (emailSubjectInput) {
                emailSubjectInput.addEventListener('input', () => {
                    updateManualMessagePreview();
                });
            }
        }

        // Drag and drop handlers
        let draggedTag = null;

        function handleDragStart(e) {
            draggedTag = e.target;
            e.target.classList.add('dragging');
            e.dataTransfer.setData('text/plain', `{${e.target.dataset.key}}`);
        }

        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
            draggedTag = null;
        }

        function handleDragOver(e) {
            e.preventDefault();
        }

        function handleDragEnter(e) {
            e.preventDefault();
            e.target.classList.add('drop-zone-active');
        }

        function handleDragLeave(e) {
            e.target.classList.remove('drop-zone-active');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.target.classList.remove('drop-zone-active');
            
            const tagText = e.dataTransfer.getData('text/plain');
            const textarea = e.target;
            
            // Insert at cursor position
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const text = textarea.value;
            
            textarea.value = text.substring(0, start) + tagText + text.substring(end);
            textarea.setSelectionRange(start + tagText.length, start + tagText.length);
            
            // Trigger animation
            textarea.classList.add('tag-inserted');
            setTimeout(() => textarea.classList.remove('tag-inserted'), 500);
            
            // Update preview
            updateManualMessagePreview();
            
            // Focus back to textarea
            textarea.focus();
        }

        // Update draggable tags when language changes
        function updateDraggableTags() {
            const container = document.getElementById('draggableTagsContainer');
            if (!container || !window.draggableTagsData) return;

            window.draggableTagsData.forEach(tag => {
                const tagElement = container.querySelector(`[data-key="${tag.key}"]`);
                if (tagElement) {
                    const labelSpan = tagElement.querySelector('span:not(.tag-icon)');
                    if (labelSpan && window.i18n) {
                        labelSpan.textContent = window.i18n.t(tag.translationKey);
                    }
                }
            });
        }

        // Expose function globally for i18n system
        window.updateDraggableTags = updateDraggableTags;

        // Initialize channel toggle for No AI dialog
        function initChannelToggleNoAI() {
            const toggleGroup = document.getElementById('channelToggleGroupNoAI');
            const emailSubjectField = document.getElementById('emailSubjectFieldNoAI');
            
            if (!toggleGroup) return;

            toggleGroup.addEventListener('click', (e) => {
                if (e.target.dataset.value) {
                    // Remove active class from all buttons
                    toggleGroup.querySelectorAll('button').forEach(btn => {
                        btn.classList.remove('active-chip', 'border-emerald-500', 'bg-emerald-600', 'text-white');
                        btn.classList.add('border-gray-600');
                    });
                    
                    // Add active class to clicked button
                    e.target.classList.add('active-chip', 'border-emerald-500', 'bg-emerald-600', 'text-white');
                    e.target.classList.remove('border-gray-600');
                    
                    // Show/hide email subject field
                    if (e.target.dataset.value === 'email') {
                        emailSubjectField?.classList.remove('hidden');
                    } else {
                        emailSubjectField?.classList.add('hidden');
                    }
                    
                    // Update preview when channel changes
                    updateManualMessagePreview();
                    
                    // Refresh templates for new channel
                    populateTemplateDropdown('templateSelectorNoAI', 'manual', e.target.dataset.value);
                }
            });

            // Set email as default
            const emailBtn = toggleGroup.querySelector('[data-value="email"]');
            if (emailBtn) {
                emailBtn.click();
            }
        }

        // Update message preview with sample data or selected test client data
        async function updateManualMessagePreview() {
            const message = document.getElementById('manualMessageInput').value;
            const preview = document.getElementById('manualMessagePreview');
            
            if (!message.trim()) {
                preview.innerHTML = `<div class="text-gray-500 text-sm">${window.i18n ? window.i18n.t('manual_contact.preview_placeholder') : 'L\'anteprima apparirà qui...'}</div>`;
                return;
            }

            // Use language-specific tag keys
            const currentLanguage = window.i18n?.currentLanguage || 'it';
            const isEnglish = currentLanguage === 'en';
            
            // Helper function to generate salutation (same logic as server)
            const buildSalutation = (fullName, language = 'it') => {
                const firstName = (fullName || '').trim().split(/\s+/)[0] || '';
                if (language === 'it') {
                    if (!firstName) {
                        return 'Gentile Cliente';
                    }
                    const isFemale = isLikelyFemale(firstName);
                    return `Gentile ${firstName}`;
                }
                // English
                return firstName ? `Dear ${firstName}` : 'Dear Customer';
            };

            const isLikelyFemale = (firstName) => {
                const name = firstName.toLowerCase();
                // Lista di nomi femminili comuni
                const femaleNames = ['anna', 'maria', 'giulia', 'francesca', 'sara', 'laura', 'elena', 'chiara', 'valentina', 'alessandra', 'monica', 'paola', 'barbara', 'roberta', 'simona', 'daniela', 'claudia', 'silvia', 'federica', 'elisa'];
                // Lista di nomi maschili che finiscono con 'a'
                const maleNamesEndingA = ['luca', 'andrea', 'mattia', 'nicola', 'simone', 'gabriele', 'michele', 'daniele'];
                
                if (femaleNames.includes(name)) return true;
                if (maleNamesEndingA.includes(name)) return false;
                
                // Fallback: euristica finale 'a'
                return name.endsWith('a');
            };

            let sampleData = {
                // Salutation tag (the missing piece!)
                'SALUTATION': buildSalutation(isEnglish ? 'John Smith' : 'Mario Rossi', currentLanguage),
                // Italian and English tags
                'NOME': window.i18n ? window.i18n.t('manual_contact.sample.name') : 'Mario',
                'NAME': window.i18n ? window.i18n.t('manual_contact.sample.name') : 'John',
                'COGNOME': window.i18n ? window.i18n.t('manual_contact.sample.surname') : 'Rossi',
                'SURNAME': window.i18n ? window.i18n.t('manual_contact.sample.surname') : 'Smith',
                'COMPANY_NAME': window.i18n ? window.i18n.t('manual_contact.sample.company') : (isEnglish ? 'Example Company Ltd.' : 'Azienda Esempio S.r.l.'),
                'EMAIL': window.i18n ? window.i18n.t('manual_contact.sample.email') : (isEnglish ? 'john.smith@email.com' : 'mario.rossi@email.com'),
                'TELEFONO': window.i18n ? window.i18n.t('manual_contact.sample.phone') : '+39 123 456 7890',
                'PHONE': window.i18n ? window.i18n.t('manual_contact.sample.phone') : '+1 234 567 8900',
                'VEICOLO': window.i18n ? window.i18n.t('manual_contact.sample.vehicle') : 'Fiat Panda',
                'VEHICLE': window.i18n ? window.i18n.t('manual_contact.sample.vehicle') : 'Ford Focus',
                'TARGA': window.i18n ? window.i18n.t('manual_contact.sample.plate') : 'AB123CD',
                'PLATE': window.i18n ? window.i18n.t('manual_contact.sample.plate') : 'ABC123',
                'ANNO': window.i18n ? window.i18n.t('manual_contact.sample.year') : '2020',
                'YEAR': window.i18n ? window.i18n.t('manual_contact.sample.year') : '2020',
                'CARBURANTE': window.i18n ? window.i18n.t('manual_contact.sample.fuel') : 'Benzina',
                'FUEL': window.i18n ? window.i18n.t('manual_contact.sample.fuel') : 'Gasoline',
                'KM': window.i18n ? window.i18n.t('manual_contact.sample.km') : '45.000',
                'VIN': window.i18n ? window.i18n.t('manual_contact.sample.vin') : 'WVWZZZ1JZ3W123456',
                'SERIAL': window.i18n ? window.i18n.t('manual_contact.sample.serial') : 'SN123456789',
                'CTA_TAGLIANDO': 'Prenota il tuo tagliando su: https://mobisat.com/tagliando'
            };

            // Check if a specific test client is selected
            const testClientSelect = document.getElementById('testClientSelectNoAI');
            if (testClientSelect && testClientSelect.value !== 'sample') {
                try {
                    const dealerId = getCurrentDealerId();
                    const r = await fetch(`/api/communications/test-clients/${dealerId}`).then(r=>r.json());
                    const testClients = r?.data || [];
                    const selectedClient = testClients.find(c => c.id === testClientSelect.value);
                    
                    if (selectedClient) {
                        const clientFullName = `${selectedClient.first_name || ''} ${selectedClient.last_name || ''}`.trim();
                        sampleData = {
                            // Salutation for selected test client
                            'SALUTATION': buildSalutation(clientFullName, currentLanguage),
                            'NOME': selectedClient.first_name || (window.i18n ? window.i18n.t('manual_contact.sample.client_name') : 'Nome'),
                            'COGNOME': selectedClient.last_name || (window.i18n ? window.i18n.t('manual_contact.sample.client_surname') : 'Cognome'),
                            'COMPANY_NAME': selectedClient.company || (window.i18n ? window.i18n.t('manual_contact.sample.client_company') : 'Azienda Cliente'),
                            'EMAIL': selectedClient.email || (window.i18n ? window.i18n.t('manual_contact.sample.client_email') : 'email@esempio.com'),
                            'TELEFONO': selectedClient.phone || (window.i18n ? window.i18n.t('manual_contact.sample.client_phone') : '+39 000 000 0000'),
                            'VEICOLO': [selectedClient.vehicle_brand, selectedClient.vehicle_model].filter(Boolean).join(' ') || (window.i18n ? window.i18n.t('manual_contact.sample.client_vehicle') : 'Veicolo'),
                            'TARGA': selectedClient.plate || (window.i18n ? window.i18n.t('manual_contact.sample.client_plate') : 'XX000XX'),
                            'ANNO': selectedClient.year || '2020',
                            'CARBURANTE': selectedClient.fuel_type || (window.i18n ? window.i18n.t('manual_contact.sample.client_fuel') : 'Benzina'),
                            'KM': selectedClient.odometer ? selectedClient.odometer.toLocaleString() : '0',
                            'VIN': selectedClient.vin || 'WVWZZZ1JZ3W123456',
                            'SERIAL': selectedClient.serial || 'SN123456789',
                            'CTA_TAGLIANDO': 'Prenota il tuo tagliando su: https://mobisat.com/tagliando'
                        };
                    }
                } catch (error) {
                    console.error('Error loading test client data:', error);
                }
            }

            // Get email subject and process it too
            const emailSubject = document.getElementById('emailSubjectInputNoAI').value || '';
            const isEmailChannel = document.querySelector('#channelToggleGroupNoAI .active-chip')?.dataset.value === 'email';
            
            let previewText = message;
            let previewSubject = emailSubject;
            
            // Replace tags in both message and subject
            Object.keys(sampleData).forEach(key => {
                const regex = new RegExp(`\\{${key}\\}`, 'g');
                const replacement = `<span class="bg-emerald-600 text-white px-1 rounded text-xs">${sampleData[key]}</span>`;
                previewText = previewText.replace(regex, replacement);
                previewSubject = previewSubject.replace(regex, replacement);
            });

            // Build preview HTML with subject (if email) and message
            let previewHTML = '';
            if (isEmailChannel && previewSubject.trim()) {
                previewHTML += `<div class="text-xs text-gray-400 mb-2">Oggetto:</div>`;
                previewHTML += `<div class="text-sm font-semibold mb-3 pb-2 border-b border-gray-600">${previewSubject}</div>`;
            }
            previewHTML += `<div class="text-sm">${previewText.replace(/\n/g, '<br>')}</div>`;

            preview.innerHTML = previewHTML;
        }

        // Toggle test clients button visibility
        function toggleTestClientsButton() {
            const checkbox = document.getElementById('sendToTestClientsNoAI');
            const button = document.getElementById('sendToTestClientsBtn');
            
            if (checkbox && button) {
                if (checkbox.checked) {
                    button.classList.remove('hidden');
                } else {
                    button.classList.add('hidden');
                }
            }
        }

        // Update selected count in button text
        function updateSelectedCountInButton() {
            const selectedCerts = getSelectedCertificates();
            const button = document.getElementById('sendToSelectedBtn');
            
            if (button) {
                const baseText = window.i18n ? window.i18n.t('manual_contact.send_to_selected') : 'Invia ai Selezionati';
                const count = selectedCerts.length;
                
                if (count > 0) {
                    button.textContent = `${baseText} (${count})`;
                    // Store the counter in a data attribute to prevent translation overwrites
                    button.setAttribute('data-has-counter', 'true');
                    button.setAttribute('data-counter-value', count);
                } else {
                    button.textContent = baseText;
                    button.removeAttribute('data-has-counter');
                    button.removeAttribute('data-counter-value');
                }
            }
        }

        // Custom dialog functions for manual communication
        function showManualContactError(message) {
            const title = window.i18n ? window.i18n.t('manual_contact.dialog.error_title') : 'Errore';
            return window.customDialog.alert(title, message, 'OK');
        }

        function showManualContactSuccess(message) {
            const title = window.i18n ? window.i18n.t('manual_contact.dialog.success_title') : 'Successo';
            return window.customDialog.alert(title, message, 'OK');
        }

        function showManualContactValidation(message) {
            const title = window.i18n ? window.i18n.t('manual_contact.dialog.validation_title') : 'Attenzione';
            return window.customDialog.alert(title, message, 'OK');
        }

        // Send to test clients
        async function sendToTestClients() {
            const channel = document.querySelector('#channelToggleGroupNoAI .active-chip')?.dataset.value || 'email';
            const message = document.getElementById('manualMessageInput').value.trim();
            const subject = document.getElementById('emailSubjectInputNoAI').value.trim();
            
            // Validation
            if (!message) {
                await showManualContactValidation(window.i18n ? window.i18n.t('manual_contact.error.enter_message') : 'Inserisci un messaggio');
                return;
            }
            
            if (channel === 'email' && !subject) {
                await showManualContactValidation(window.i18n ? window.i18n.t('manual_contact.error.email_subject_required') : 'L\'oggetto email è obbligatorio');
                document.getElementById('emailSubjectInputNoAI').focus();
                return;
            }

            try {
                const dealerId = getCurrentDealerId();
                
                // Get test clients count for confirmation
                const testClientsResponse = await fetch(`/api/communications/test-clients/${dealerId}`);
                const testClientsData = await testClientsResponse.json();
                const testClients = testClientsData.data || [];
                
                if (testClients.length === 0) {
                    await showManualContactValidation('Nessun cliente test trovato per questo dealer.');
                    return;
                }
                
                // Calculate cost
                const costPerMessage = channel === 'email' ? 5 : 10; // in cents
                const totalCost = testClients.length * costPerMessage;
                const costEuro = (totalCost / 100).toLocaleString('it-IT', {style: 'currency', currency: 'EUR'});
                
                // Show confirmation dialog
                const confirmMessage = channel === 'email' 
                    ? window.i18n ? window.i18n.t('manual_contact.confirm_send_email', { count: testClients.length, cost: costEuro }) : `Stai per inviare ${testClients.length} email al costo di ${costEuro}. Sei sicuro di voler procedere?`
                    : window.i18n ? window.i18n.t('manual_contact.confirm_send_whatsapp', { count: testClients.length, cost: costEuro }) : `Stai per inviare ${testClients.length} WhatsApp al costo di ${costEuro}. Sei sicuro di voler procedere?`;
                
                const confirmed = await window.customDialog.confirm(
                    'Conferma Invio',
                    confirmMessage,
                    'Invia',
                    'Annulla'
                );
                
                if (!confirmed) return;

                await sendManualCommunication(true); // true = send to test clients
                
            } catch (error) {
                console.error('Error sending to test clients:', error);
                await showManualContactError(window.i18n ? window.i18n.t('manual_contact.error_sending', { error: error.message }) : `Errore nell'invio: ${error.message}`);
            }
        }

        // Send to selected certificates
        async function sendToSelected() {
            const channel = document.querySelector('#channelToggleGroupNoAI .active-chip')?.dataset.value || 'email';
            const message = document.getElementById('manualMessageInput').value.trim();
            const subject = document.getElementById('emailSubjectInputNoAI').value.trim();
            
            // Validation
            if (!message) {
                await showManualContactValidation(window.i18n ? window.i18n.t('manual_contact.error.enter_message') : 'Inserisci un messaggio');
                return;
            }
            
            if (channel === 'email' && !subject) {
                await showManualContactValidation(window.i18n ? window.i18n.t('manual_contact.error.email_subject_required') : 'L\'oggetto email è obbligatorio');
                document.getElementById('emailSubjectInputNoAI').focus();
                return;
            }

            // Get selected certificates count
            const selectedCerts = getSelectedCertificates();
            if (selectedCerts.length === 0) {
                await showManualContactValidation('Seleziona almeno un certificato per inviare la comunicazione.');
                return;
            }

            // Calculate cost
            const costPerMessage = channel === 'email' ? 5 : 10; // in cents
            const totalCost = selectedCerts.length * costPerMessage;
            const costEuro = (totalCost / 100).toLocaleString('it-IT', {style: 'currency', currency: 'EUR'});
            
            // Show confirmation dialog
            const confirmMessage = channel === 'email' 
                ? window.i18n ? window.i18n.t('manual_contact.confirm_send_email', { count: selectedCerts.length, cost: costEuro }) : `Stai per inviare ${selectedCerts.length} email al costo di ${costEuro}. Sei sicuro di voler procedere?`
                : window.i18n ? window.i18n.t('manual_contact.confirm_send_whatsapp', { count: selectedCerts.length, cost: costEuro }) : `Stai per inviare ${selectedCerts.length} WhatsApp al costo di ${costEuro}. Sei sicuro di voler procedere?`;
            
            const confirmed = await window.customDialog.confirm(
                'Conferma Invio',
                confirmMessage,
                'Invia',
                'Annulla'
            );
            
            if (!confirmed) return;

            try {
                await sendManualCommunication(false); // false = send to selected
            } catch (error) {
                console.error('Error sending to selected:', error);
                await showManualContactError(window.i18n ? window.i18n.t('manual_contact.error_sending', { error: error.message }) : `Errore nell'invio: ${error.message}`);
            }
        }

        // Shared function to send manual communication
        async function sendManualCommunication(sendToTest = false) {
            const channel = document.querySelector('#channelToggleGroupNoAI .active-chip')?.dataset.value || 'email';
            const message = document.getElementById('manualMessageInput').value.trim();
            const subject = document.getElementById('emailSubjectInputNoAI').value.trim();
            const dealerId = getCurrentDealerId();
            
            // Get dealer signature
            let dealerSignatureText = '';
            const sigSelect = document.getElementById('dealerSignatureSelectNoAI');
            if (sigSelect && sigSelect.value !== 'none') {
                try {
                    const sig = JSON.parse(decodeURIComponent(sigSelect.value));
                    dealerSignatureText = `${sig.company_name||''}${sig.address1? `\n${sig.address1}`:''}${sig.postcode||sig.city? `\n${[sig.postcode||'', sig.city||''].filter(Boolean).join(' ')}`:''}${sig.phone? `\nTel: ${sig.phone}`:''}${sig.email? `\nEmail: ${sig.email}`:''}`.trim();
                } catch {}
            }

            // Build recipients list
            let recipients = [];
            if (sendToTest) {
                const testClients = await fetch(`/api/communications/test-clients/${dealerId}`).then(r=>r.json()).then(j=> j.data||[]);
                recipients = testClients.map(c => ({
                    name: [c.first_name, c.last_name].filter(Boolean).join(' ').trim(),
                    firstName: c.first_name || '',
                    lastName: c.last_name || '',
                    companyName: c.company || '',
                    email: c.email?.toLowerCase() || '',
                    phone: c.phone || '',
                    vehicle: [c.vehicle_brand, c.vehicle_model].filter(Boolean).join(' '),
                    plate: c.plate || '',
                    year: c.year || '',
                    fuel: c.fuel_type || '',
                    km: c.odometer || '',
                    vin: c.vin || '',
                    serial: c.serial || ''
                }));
            } else {
                const selectedCerts = getSelectedCertificates();
                console.log('🔍 DEBUG MANUAL2: selectedCerts sample:', selectedCerts[0]);
                console.log('🔍 DEBUG MANUAL2: Available keys:', Object.keys(selectedCerts[0] || {}));
                
                recipients = selectedCerts.map(cert => {
                    console.log('🔍 DEBUG MANUAL2: Processing cert:', {
                        id: cert.id,
                        brand_flat: cert.brand,
                        brand_nested: cert.vehicle?.brand,
                        model_flat: cert.model,
                        model_nested: cert.vehicle?.model,
                        license_plate: cert.license_plate,
                        plate_nested: cert.vehicle?.plate,
                        year: cert.year,
                        year_nested: cert.vehicle?.year,
                        fuel_type: cert.fuel_type,
                        fuel_nested: cert.vehicle?.fuelType,
                        odometer: cert.odometer
                    });
                    
                    // Use nested data first, then fallback to flat
                    const brand = cert.vehicle?.brand || cert.brand || '';
                    const model = cert.vehicle?.model || cert.model || '';
                    const plate = cert.vehicle?.plate || cert.license_plate || '';
                    const year = cert.vehicle?.year || cert.year || '';
                    const fuel = cert.vehicle?.fuelType || cert.fuel_type || '';
                    
                    // Debug: Log client data structure
                    console.log('🔍 DEBUG MANUAL3: cert.client structure:', cert.client);
                    console.log('🔍 DEBUG MANUAL3: cert.clientName:', cert.clientName);
                    console.log('🔍 DEBUG MANUAL3: cert.clientEmail:', cert.clientEmail);
                    
                    // Try different ways to get the client name
                    const clientName = cert.clientName || 
                                     `${cert.client?.firstName || ''} ${cert.client?.lastName || ''}`.trim() ||
                                     cert.client?.name || '';
                    
                    console.log('🔍 DEBUG MANUAL3: Final clientName:', clientName);
                    
                    return {
                        name: clientName,
                        firstName: cert.client?.firstName || cert.clientName?.split(' ')[0] || '',
                        lastName: cert.client?.lastName || cert.clientName?.split(' ').slice(1).join(' ') || '',
                        companyName: cert.client?.company || '',
                        email: cert.client?.email?.toLowerCase() || cert.clientEmail?.toLowerCase() || '',
                        phone: cert.client?.phone || cert.clientPhone || '',
                        vehicle: `${brand} ${model}`.trim(),
                        plate: plate,
                        year: year,
                        fuel: fuel,
                        km: cert.odometer || '',
                        vin: cert.vin || '',
                        serial: cert.serial || ''
                    };
                });
                
                console.log('🔍 DEBUG MANUAL2: Final recipients sample:', recipients[0]);
            }

            // Send manual communication
            const currentLanguage = window.i18n?.currentLanguage || 'it';
            const response = await fetch('/api/communications/send-manual', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    dealerId,
                    channel,
                    subject: channel === 'email' ? subject : undefined,
                    message,
                    signature: dealerSignatureText,
                    recipients,
                    language: currentLanguage
                })
            });

            if (!response.ok) {
                throw new Error(await response.text());
            }

            const result = await response.json();
            
            // Update credit display dynamically
            if (result.newBalance !== undefined) {
                const balanceElement = document.getElementById('dealerBalanceTextNoAI');
                
                if (balanceElement) {
                    const currentLanguage = window.i18n?.currentLanguage || 'it';
                    const locale = currentLanguage === 'it' ? 'it-IT' : 'en-US';
                    const newBalanceEuro = (result.newBalance / 100).toLocaleString(locale, {style: 'currency', currency: 'EUR'});
                    
                    balanceElement.textContent = newBalanceEuro;
                } else {
                    console.error('💰 Balance element not found!');
                }
            } else {
                console.warn('💰 No newBalance in server response - fetching manually');
                // Fallback: fetch balance manually
                try {
                    const dealerId = getCurrentDealerId();
                    const balanceResponse = await fetch(`/api/billing/balance/${dealerId}`);
                    const balanceData = await balanceResponse.json();
                    
                    if (balanceData.balance_cents !== undefined) {
                        const balanceElement = document.getElementById('dealerBalanceTextNoAI');
                        if (balanceElement) {
                            const currentLanguage = window.i18n?.currentLanguage || 'it';
                            const locale = currentLanguage === 'it' ? 'it-IT' : 'en-US';
                            const newBalanceEuro = (balanceData.balance_cents / 100).toLocaleString(locale, {style: 'currency', currency: 'EUR'});
                            balanceElement.textContent = newBalanceEuro;
                            console.log('💰 Balance updated manually:', newBalanceEuro);
                        }
                    }
                } catch (e) {
                    console.warn('💰 Failed to fetch balance manually:', e);
                }
            }
            
            // Show success message with updated credit info
            const successMessage = window.i18n ? window.i18n.t('manual_contact.dialog.message_sent_success', { count: result.sent }) : `Messaggio inviato con successo a ${result.sent} destinatari!`;
            let fullMessage = successMessage;
            
            if (result.newBalance !== undefined) {
                const newBalanceEuro = (result.newBalance / 100).toLocaleString('it-IT', {style: 'currency', currency: 'EUR'});
                const creditMessage = window.i18n ? window.i18n.t('manual_contact.dialog.credit_updated', { credit: newBalanceEuro }) : `Il tuo credito è stato aggiornato a ${newBalanceEuro}`;
                fullMessage += `\n\n${creditMessage}`;
            }
            
            await showManualContactSuccess(fullMessage);
            
            // DON'T close the dialog - keep it open for more communications
            // closeBulkContactWithoutAIDialog();
        }

        // Show email subject field in AI dialog when email is selected
        function initChannelToggleAI() {
            const toggleGroup = document.getElementById('channelToggleGroup');
            const emailSubjectField = document.getElementById('emailSubjectField');
            
            if (!toggleGroup) return;

            toggleGroup.addEventListener('click', (e) => {
                if (e.target.dataset.value) {
                    // Show/hide email subject field
                    if (e.target.dataset.value === 'email') {
                        emailSubjectField?.classList.remove('hidden');
                    } else {
                        emailSubjectField?.classList.add('hidden');
                    }
                }
            });
        }

        // Initialize channel toggle for AI dialog on page load
        document.addEventListener('DOMContentLoaded', function() {
            // ... existing code ...
            initChannelToggleAI();
        });

        // ===== TEMPLATE MANAGEMENT FUNCTIONS =====

        // Load templates for dropdown
        async function loadTemplatesForDropdown(templateType = 'manual', channel = null) {
            try {
                const dealerId = getCurrentDealerId();
                if (!dealerId) return [];

                let url = `/api/templates/${dealerId}`;
                const params = new URLSearchParams();
                
                if (templateType === 'manual') {
                    params.append('type', 'manual,hybrid');
                } else if (templateType === 'ai') {
                    params.append('type', 'ai,hybrid');
                }
                
                if (channel) {
                    params.append('channel', channel);
                }

                if (params.toString()) {
                    url += '?' + params.toString();
                }

                const response = await fetch(url);
                if (!response.ok) throw new Error('Failed to load templates');
                
                const result = await response.json();
                return result.data || [];
            } catch (error) {
                console.error('Error loading templates:', error);
                return [];
            }
        }

        // Populate template dropdown
        async function populateTemplateDropdown(dropdownId, templateType, channel) {
            const dropdown = document.getElementById(dropdownId);
            if (!dropdown) return;

            try {
                const templates = await loadTemplatesForDropdown(templateType, channel);
                
                dropdown.innerHTML = '<option value="">-- Seleziona Template --</option>';
                
                templates.forEach(template => {
                    const channelIcon = template.channel === 'email' ? '📧' : template.channel === 'whatsapp' ? '💬' : '📱';
                    const styleText = template.style === 'formal' ? 'Formale' : template.style === 'informal' ? 'Informale' : 'Professionale';
                    const option = document.createElement('option');
                    option.value = template.id;
                    option.textContent = `${channelIcon} ${template.name} (${template.channel} - ${styleText})`;
                    dropdown.appendChild(option);
                });
            } catch (error) {
                console.error('Error populating template dropdown:', error);
            }
        }

        // Handle template selection for manual dialog
        async function onTemplateSelectedManual() {
            const dropdown = document.getElementById('templateSelectorNoAI');
            const templateId = dropdown.value;
            
            if (!templateId) return;

            try {
                // Get all templates and find the selected one
                const response = await fetch(`/api/templates/${getCurrentDealerId()}`);
                if (!response.ok) throw new Error('Failed to load template');
                
                const result = await response.json();
                const templates = result.data || [];
                const template = templates.find(t => t.id === templateId);
                
                if (!template) {
                    console.error('Template not found');
                    return;
                }

                // Apply template to form
                if (template.email_subject) {
                    document.getElementById('emailSubjectInputNoAI').value = template.email_subject;
                }
                
                document.getElementById('manualMessageInput').value = template.message_content;
                
                // Set channel if different
                if (template.channel) {
                    const channelButtons = document.querySelectorAll('#channelToggleGroupNoAI button');
                    channelButtons.forEach(btn => {
                        btn.classList.remove('active-chip', 'border-emerald-500', 'bg-emerald-600', 'text-white');
                        btn.classList.add('border-gray-600');
                        
                        if (btn.dataset.value === template.channel) {
                            btn.classList.add('active-chip', 'border-emerald-500', 'bg-emerald-600', 'text-white');
                            btn.classList.remove('border-gray-600');
                        }
                    });
                    
                    // Show/hide email subject field
                    const emailSubjectField = document.getElementById('emailSubjectFieldNoAI');
                    if (template.channel === 'email') {
                        emailSubjectField.classList.remove('hidden');
                    } else {
                        emailSubjectField.classList.add('hidden');
                    }
                }

                // Update preview
                updateManualMessagePreview();
                
                // Increment usage count
                fetch(`/api/templates/${templateId}/use`, { method: 'POST' }).catch(console.error);
                
            } catch (error) {
                console.error('Error applying template:', error);
                alert('Errore nel caricamento del template');
            }
        }

        // Handle template selection for AI dialog
        async function onTemplateSelectedAI() {
            const dropdown = document.getElementById('templateSelectorAI');
            const templateId = dropdown.value;
            
            if (!templateId) return;

            try {
                // Get all templates and find the selected one
                const response = await fetch(`/api/templates/${getCurrentDealerId()}`);
                if (!response.ok) throw new Error('Failed to load template');
                
                const result = await response.json();
                const templates = result.data || [];
                const template = templates.find(t => t.id === templateId);
                
                if (!template) {
                    console.error('Template not found');
                    return;
                }

                // Apply template to AI form
                if (template.prompt) {
                    document.getElementById('aiPromptInput').value = template.prompt;
                }
                
                // Apply email subject if present
                if (template.email_subject) {
                    document.getElementById('emailSubjectInput').value = template.email_subject;
                }
                
                // Set channel if different
                if (template.channel) {
                    const channelButtons = document.querySelectorAll('#channelToggleGroup button');
                    channelButtons.forEach(btn => {
                        btn.classList.remove('active-chip', 'border-emerald-500', 'bg-emerald-600/10');
                        btn.classList.add('border-gray-600');
                        
                        if (btn.dataset.value === template.channel) {
                            btn.classList.add('active-chip', 'border-emerald-500', 'bg-emerald-600/10');
                            btn.classList.remove('border-gray-600');
                        }
                    });
                }

                // Set style if different
                if (template.style) {
                    const styleButtons = document.querySelectorAll('#styleToggleGroup button');
                    styleButtons.forEach(btn => {
                        btn.classList.remove('active-chip', 'border-emerald-500', 'bg-emerald-600/10');
                        btn.classList.add('border-gray-600');
                        
                        if (btn.dataset.value === template.style) {
                            btn.classList.add('active-chip', 'border-emerald-500', 'bg-emerald-600/10');
                            btn.classList.remove('border-gray-600');
                        }
                    });
                }

                // If hybrid template, show content as example in results
                if (template.template_type === 'hybrid' && template.message_content) {
                    document.getElementById('aiResults').value = template.message_content;
                }
                
                // Increment usage count
                fetch(`/api/templates/${templateId}/use`, { method: 'POST' }).catch(console.error);
                
            } catch (error) {
                console.error('Error applying template:', error);
                alert('Errore nel caricamento del template');
            }
        }

        // Save template from manual dialog
        async function saveTemplateFromManual() {
            const channel = document.querySelector('#channelToggleGroupNoAI .active-chip')?.dataset.value;
            const subject = document.getElementById('emailSubjectInputNoAI').value;
            const message = document.getElementById('manualMessageInput').value;
            
            if (!channel) {
                alert('Seleziona prima un canale');
                return;
            }
            
            if (!message.trim()) {
                alert('Inserisci un messaggio prima di salvare');
                return;
            }

            const name = prompt('Nome del template:');
            if (!name) return;

            const description = prompt('Descrizione (opzionale):') || '';

            try {
                const dealerId = getCurrentDealerId();
                const templateData = {
                    dealer_id: dealerId,
                    name: name.trim(),
                    description: description.trim(),
                    channel: channel,
                    style: 'professional', // Default style for manual templates
                    template_type: 'manual',
                    prompt: null,
                    message_content: message.trim(),
                    email_subject: channel === 'email' ? subject.trim() : null
                };

                const response = await fetch('/api/templates', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(templateData)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Errore nel salvataggio');
                }

                alert('Template salvato con successo!');
                
                // Refresh template dropdown
                populateTemplateDropdown('templateSelectorNoAI', 'manual', channel);
                
            } catch (error) {
                console.error('Error saving template:', error);
                alert('Errore nel salvataggio del template: ' + error.message);
            }
        }

        // Save template from AI dialog
        async function saveTemplateFromAI() {
            const channel = document.querySelector('#channelToggleGroup .active-chip')?.dataset.value;
            const style = document.querySelector('#styleToggleGroup .active-chip')?.dataset.value;
            const promptText = document.getElementById('aiPromptInput').value;
            const content = document.getElementById('aiResults').value;
            
            if (!channel) {
                alert('Seleziona prima un canale');
                return;
            }
            
            if (!promptText.trim() && !content.trim()) {
                alert('Genera prima una comunicazione AI o inserisci un prompt');
                return;
            }

            const name = window.prompt('Nome del template:'); // Uso window.prompt esplicitamente
            if (!name) return;

            const description = window.prompt('Descrizione (opzionale):') || '';
            
            const templateType = window.prompt('Tipo template:\n1 = AI (solo prompt)\n2 = Manuale (solo contenuto)\n3 = Ibrido (entrambi)', '3');
            let type = 'hybrid';
            if (templateType === '1') type = 'ai';
            else if (templateType === '2') type = 'manual';

            try {
                const dealerId = getCurrentDealerId();
                const templateData = {
                    dealer_id: dealerId,
                    name: name.trim(),
                    description: description.trim(),
                    channel: channel,
                    style: style || 'professional',
                    template_type: type,
                    prompt: (type === 'ai' || type === 'hybrid') ? promptText.trim() : null,
                    message_content: (type === 'manual' || type === 'hybrid') ? content.trim() : '',
                    email_subject: null // Will be generated by AI
                };

                const response = await fetch('/api/templates', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(templateData)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Errore nel salvataggio');
                }

                alert('Template salvato con successo!');
                
                // Refresh template dropdown
                populateTemplateDropdown('templateSelectorAI', 'ai', channel);
                
            } catch (error) {
                console.error('Error saving template:', error);
                alert('Errore nel salvataggio del template: ' + error.message);
            }
        }
    </script>
</body>
</html> 
<!DOCTYPE html>
<html lang="it" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Impostazioni - Service Hub Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="icon" type="image/x-icon" href="/favicon/favicon.ico">
    <style>
        /* Collapsible sections */
        .collapsible-section {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            background: var(--bg-secondary);
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .collapsible-header {
            cursor: pointer;
            transition: all 0.2s ease;
            background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
            border-bottom: 1px solid transparent;
        }
        
        .collapsible-header:hover {
            background: linear-gradient(135deg, var(--bg-tertiary) 0%, var(--bg-secondary) 100%);
            transform: translateY(-1px);
        }
        
        .collapsible-header.active {
            border-bottom-color: var(--border-color);
            background: var(--bg-primary);
            box-shadow: 0 2px 8px rgba(0, 174, 93, 0.1);
        }
        
        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1), padding 0.3s ease;
            background: var(--bg-secondary);
        }
        
        .collapsible-content.active {
            max-height: 3000px;
            padding: 1.5rem;
        }
        
        .chevron-icon {
            transition: transform 0.3s ease;
        }
        
        .chevron-icon.rotated {
            transform: rotate(180deg);
        }
        
        /* Enhanced form styles */
        .form-section {
            background: var(--bg-primary);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            transition: all 0.2s ease;
        }
        
        .form-section:hover {
            border-color: rgba(0, 174, 93, 0.3);
        }
        
        .compact-form .form-input { 
            padding: 0.75rem !important; 
            min-height: 40px !important;
            border-radius: 8px;
            transition: all 0.2s ease;
        }
        
        .compact-form .form-input:focus {
            border-color: #00AE5D;
            box-shadow: 0 0 0 3px rgba(0, 174, 93, 0.1);
        }
        
        .compact-form .form-label { 
            margin-bottom: 0.5rem !important; 
            font-size: 0.875rem !important; 
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .compact-form .form-group { 
            margin-bottom: 1rem !important; 
        }
        
        /* Status indicators */
        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        
        .status-success {
            background: rgba(34, 197, 94, 0.1);
            color: rgb(34, 197, 94);
            border: 1px solid rgba(34, 197, 94, 0.2);
        }
        
        .status-error {
            background: rgba(239, 68, 68, 0.1);
            color: rgb(239, 68, 68);
            border: 1px solid rgba(239, 68, 68, 0.2);
        }
        
        /* Template cards */
        .template-card {
            transition: all 0.3s ease;
            border: 1px solid var(--border-color);
            background: var(--bg-primary);
            border-radius: 12px;
        }
        
        .template-card:hover {
            border-color: #00AE5D;
            box-shadow: 0 8px 25px rgba(0, 174, 93, 0.15);
            transform: translateY(-2px);
        }
        
        /* Section icons */
        .section-icon {
            width: 28px;
            height: 28px;
            flex-shrink: 0;
        }
        
        /* Quick actions */
        .quick-action {
            transition: all 0.2s ease;
            border: 1px solid rgba(0, 174, 93, 0.2);
            background: rgba(0, 174, 93, 0.05);
            border-radius: 8px;
        }
        
        .quick-action:hover {
            border-color: #00AE5D;
            background: rgba(0, 174, 93, 0.1);
            transform: translateY(-1px);
        }
        
        /* Gradient backgrounds */
        .gradient-bg {
            background: linear-gradient(135deg, 
                rgba(0, 174, 93, 0.1) 0%, 
                rgba(59, 130, 246, 0.1) 50%, 
                rgba(168, 85, 247, 0.1) 100%);
            border: 1px solid rgba(0, 174, 93, 0.2);
        }
        
        /* Button enhancements */
        .btn {
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        
        .btn:hover {
            transform: translateY(-1px);
        }
        
        .btn-primary {
            background: #00AE5D;
            box-shadow: 0 2px 4px rgba(0, 174, 93, 0.2);
        }
        
        .btn-primary:hover {
            background: #009951;
            box-shadow: 0 4px 8px rgba(0, 174, 93, 0.3);
        }
    </style>
    
    <script src="/js/auth-config.js"></script>
    <script src="/js/custom-dialog.js"></script>
</head>
<body class="min-h-screen theme-transition">
    <!-- Sidebar -->
    <div class="sidebar fixed left-0 top-0 h-full w-16 flex flex-col py-4 z-50">
        <div class="flex items-center justify-center mb-8">
            <img src="/images/greenbox-logo.png" alt="Service Hub" class="w-10 h-10 object-contain" onerror="this.style.display='none'; document.getElementById('logoFallback').style.display='flex'" id="sidebarLogo">
            <div class="w-10 h-10 bg-green-600 rounded-lg flex items-center justify-center text-white font-bold text-xs" style="display: none;" id="logoFallback">SH</div>
        </div>
        
        <nav class="flex-1 py-4">
            <div class="relative group">
                <button onclick="window.location.href='/'" class="sidebar-nav-item w-full p-3 flex justify-center rounded-lg transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                    </svg>
                </button>
                <div class="sidebar-tooltip absolute left-full ml-2 px-2 py-1 text-sm rounded opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none whitespace-nowrap z-60">Dashboard</div>
            </div>
            
            <div class="relative group mt-2">
                <button onclick="window.location.href='/certificates.html'" class="sidebar-nav-item w-full p-3 flex justify-center rounded-lg transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                </button>
                <div class="sidebar-tooltip absolute left-full ml-2 px-2 py-1 text-sm rounded opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none whitespace-nowrap z-60">Certificati</div>
            </div>

            <div class="relative group mt-2">
                <button onclick="window.location.href='/billing.html'" class="sidebar-nav-item w-full p-3 flex justify-center rounded-lg transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M5 6h14a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2zm4 10h.01M8 14h8" />
                    </svg>
                </button>
                <div class="sidebar-tooltip absolute left-full ml-2 px-2 py-1 text-sm rounded opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none whitespace-nowrap z-60">Billing</div>
            </div>
            
            <div class="relative group mt-2">
                <button class="sidebar-nav-item active w-full p-3 flex justify-center rounded-lg">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                </button>
                <div class="sidebar-tooltip absolute left-full ml-2 px-2 py-1 text-sm rounded opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none whitespace-nowrap z-60">Impostazioni</div>
            </div>
        </nav>
        
        <div class="relative group mt-auto">
            <button onclick="logout()" class="sidebar-nav-item w-full p-3 flex justify-center rounded-lg hover:bg-red-600 hover:text-white transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                </svg>
            </button>
            <div class="sidebar-tooltip absolute left-full ml-2 px-2 py-1 text-sm rounded opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none whitespace-nowrap z-60">Logout</div>
        </div>
    </div>

    <!-- Main content -->
    <div style="margin-left: 64px;">
        <!-- Header -->
        <header class="page-header px-6 py-4">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="page-title text-2xl font-bold bg-gradient-to-r from-green-600 to-blue-600 bg-clip-text text-transparent" data-en="‚öôÔ∏è Settings" data-it="‚öôÔ∏è Impostazioni">‚öôÔ∏è Impostazioni</h1>
                    <p class="page-subtitle text-sm opacity-70 mt-1" data-en="Configure your preferences and manage your templates" data-it="Configura le tue preferenze e gestisci i tuoi template">Configura le tue preferenze e gestisci i tuoi template</p>
                </div>
                <div class="flex items-center space-x-4 pr-4">
                    <img id="headerLogo" src="/images/header_logo_light_theme.png?v10" alt="Mobisat" class="h-8 w-auto object-contain">
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <div class="max-w-7xl mx-auto px-6 py-8">
            
            <!-- Quick Actions Bar -->
            <div class="mb-8 p-6 rounded-2xl gradient-bg">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <div class="p-3 rounded-full bg-gradient-to-r from-green-500 to-blue-500 shadow-lg">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                            </svg>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold text-gray-800 dark:text-gray-100" data-en="üöÄ Quick Actions" data-it="üöÄ Azioni Rapide">üöÄ Azioni Rapide</h3>
                            <p class="text-sm text-gray-600 dark:text-gray-300" data-en="Fast access to most used functions" data-it="Accesso veloce alle funzioni pi√π utilizzate">Accesso veloce alle funzioni pi√π utilizzate</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        <button onclick="toggleSection('preferences')" class="quick-action px-4 py-2 rounded-lg text-sm font-semibold transition-all" data-en="üé® Preferences" data-it="üé® Preferenze">
                            üé® Preferenze
                        </button>
                        <button onclick="toggleSection('communications')" class="quick-action px-4 py-2 rounded-lg text-sm font-semibold transition-all" data-en="üí¨ Communications" data-it="üí¨ Comunicazioni">
                            üí¨ Comunicazioni
                        </button>
                        <button onclick="toggleSection('templates')" class="quick-action px-4 py-2 rounded-lg text-sm font-semibold transition-all" data-en="üìã Templates" data-it="üìã Template">
                            üìã Template
                        </button>
                        <button onclick="toggleSection('dealer')" class="quick-action px-4 py-2 rounded-lg text-sm font-semibold transition-all" data-en="üè¢ Dealer" data-it="üè¢ Dealer">
                            üè¢ Dealer
                        </button>
                    </div>
                </div>
            </div>

            <div class="space-y-6">
                <!-- Preferenze Section -->
                <div class="collapsible-section" id="preferences-section">
                    <div class="collapsible-header p-6 flex items-center justify-between" onclick="toggleSection('preferences')">
                        <div class="flex items-center gap-4">
                            <div class="p-2 rounded-full bg-purple-100 dark:bg-purple-900">
                                <svg class="section-icon text-purple-600 dark:text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zM21 5a2 2 0 00-2-2h-4a2 2 0 00-2 2v12a4 4 0 004 4h4a2 2 0 002-2V5z"></path>
                                </svg>
                            </div>
                            <div>
                                <h2 class="text-xl font-bold" data-en="üé® Preferences" data-it="üé® Preferenze">üé® Preferenze</h2>
                                <p class="text-sm opacity-70" data-en="Language and interface theme" data-it="Lingua e tema dell'interfaccia">Lingua e tema dell'interfaccia</p>
                            </div>
                        </div>
                        <svg class="chevron-icon w-6 h-6 transition-transform text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </div>
                    <div class="collapsible-content" id="preferences-content">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <!-- Language -->
                            <div class="form-section p-6">
                                <div class="flex items-center gap-3 mb-4">
                                    <svg class="w-6 h-6 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129"></path>
                                    </svg>
                                    <h3 class="text-lg font-bold" data-en="Language" data-it="Lingua">Lingua</h3>
                                </div>
                                <p class="text-sm mb-6 opacity-70" data-en="Select the interface language" data-it="Seleziona la lingua dell'interfaccia">Seleziona la lingua dell'interfaccia</p>
                                <div class="flex gap-4">
                                    <button id="lang-it" onclick="changeLanguage('it')" class="btn-theme btn-theme-active px-6 py-3 rounded-lg transition-all flex-1 font-semibold">üáÆüáπ <span data-en="Italian" data-it="Italiano">Italiano</span></button>
                                    <button id="lang-en" onclick="changeLanguage('en')" class="btn-theme btn-theme-inactive px-6 py-3 rounded-lg transition-all flex-1 font-semibold">üá¨üáß <span data-en="English" data-it="Inglese">English</span></button>
                                </div>
                            </div>
                            
                            <!-- Theme -->
                            <div class="form-section p-6">
                                <div class="flex items-center gap-3 mb-4">
                                    <svg class="w-6 h-6 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>
                                    </svg>
                                    <h3 class="text-lg font-bold" data-en="Theme" data-it="Tema">Tema</h3>
                                </div>
                                <p class="text-sm mb-6 opacity-70" data-en="Choose the interface appearance" data-it="Scegli l'aspetto dell'interfaccia">Scegli l'aspetto dell'interfaccia</p>
                                <div class="flex gap-4">
                                    <button id="themeDark" onclick="setTheme('dark')" class="btn-theme btn-theme-active px-6 py-3 rounded-lg transition-all flex-1 font-semibold">üåô <span data-en="Dark" data-it="Scuro">Scuro</span></button>
                                    <button id="themeLight" onclick="setTheme('light')" class="btn-theme btn-theme-inactive px-6 py-3 rounded-lg transition-all flex-1 font-semibold">‚òÄÔ∏è <span data-en="Light" data-it="Chiaro">Chiaro</span></button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Comunicazioni Section -->
                <div class="collapsible-section" id="communications-section">
                    <div class="collapsible-header p-6 flex items-center justify-between" onclick="toggleSection('communications')">
                        <div class="flex items-center gap-4">
                            <div class="p-2 rounded-full bg-blue-100 dark:bg-blue-900">
                                <svg class="section-icon text-blue-600 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                                </svg>
                            </div>
                            <div>
                                <h2 class="text-xl font-bold" data-en="üí¨ Communications" data-it="üí¨ Comunicazioni">üí¨ Comunicazioni</h2>
                                <p class="text-sm opacity-70" data-en="Dealer signatures and test clients" data-it="Firme dealer e clienti di test">Firme dealer e clienti di test</p>
                            </div>
                        </div>
                        <svg class="chevron-icon w-6 h-6 transition-transform text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </div>
                    <div class="collapsible-content" id="communications-content">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- Firma Dealer -->
                            <div class="form-section p-6">
                                <div class="flex items-center gap-3 mb-4">
                                    <svg class="w-6 h-6 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path>
                                    </svg>
                                    <h3 class="text-lg font-bold" data-en="Dealer Signature" data-it="Firma Dealer">Firma Dealer</h3>
                                </div>
                                <form id="dealerSignatureForm" class="space-y-4 compact-form">
                                    <div class="form-group">
                                        <label class="form-label" for="sig_company_name" data-en="Dealer name" data-it="Nome concessionaria">Nome concessionaria</label>
                                        <input class="form-input" id="sig_company_name" required placeholder="" data-en-placeholder="Enter dealer name" data-it-placeholder="Inserisci nome concessionaria" />
                                    </div>
                                    <div class="grid grid-cols-2 gap-3">
                                        <div class="form-group">
                                            <label class="form-label" for="sig_address1" data-en="Address 1" data-it="Indirizzo 1">Indirizzo 1</label>
                                            <input class="form-input" id="sig_address1" placeholder="" data-en-placeholder="Street address" data-it-placeholder="Via e numero" />
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label" for="sig_address2" data-en="Address 2" data-it="Indirizzo 2">Indirizzo 2</label>
                                            <input class="form-input" id="sig_address2" placeholder="" data-en-placeholder="Optional" data-it-placeholder="Opzionale" />
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-2 gap-3">
                                        <div class="form-group">
                                            <label class="form-label" for="sig_city" data-en="City" data-it="Citt√†">Citt√†</label>
                                            <input class="form-input" id="sig_city" placeholder="" data-en-placeholder="City name" data-it-placeholder="Nome citt√†" />
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label" for="sig_provincia" data-en="Province" data-it="Provincia">Provincia</label>
                                            <input class="form-input" id="sig_provincia" placeholder="" data-en-placeholder="Province code" data-it-placeholder="Sigla provincia" />
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-2 gap-3">
                                        <div class="form-group">
                                            <label class="form-label" for="sig_postcode" data-en="Postcode" data-it="CAP">CAP</label>
                                            <input class="form-input" id="sig_postcode" placeholder="" data-en-placeholder="Postal code" data-it-placeholder="Codice postale" />
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label" for="sig_phone" data-en="Phone" data-it="Telefono">Telefono</label>
                                            <input class="form-input" id="sig_phone" placeholder="" data-en-placeholder="+39 xxx xxx xxxx" data-it-placeholder="+39 xxx xxx xxxx" />
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label" for="sig_email" data-en="Email" data-it="Email">Email</label>
                                        <input class="form-input" id="sig_email" type="email" placeholder="" data-en-placeholder="email@example.com" data-it-placeholder="email@esempio.it" />
                                    </div>
                                    <div class="flex gap-2">
                                        <button type="button" id="saveSignatureBtn" class="btn btn-primary flex-1" data-en="Save" data-it="Salva">Salva</button>
                                        <button type="button" id="resetSignatureBtn" class="btn btn-secondary" data-en="Reset" data-it="Reset">Reset</button>
                                    </div>
                                </form>
                                <div class="mt-6">
                                    <h4 class="text-sm font-semibold mb-3" data-en="Saved signatures" data-it="Firme salvate">Firme salvate</h4>
                                    <div id="signaturesList" class="space-y-2"></div>
                                </div>
                            </div>

                            <!-- Clienti Test -->
                            <div class="form-section p-6">
                                <div class="flex items-center gap-3 mb-4">
                                    <svg class="w-6 h-6 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                    </svg>
                                    <h3 class="text-lg font-bold" data-en="Test Clients" data-it="Clienti Test">Clienti Test</h3>
                                </div>
                                <form id="testClientForm" class="space-y-4 compact-form">
                                    <!-- Client Data -->
                                    <h4 class="text-sm font-semibold text-gray-600 dark:text-gray-300 border-b pb-2" data-en="Client Data" data-it="Dati cliente">Dati cliente</h4>
                                    <div class="grid grid-cols-2 gap-3">
                                        <div class="form-group">
                                            <label class="form-label" for="tc_first_name" data-en="First name" data-it="Nome">Nome</label>
                                            <input class="form-input" id="tc_first_name" required placeholder="" data-en-placeholder="First name" data-it-placeholder="Nome" />
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label" for="tc_last_name" data-en="Last name" data-it="Cognome">Cognome</label>
                                            <input class="form-input" id="tc_last_name" required placeholder="" data-en-placeholder="Last name" data-it-placeholder="Cognome" />
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label" for="tc_company" data-en="Company" data-it="Societ√†">Societ√†</label>
                                        <input class="form-input" id="tc_company" placeholder="" data-en-placeholder="Company name (optional)" data-it-placeholder="Nome societ√† (opzionale)" />
                                    </div>
                                    <div class="grid grid-cols-2 gap-3">
                                        <div class="form-group">
                                            <label class="form-label" for="tc_address1" data-en="Address 1" data-it="Indirizzo 1">Indirizzo 1</label>
                                            <input class="form-input" id="tc_address1" placeholder="" data-en-placeholder="Street address" data-it-placeholder="Via e numero" />
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label" for="tc_address2" data-en="Address 2" data-it="Indirizzo 2">Indirizzo 2</label>
                                            <input class="form-input" id="tc_address2" placeholder="" data-en-placeholder="Optional" data-it-placeholder="Opzionale" />
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-3 gap-3">
                                        <div class="form-group">
                                            <label class="form-label" for="tc_city" data-en="City" data-it="Citt√†">Citt√†</label>
                                            <input class="form-input" id="tc_city" placeholder="" data-en-placeholder="City name" data-it-placeholder="Nome citt√†" />
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label" for="tc_provincia" data-en="Province" data-it="Provincia">Provincia</label>
                                            <input class="form-input" id="tc_provincia" placeholder="" data-en-placeholder="Province code" data-it-placeholder="Sigla provincia" />
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label" for="tc_postcode" data-en="Postcode" data-it="CAP">CAP</label>
                                            <input class="form-input" id="tc_postcode" placeholder="" data-en-placeholder="Postal code" data-it-placeholder="Codice postale" />
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-3 gap-3">
                                        <div class="form-group">
                                            <label class="form-label" for="tc_email" data-en="Email" data-it="Email">Email</label>
                                            <input class="form-input" id="tc_email" type="email" placeholder="" data-en-placeholder="email@example.com" data-it-placeholder="email@esempio.it" />
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label" for="tc_phone" data-en="Phone" data-it="Telefono">Telefono</label>
                                            <input class="form-input" id="tc_phone" placeholder="" data-en-placeholder="+39 xxx xxx xxxx" data-it-placeholder="+39 xxx xxx xxxx" />
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label" for="tc_country" data-en="Country" data-it="Paese">Paese</label>
                                            <select class="form-input" id="tc_country">
                                                <option value="">-</option>
                                                <option value="IT">Italia</option>
                                                <option value="US">USA</option>
                                                <option value="GB">UK</option>
                                                <option value="FR">Francia</option>
                                                <option value="DE">Germania</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <!-- Vehicle Data -->
                                    <h4 class="text-sm font-semibold text-gray-600 dark:text-gray-300 border-b pb-2 mt-6" data-en="Vehicle Data" data-it="Dati veicolo">Dati veicolo</h4>
                                    <div class="grid grid-cols-2 gap-3">
                                        <div class="form-group">
                                            <label class="form-label" for="tc_vehicle_brand" data-en="Brand" data-it="Marca">Marca</label>
                                            <input class="form-input" id="tc_vehicle_brand" placeholder="" data-en-placeholder="e.g. Toyota" data-it-placeholder="es. Toyota" />
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label" for="tc_vehicle_model" data-en="Model" data-it="Modello">Modello</label>
                                            <input class="form-input" id="tc_vehicle_model" placeholder="" data-en-placeholder="e.g. Corolla" data-it-placeholder="es. Corolla" />
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-2 gap-3">
                                        <div class="form-group">
                                            <label class="form-label" for="tc_plate" data-en="Plate" data-it="Targa">Targa</label>
                                            <input class="form-input" id="tc_plate" placeholder="" data-en-placeholder="AA123BB" data-it-placeholder="AA123BB" />
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label" for="tc_year" data-en="Year" data-it="Anno">Anno</label>
                                            <input class="form-input" id="tc_year" type="number" min="1900" max="2030" placeholder="" data-en-placeholder="2024" data-it-placeholder="2024" />
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-2 gap-3">
                                        <div class="form-group">
                                            <label class="form-label" for="tc_fuel_type" data-en="Fuel type" data-it="Alimentazione">Alimentazione</label>
                                            <input class="form-input" id="tc_fuel_type" placeholder="" data-en-placeholder="e.g. Petrol" data-it-placeholder="es. Benzina" />
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label" for="tc_odometer" data-en="Odometer (Km)" data-it="Odometro (Km)">Odometro (Km)</label>
                                            <input class="form-input" id="tc_odometer" type="number" min="0" placeholder="" data-en-placeholder="50000" data-it-placeholder="50000" />
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-2 gap-3">
                                        <div class="form-group">
                                            <label class="form-label" for="tc_vin" data-en="VIN" data-it="VIN">VIN</label>
                                            <input class="form-input" id="tc_vin" maxlength="17" placeholder="" data-en-placeholder="17 character VIN" data-it-placeholder="VIN 17 caratteri" />
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label" for="tc_serial" data-en="Serial" data-it="Seriale">Serial</label>
                                            <input class="form-input" id="tc_serial" placeholder="" data-en-placeholder="Serial number" data-it-placeholder="Numero seriale" />
                                        </div>
                                    </div>
                                    <div class="flex gap-2">
                                        <button type="button" id="saveTestClientBtn" class="btn btn-primary flex-1" data-en="Save" data-it="Salva">Salva</button>
                                        <button type="button" id="resetTestClientBtn" class="btn btn-secondary" data-en="Reset" data-it="Reset">Reset</button>
                                    </div>
                                </form>
                                <div class="mt-6">
                                    <h4 class="text-sm font-semibold mb-3" data-en="Saved test clients" data-it="Clienti test salvati">Clienti test salvati</h4>
                                    <div id="testClientsList" class="space-y-2"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Template Section -->
                <div class="collapsible-section" id="templates-section">
                    <div class="collapsible-header p-6 flex items-center justify-between" onclick="toggleSection('templates')">
                        <div class="flex items-center gap-4">
                            <div class="p-2 rounded-full bg-green-100 dark:bg-green-900">
                                <svg class="section-icon text-green-600 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                            </div>
                            <div>
                                <h2 class="text-xl font-bold" data-en="üìã Template Management" data-it="üìã Gestione Template">üìã Gestione Template</h2>
                                <p class="text-sm opacity-70" data-en="Create and manage communication templates" data-it="Crea e gestisci template di comunicazione">Crea e gestisci template di comunicazione</p>
                            </div>
                        </div>
                        <svg class="chevron-icon w-6 h-6 transition-transform text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </div>
                    <div class="collapsible-content" id="templates-content">
                        <!-- Template Creation Form -->
                        <div class="form-section p-6 mb-6">
                            <div class="flex items-center gap-3 mb-4">
                                <svg class="w-6 h-6 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                </svg>
                                <h3 class="text-lg font-bold" data-en="Create New Template" data-it="Crea Nuovo Template">Crea Nuovo Template</h3>
                            </div>
                            <form id="templateForm" class="space-y-4">
                                <!-- Row 1: Nome + Descrizione -->
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div class="form-group">
                                        <label class="form-label" for="tmpl_name" data-en="Template Name" data-it="Nome Template">Nome Template</label>
                                        <input class="form-input" id="tmpl_name" required maxlength="100" placeholder="" data-en-placeholder="e.g. Service Reminder" data-it-placeholder="es. Promemoria Tagliando" />
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label" for="tmpl_description" data-en="Description" data-it="Descrizione">Descrizione</label>
                                        <input class="form-input" id="tmpl_description" maxlength="255" placeholder="" data-en-placeholder="Brief description of template" data-it-placeholder="Breve descrizione del template" />
                                    </div>
                                </div>

                                <!-- Row 2: Canale + Stile + Tipo -->
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div class="form-group">
                                        <label class="form-label" for="tmpl_channel" data-en="Channel" data-it="Canale">Canale</label>
                                        <select class="form-input" id="tmpl_channel" required>
                                            <option value="" data-en="-- Select Channel --" data-it="-- Seleziona Canale --">-- Seleziona Canale --</option>
                                            <option value="email">üìß Email</option>
                                            <option value="whatsapp">üí¨ WhatsApp</option>
                                            <option value="sms">üì± SMS</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label" for="tmpl_style" data-en="Style" data-it="Stile">Stile</label>
                                        <select class="form-input" id="tmpl_style" required>
                                            <option value="" data-en="-- Select Style --" data-it="-- Seleziona Stile --">-- Seleziona Stile --</option>
                                            <option value="professional" data-en="Professional" data-it="Professionale">Professionale</option>
                                            <option value="formal" data-en="Formal" data-it="Formale">Formale</option>
                                            <option value="informal" data-en="Informal" data-it="Informale">Informale</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label" for="tmpl_type" data-en="Template Type" data-it="Tipo Template">Tipo Template</label>
                                        <select class="form-input" id="tmpl_type" required onchange="toggleTemplateFields()">
                                            <option value="" data-en="-- Select Type --" data-it="-- Seleziona Tipo --">-- Seleziona Tipo --</option>
                                            <option value="ai" data-en="AI (prompt only)" data-it="AI (solo prompt)">AI (solo prompt)</option>
                                            <option value="manual" data-en="Manual (content only)" data-it="Manuale (solo contenuto)">Manuale (solo contenuto)</option>
                                            <option value="hybrid" data-en="Hybrid (prompt + content)" data-it="Ibrido (prompt + contenuto)">Ibrido (prompt + contenuto)</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- Dynamic Fields -->
                                <div class="space-y-4">
                                    <!-- Oggetto Email -->
                                    <div class="form-group" id="emailSubjectGroup" style="display: none;">
                                        <label class="form-label" for="tmpl_email_subject" data-en="Email Subject" data-it="Oggetto Email">Oggetto Email</label>
                                        <input class="form-input" id="tmpl_email_subject" placeholder="" data-en-placeholder="e.g. Service Reminder - {VEHICLE} {PLATE}" data-it-placeholder="es. Promemoria Tagliando - {VEICOLO} {TARGA}" />
                                        <div class="text-xs text-gray-500 mt-1" data-en="Use placeholders like {NAME}, {VEHICLE}, {PLATE}, etc." data-it="Usa placeholder come {NOME}, {VEICOLO}, {TARGA}, ecc.">Usa placeholder come {NOME}, {VEICOLO}, {TARGA}, ecc.</div>
                                    </div>

                                    <!-- Prompt AI -->
                                    <div class="form-group" id="promptGroup" style="display: none;">
                                        <label class="form-label" for="tmpl_prompt" data-en="AI Prompt" data-it="Prompt AI">Prompt AI</label>
                                        <textarea class="form-input" id="tmpl_prompt" rows="3" placeholder="" data-en-placeholder="e.g. Write a professional service reminder for vehicle maintenance..." data-it-placeholder="es. Scrivi un promemoria professionale per il tagliando del veicolo..."></textarea>
                                        <div class="text-xs text-gray-500 mt-1" data-en="Instructions for the AI to generate the message content" data-it="Istruzioni per l'AI per generare il contenuto del messaggio">Istruzioni per l'AI per generare il contenuto del messaggio</div>
                                    </div>

                                    <!-- Contenuto Messaggio -->
                                    <div class="form-group" id="contentGroup" style="display: none;">
                                        <label class="form-label" for="tmpl_content" data-en="Message Content" data-it="Contenuto Messaggio">Contenuto Messaggio</label>
                                        <textarea class="form-input" id="tmpl_content" rows="6" placeholder="" data-en-placeholder="{SALUTATION},&#10;&#10;We are contacting you to remind you that your {VEHICLE} with plate {PLATE} has reached {KM} kilometers..." data-it-placeholder="{SALUTATION},&#10;&#10;La contattiamo per ricordarle che il suo {VEICOLO} con targa {TARGA} ha raggiunto {KM} chilometri..."></textarea>
                                        <div class="text-xs text-gray-500 mt-1" data-en="Message content with placeholders" data-it="Contenuto del messaggio con placeholder">Contenuto del messaggio con placeholder come {SALUTATION}, {NOME}, {VEICOLO}, ecc.</div>
                                    </div>
                                </div>

                                <!-- Preferito -->
                                <div class="form-group">
                                    <label class="flex items-center">
                                        <input type="checkbox" id="tmpl_favorite" class="mr-2" />
                                        <span class="text-sm" data-en="‚≠ê Mark as favorite" data-it="‚≠ê Segna come preferito">‚≠ê Segna come preferito</span>
                                    </label>
                                </div>

                                <!-- Buttons -->
                                <div class="flex gap-2">
                                    <button type="button" id="saveTemplateBtn" class="btn btn-primary" data-en="Save Template" data-it="Salva Template">Salva Template</button>
                                    <button type="button" id="resetTemplateBtn" class="btn btn-secondary" data-en="Reset" data-it="Reset">Reset</button>
                                    <button type="button" id="cancelEditBtn" class="btn btn-secondary" style="display: none;" data-en="Cancel Edit" data-it="Annulla Modifica" onclick="cancelTemplateEdit()">Annulla Modifica</button>
                                </div>
                            </form>
                        </div>

                        <!-- Templates List -->
                        <div class="form-section p-6">
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center gap-3">
                                    <svg class="w-6 h-6 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                                    </svg>
                                    <h3 class="text-lg font-bold" data-en="Saved Templates" data-it="Template Salvati">Template Salvati</h3>
                                </div>
                                <div class="flex items-center gap-2">
                                    <label class="text-sm" data-en="Filter by:" data-it="Filtra per:">Filtra per:</label>
                                    <select id="filterChannel" class="form-input text-sm py-1" onchange="refreshTemplates()">
                                        <option value="" data-en="All channels" data-it="Tutti i canali">Tutti i canali</option>
                                        <option value="email">üìß Email</option>
                                        <option value="whatsapp">üí¨ WhatsApp</option>
                                        <option value="sms">üì± SMS</option>
                                    </select>
                                    <select id="filterType" class="form-input text-sm py-1" onchange="refreshTemplates()">
                                        <option value="" data-en="All types" data-it="Tutti i tipi">Tutti i tipi</option>
                                        <option value="ai">AI</option>
                                        <option value="manual" data-en="Manual" data-it="Manuale">Manuale</option>
                                        <option value="hybrid" data-en="Hybrid" data-it="Ibrido">Ibrido</option>
                                    </select>
                                </div>
                            </div>
                            <div id="templatesList" class="space-y-3">
                                <div class="text-sm text-gray-400" data-en="Loading templates..." data-it="Caricamento template...">Caricamento template...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Dealer Section -->
                <div class="collapsible-section" id="dealer-section">
                    <div class="collapsible-header p-6 flex items-center justify-between" onclick="toggleSection('dealer')">
                        <div class="flex items-center gap-4">
                            <div class="p-2 rounded-full bg-indigo-100 dark:bg-indigo-900">
                                <svg class="section-icon text-indigo-600 dark:text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                                </svg>
                            </div>
                            <div>
                                <h2 class="text-xl font-bold" data-en="üè¢ Dealer Information" data-it="üè¢ Informazioni Dealer">üè¢ Informazioni Dealer</h2>
                                <p class="text-sm opacity-70" data-en="Your dealer account details" data-it="Dettagli del tuo account dealer">Dettagli del tuo account dealer</p>
                            </div>
                        </div>
                        <svg class="chevron-icon w-6 h-6 transition-transform text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </div>
                    <div class="collapsible-content" id="dealer-content">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <!-- Info Principali -->
                            <div class="form-section p-6 space-y-6">
                                <div class="text-center mb-6">
                                    <div class="w-16 h-16 rounded-full bg-gradient-to-r from-blue-500 to-purple-500 flex items-center justify-center text-white text-2xl font-bold mx-auto mb-3">
                                        üè¢
                                    </div>
                                    <h3 class="text-lg font-bold" data-en="Main Information" data-it="Informazioni Principali">Informazioni Principali</h3>
                                </div>
                                
                                <div class="space-y-4">
                                    <div class="flex items-center gap-4 p-3 rounded-lg bg-gray-50 dark:bg-gray-800">
                                        <svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                                        </svg>
                                        <div class="flex-1">
                                            <span class="text-sm text-gray-500" data-en="Dealer Name" data-it="Nome Concessionaria">Nome Concessionaria</span>
                                            <div class="font-semibold" id="dealerNameDisplay">-</div>
                                        </div>
                                    </div>
                                    
                                    <div class="flex items-center gap-4 p-3 rounded-lg bg-gray-50 dark:bg-gray-800">
                                        <svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 20l4-16m2 16l4-16M6 9h14M4 15h14"></path>
                                        </svg>
                                        <div class="flex-1">
                                            <span class="text-sm text-gray-500" data-en="Dealer ID" data-it="ID Dealer">ID Dealer</span>
                                            <div class="font-mono text-sm px-3 py-1 rounded-full bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 inline-block" id="dealerIdDisplay">-</div>
                                        </div>
                                    </div>
                                    
                                    <div class="flex items-center gap-4 p-3 rounded-lg bg-gray-50 dark:bg-gray-800">
                                        <svg class="w-5 h-5 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                                        </svg>
                                        <div class="flex-1">
                                            <span class="text-sm text-gray-500" data-en="Login Email" data-it="Email Login">Email Login</span>
                                            <div class="font-semibold" id="companyLoginEmail">-</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Stato Sistema -->
                            <div class="form-section p-6">
                                <div class="text-center mb-6">
                                    <div class="w-16 h-16 rounded-full bg-gradient-to-r from-green-500 to-teal-500 flex items-center justify-center text-white text-2xl font-bold mx-auto mb-3">
                                        ‚öôÔ∏è
                                    </div>
                                    <h3 class="text-lg font-bold" data-en="System Status" data-it="Stato Sistema">Stato Sistema</h3>
                                </div>
                                
                                <div class="space-y-4">
                                    <div class="p-4 rounded-lg bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20 border border-blue-200 dark:border-blue-800">
                                        <div class="flex items-center justify-between mb-2">
                                            <span class="font-semibold" data-en="System Version" data-it="Versione Sistema">Versione Sistema</span>
                                            <span class="text-xs px-2 py-1 rounded-full bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200">v1.0</span>
                                        </div>
                                        <p class="text-sm text-gray-600 dark:text-gray-400">Service Hub Portal</p>
                                    </div>
                                    
                                    <div class="space-y-3">
                                        <div class="flex items-center justify-between p-3 rounded-lg bg-gray-50 dark:bg-gray-800">
                                            <span class="text-sm font-medium" data-en="Main Database" data-it="Database Principale">Database Principale</span>
                                            <div class="status-indicator status-success" id="db1Status">
                                                <div class="w-2 h-2 rounded-full bg-green-500"></div>
                                                <span data-en="Connected" data-it="Connesso">Connesso</span>
                                            </div>
                                        </div>
                                        
                                        <div class="flex items-center justify-between p-3 rounded-lg bg-gray-50 dark:bg-gray-800">
                                            <span class="text-sm font-medium" data-en="Secondary Database" data-it="Database Secondario">Database Secondario</span>
                                            <div class="status-indicator status-success" id="db2Status">
                                                <div class="w-2 h-2 rounded-full bg-green-500"></div>
                                                <span data-en="Connected" data-it="Connesso">Connesso</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="/js/auth-guard.js"></script>
    <script src="/js/theme.js"></script>
    <script src="/js/i18n.js"></script>
    
    <script>
        // Collapsible sections management
        function toggleSection(sectionName) {
            const section = document.getElementById(`${sectionName}-section`);
            const content = document.getElementById(`${sectionName}-content`);
            const header = section.querySelector('.collapsible-header');
            const chevron = header.querySelector('.chevron-icon');
            
            const isActive = content.classList.contains('active');
            
            if (isActive) {
                // Close section
                content.classList.remove('active');
                header.classList.remove('active');
                chevron.classList.remove('rotated');
            } else {
                // Close all other sections first
                document.querySelectorAll('.collapsible-content.active').forEach(el => {
                    el.classList.remove('active');
                });
                document.querySelectorAll('.collapsible-header.active').forEach(el => {
                    el.classList.remove('active');
                });
                document.querySelectorAll('.chevron-icon.rotated').forEach(el => {
                    el.classList.remove('rotated');
                });
                
                // Open this section
                content.classList.add('active');
                header.classList.add('active');
                chevron.classList.add('rotated');
            }
        }

        // Logo switcher function
        function updateHeaderLogo() {
            const logo = document.getElementById('headerLogo');
            if (!logo) return;
            
            const isDark = document.documentElement.classList.contains('dark');
            logo.src = isDark ? '/images/header_logo_dark_theme.png?v10' : '/images/header_logo_light_theme.png?v10';
        }
        
        document.addEventListener('DOMContentLoaded', updateHeaderLogo);
        
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                    updateHeaderLogo();
                }
            });
        });
        
        observer.observe(document.documentElement, {
            attributes: true,
            attributeFilter: ['class']
        });

        // Load dealer information
        async function loadDealerInfo() {
            try {
                let dealerId = null;
                
                const servicehubUser = localStorage.getItem('servicehub-user');
                if (servicehubUser) {
                    try {
                        const parsed = JSON.parse(servicehubUser);
                        dealerId = parsed.id;
                    } catch (e) {}
                }
                
                if (!dealerId) {
                    const authData = localStorage.getItem('authData');
                    if (authData) {
                        try {
                            const parsed = JSON.parse(authData);
                            dealerId = parsed.dealerId;
                        } catch (e) {}
                    }
                }
                
                if (!dealerId) throw new Error('No dealerId found');
                
                const response = await fetch(`/api/dealer/${dealerId}`);
                const data = await response.json();
                
                if (data.success && data.dealer) {
                    const d = data.dealer;
                    document.getElementById('dealerIdDisplay').textContent = d.id ?? dealerId;
                    document.getElementById('dealerNameDisplay').textContent = d.companyName || '-';
                    document.getElementById('companyLoginEmail').textContent = d.companyLoginEmail || '-';
                }
                
            } catch (error) {
                console.error('Error loading dealer info:', error);
            }
        }

        async function updateDbStatus() {
            try {
                const res = await fetch('/status');
                const okHtml = `<div class="w-2 h-2 rounded-full bg-green-500"></div><span data-en="Connected" data-it="Connesso">Connesso</span>`;
                const db1 = document.getElementById('db1Status');
                const db2 = document.getElementById('db2Status');
                if (db1) {
                    db1.innerHTML = okHtml;
                    db1.className = 'status-indicator status-success';
                }
                if (db2) {
                    db2.innerHTML = okHtml;
                    db2.className = 'status-indicator status-success';
                }
                // Force update bilingual elements for the new content
                forceUpdateBilingualElements();
            } catch (_) {
                const errorHtml = `<div class="w-2 h-2 rounded-full bg-red-500"></div><span data-en="Error" data-it="Errore">Errore</span>`;
                const db1 = document.getElementById('db1Status');
                const db2 = document.getElementById('db2Status');
                if (db1) {
                    db1.innerHTML = errorHtml;
                    db1.className = 'status-indicator status-error';
                }
                if (db2) {
                    db2.innerHTML = errorHtml;
                    db2.className = 'status-indicator status-error';
                }
                // Force update bilingual elements for the new content
                forceUpdateBilingualElements();
            }
        }

        // Logout function
        window.logout = async function() {
            const lang = localStorage.getItem('servicehub-language') || 'it';
            const title = lang === 'en' ? 'Confirm Logout' : 'Conferma Logout';
            const message = lang === 'en' ? 'Are you sure you want to logout?' : 'Sei sicuro di voler effettuare il logout?';
            const confirmText = lang === 'en' ? 'Logout' : 'Esci';
            const cancelText = lang === 'en' ? 'Cancel' : 'Annulla';
            const confirmed = await window.customDialog.confirm(title, message, confirmText, cancelText);
            if (confirmed) {
                if (window.authManager) {
                    window.authManager.clearAuthData();
                    window.authManager.redirectToLogout();
                } else {
                    localStorage.clear();
                    window.location.href = '/pages/login.html';
                }
            }
        };

        // Initialize communications functionality
        function initializeCommunications() {
            // Get dealer ID - support both auth systems
            let dealerId = null;
            
            const servicehubUser = localStorage.getItem('servicehub-user');
            if (servicehubUser) {
                try {
                    const parsed = JSON.parse(servicehubUser);
                    dealerId = parsed.id;
                } catch (e) {
                    console.warn('‚ö†Ô∏è Invalid auth format');
                }
            }
            
            if (!dealerId) {
                const authData = localStorage.getItem('authData');
                if (authData) {
                    try {
                        const parsed = JSON.parse(authData);
                        dealerId = parsed.dealerId;
                    } catch (e) {
                        console.warn('‚ö†Ô∏è Invalid auth format');
                    }
                }
            }
            
            if (!dealerId) {
                console.error('No dealer ID found');
                window.location.href = '/pages/login.html';
                return;
            }

            // Refresh signatures function
            async function refreshSignatures() {
                const list = document.getElementById('signaturesList');
                if (!list) return;
                list.innerHTML = '<div class="text-sm text-gray-400" data-en="Loading..." data-it="Caricamento...">Caricamento...</div>';
                try {
                    const url = `/api/communications/signatures/${dealerId}`;
                    const r = await fetch(url, { credentials: 'include', headers: { 'Accept': 'application/json' } });
                    const j = await r.json();
                    list.innerHTML = (j.data||[]).map(s => `
                        <div class="relative p-3 border rounded">
                            <button data-id="${s.id}" class="absolute top-2 right-2 px-2 py-1 text-xs rounded bg-red-600 text-white del-sig" data-en="DELETE" data-it="ELIMINA">ELIMINA</button>
                            <div class="text-sm pr-16 break-words">
                                <div class="font-medium">${s.company_name||'-'}</div>
                                <div class="text-gray-400">${[s.address1,s.postcode,s.city,s.provincia].filter(Boolean).join(' ')}</div>
                                <div class="text-gray-400">${s.phone||''} ${s.email? ' ‚Ä¢ '+s.email:''}</div>
                            </div>
                        </div>
                    `).join('') || `<div class="text-sm text-gray-400" data-en="No saved signatures" data-it="Nessuna firma salvata">Nessuna firma salvata</div>`;
                    
                    if (window.forceUpdateBilingualElements) {
                        window.forceUpdateBilingualElements(list);
                    }
                    list.querySelectorAll('.del-sig').forEach(btn=>{
                        btn.addEventListener('click', async()=>{
                            await fetch(`/api/communications/signatures/${btn.dataset.id}/${dealerId}`, { method:'DELETE' });
                            refreshSignatures();
                        });
                    });
                } catch (e) { 
                    console.error('Error loading signatures:', e);
                    list.innerHTML = '<div class="text-sm text-gray-400" data-en="Error loading signatures" data-it="Errore caricamento firme">Errore caricamento firme</div>';
                }
            }

            // Refresh test clients function
            async function refreshTestClients() {
                const list = document.getElementById('testClientsList');
                if (!list) return;
                list.innerHTML = '<div class="text-sm text-gray-400" data-en="Loading..." data-it="Caricamento...">Caricamento...</div>';
                try {
                    const url = `/api/communications/test-clients/${dealerId}`;
                    const r = await fetch(url, { credentials: 'include', headers: { 'Accept': 'application/json' } });
                    const j = await r.json();
                    list.innerHTML = (j.data||[]).map(c => `
                        <div class="relative p-3 border rounded">
                            <button data-id="${c.id}" class="absolute top-2 right-2 px-2 py-1 text-xs rounded bg-red-600 text-white del-tc" data-en="DELETE" data-it="ELIMINA">ELIMINA</button>
                            <div class="text-sm pr-16 break-words">
                                <div class="font-medium">${[c.first_name,c.last_name].filter(Boolean).join(' ')||'-'} ${c.company? '‚Ä¢ '+c.company:''}</div>
                                <div class="text-gray-400">${[c.address1,c.postcode,c.city,c.provincia].filter(Boolean).join(' ')}</div>
                                <div class="text-gray-400">${c.phone||''} ${c.email? ' ‚Ä¢ '+c.email:''}</div>
                                <div class="text-gray-400">${[c.vehicle_brand,c.vehicle_model,c.plate,c.year,c.fuel_type,c.odometer?c.odometer+'km':''].filter(Boolean).join(' ‚Ä¢ ')}</div>
                            </div>
                        </div>
                    `).join('') || `<div class="text-sm text-gray-400" data-en="No saved test clients" data-it="Nessun cliente test salvato">Nessun cliente test salvato</div>`;
                    
                    if (window.forceUpdateBilingualElements) {
                        window.forceUpdateBilingualElements(list);
                    }
                    list.querySelectorAll('.del-tc').forEach(btn=>{
                        btn.addEventListener('click', async()=>{
                            await fetch(`/api/communications/test-clients/${btn.dataset.id}/${dealerId}`, { method:'DELETE' });
                            refreshTestClients();
                        });
                    });
                } catch (e) { 
                    console.error('Error loading test clients:', e);
                    list.innerHTML = '<div class="text-sm text-gray-400" data-en="Error loading test clients" data-it="Errore caricamento clienti test">Errore caricamento clienti test</div>';
                }
            }

            // Save signature handler
            const saveSignatureBtn = document.getElementById('saveSignatureBtn');
            if (saveSignatureBtn) {
                saveSignatureBtn.addEventListener('click', async()=>{
                    const companyInput = document.getElementById('sig_company_name');
                    const companyName = companyInput?.value.trim() || '';
                    if (!companyName) {
                        const title = window.i18n ? window.i18n.t('common.warning') : 'Attenzione';
                        await window.customDialog.alert(title, 'Il nome della concessionaria √® obbligatorio / Company name is required', 'OK');
                        companyInput?.focus();
                        return;
                    }
                    const body = {
                        dealer_id: dealerId,
                        company_name: companyName,
                        address1: document.getElementById('sig_address1')?.value || '',
                        address2: document.getElementById('sig_address2')?.value || '',
                        city: document.getElementById('sig_city')?.value || '',
                        provincia: document.getElementById('sig_provincia')?.value || '',
                        postcode: document.getElementById('sig_postcode')?.value || '',
                        phone: document.getElementById('sig_phone')?.value || '',
                        email: document.getElementById('sig_email')?.value || ''
                    };
                    try {
                        await fetch('/api/communications/signatures', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)});
                        refreshSignatures();
                        document.getElementById('dealerSignatureForm').reset();
                    } catch (e) {
                        console.error('Error saving signature:', e);
                    }
                });
            }

            // Reset signature handler
            const resetSignatureBtn = document.getElementById('resetSignatureBtn');
            if (resetSignatureBtn) resetSignatureBtn.addEventListener('click', ()=> document.getElementById('dealerSignatureForm').reset());

            // Save test client handler
            const saveTestClientBtn = document.getElementById('saveTestClientBtn');
            if (saveTestClientBtn) {
                saveTestClientBtn.addEventListener('click', async()=>{
                    const firstInput = document.getElementById('tc_first_name');
                    const lastInput = document.getElementById('tc_last_name');
                    const firstName = firstInput?.value.trim() || '';
                    const lastName = lastInput?.value.trim() || '';
                    if (!firstName || !lastName) {
                        const title = window.i18n ? window.i18n.t('common.warning') : 'Attenzione';
                        await window.customDialog.alert(title, 'Nome e cognome sono obbligatori / First name and last name are required', 'OK');
                        (firstName ? lastInput : firstInput)?.focus();
                        return;
                    }
                    
                    const rawYear = document.getElementById('tc_year')?.value || '';
                    const parsedYear = parseInt(rawYear, 10);
                    const rawOdometer = document.getElementById('tc_odometer')?.value || '';
                    const parsedOdometer = rawOdometer === '' ? null : parseInt(rawOdometer, 10);

                    const body = {
                        dealer_id: dealerId,
                        first_name: firstName,
                        last_name: lastName,
                        company: document.getElementById('tc_company')?.value || '',
                        address1: document.getElementById('tc_address1')?.value || '',
                        address2: document.getElementById('tc_address2')?.value || '',
                        city: document.getElementById('tc_city')?.value || '',
                        provincia: document.getElementById('tc_provincia')?.value || '',
                        postcode: document.getElementById('tc_postcode')?.value || '',
                        country: document.getElementById('tc_country')?.value || '',
                        email: document.getElementById('tc_email')?.value || '',
                        phone: document.getElementById('tc_phone')?.value || '',
                        vehicle_brand: document.getElementById('tc_vehicle_brand')?.value || '',
                        vehicle_model: document.getElementById('tc_vehicle_model')?.value || '',
                        plate: document.getElementById('tc_plate')?.value || '',
                        year: Number.isFinite(parsedYear) ? parsedYear : null,
                        fuel_type: document.getElementById('tc_fuel_type')?.value || '',
                        odometer: parsedOdometer,
                        vin: document.getElementById('tc_vin')?.value || '',
                        serial: document.getElementById('tc_serial')?.value || ''
                    };
                    try {
                        const r = await fetch('/api/communications/test-clients', { 
                            method:'POST', 
                            credentials: 'include', 
                            headers:{'Content-Type':'application/json','Accept':'application/json'}, 
                            body: JSON.stringify(body) 
                        });
                        if (!r.ok) {
                            console.error('Save test client failed:', await r.text());
                        }
                        refreshTestClients();
                        document.getElementById('testClientForm').reset();
                    } catch (e) { 
                        console.error('Error saving test client:', e); 
                    }
                });
            }

            // Reset test client handler
            const resetTestClientBtn = document.getElementById('resetTestClientBtn');
            if (resetTestClientBtn) resetTestClientBtn.addEventListener('click', ()=> document.getElementById('testClientForm').reset());

            // Load initial data
            refreshSignatures();
            refreshTestClients();
        }

        // Initialize template management
        function initializeTemplateManagement() {
            let dealerId = null;
            
            const servicehubUser = localStorage.getItem('servicehub-user');
            if (servicehubUser) {
                try {
                    const parsed = JSON.parse(servicehubUser);
                    dealerId = parsed.id;
                } catch (e) {}
            }
            
            if (!dealerId) {
                const authData = localStorage.getItem('authData');
                if (authData) {
                    try {
                        const parsed = JSON.parse(authData);
                        dealerId = parsed.dealerId;
                    } catch (e) {}
                }
            }
            
            if (!dealerId) {
                console.error('No dealer ID found for templates');
                return;
            }

            let editingTemplateId = null;

            // Toggle template form fields based on type selection
            window.toggleTemplateFields = function() {
                const type = document.getElementById('tmpl_type').value;
                const channel = document.getElementById('tmpl_channel').value;
                
                const promptGroup = document.getElementById('promptGroup');
                const contentGroup = document.getElementById('contentGroup');
                const emailSubjectGroup = document.getElementById('emailSubjectGroup');
                
                // Show/hide based on template type
                if (type === 'ai') {
                    promptGroup.style.display = 'block';
                    contentGroup.style.display = 'none';
                } else if (type === 'manual') {
                    promptGroup.style.display = 'none';
                    contentGroup.style.display = 'block';
                } else if (type === 'hybrid') {
                    promptGroup.style.display = 'block';
                    contentGroup.style.display = 'block';
                } else {
                    promptGroup.style.display = 'none';
                    contentGroup.style.display = 'none';
                }
                
                // Show email subject only for email channel
                emailSubjectGroup.style.display = (channel === 'email') ? 'block' : 'none';
            };

            // Handle channel change
            const channelSelect = document.getElementById('tmpl_channel');
            if (channelSelect) channelSelect.addEventListener('change', toggleTemplateFields);

            // Load and display templates
            async function refreshTemplates() {
                const list = document.getElementById('templatesList');
                if (!list) return;
                
                list.innerHTML = '<div class="text-sm text-gray-400" data-en="Loading templates..." data-it="Caricamento template...">Caricamento template...</div>';
                
                try {
                    let url = `/api/templates/${dealerId}`;
                    const params = new URLSearchParams();
                    
                    const filterChannel = document.getElementById('filterChannel')?.value;
                    const filterType = document.getElementById('filterType')?.value;
                    
                    if (filterChannel) params.append('channel', filterChannel);
                    if (filterType) params.append('type', filterType);
                    
                    if (params.toString()) url += '?' + params.toString();
                    
                    const response = await fetch(url);
                    const result = await response.json();
                    
                    if (!result.success) throw new Error('Error loading templates / Errore caricamento template');
                    
                    const templates = result.data || [];
                    
                    if (templates.length === 0) {
                        list.innerHTML = '<div class="text-sm text-gray-400" data-en="No templates found" data-it="Nessun template trovato">Nessun template trovato</div>';
                        return;
                    }
                    
                    list.innerHTML = templates.map(template => {
                        const channelIcon = template.channel === 'email' ? 'üìß' : template.channel === 'whatsapp' ? 'üí¨' : 'üì±';
                        const styleText = template.style === 'formal' ? 'Formale' : template.style === 'informal' ? 'Informale' : 'Professionale';
                        const typeText = template.template_type === 'ai' ? 'AI' : template.template_type === 'manual' ? 'Manuale' : 'Ibrido';
                        const favoriteIcon = template.is_favorite ? '‚≠ê' : '';
                        
                        return `
                            <div class="relative border rounded-lg p-4 hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors">
                                <div class="flex items-start justify-between">
                                    <div class="flex-1 min-w-0">
                                        <div class="flex items-center gap-2 mb-2">
                                            <h4 class="font-semibold text-base">${favoriteIcon}${template.name}</h4>
                                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200">
                                                ${channelIcon} ${template.channel}
                                            </span>
                                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200">
                                                ${typeText}
                                            </span>
                                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200">
                                                ${styleText}
                                            </span>
                                        </div>
                                        ${template.description ? `<p class="text-sm text-gray-600 dark:text-gray-400 mb-2">${template.description}</p>` : ''}
                                        <div class="text-xs text-gray-500 space-y-1">
                                            ${template.email_subject ? `<div><strong>Oggetto/Subject:</strong> ${template.email_subject}</div>` : ''}
                                            ${template.prompt ? `<div><strong>Prompt:</strong> ${template.prompt.substring(0, 100)}${template.prompt.length > 100 ? '...' : ''}</div>` : ''}
                                            ${template.message_content ? `<div><strong>Contenuto/Content:</strong> ${template.message_content.substring(0, 150)}${template.message_content.length > 150 ? '...' : ''}</div>` : ''}
                                            <div class="flex items-center gap-4 mt-2">
                                                <span>üìä Utilizzi/Usage: ${template.usage_count || 0}</span>
                                                <span>üìÖ Creato/Created: ${new Date(template.created_at).toLocaleDateString('it-IT')}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="flex items-center gap-2 ml-4">
                                        <button onclick="editTemplate('${template.id}')" class="px-3 py-1 text-xs rounded bg-blue-600 text-white hover:bg-blue-700 transition-colors" data-en="Edit" data-it="Modifica">Modifica</button>
                                        <button onclick="duplicateTemplate('${template.id}')" class="px-3 py-1 text-xs rounded bg-green-600 text-white hover:bg-green-700 transition-colors" data-en="Duplicate" data-it="Duplica">Duplica</button>
                                        <button onclick="deleteTemplate('${template.id}', '${template.name.replace(/'/g, "\\'")}')" class="px-3 py-1 text-xs rounded bg-red-600 text-white hover:bg-red-700 transition-colors" data-en="Delete" data-it="Elimina">Elimina</button>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                    
                    if (window.forceUpdateBilingualElements) {
                        window.forceUpdateBilingualElements(list);
                    }
                    
                } catch (error) {
                    console.error('Error loading templates:', error);
                    list.innerHTML = '<div class="text-sm text-red-400" data-en="Error loading templates" data-it="Errore nel caricamento dei template">Errore nel caricamento dei template</div>';
                }
            }

            // Save template function
            async function saveTemplate() {
                const name = document.getElementById('tmpl_name')?.value.trim();
                const description = document.getElementById('tmpl_description')?.value.trim();
                const channel = document.getElementById('tmpl_channel')?.value;
                const style = document.getElementById('tmpl_style')?.value;
                const type = document.getElementById('tmpl_type')?.value;
                const emailSubject = document.getElementById('tmpl_email_subject')?.value.trim();
                const promptText = document.getElementById('tmpl_prompt')?.value.trim();
                const content = document.getElementById('tmpl_content')?.value.trim();
                const isFavorite = document.getElementById('tmpl_favorite')?.checked;

                // Validation
                if (!name) {
                    const title = window.i18n ? window.i18n.t('common.warning') : 'Attenzione';
                    await window.customDialog.alert(title, 'Il nome del template √® obbligatorio / Template name is required', 'OK');
                    document.getElementById('tmpl_name')?.focus();
                    return;
                }
                
                if (!channel || !style || !type) {
                    const title = window.i18n ? window.i18n.t('common.warning') : 'Attenzione';
                    await window.customDialog.alert(title, 'Canale, stile e tipo template sono obbligatori / Channel, style and template type are required', 'OK');
                    return;
                }
                
                if ((type === 'ai' || type === 'hybrid') && !promptText) {
                    const title = window.i18n ? window.i18n.t('common.warning') : 'Attenzione';
                    await window.customDialog.alert(title, 'Il prompt AI √® obbligatorio per template AI e ibridi / AI prompt is required for AI and hybrid templates', 'OK');
                    document.getElementById('tmpl_prompt')?.focus();
                    return;
                }
                
                if ((type === 'manual' || type === 'hybrid') && !content) {
                    const title = window.i18n ? window.i18n.t('common.warning') : 'Attenzione';
                    await window.customDialog.alert(title, 'Il contenuto del messaggio √® obbligatorio per template manuali e ibridi / Message content is required for manual and hybrid templates', 'OK');
                    document.getElementById('tmpl_content')?.focus();
                    return;
                }

                const templateData = {
                    dealer_id: dealerId,
                    name: name,
                    description: description,
                    channel: channel,
                    style: style,
                    template_type: type,
                    email_subject: channel === 'email' ? emailSubject : null,
                    prompt: (type === 'ai' || type === 'hybrid') ? promptText : null,
                    message_content: (type === 'manual' || type === 'hybrid') ? content : null,
                    is_favorite: isFavorite
                };

                try {
                    const url = editingTemplateId ? `/api/templates/${editingTemplateId}` : '/api/templates';
                    const method = editingTemplateId ? 'PUT' : 'POST';
                    
                    const response = await fetch(url, {
                        method: method,
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(templateData)
                    });

                    const result = await response.json();
                    
                    if (!result.success) {
                        throw new Error(result.error || 'Errore nel salvataggio / Save error');
                    }

                    const title = window.i18n ? window.i18n.t('common.success') : 'Successo';
                    const message = editingTemplateId ? 'Template aggiornato con successo! / Template updated successfully!' : 'Template creato con successo! / Template created successfully!';
                    await window.customDialog.alert(title, message, 'OK');
                    resetTemplateForm();
                    refreshTemplates();
                    
                } catch (error) {
                    console.error('Error saving template:', error);
                    const title = window.i18n ? window.i18n.t('common.error') : 'Errore';
                    await window.customDialog.alert(title, 'Errore nel salvataggio del template / Error saving template: ' + error.message, 'OK');
                }
            }

            // Reset template form
            function resetTemplateForm() {
                document.getElementById('templateForm')?.reset();
                editingTemplateId = null;
                const cancelBtn = document.getElementById('cancelEditBtn');
                if (cancelBtn) cancelBtn.style.display = 'none';
                const saveBtn = document.getElementById('saveTemplateBtn');
                if (saveBtn) saveBtn.textContent = 'Salva Template';
                toggleTemplateFields();
            }

            // Global functions for template management
            window.cancelTemplateEdit = function() {
                resetTemplateForm();
            };

            window.editTemplate = async function(templateId) {
                try {
                    const response = await fetch(`/api/templates/${dealerId}`);
                    const result = await response.json();
                    
                    if (!result.success) throw new Error('Errore caricamento template / Error loading template');
                    
                    const template = result.data.find(t => t.id === templateId);
                    if (!template) throw new Error('Template non trovato / Template not found');
                    
                    // Populate form
                    document.getElementById('tmpl_name').value = template.name || '';
                    document.getElementById('tmpl_description').value = template.description || '';
                    document.getElementById('tmpl_channel').value = template.channel || '';
                    document.getElementById('tmpl_style').value = template.style || '';
                    document.getElementById('tmpl_type').value = template.template_type || '';
                    document.getElementById('tmpl_email_subject').value = template.email_subject || '';
                    document.getElementById('tmpl_prompt').value = template.prompt || '';
                    document.getElementById('tmpl_content').value = template.message_content || '';
                    document.getElementById('tmpl_favorite').checked = template.is_favorite || false;
                    
                    // Update form state
                    editingTemplateId = templateId;
                    document.getElementById('cancelEditBtn').style.display = 'inline-block';
                    document.getElementById('saveTemplateBtn').textContent = 'Aggiorna Template';
                    toggleTemplateFields();
                    
                    // Scroll to form
                    document.getElementById('templateForm').scrollIntoView({ behavior: 'smooth' });
                    
                } catch (error) {
                    console.error('Error loading template for edit:', error);
                    const title = window.i18n ? window.i18n.t('common.error') : 'Errore';
                    await window.customDialog.alert(title, 'Errore nel caricamento del template / Error loading template: ' + error.message, 'OK');
                }
            };

            window.duplicateTemplate = async function(templateId) {
                try {
                    const response = await fetch(`/api/templates/${dealerId}`);
                    const result = await response.json();
                    
                    if (!result.success) throw new Error('Errore caricamento template / Error loading template');
                    
                    const template = result.data.find(t => t.id === templateId);
                    if (!template) throw new Error('Template non trovato / Template not found');
                    
                    // Reset form and populate with template data
                    resetTemplateForm();
                    document.getElementById('tmpl_name').value = template.name + ' (Copia)';
                    document.getElementById('tmpl_description').value = template.description || '';
                    document.getElementById('tmpl_channel').value = template.channel || '';
                    document.getElementById('tmpl_style').value = template.style || '';
                    document.getElementById('tmpl_type').value = template.template_type || '';
                    document.getElementById('tmpl_email_subject').value = template.email_subject || '';
                    document.getElementById('tmpl_prompt').value = template.prompt || '';
                    document.getElementById('tmpl_content').value = template.message_content || '';
                    document.getElementById('tmpl_favorite').checked = false;
                    
                    toggleTemplateFields();
                    
                    // Scroll to form
                    document.getElementById('templateForm').scrollIntoView({ behavior: 'smooth' });
                    
                } catch (error) {
                    console.error('Error duplicating template:', error);
                    const title = window.i18n ? window.i18n.t('common.error') : 'Errore';
                    await window.customDialog.alert(title, 'Errore nella duplicazione del template / Error duplicating template: ' + error.message, 'OK');
                }
            };

            window.deleteTemplate = async function(templateId, templateName) {
                const title = 'Conferma Eliminazione / Confirm Deletion';
                const message = `Sei sicuro di voler eliminare il template "${templateName}"?\n\nAre you sure you want to delete template "${templateName}"?\n\nQuesta azione non pu√≤ essere annullata.\nThis action cannot be undone.`;
                const confirmed = await window.customDialog.confirm(title, message, 'Elimina / Delete', 'Annulla / Cancel');
                
                if (!confirmed) return;
                
                try {
                    const response = await fetch(`/api/templates/${templateId}`, {
                        method: 'DELETE'
                    });

                    const result = await response.json();
                    
                    if (!result.success) {
                        throw new Error(result.error || 'Errore nell\'eliminazione / Error deleting');
                    }

                    const title = window.i18n ? window.i18n.t('common.success') : 'Successo';
                    await window.customDialog.alert(title, 'Template eliminato con successo! / Template deleted successfully!', 'OK');
                    refreshTemplates();
                    
                    // If we were editing this template, reset the form
                    if (editingTemplateId === templateId) {
                        resetTemplateForm();
                    }
                    
                } catch (error) {
                    console.error('Error deleting template:', error);
                    const title = window.i18n ? window.i18n.t('common.error') : 'Errore';
                    await window.customDialog.alert(title, 'Errore nell\'eliminazione del template / Error deleting template: ' + error.message, 'OK');
                }
            };

            // Wire up event handlers
            const saveTemplateBtn = document.getElementById('saveTemplateBtn');
            if (saveTemplateBtn) {
                saveTemplateBtn.addEventListener('click', saveTemplate);
            }

            const resetTemplateBtn = document.getElementById('resetTemplateBtn');
            if (resetTemplateBtn) {
                resetTemplateBtn.addEventListener('click', resetTemplateForm);
            }

            // Add change handlers for filter dropdowns
            const filterChannel = document.getElementById('filterChannel');
            const filterType = document.getElementById('filterType');
            if (filterChannel) filterChannel.addEventListener('change', refreshTemplates);
            if (filterType) filterType.addEventListener('change', refreshTemplates);

            // Load templates on page load
            refreshTemplates();
        }

        // Language change function
        function changeLanguage(lang) {
            // Update localStorage using the same keys as the i18n system
            localStorage.setItem('servicehub-language', lang);
            localStorage.setItem('language', lang); // backward compatibility
            
            // Update button states
            const langButtons = document.querySelectorAll('[id^="lang-"]');
            langButtons.forEach(btn => {
                if (btn.id === `lang-${lang}`) {
                    btn.className = btn.className.replace('btn-theme-inactive', 'btn-theme-active');
                } else {
                    btn.className = btn.className.replace('btn-theme-active', 'btn-theme-inactive');
                }
            });
            
            // Use the global i18n system if available
            if (window.i18nManager && window.i18nManager.setLanguage) {
                window.i18nManager.setLanguage(lang);
            }
            
            // Always force update our custom bilingual elements
            forceUpdateBilingualElements();
            
            console.log(`‚úÖ Language changed to: ${lang} / Lingua cambiata a: ${lang}`);
        }

        // Theme change function
        function setTheme(theme) {
            // Update localStorage
            localStorage.setItem('servicehub-theme', theme);
            
            // Update button states
            const themeButtons = document.querySelectorAll('[id^="theme"]');
            themeButtons.forEach(btn => {
                if (btn.id === `theme${theme.charAt(0).toUpperCase() + theme.slice(1)}`) {
                    btn.className = btn.className.replace('btn-theme-inactive', 'btn-theme-active');
                } else {
                    btn.className = btn.className.replace('btn-theme-active', 'btn-theme-inactive');
                }
            });
            
            // Apply theme
            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
            
            console.log(`‚úÖ Theme changed to: ${theme}`);
        }

        // Force update all bilingual elements
        function forceUpdateBilingualElements(container = document) {
            const lang = localStorage.getItem('servicehub-language') || 'it';
            
            // Update data-en/data-it elements
            container.querySelectorAll('[data-en][data-it]').forEach(el => {
                const text = el.getAttribute(`data-${lang}`);
                if (text) el.textContent = text;
            });
            
            // Update placeholders
            container.querySelectorAll(`[data-${lang}-placeholder]`).forEach(el => {
                const placeholder = el.getAttribute(`data-${lang}-placeholder`);
                if (placeholder) el.placeholder = placeholder;
            });
        }

        // Make forceUpdateBilingualElements available globally
        window.forceUpdateBilingualElements = forceUpdateBilingualElements;

        // Initialize language and theme on page load
        function initializePreferences() {
            // Get saved language or default to Italian
            const savedLang = localStorage.getItem('servicehub-language') || 'it';
            
            // Set initial button states
            const langButtons = document.querySelectorAll('[id^="lang-"]');
            langButtons.forEach(btn => {
                if (btn.id === `lang-${savedLang}`) {
                    btn.className = btn.className.replace('btn-theme-inactive', 'btn-theme-active');
                } else {
                    btn.className = btn.className.replace('btn-theme-active', 'btn-theme-inactive');
                }
            });
            
            // Force update all bilingual elements immediately
            forceUpdateBilingualElements();
            
            // Get saved theme or default to dark
            const savedTheme = localStorage.getItem('servicehub-theme') || 'dark';
            setTheme(savedTheme);
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            if (window.authManager && !window.authManager.isAuthenticated()) {
                window.authManager.redirectToLogin();
                return;
            }
            
            // Initialize preferences first
            initializePreferences();
            
            // Open preferences section by default
            toggleSection('preferences');
            
            // Load data
            loadDealerInfo();
            updateDbStatus();
            
            // Initialize functionality
            initializeCommunications();
            initializeTemplateManagement();
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="meta.login.title">Login - Service Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Favicons -->
    <link rel="icon" type="image/x-icon" href="/favicon/favicon.ico">
    <link rel="icon" type="image/svg+xml" href="/favicon/favicon.svg">
    <link rel="icon" type="image/png" href="/favicon/favicon-16x16.png" sizes="16x16">
    <link rel="icon" type="image/png" href="/favicon/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/favicon/favicon-48x48.png" sizes="48x48">
    <link rel="apple-touch-icon" href="/favicon/apple-touch-icon.png" sizes="180x180">
    <link rel="manifest" href="/favicon/manifest.json">
    
    <!-- I18n System -->
    <script src="../js/i18n.js"></script>
    
    <!-- IP Geolocation Service -->
    <script src="../js/ip-geolocation.js"></script>
    
    
    
    <style>
        .bg-primary { background-color: #3B82F6; }
        .text-primary { color: #3B82F6; }
        .hover\:bg-primary:hover { background-color: #2563EB; }
    </style>
</head>

<body class="min-h-screen bg-gray-900 flex items-center justify-center p-4">
    
    <!-- Login Container -->
    <div class="w-full max-w-md">

        <!-- Logo and Title -->
        <div class="text-center mb-8">
            <div class="mb-4">
                <img src="../images/serviceHub.png" alt="Service Hub" class="h-16 mx-auto" onerror="this.outerHTML='<div class=&quot;w-16 h-16 bg-blue-600 rounded-lg mx-auto flex items-center justify-center&quot;><span class=&quot;text-white font-bold text-2xl&quot;>SH</span></div>'">
            </div>
            <h1 id="pageTitle" class="text-3xl font-bold text-white mb-2">Service Portal</h1>
            <p id="pageSubtitle" class="text-blue-300">Advanced Telematics Platform</p>
        </div>
        
        <!-- Login Form -->
        <div class="bg-gray-800 rounded-xl p-8 shadow-2xl border border-gray-700">
            
                        <form id="loginForm" class="space-y-6" onsubmit="handleLogin(event)">
                
                
                
                <!-- Dynamic Input Field -->
                <div id="contactField">
                    <label for="contactInput" class="block text-sm font-medium text-white mb-2" id="contactLabel">
                        Indirizzo Email
                    </label>
                    
                    <!-- Email Input -->
                    <div id="emailInputContainer">
                        <input 
                            type="email" 
                            id="emailInput" 
                            name="contact"
                            required
                            class="w-full px-4 py-3 rounded-lg bg-gray-700 border border-gray-600 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            placeholder="dealer@azienda.it"
                        >
                    </div>
                    
                    
                </div>
                
                <!-- PIN Field (Hidden by default) -->
                <div id="pinField" style="display: none;">
                    <label for="pin" class="block text-sm font-medium text-white mb-2" id="pinLabel">
                        Codice PIN
                    </label>
                    <div class="relative">
                        <input 
                             type="password" 
                             id="pin" 
                             name="pin" 
                             maxlength="6"
                             class="w-full px-4 py-3 pr-12 rounded-lg bg-gray-700 border border-gray-600 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-center text-2xl tracking-widest"
                             placeholder="000000"
                         >
                        <button 
                            type="button" 
                            id="togglePin" 
                            class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-white"
                        >
                            üëÅÔ∏è
                        </button>
                    </div>
                    <div class="text-center mt-2">
                        <p class="text-gray-400 text-sm" id="pinInstructions">
                            Controlla la tua email per il PIN a 6 cifre
                        </p>
                    </div>
                </div>
                
                <!-- Submit Button -->
                <button 
                    type="submit" 
                    id="submitButton"
                    class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-lg transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
                    Invia PIN
                </button>
                
            </form>
            
            <!-- Status Messages -->
            <div id="statusMessages" class="mt-6">
                <div id="errorMessage" class="hidden bg-red-600 text-white p-3 rounded-lg text-sm mb-2"></div>
                <div id="successMessage" class="hidden bg-green-600 text-white p-3 rounded-lg text-sm mb-2"></div>
            </div>
            
        </div>
        
        <!-- Footer -->
        <div class="text-center mt-6 text-sm text-gray-400">
            <p data-en="Authorized personnel only. All access is monitored." 
               data-it="Solo personale autorizzato. Tutti gli accessi sono monitorati.">
                Authorized personnel only. All access is monitored.
            </p>
        </div>
        
    </div>
    
    <!-- Forgot PIN Modal -->
    <div id="forgotPinModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 rounded-xl p-6 max-w-md w-full border border-gray-700">
            <div class="text-center space-y-4">
                <h3 class="text-lg font-semibold text-white" 
                    data-en="PIN Recovery" data-it="Recupero PIN">PIN Recovery</h3>
                <p class="text-gray-300" 
                   data-en="Contact your system administrator for PIN recovery assistance." 
                   data-it="Contatta l'amministratore di sistema per assistenza nel recupero del PIN.">
                    Contact your system administrator for PIN recovery assistance.
                </p>
                <div class="space-y-2 text-sm text-blue-300">
                    <div>Email: support@servicehub.portal</div>
                    <div>Phone: +39 02 1234 5678</div>
                </div>
                <div class="flex space-x-3">
                    <button id="closeForgotModal" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white py-2 px-4 rounded-lg"
                            data-en="Close" data-it="Chiudi">
                        Close
                    </button>
                    <a href="mailto:support@servicehub.portal" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg text-center"
                       data-en="Contact Support" data-it="Contatta Supporto">
                        Contact Support
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Load Authentication Modules -->
    <script src="../js/auth.js"></script>
    <script src="../js/auth-guard.js"></script>
    
    <script>
        let currentStep = 'contact'; // 'contact', 'pin'
        
        let userLocation = null;
        let currentLanguage = 'it'; // Default to Italian
        
        // Translations
        const translations = {
            it: {
                pageTitle: 'Service Portal',
                pageSubtitle: 'Piattaforma Telematica Avanzata',
                deliveryLabel: 'Come vuoi ricevere il tuo PIN?',
                emailOption: 'Email',
                whatsappOption: 'WhatsApp', 
                emailDesc: 'Ricevi il PIN via email',
                whatsappDesc: 'Ricevi il PIN via WhatsApp',
                emailLabel: 'Indirizzo Email',
                phoneLabel: 'Numero di Telefono',
                pinLabel: 'Codice PIN',
                submitButtonContact: 'Invia PIN',
                submitButtonPin: 'Accedi',
                pinInstructionsEmail: 'Controlla la tua email per il PIN a 6 cifre',
                pinInstructionsWhatsApp: 'Controlla il tuo WhatsApp per il PIN a 6 cifre',
                errorEmailRequired: 'Inserisci il tuo indirizzo email',
                errorEmailInvalid: 'Inserisci un indirizzo email valido',
                errorPhoneRequired: 'Inserisci il tuo numero di telefono',
                errorPhoneInvalid: 'Inserisci un numero di telefono valido',
                errorPinRequired: 'Inserisci il codice PIN',
                errorPinInvalid: 'Il PIN deve essere di 6 cifre',
                successPinSent: 'PIN inviato con successo!',
                errorSendPin: 'Invio del PIN non riuscito. Riprova.',
                pinGenerated: 'PIN generato. Inseriscilo qui sotto.',
                successLogin: 'Accesso effettuato! Reindirizzamento...',
                sending: 'Invio...',
                verifying: 'Verifica...'
            },
            en: {
                pageTitle: 'Service Portal',
                pageSubtitle: 'Advanced Telematics Platform',
                deliveryLabel: 'How would you like to receive your PIN?',
                emailOption: 'Email',
                whatsappOption: 'WhatsApp',
                emailDesc: 'Receive PIN via email',
                whatsappDesc: 'Receive PIN via WhatsApp',
                emailLabel: 'Email Address',
                phoneLabel: 'Phone Number',
                pinLabel: 'PIN Code',
                submitButtonContact: 'Send PIN',
                submitButtonPin: 'Login',
                pinInstructionsEmail: 'Check your email for the 6-digit PIN',
                pinInstructionsWhatsApp: 'Check your WhatsApp for the 6-digit PIN',
                errorEmailRequired: 'Please enter your email address',
                errorEmailInvalid: 'Please enter a valid email address',
                errorPhoneRequired: 'Please enter your phone number',
                errorPhoneInvalid: 'Please enter a valid phone number',
                errorPinRequired: 'Please enter your PIN',
                errorPinInvalid: 'PIN must be 6 digits',
                successPinSent: 'PIN sent successfully!',
                errorSendPin: 'Failed to send PIN. Please try again.',
                pinGenerated: 'PIN generated. Please enter it below.',
                successLogin: 'Login successful! Redirecting...',
                sending: 'Sending...',
                verifying: 'Verifying...'
            }
        };
        
        function t(key) {
            return translations[currentLanguage][key] || translations.en[key] || key;
        }
        
        function togglePin() {
            const pinField = document.getElementById('pin');
            pinField.type = pinField.type === 'password' ? 'text' : 'password';
        }
        
        async function detectUserLocation() {
            try {
                if (window.ipGeoService) {
                    userLocation = await window.ipGeoService.getUserLocation();
                    if (userLocation && userLocation.country === 'IT') {
                        currentLanguage = 'it';
                    } else {
                        currentLanguage = 'en';
                    }
                    // Sync global i18n language so data-it/data-en elements update correctly
                    if (window.i18n && typeof window.i18n.changeLanguage === 'function') {
                        window.i18n.changeLanguage(currentLanguage);
                    } else if (typeof window.changeLanguage === 'function') {
                        window.changeLanguage(currentLanguage);
                    }
                    updateLanguageDisplay();
                    
                }
            } catch (error) {
                
                currentLanguage = 'en';
                if (window.i18n && typeof window.i18n.changeLanguage === 'function') {
                    window.i18n.changeLanguage(currentLanguage);
                } else if (typeof window.changeLanguage === 'function') {
                    window.changeLanguage(currentLanguage);
                }
                updateLanguageDisplay();
            }
        }
        
        
        function updateLanguageDisplay() {
            // Update all text elements
            document.getElementById('pageTitle').textContent = t('pageTitle');
            document.getElementById('pageSubtitle').textContent = t('pageSubtitle');
            document.getElementById('contactLabel').textContent = t('emailLabel');
            document.getElementById('pinLabel').textContent = t('pinLabel');
            
            // Update placeholders
            const emailInput = document.getElementById('emailInput');
            if (currentLanguage === 'it') {
                emailInput.placeholder = 'dealer@azienda.it';
            } else {
                emailInput.placeholder = 'dealer@company.com';
            }
            
            updateSubmitButton();
            updatePinInstructions();

            // Update bilingual elements using data-it/data-en attributes
            if (window.forceUpdateBilingualElements) {
                window.forceUpdateBilingualElements(document);
            } else {
                document.querySelectorAll('[data-it],[data-en]').forEach(el => {
                    const it = el.getAttribute('data-it');
                    const en = el.getAttribute('data-en');
                    el.textContent = currentLanguage === 'it' ? (it || el.textContent) : (en || el.textContent);
                });
            }
        }
        
        function updateSubmitButton() {
            const button = document.getElementById('submitButton');
            if (currentStep === 'contact') {
                button.textContent = t('submitButtonContact');
            } else {
                button.textContent = t('submitButtonPin');
            }
        }
        
        function updatePinInstructions() {
            const instructions = document.getElementById('pinInstructions');
            instructions.textContent = t('pinInstructionsEmail');
        }
        
        function updateContactField() {
            const emailContainer = document.getElementById('emailInputContainer');
            const contactLabel = document.getElementById('contactLabel');
            const emailInput = document.getElementById('emailInput');
            emailContainer.style.display = 'block';
            contactLabel.textContent = t('emailLabel');
            emailInput.required = true;
        }
        
        function showPinField() {
            document.getElementById('pinField').style.display = 'block';
            document.getElementById('pin').focus();
            currentStep = 'pin';
            updateSubmitButton();
            updatePinInstructions();
        }
        
        function hidePinField() {
            document.getElementById('pinField').style.display = 'none';
            currentStep = 'contact';
            updateSubmitButton();
        }
        
        async function handleLogin(e) {
            e.preventDefault();
            
            const submitButton = document.getElementById('submitButton');
            
            if (currentStep === 'contact') {
                // Step 1: Send PIN
                let contact = '';
                let isValid = false;
                
                contact = document.getElementById('emailInput').value.trim();
                if (!contact) {
                    showMessage(t('errorEmailRequired'), 'error');
                    return;
                }
                if (!isValidEmail(contact)) {
                    showMessage(t('errorEmailInvalid'), 'error');
                    return;
                }
                isValid = true;
                
                if (!isValid) return;
                
                // Show loading state
                submitButton.disabled = true;
                submitButton.textContent = t('sending');
                
                try {
                    // Call real API to send PIN
                    const requestData = {
                        email: contact,
                        method: 'email',
                        phone: null
                    };
                    
                    
                    
                    const response = await fetch('/api/auth/request-pin', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept-Language': currentLanguage === 'it' ? 'it-IT,it;q=0.9' : 'en-US,en;q=0.9',
                        },
                        body: JSON.stringify(requestData)
                    });
                    
                    const result = await response.json();
                    
                    
                    if (result.success) {
                        if (result.pin) {
                            const pinInput = document.getElementById('pin');
                            if (pinInput && /^\d{6}$/.test(result.pin)) {
                                pinInput.value = result.pin;
                            }
                            showMessage(t('pinGenerated'), 'success');
                        } else {
                            showMessage(t('successPinSent'), 'success');
                        }
                        showPinField();
                    } else {
                        
                        let localizedError = t('errorSendPin');
                        switch (result.error) {
                            case 'email_required':
                                localizedError = t('errorEmailRequired');
                                break;
                            case 'dealer_not_found':
                                localizedError = currentLanguage === 'it' ? 'Dealer non trovato' : 'Dealer not found';
                                break;
                            case 'request_in_progress':
                                localizedError = currentLanguage === 'it' ? 'Richiesta gi√† in corso. Attendere.' : 'A request is already in progress. Please wait.';
                                break;
                            case 'duplicate_request':
                                localizedError = currentLanguage === 'it' ? 'Attendi prima di richiedere un altro PIN' : 'Please wait before requesting another PIN';
                                break;
                            default:
                                if (result.message) localizedError = result.message;
                        }
                        showMessage(localizedError, 'error');
                    }
                    
                } catch (error) {
                    
                    showMessage('Network error. Please try again.', 'error');
                } finally {
                    submitButton.disabled = false;
                    updateSubmitButton();
                }
                
            } else if (currentStep === 'pin') {
                // Step 2: Verify PIN
                const pin = document.getElementById('pin').value.trim();
                
                if (!pin) {
                    showMessage(t('errorPinRequired'), 'error');
                    return;
                }
                
                if (pin.length !== 6 || !/^\d{6}$/.test(pin)) {
                    showMessage(t('errorPinInvalid'), 'error');
                    return;
                }
                
                // Show loading state
                submitButton.disabled = true;
                submitButton.textContent = t('verifying');
                
                try {
                    // Call real API to verify PIN
                    const response = await fetch('/api/auth/verify-pin', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            email: document.getElementById('emailInput').value.trim(), // Always use email for verification
                            pin: pin
                        })
                    });
                    
                    const result = await response.json();
                    
                    console.log('üîç DEBUG - Login result:', result);
                    console.log('üîç DEBUG - Dealer object:', result.dealer);
                    console.log('üîç DEBUG - Dealer ID:', result.dealer?.id);
                    
                    if (result.success) {
                        showMessage(t('successLogin'), 'success');
                        
                        // Store auth info in the format expected by Auth Guard
                        try {
                            if (window.authGuard && typeof window.authGuard.handleSuccessfulLogin === 'function') {
                                window.authGuard.handleSuccessfulLogin({
                                    token: result.token,
                                    id: result.dealer.id,
                                    email: result.dealer.email,
                                    companyName: result.dealer.companyName,
                                    name: result.dealer.name
                                });
                            } else {
                                if (result.token) {
                                    localStorage.setItem('servicehub-auth-token', result.token);
                                }
                                const userPayload = {
                                    id: result.dealer.id,
                                    email: result.dealer.email,
                                    companyName: result.dealer.companyName,
                                    name: result.dealer.name,
                                    expiresAt: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString()
                                };
                                localStorage.setItem('servicehub-user', JSON.stringify(userPayload));
                                
                                // Also store authData in the format expected by other pages
                                const authData = {
                                    dealerId: result.dealer.id,
                                    dealerName: result.dealer.companyName,
                                    email: result.dealer.email,
                                    name: result.dealer.name
                                };
                                console.log('üîç DEBUG - AuthData being stored:', authData);
                                localStorage.setItem('authData', JSON.stringify(authData));
                                
                                // Redirect to dashboard
                                window.location.href = '../index.html';
                            }
                        } catch (e) {
                            
                            window.location.href = '../index.html';
                        }
                    } else {
                        showMessage(result.message || 'Invalid PIN', 'error');
                        document.getElementById('pin').value = '';
                        document.getElementById('pin').focus();
                    }
                    
                } catch (error) {
                    
                    showMessage('Network error. Please try again.', 'error');
                    document.getElementById('pin').value = '';
                    document.getElementById('pin').focus();
                } finally {
                    submitButton.disabled = false;
                    updateSubmitButton();
                }
            }
        }
        
        function showMessage(message, type) {
            const errorDiv = document.getElementById('errorMessage');
            const successDiv = document.getElementById('successMessage');
            
            // Hide both first
            errorDiv.classList.add('hidden');
            successDiv.classList.add('hidden');
            
            if (type === 'error') {
                errorDiv.textContent = message;
                errorDiv.classList.remove('hidden');
            } else if (type === 'success') {
                successDiv.textContent = message;
                successDiv.classList.remove('hidden');
            }
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                errorDiv.classList.add('hidden');
                successDiv.classList.add('hidden');
            }, 5000);
        }
        
        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }
        
        

        // Initialize page
        document.addEventListener('DOMContentLoaded', async function() {
            
            
            // Set up event listeners
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('togglePin').addEventListener('click', togglePin);
            
            // Detect user location and set language
            await detectUserLocation();
            
            // Initialize UI
            updateContactField();
            updateSubmitButton();
            
            
        });
    </script>
    
</body>
</html> 